import"../chunks/DsnmJJEf.js";import{i as Re}from"../chunks/D444ibiU.js";import{h as Ye,a as St,ac as _t,bn as pa,b as fa,E as ga,B as ha,bo as ya,aJ as ma,bp as wa,aw as ba,ai as _a,d as Wt,c as xt,Y as xa,R as ka,aN as Sa,A as ze,I as Ne,K as r,L as P,m as ie,l as e,J as nt,q as Ue,v as Fe,x as b,C as Ve,y as F,t as Ge,z as K,N as z,D as o,F as n,G as c,u as _,b0 as lt,M as Ca,bq as rt,aX as Ma,br as Ut,_ as gt,bk as de}from"../chunks/BIWrGPwp.js";import{l as Xt,p as W,s as Ke,a as He,b as at}from"../chunks/7Y9Eh46m.js";import{s as Ta}from"../chunks/Ca7_EGNT.js";import{c as Ze,s as E,o as Jt,a as La}from"../chunks/CLAw4lq8.js";import{i as G}from"../chunks/bLLYHiUB.js";import{e as $a,a as Me,r as vt,s as De,i as Pa,f as Aa,d as Ea}from"../chunks/CNuyH17j.js";import{aa as ht,V as Ct,a0 as Mt,W as Tt,Y as Lt,X as Qt,F as $t,$ as Oa,a6 as ja,a1 as Na,ab as Ba,a4 as Ia,a3 as Fa,a5 as Da,a7 as Ra,ac as za,Z as Va,L as Ha}from"../chunks/7m7KEctv.js";import{e as dt,K as qa,i as ea,aq as Ya,ar as Ka,ai as Wa,am as st,aj as Ua,D as Xa,P as Ga}from"../chunks/DjeodknY.js";import{w as ta,d as Za}from"../chunks/CzxzY2VL.js";function Ja(s,a,t,l,u){Ye&&St();var i=a.$$slots?.[t],S=!1;i===!0&&(i=a.children,S=!0),i===void 0||i(s,S?()=>l:l)}function Qa(s,a,t,l,u,i){let S=Ye;Ye&&St();var h=null;Ye&&_t.nodeType===pa&&(h=_t,St());var C=Ye?_t:s,v=new ha(C,!1);fa(()=>{const w=a()||null;var N=w==="svg"?ya:null;if(w===null){v.ensure(null,null);return}return v.ensure(w,I=>{if(w){if(h=Ye?h:N?document.createElementNS(N,w):document.createElement(w),ma(h,h),l){Ye&&wa(w)&&h.append(document.createComment(""));var f=Ye?ba(h):h.appendChild(_a());Ye&&(f===null?Wt(!1):xt(f)),l(h,f)}xa.nodes_end=h,I.before(h)}Ye&&xt(I)}),()=>{}},ga),ka(()=>{}),S&&(Wt(!0),xt(C))}function en(s){return function(...a){var t=a[0];return t.stopPropagation(),s?.apply(this,a)}}function tn(s,a){var t=s.$$events?.[a.type],l=Sa(t)?t.slice():t==null?[]:[t];for(var u of l)u.call(this,a)}const an=()=>{const s=Ta;return{page:{subscribe:s.page.subscribe},navigating:{subscribe:s.navigating.subscribe},updated:s.updated}},nn={subscribe(s){return an().page.subscribe(s)}},sn={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};function on(s,a=sn){return"geolocation"in navigator?navigator.geolocation.watchPosition(s.onPosition,s.onError,a):(s.onError({code:0,message:"Geolocation not supported",PERMISSION_DENIED:1,POSITION_UNAVAILABLE:2,TIMEOUT:3}),null)}function kt(s){navigator.geolocation.clearWatch(s)}function rn(s){switch(s.code){case s.PERMISSION_DENIED:return"Location access denied. Please enable location permissions.";case s.POSITION_UNAVAILABLE:return"Location unavailable. Please check your device settings.";case s.TIMEOUT:return"Location request timed out. Please try again.";default:return"An unknown location error occurred."}}function ln(s,a){const t=Xt(a,["children","$$slots","$$events","$$legacy"]),l=Xt(t,["as","gap","align","justify","wrap","className","style"]);ze(a,!1);const u=P(),i=P(),S=P(),h=P(),C={start:"flex-start",center:"center",end:"flex-end",stretch:"stretch",baseline:"baseline"},v={start:"flex-start",center:"center",end:"flex-end",between:"space-between",around:"space-around",evenly:"space-evenly"};let w=W(a,"as",8,"div"),N=W(a,"gap",8,"var(--space-4)"),I=W(a,"align",8,"stretch"),f=W(a,"justify",8,"start"),m=W(a,"wrap",8,!1),d=W(a,"className",8,""),x=W(a,"style",8,void 0);const k=(M,g)=>g in M?M[g]:g;Ne(()=>ie(I()),()=>{r(u,k(C,String(I())))}),Ne(()=>ie(f()),()=>{r(i,k(v,String(f())))}),Ne(()=>(ie(m()),ie(d()),ie(t)),()=>{r(S,["stack",m()?"stack--wrap":"",d(),t.class].filter(Boolean).join(" "))}),Ne(()=>(ie(x()),ie(t),ie(N()),e(u),e(i)),()=>{r(h,[x(),t.style,`--stack-gap:${N()}`,`--stack-align:${e(u)}`,`--stack-justify:${e(i)}`].filter(Boolean).join(";"))}),nt(),Re();var O=Ue(),D=Fe(O);Qa(D,w,!1,(M,g)=>{$a(M,()=>({...l,class:e(S),style:e(h)}),void 0,void 0,"svelte-h657km");var j=Ue(),H=Fe(j);Ja(H,a,"default",{}),b(g,j)}),b(s,O),Ve()}function aa(){return typeof window<"u"}function cn(s,a){let t;return l=>{t!==void 0&&clearTimeout(t),t=setTimeout(()=>{s(l),t=void 0},a)}}function vn(s,a,t){if(!aa())return a;const l=t??window.localStorage;try{const u=l.getItem(s);if(u){const i=JSON.parse(u);return typeof a=="object"&&a!==null&&!Array.isArray(a)?{...a,...i}:i}}catch(u){console.warn(`[PersistedStore] Failed to load "${s}":`,u)}return a}function Gt(s,a,t){if(!aa())return;const l=t??window.localStorage;try{l.setItem(s,JSON.stringify(a))}catch(u){console.warn(`[PersistedStore] Failed to save "${s}":`,u)}}function na(s){const{key:a,defaultValue:t,debounceMs:l=0,storage:u}=s,i=vn(a,t,u),{subscribe:S,set:h,update:C}=ta(i),v=l>0?cn(f=>Gt(a,f,u),l):f=>Gt(a,f,u);function w(f){h(f),v(f)}function N(f){C(m=>{const d=f(m);return v(d),d})}function I(){w(t)}return{subscribe:S,set:w,update:N,reset:I}}function dn(s){const{dbName:a,version:t=1,stores:l}=s;let u=null;function i(){return u||(u=new Promise((f,m)=>{const d=indexedDB.open(a,t);d.onerror=()=>{u=null,m(d.error)},d.onsuccess=()=>{f(d.result)},d.onupgradeneeded=x=>{const k=x.target.result;for(const O of l)k.objectStoreNames.contains(O)||k.createObjectStore(O)}}),u)}async function S(f,m){try{const d=await i();return new Promise((x,k)=>{const M=d.transaction(f,"readonly").objectStore(f).get(m);M.onerror=()=>k(M.error),M.onsuccess=()=>{const g=M.result;x(g||null)}})}catch(d){return console.error(`[IndexedDB] Error reading from ${f}:`,d),null}}async function h(f,m){const d=await S(f,m);return!d||Date.now()>d.expiresAt?null:d.data}async function C(f,m,d,x){try{const k=await i();return new Promise((O,D)=>{const g=k.transaction(f,"readwrite").objectStore(f),j={data:d,timestamp:Date.now(),expiresAt:Date.now()+x},H=g.put(j,m);H.onerror=()=>D(H.error),H.onsuccess=()=>O(!0)})}catch(k){return console.error(`[IndexedDB] Error writing to ${f}:`,k),!1}}async function v(f,m){try{const d=await i();return new Promise((x,k)=>{const M=d.transaction(f,"readwrite").objectStore(f).delete(m);M.onerror=()=>k(M.error),M.onsuccess=()=>x(!0)})}catch(d){return console.error(`[IndexedDB] Error deleting from ${f}:`,d),!1}}async function w(f){try{const m=await i();return new Promise((d,x)=>{const D=m.transaction(f,"readwrite").objectStore(f).clear();D.onerror=()=>x(D.error),D.onsuccess=()=>d(!0)})}catch(m){return console.error(`[IndexedDB] Error clearing ${f}:`,m),!1}}async function N(){for(const f of l)await w(f)}async function I(f){try{const m=await i();return new Promise(d=>{const O=m.transaction(f,"readonly").objectStore(f).count();O.onsuccess=()=>d(O.result),O.onerror=()=>d(0)})}catch{return 0}}return{openDB:i,get:S,getIfValid:h,set:C,remove:v,clear:w,clearAll:N,count:I}}const un="vma-trip-language-v1";function pn(){const s=na({key:un,defaultValue:"en"});return{subscribe:s.subscribe,setLanguage:a=>{s.set(a)},toggleLanguage:()=>{s.update(a=>a==="en"?"vi":"en")}}}const Pt=pn(),fn={welcome:{title:"Welcome to Historical Maps",message:"Choose your starting city to explore historical maps from different eras.",skipButton:"Skip for Now",cityIcon:"üìç"},mapSelector:{consultingAtlas:"Consulting Atlas...",mapCollection:"Map Collection",allRegions:"All Regions",searchPlaceholder:"Search by year or name",zoomButton:"üîç Zoom to Map",anno:"Anno",noMapsFound:"‚äò No maps discovered in this region",buttonOrnament:"‚ßâ"},location:{tracking:"Tracking",myLocation:"My Location"},mapHint:{icon:"üëÜ",title:"Explore Historical Maps",description:"Click here to browse our collection of vintage maps",button:"Got it!"},cityFilter:{icon:"üó∫Ô∏è",title:"Filter Map Collection?",message:"Would you like to filter the map collection to show only maps from",noShowAll:"No, Show All",yesFilter:"Yes, Filter"},cities:{hanoi:"Hanoi",hue:"Hue",hochiminh:"Ho Chi Minh City",danang:"Da Nang",haiphong:"Hai Phong",cantho:"Can Tho",nhatrang:"Nha Trang",dalat:"Da Lat",vungtau:"Vung Tau",quinhon:"Quy Nhon"},search:{search:"Search",searchLocation:"Search location",searchPlaceholder:"Enter location...",searching:"Searching..."},viewControls:{overlayOpacity:"Overlay Opacity",opacity:"Opacity",viewMode:"View Mode",overlay:"Overlay",sideX:"Side X",sideY:"Side Y",spyglass:"Spyglass"},loading:{preparingMap:"Preparing your map...",loadingCity:"Loading",findingMaps:"Finding historical maps...",almostReady:"Almost ready!"},common:{loading:"Loading...",error:"Error",close:"Close",cancel:"Cancel",confirm:"Confirm",save:"Save"}},gn={welcome:{title:"Ch√†o m·ª´ng ƒë·∫øn v·ªõi B·∫£n ƒë·ªì L·ªãch s·ª≠",message:"Ch·ªçn th√†nh ph·ªë b·∫Øt ƒë·∫ßu ƒë·ªÉ kh√°m ph√° b·∫£n ƒë·ªì l·ªãch s·ª≠ t·ª´ nhi·ªÅu th·ªùi k·ª≥ kh√°c nhau.",skipButton:"B·ªè qua",cityIcon:"üìç"},mapSelector:{consultingAtlas:"ƒêang t·∫£i b·∫£n ƒë·ªì...",mapCollection:"B·ªô s∆∞u t·∫≠p B·∫£n ƒë·ªì",allRegions:"T·∫•t c·∫£ V√πng",searchPlaceholder:"T√¨m ki·∫øm theo nƒÉm ho·∫∑c t√™n",zoomButton:"üîç Ph√≥ng to B·∫£n ƒë·ªì",anno:"NƒÉm",noMapsFound:"‚äò Kh√¥ng t√¨m th·∫•y b·∫£n ƒë·ªì trong khu v·ª±c n√†y",buttonOrnament:"‚ßâ"},location:{tracking:"ƒêang theo d√µi",myLocation:"V·ªã tr√≠ c·ªßa t√¥i"},mapHint:{icon:"üëÜ",title:"Kh√°m ph√° B·∫£n ƒë·ªì L·ªãch s·ª≠",description:"Nh·∫•n v√†o ƒë√¢y ƒë·ªÉ xem b·ªô s∆∞u t·∫≠p b·∫£n ƒë·ªì c·ªï c·ªßa ch√∫ng t√¥i",button:"ƒê√£ hi·ªÉu!"},cityFilter:{icon:"üó∫Ô∏è",title:"L·ªçc B·ªô s∆∞u t·∫≠p B·∫£n ƒë·ªì?",message:"B·∫°n c√≥ mu·ªën l·ªçc b·ªô s∆∞u t·∫≠p b·∫£n ƒë·ªì ƒë·ªÉ ch·ªâ hi·ªÉn th·ªã b·∫£n ƒë·ªì t·ª´",noShowAll:"Kh√¥ng, Hi·ªÉn th·ªã T·∫•t c·∫£",yesFilter:"C√≥, L·ªçc"},cities:{hanoi:"H√† N·ªôi",hue:"Hu·∫ø",hochiminh:"Th√†nh ph·ªë H·ªì Ch√≠ Minh",danang:"ƒê√† N·∫µng",haiphong:"H·∫£i Ph√≤ng",cantho:"C·∫ßn Th∆°",nhatrang:"Nha Trang",dalat:"ƒê√† L·∫°t",vungtau:"V≈©ng T√†u",quinhon:"Quy Nh∆°n"},search:{search:"T√¨m ki·∫øm",searchLocation:"T√¨m ki·∫øm v·ªã tr√≠",searchPlaceholder:"Nh·∫≠p v·ªã tr√≠...",searching:"ƒêang t√¨m..."},viewControls:{overlayOpacity:"ƒê·ªô trong su·ªët",opacity:"ƒê·ªô m·ªù",viewMode:"Ch·∫ø ƒë·ªô xem",overlay:"Ph·ªß",sideX:"Chia ngang",sideY:"Chia d·ªçc",spyglass:"K√≠nh l√∫p"},loading:{preparingMap:"ƒêang chu·∫©n b·ªã b·∫£n ƒë·ªì...",loadingCity:"ƒêang t·∫£i",findingMaps:"ƒêang t√¨m b·∫£n ƒë·ªì l·ªãch s·ª≠...",almostReady:"G·∫ßn ho√†n t·∫•t!"},common:{loading:"ƒêang t·∫£i...",error:"L·ªói",close:"ƒê√≥ng",cancel:"H·ªßy",confirm:"X√°c nh·∫≠n",save:"L∆∞u"}},hn={en:fn,vi:gn},Je=Za(Pt,s=>hn[s]);var yn=F('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>'),mn=F('<option class="svelte-1twr28"> </option>'),wn=F('<select class="city-select svelte-1twr28"><option class="svelte-1twr28"> </option><!></select>'),bn=F('<button class="map-item zoom svelte-1twr28"><span class="zoom-icon svelte-1twr28">üîç</span> <span> </span></button>'),_n=F('<div class="empty-state svelte-1twr28"><div class="empty-icon svelte-1twr28">‚äò</div> <p class="svelte-1twr28"> </p></div>'),xn=F('<div class="map-type svelte-1twr28"> </div>'),kn=F('<div class="map-year svelte-1twr28"> </div>'),Sn=F('<div class="selected-mark svelte-1twr28">‚úì</div>'),Cn=F('<button><div class="map-info svelte-1twr28"><div class="map-name svelte-1twr28"> </div> <!> <!></div> <!></button>'),Mn=F('<!> <input type="text" class="search-input svelte-1twr28"/> <div class="map-list svelte-1twr28"><!> <!></div>',1),Tn=F('<div class="selector-panel svelte-1twr28"><!></div>'),Ln=F('<div class="selector-container svelte-1twr28"><button class="selector-button svelte-1twr28"><span class="button-ornament svelte-1twr28"> </span> <span class="button-text svelte-1twr28"><!></span> <span>‚ñº</span></button> <!></div>');function $n(s,a){ze(a,!1);const t=()=>He(Je,"$t",l),[l,u]=Ke(),i=P(),S=P(),h=P();let C=W(a,"maps",24,()=>[]),v=W(a,"selected",8,null),w=W(a,"loading",8,!1),N=W(a,"filterCity",8,null),I=W(a,"initialOpen",8,!1);const f=Ze();let m=P(""),d=P("all"),x=P(I());function k(B){f("select",{mapId:B}),r(x,!1),r(m,"")}function O(){e(h)&&f("zoom",{mapId:e(h).id,bounds:e(h).bounds})}function D(){r(x,!e(x)),e(x)||r(m,"")}function M(B){const R=B.target;r(d,R.value)}Ne(()=>ie(N()),()=>{N()&&(r(d,N()),r(x,!0))}),Ne(()=>ie(C()),()=>{r(i,Array.from(new Set(C().map(B=>B.type).filter(Boolean))).sort())}),Ne(()=>(ie(C()),e(d),e(m)),()=>{r(S,C().filter(B=>{if(e(d)!=="all"&&B.type!==e(d))return!1;if(!e(m).trim())return!0;const R=e(m).toLowerCase();return B.name.toLowerCase().includes(R)||B.type.toLowerCase().includes(R)||B.summary?.toLowerCase().includes(R)}))}),Ne(()=>(ie(C()),ie(v())),()=>{r(h,C().find(B=>B.id===v()))}),nt(),Re();var g=Ln();Ge(B=>{var R=yn();b(B,R)});var j=o(g),H=o(j),te=o(H,!0);n(H);var le=c(H,2),me=o(le);{var ae=B=>{var R=lt();K(()=>E(R,(t(),_(()=>t().mapSelector.consultingAtlas)))),b(B,R)},ue=B=>{var R=Ue(),X=Fe(R);{var Z=ee=>{var oe=lt();K(()=>E(oe,(e(h),_(()=>e(h).name)))),b(ee,oe)},U=ee=>{var oe=lt();K(()=>E(oe,(t(),_(()=>t().mapSelector.mapCollection)))),b(ee,oe)};G(X,ee=>{e(h)?ee(Z):ee(U,!1)},!0)}b(B,R)};G(me,B=>{w()?B(ae):B(ue,!1)})}n(le);var ne=c(le,2);let pe;n(j);var xe=c(j,2);{var Ee=B=>{var R=Tn(),X=o(R);ln(X,{gap:"var(--space-2)",children:(Z,U)=>{var ee=Mn(),oe=Fe(ee);{var Se=he=>{var y=wn(),A=o(y),J=o(A,!0);n(A),A.value=A.__value="all";var q=c(A);dt(q,1,()=>e(i),ke=>ke,(ke,ce)=>{var Q=mn(),Te=o(Q,!0);n(Q);var Be={};K(()=>{E(Te,e(ce)),Be!==(Be=e(ce))&&(Q.value=(Q.__value=e(ce))??"")}),b(ke,Q)}),n(y);var be;Pa(y),K(()=>{E(J,(t(),_(()=>t().mapSelector.allRegions))),be!==(be=e(d))&&(y.value=(y.__value=e(d))??"",Aa(y,e(d)))}),z("change",y,M),b(he,y)};G(oe,he=>{e(i),_(()=>e(i).length>0)&&he(Se)})}var we=c(oe,2);vt(we);var re=c(we,2),se=o(re);{var fe=he=>{var y=bn(),A=c(o(y),2),J=o(A,!0);n(A),n(y),K(q=>E(J,q),[()=>(t(),_(()=>t().mapSelector.zoomButton.replace("üîç ","")))]),z("click",y,O),b(he,y)};G(se,he=>{ie(v()),e(h),_(()=>v()&&e(h)?.bounds)&&he(fe)})}var ge=c(se,2);{var Xe=he=>{var y=_n(),A=c(o(y),2),J=o(A,!0);n(A),n(y),K(q=>E(J,q),[()=>(t(),_(()=>t().mapSelector.noMapsFound.replace("‚äò ","")))]),b(he,y)},Qe=he=>{var y=Ue(),A=Fe(y);dt(A,1,()=>e(S),J=>J.id,(J,q)=>{var be=Cn();let ke;var ce=o(be),Q=o(ce),Te=o(Q,!0);n(Q);var Be=c(Q,2);{var ve=ye=>{var _e=xn(),Pe=o(_e,!0);n(_e),K(()=>E(Pe,(e(q),_(()=>e(q).type)))),b(ye,_e)};G(Be,ye=>{e(q),_(()=>e(q).type)&&ye(ve)})}var Oe=c(Be,2);{var Le=ye=>{var _e=kn(),Pe=o(_e);n(_e),K(()=>E(Pe,`${t(),_(()=>t().mapSelector.anno)??""} ${e(q),_(()=>e(q).year)??""}`)),b(ye,_e)};G(Oe,ye=>{e(q),_(()=>e(q).year)&&ye(Le)})}n(ce);var $e=c(ce,2);{var je=ye=>{var _e=Sn();b(ye,_e)};G($e,ye=>{e(q),ie(v()),_(()=>e(q).id===v())&&ye(je)})}n(be),K(()=>{ke=Me(be,1,"map-item svelte-1twr28",null,ke,{selected:e(q).id===v()}),E(Te,(e(q),_(()=>e(q).name)))}),z("click",be,()=>k(e(q).id)),b(J,be)}),b(he,y)};G(ge,he=>{e(S),_(()=>e(S).length===0)?he(Xe):he(Qe,!1)})}n(re),K(()=>De(we,"placeholder",(t(),_(()=>t().mapSelector.searchPlaceholder)))),ht(we,()=>e(m),he=>r(m,he)),b(Z,ee)},$$slots:{default:!0}}),n(R),b(B,R)};G(xe,B=>{e(x)&&B(Ee)})}n(g),K(()=>{j.disabled=w(),E(te,(t(),_(()=>t().mapSelector.buttonOrnament))),pe=Me(ne,1,"arrow svelte-1twr28",null,pe,{open:e(x)})}),z("click",j,D),b(s,g),Ve(),u()}function Pn(s,a){ze(a,!1);let t=W(a,"map",8),l=W(a,"position",8),u=W(a,"heading",8,0),i=W(a,"fieldOfView",8,60),S=W(a,"radius",8,200),h=null,C=P(null),v=null;function w(f,m,d,x){const k=d,O=(90-m)*Math.PI/180,D=x/2*Math.PI/180,M=[f],g=O-D,j=O+D,H=20;for(let te=0;te<=H;te++){const le=g+te/H*(j-g),me=f[0]+k*Math.cos(le),ae=f[1]+k*Math.sin(le);M.push([me,ae])}return M.push(f),new qa([M])}function N(){if(!l()||!t()){console.log("[DirectionCone] Cannot update: position or map missing",{position:!!l(),map:!!t()});return}const f=l().getGeometry();if(!f){console.log("[DirectionCone] Cannot update: position geometry missing");return}const m=f.getCoordinates();if(console.log("[DirectionCone] Updating cone:",{center:m,heading:u(),radius:S(),fieldOfView:i(),hasFeature:!!v,hasSource:!!e(C)}),v){const d=w(m,u(),S(),i());v.setGeometry(d),console.log("[DirectionCone] Updated cone geometry")}else{const d=w(m,u(),S(),i());v=new $t({geometry:d}),v.setId("direction-cone"),e(C)?.addFeature(v),console.log("[DirectionCone] Created new cone feature")}}function I(){return new Tt({fill:new Qt({color:"rgba(37, 99, 235, 0.3)"}),stroke:new Lt({color:"rgba(37, 99, 235, 0.8)",width:3})})}Jt(()=>{console.log("[DirectionCone] onMount called",{hasMap:!!t()}),t()&&(r(C,new Ct),h=new Mt({source:e(C),zIndex:24,style:I()}),t().addLayer(h),console.log("[DirectionCone] Layer added to map",{zIndex:24}),N())}),La(()=>{t()&&h&&t().removeLayer(h)}),Ne(()=>(ie(t()),ie(l()),ie(u()),e(C)),()=>{t()&&l()&&u()!==void 0&&(console.log("[DirectionCone] Reactive update triggered",{hasMap:!!t(),hasPosition:!!l(),heading:u(),hasDirectionSource:!!e(C)}),N())}),nt(),Re(),Ve()}var An=F('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>'),En=F('<div class="controls-container svelte-pwt3by"><div class="controls-panel svelte-pwt3by"><div class="control-group svelte-pwt3by"><div class="control-label svelte-pwt3by"><span class="label-icon svelte-pwt3by">‚ó´</span> <span class="label-text svelte-pwt3by"> </span></div> <div class="view-mode-buttons svelte-pwt3by"><button type="button"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-pwt3by"><rect x="3" y="3" width="18" height="18" rx="2"></rect></svg></button> <button type="button"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-pwt3by"><rect x="3" y="3" width="18" height="18" rx="2"></rect><line x1="12" y1="3" x2="12" y2="21"></line></svg></button> <button type="button"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-pwt3by"><rect x="3" y="3" width="18" height="18" rx="2"></rect><line x1="3" y1="12" x2="21" y2="12"></line></svg></button> <button type="button"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-pwt3by"><rect x="3" y="3" width="18" height="18" rx="2"></rect><circle cx="12" cy="12" r="5"></circle></svg></button></div></div> <div class="control-divider svelte-pwt3by"></div> <div class="control-group svelte-pwt3by"><div class="control-label svelte-pwt3by"><span class="label-icon svelte-pwt3by">‚óê</span> <span class="label-text svelte-pwt3by"> </span></div> <div class="slider-container svelte-pwt3by"><span class="slider-value svelte-pwt3by"> </span> <input type="range" min="0" max="1" step="0.05" class="opacity-slider svelte-pwt3by"/></div></div></div></div>');function On(s,a){ze(a,!1);const t=()=>He(Je,"$t",l),[l,u]=Ke();let i=W(a,"opacity",12,1),S=W(a,"viewMode",8,"overlay");const h=Ze();function C(B){const R=B.target,X=parseFloat(R.value);h("opacityChange",{opacity:X})}function v(B){h("viewModeChange",{viewMode:B})}Re();var w=En();Ge(B=>{var R=An();b(B,R)});var N=o(w),I=o(N),f=o(I),m=c(o(f),2),d=o(m,!0);n(m),n(f);var x=c(f,2),k=o(x);let O;var D=c(k,2);let M;var g=c(D,2);let j;var H=c(g,2);let te;n(x),n(I);var le=c(I,4),me=o(le),ae=c(o(me),2),ue=o(ae,!0);n(ae),n(me);var ne=c(me,2),pe=o(ne),xe=o(pe);n(pe);var Ee=c(pe,2);vt(Ee),n(ne),n(le),n(N),n(w),K(B=>{E(d,(t(),_(()=>t().viewControls.viewMode))),O=Me(k,1,"mode-button svelte-pwt3by",null,O,{selected:S()==="overlay"}),De(k,"title",(t(),_(()=>t().viewControls.overlay))),M=Me(D,1,"mode-button svelte-pwt3by",null,M,{selected:S()==="side-x"}),De(D,"title",(t(),_(()=>t().viewControls.sideX))),j=Me(g,1,"mode-button svelte-pwt3by",null,j,{selected:S()==="side-y"}),De(g,"title",(t(),_(()=>t().viewControls.sideY))),te=Me(H,1,"mode-button svelte-pwt3by",null,te,{selected:S()==="spy"}),De(H,"title",(t(),_(()=>t().viewControls.spyglass))),E(ue,(t(),_(()=>t().viewControls.opacity))),E(xe,`${B??""}%`)},[()=>(ie(i()),_(()=>Math.round(i()*100)))]),z("click",k,()=>v("overlay")),z("click",D,()=>v("side-x")),z("click",g,()=>v("side-y")),z("click",H,()=>v("spy")),ht(Ee,i),z("input",Ee,C),b(s,w),Ve(),u()}var jn=F('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet" class="svelte-1wnqptu"/>'),Nn=F('<div class="error-tooltip svelte-1wnqptu"> </div>'),Bn=F('<div class="location-button-container svelte-1wnqptu"><button><span class="icon svelte-1wnqptu"><!></span> <span class="label svelte-1wnqptu"> </span></button> <!></div>');function In(s,a){ze(a,!1);const t=()=>He(Je,"$t",l),[l,u]=Ke();let i=W(a,"isTracking",8,!1),S=W(a,"error",8,null);const h=Ze();function C(){i()?h("stop"):h("start")}Re();var v=Bn();Ge(M=>{var g=jn();b(M,g)});var w=o(v);let N;var I=o(w),f=o(I);{var m=M=>{var g=lt("‚óâ");b(M,g)},d=M=>{var g=lt("‚óé");b(M,g)};G(f,M=>{i()?M(m):M(d,!1)})}n(I);var x=c(I,2),k=o(x,!0);n(x),n(w);var O=c(w,2);{var D=M=>{var g=Nn(),j=o(g,!0);n(g),K(()=>E(j,S())),b(M,g)};G(O,M=>{S()&&M(D)})}n(v),K(()=>{N=Me(w,1,"location-button svelte-1wnqptu",null,N,{active:i(),error:!!S()}),De(w,"title",i()?"Stop location tracking":"Start location tracking"),E(k,(ie(i()),t(),_(()=>i()?t().location.tracking:t().location.myLocation)))}),z("click",w,C),b(s,v),Ve(),u()}var Fn=F('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>'),Dn=F('<span class="label svelte-td9aje"> </span>'),Rn=F('<div class="error-message svelte-td9aje"> </div>'),zn=F('<button class="result-item svelte-td9aje"><span class="result-icon svelte-td9aje">üìå</span> <div class="result-content svelte-td9aje"><div class="result-name svelte-td9aje"> </div> <div class="result-address svelte-td9aje"> </div></div></button>'),Vn=F('<div class="results-list svelte-td9aje"></div>'),Hn=F('<div class="search-panel svelte-td9aje"><div class="search-header svelte-td9aje"><span class="header-icon svelte-td9aje">üìç</span> <span class="header-text svelte-td9aje"> </span></div> <div class="search-input-container svelte-td9aje"><input type="text" class="search-input svelte-td9aje"/> <button class="search-button svelte-td9aje"> </button></div> <!> <!></div>'),qn=F('<div class="search-container svelte-td9aje"><button class="search-toggle svelte-td9aje"><span class="icon svelte-td9aje">‚åï</span> <!></button> <!></div>');function Yn(s,a){ze(a,!1);const t=()=>He(Je,"$t",l),[l,u]=Ke();let i=W(a,"isOpen",12,!1);const S=Ze();let h=P(""),C=P([]),v=P(!1),w=P(null);async function N(){if(e(h).trim()){r(v,!0),r(w,null);try{const g=await fetch("https://nominatim.openstreetmap.org/search?"+new URLSearchParams({q:e(h),format:"json",limit:"5",addressdetails:"1"}));if(!g.ok)throw new Error("Search failed");r(C,await g.json()),e(C).length===0&&r(w,"No locations found")}catch(g){console.error("[LocationSearch] Search error:",g),r(w,"Failed to search location"),r(C,[])}finally{r(v,!1)}}}function I(g){S("select",{lat:parseFloat(g.lat),lon:parseFloat(g.lon),name:g.display_name,address:g.address}),r(h,""),r(C,[]),i(!1)}function f(g){g.key==="Enter"&&N()}function m(){i(!i()),i()||(r(h,""),r(C,[]),r(w,null))}Ne(()=>ie(i()),()=>{i()||(r(h,""),r(C,[]),r(w,null))}),nt(),Re();var d=qn();Ge(g=>{var j=Fn();b(g,j)});var x=o(d),k=c(o(x),2);{var O=g=>{var j=Dn(),H=o(j,!0);n(j),K(()=>E(H,(t(),_(()=>t().search.search)))),b(g,j)};G(k,g=>{i()||g(O)})}n(x);var D=c(x,2);{var M=g=>{var j=Hn(),H=o(j),te=c(o(H),2),le=o(te,!0);n(te),n(H);var me=c(H,2),ae=o(me);vt(ae);var ue=c(ae,2),ne=o(ue,!0);n(ue),n(me);var pe=c(me,2);{var xe=R=>{var X=Rn(),Z=o(X,!0);n(X),K(()=>E(Z,e(w))),b(R,X)};G(pe,R=>{e(w)&&R(xe)})}var Ee=c(pe,2);{var B=R=>{var X=Vn();dt(X,5,()=>e(C),ea,(Z,U)=>{var ee=zn(),oe=c(o(ee),2),Se=o(oe),we=o(Se,!0);n(Se);var re=c(Se,2),se=o(re,!0);n(re),n(oe),n(ee),K(fe=>{E(we,fe),E(se,(e(U),_(()=>e(U).display_name)))},[()=>(e(U),_(()=>e(U).name||e(U).display_name.split(",")[0]))]),z("click",ee,()=>I(e(U))),b(Z,ee)}),n(X),b(R,X)};G(Ee,R=>{e(C),_(()=>e(C).length>0)&&R(B)})}n(j),K(R=>{E(le,(t(),_(()=>t().search.searchLocation))),De(ae,"placeholder",(t(),_(()=>t().search.searchPlaceholder))),ae.disabled=e(v),ue.disabled=R,E(ne,(e(v),t(),_(()=>e(v)?t().search.searching:t().search.search)))},[()=>(e(v),e(h),_(()=>e(v)||!e(h).trim()))]),ht(ae,()=>e(h),R=>r(h,R)),z("keydown",ae,f),z("click",ue,N),b(g,j)};G(D,g=>{i()&&g(M)})}n(d),K(()=>De(x,"title",(t(),_(()=>t().search.searchLocation)))),z("click",x,m),b(s,d),Ve(),u()}var Kn=F('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>'),Wn=F('<div class="dialog-overlay svelte-r8jync"><div class="dialog-container svelte-r8jync"><div class="dialog-icon svelte-r8jync"> </div> <div class="dialog-content svelte-r8jync"><h3 class="dialog-title svelte-r8jync"> </h3> <p class="dialog-message svelte-r8jync"> <strong class="svelte-r8jync"> </strong>?</p></div> <div class="dialog-actions svelte-r8jync"><button class="dialog-button secondary svelte-r8jync"> </button> <button class="dialog-button primary svelte-r8jync"> </button></div></div></div>');function Un(s,a){ze(a,!1);const t=()=>He(Je,"$t",l),[l,u]=Ke();let i=W(a,"cityName",8,""),S=W(a,"isOpen",8,!1);const h=Ze();function C(){h("confirm",{filter:!0})}function v(){h("confirm",{filter:!1})}function w(m){const d=m.toLowerCase().replace(/\s+/g,"");return t().cities[d]||m}Re();var N=Ue();Ge(m=>{var d=Kn();b(m,d)});var I=Fe(N);{var f=m=>{var d=Wn(),x=o(d),k=o(x),O=o(k,!0);n(k);var D=c(k,2),M=o(D),g=o(M,!0);n(M);var j=c(M,2),H=o(j),te=c(H),le=o(te,!0);n(te),Ca(),n(j),n(D);var me=c(D,2),ae=o(me),ue=o(ae,!0);n(ae);var ne=c(ae,2),pe=o(ne,!0);n(ne),n(me),n(x),n(d),K(xe=>{E(O,(t(),_(()=>t().cityFilter.icon))),E(g,(t(),_(()=>t().cityFilter.title))),E(H,`${t(),_(()=>t().cityFilter.message)??""} `),E(le,xe),E(ue,(t(),_(()=>t().cityFilter.noShowAll))),E(pe,(t(),_(()=>t().cityFilter.yesFilter)))},[()=>(ie(i()),_(()=>w(i())))]),z("click",ae,v),z("click",ne,C),z("click",x,en(function(xe){tn.call(this,a,xe)})),z("click",d,v),b(m,d)};G(I,m=>{S()&&m(f)})}b(s,N),Ve(),u()}var Xn=F('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>'),Gn=F('<span class="loading-spinner svelte-1vbp4hf">‚è≥</span> <span class="city-name svelte-1vbp4hf"> </span>',1),Zn=F('<span class="city-icon svelte-1vbp4hf"> </span> <span class="city-name svelte-1vbp4hf"> </span>',1),Jn=F("<button><!></button>"),Qn=F('<div class="dialog-overlay svelte-1vbp4hf"><div class="dialog-container svelte-1vbp4hf"><div class="dialog-header svelte-1vbp4hf"><div class="dialog-icon svelte-1vbp4hf">üó∫Ô∏è</div> <h2 class="dialog-title svelte-1vbp4hf"> </h2> <div class="language-toggle svelte-1vbp4hf"><button>EN</button> <span class="lang-separator svelte-1vbp4hf">|</span> <button>VI</button></div></div> <div class="dialog-content svelte-1vbp4hf"><p class="dialog-message svelte-1vbp4hf"> </p> <div class="city-grid svelte-1vbp4hf"></div></div> <div class="dialog-actions svelte-1vbp4hf"><button class="dialog-button secondary svelte-1vbp4hf"> </button></div></div></div>');function es(s,a){ze(a,!1);const t=()=>He(Je,"$t",u),l=()=>He(Pt,"$currentLanguage",u),[u,i]=Ke();let S=W(a,"isOpen",8,!1),h=W(a,"cities",24,()=>[]),C=W(a,"loadingCity",8,null);const v=Ze();function w(k){v("select",{city:k})}function N(){v("skip")}function I(k){Pt.setLanguage(k)}function f(k){const O=k.toLowerCase().replace(/\s+/g,"");return t().cities[O]||k}Re();var m=Ue();Ge(k=>{var O=Xn();b(k,O)});var d=Fe(m);{var x=k=>{var O=Qn(),D=o(O),M=o(D),g=c(o(M),2),j=o(g,!0);n(g);var H=c(g,2),te=o(H);let le;var me=c(te,4);let ae;n(H),n(M);var ue=c(M,2),ne=o(ue),pe=o(ne,!0);n(ne);var xe=c(ne,2);dt(xe,5,h,X=>X,(X,Z)=>{var U=Jn();let ee;var oe=o(U);{var Se=re=>{var se=Gn(),fe=c(Fe(se),2),ge=o(fe);n(fe),K(()=>E(ge,`${t(),_(()=>t().loading.loadingCity)??""}...`)),b(re,se)},we=re=>{var se=Zn(),fe=Fe(se),ge=o(fe,!0);n(fe);var Xe=c(fe,2),Qe=o(Xe,!0);n(Xe),K(he=>{E(ge,(t(),_(()=>t().welcome.cityIcon))),E(Qe,he)},[()=>(e(Z),_(()=>f(e(Z))))]),b(re,se)};G(oe,re=>{C()===e(Z)?re(Se):re(we,!1)})}n(U),K(()=>{ee=Me(U,1,"city-button svelte-1vbp4hf",null,ee,{loading:C()===e(Z),disabled:C()&&C()!==e(Z)}),U.disabled=!!C()}),z("click",U,()=>w(e(Z))),b(X,U)}),n(xe),n(ue);var Ee=c(ue,2),B=o(Ee),R=o(B,!0);n(B),n(Ee),n(D),n(O),K(()=>{E(j,(t(),_(()=>t().welcome.title))),le=Me(te,1,"lang-button svelte-1vbp4hf",null,le,{active:l()==="en"}),ae=Me(me,1,"lang-button svelte-1vbp4hf",null,ae,{active:l()==="vi"}),E(pe,(t(),_(()=>t().welcome.message))),B.disabled=!!C(),E(R,(t(),_(()=>t().welcome.skipButton)))}),z("click",te,()=>I("en")),z("click",me,()=>I("vi")),z("click",B,N),b(k,O)};G(d,k=>{S()&&k(x)})}b(s,m),Ve(),i()}var ts=F('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet" class="svelte-1lpq58w"/>'),as=F('<div class="hint-overlay svelte-1lpq58w"><div class="spotlight svelte-1lpq58w"></div></div> <div class="hint-popup svelte-1lpq58w"><div class="hint-content svelte-1lpq58w"><div class="hint-icon svelte-1lpq58w"> </div> <div class="hint-text svelte-1lpq58w"><div class="hint-title svelte-1lpq58w"> </div> <div class="hint-description svelte-1lpq58w"> </div></div></div> <button class="hint-dismiss svelte-1lpq58w"> </button></div>',1);function ns(s,a){ze(a,!1);const t=()=>He(Je,"$t",l),[l,u]=Ke();let i=W(a,"isVisible",8,!1);const S=Ze();function h(){S("dismiss")}Re();var C=Ue();Ge(N=>{var I=ts();b(N,I)});var v=Fe(C);{var w=N=>{var I=as(),f=Fe(I),m=c(f,2),d=o(m),x=o(d),k=o(x,!0);n(x);var O=c(x,2),D=o(O),M=o(D,!0);n(D);var g=c(D,2),j=o(g,!0);n(g),n(O),n(d);var H=c(d,2),te=o(H,!0);n(H),n(m),K(()=>{E(k,(t(),_(()=>t().mapHint.icon))),E(M,(t(),_(()=>t().mapHint.title))),E(j,(t(),_(()=>t().mapHint.description))),E(te,(t(),_(()=>t().mapHint.button)))}),z("click",f,h),z("click",H,h),b(N,I)};G(v,N=>{i()&&N(w)})}b(s,C),Ve(),u()}var ss=F('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet" class="svelte-ua832v"/>'),os=rt('<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="svelte-ua832v"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" stroke="#6b5d52" stroke-width="1.5" fill="#d4af37" stroke-linejoin="round" class="svelte-ua832v"></path></svg>'),rs=rt('<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="svelte-ua832v"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" stroke="#6b5d52" stroke-width="1.5" fill="none" stroke-linejoin="round" class="svelte-ua832v"></path></svg>'),is=rt('<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#6b5d52" stroke-width="1.5" class="svelte-ua832v"><rect x="3" y="3" width="18" height="18" rx="2" class="svelte-ua832v"></rect></svg>'),ls=rt('<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#6b5d52" stroke-width="1.5" class="svelte-ua832v"><rect x="3" y="3" width="18" height="18" rx="2" class="svelte-ua832v"></rect><line x1="12" y1="3" x2="12" y2="21" class="svelte-ua832v"></line></svg>'),cs=rt('<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#6b5d52" stroke-width="1.5" class="svelte-ua832v"><rect x="3" y="3" width="18" height="18" rx="2" class="svelte-ua832v"></rect><line x1="3" y1="12" x2="21" y2="12" class="svelte-ua832v"></line></svg>'),vs=rt('<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#6b5d52" stroke-width="1.5" class="svelte-ua832v"><rect x="3" y="3" width="18" height="18" rx="2" class="svelte-ua832v"></rect><circle cx="12" cy="12" r="5" class="svelte-ua832v"></circle></svg>'),ds=F('<button title="View mode"><span class="btn-icon svelte-ua832v"><!></span></button>'),us=F('<button title="Adjust opacity"><span class="btn-icon svelte-ua832v">‚óê</span></button>'),ps=F('<div class="expansion-panel view-mode-panel svelte-ua832v"><div class="panel-header svelte-ua832v"><span class="header-icon svelte-ua832v">‚ó´</span> <span class="header-text svelte-ua832v"> </span></div> <div class="view-mode-grid svelte-ua832v"><button><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="svelte-ua832v"><rect x="3" y="3" width="18" height="18" rx="2" class="svelte-ua832v"></rect></svg> <span class="svelte-ua832v"> </span></button> <button><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="svelte-ua832v"><rect x="3" y="3" width="18" height="18" rx="2" class="svelte-ua832v"></rect><line x1="12" y1="3" x2="12" y2="21" class="svelte-ua832v"></line></svg> <span class="svelte-ua832v"> </span></button> <button><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="svelte-ua832v"><rect x="3" y="3" width="18" height="18" rx="2" class="svelte-ua832v"></rect><line x1="3" y1="12" x2="21" y2="12" class="svelte-ua832v"></line></svg> <span class="svelte-ua832v"> </span></button> <button><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="svelte-ua832v"><rect x="3" y="3" width="18" height="18" rx="2" class="svelte-ua832v"></rect><circle cx="12" cy="12" r="5" class="svelte-ua832v"></circle></svg> <span class="svelte-ua832v"> </span></button></div></div>'),fs=F('<div class="expansion-panel opacity-panel svelte-ua832v"><div class="panel-content svelte-ua832v"><span class="panel-label svelte-ua832v"> </span> <input type="range" min="0" max="1" step="0.05" class="opacity-slider svelte-ua832v"/> <span class="panel-value svelte-ua832v"> </span></div></div>'),gs=F('<div class="search-error svelte-ua832v"> </div>'),hs=F('<button class="result-item svelte-ua832v"><span class="result-icon svelte-ua832v">üìå</span> <div class="result-content svelte-ua832v"><div class="result-name svelte-ua832v"> </div> <div class="result-address svelte-ua832v"> </div></div></button>'),ys=F('<div class="search-results svelte-ua832v"></div>'),ms=F('<div class="expansion-panel search-panel svelte-ua832v"><div class="search-header svelte-ua832v"><span class="header-icon svelte-ua832v">üìç</span> <span class="header-text svelte-ua832v">Search Location</span></div> <div class="search-input-wrapper svelte-ua832v"><input type="text" class="search-input svelte-ua832v" placeholder="Enter city, address..."/> <button class="search-btn svelte-ua832v"> </button></div> <!> <!></div>'),ws=F('<div class="error-badge svelte-ua832v"> </div>'),bs=F('<div class="mobile-controls svelte-ua832v"><div class="control-bar svelte-ua832v"><button><span class="btn-icon svelte-ua832v"><!></span></button> <button title="Search location"><span class="btn-icon svelte-ua832v"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="svelte-ua832v"><circle cx="11" cy="11" r="7" stroke="#6b5d52" stroke-width="1.5" class="svelte-ua832v"></circle><path d="M16 16L21 21" stroke="#6b5d52" stroke-width="1.5" stroke-linecap="round" class="svelte-ua832v"></path></svg></span></button> <!> <!></div> <!> <!> <!> <!></div>');function _s(s,a){ze(a,!1);const t=()=>He(Je,"$t",l),[l,u]=Ke();let i=W(a,"isTracking",8,!1),S=W(a,"error",8,null),h=W(a,"opacity",8,1),C=W(a,"hasMapSelected",8,!1),v=W(a,"searchOpen",8,!1),w=W(a,"viewMode",8,"overlay");const N=Ze();let I=P(!1),f=P(!1),m=P(""),d=P([]),x=P(!1),k=P(null);function O(){r(I,!e(I)),e(I)&&r(f,!1)}function D(){r(f,!e(f)),e(f)&&r(I,!1)}function M(y){N("viewModeChange",{viewMode:y}),r(f,!1)}function g(){N("toggleSearch")}async function j(){if(e(m).trim()){r(x,!0),r(k,null);try{const y=await fetch("https://nominatim.openstreetmap.org/search?"+new URLSearchParams({q:e(m),format:"json",limit:"5",addressdetails:"1"}));if(!y.ok)throw new Error("Search failed");r(d,await y.json()),e(d).length===0&&r(k,"No locations found")}catch(y){console.error("[MobileControls] Search error:",y),r(k,"Failed to search location"),r(d,[])}finally{r(x,!1)}}}function H(y){N("locationSelect",{lat:parseFloat(y.lat),lon:parseFloat(y.lon),name:y.display_name,address:y.address}),r(m,""),r(d,[]),N("toggleSearch")}function te(y){y.key==="Enter"&&j()}function le(){i()?N("stopTracking"):N("startTracking")}function me(y){const A=y.target;N("opacityChange",{opacity:parseFloat(A.value)})}Ne(()=>ie(v()),()=>{v()||(r(m,""),r(d,[]),r(k,null))}),nt(),Re();var ae=bs();Ge(y=>{var A=ss();b(y,A)});var ue=o(ae),ne=o(ue);let pe;var xe=o(ne),Ee=o(xe);{var B=y=>{var A=os();b(y,A)},R=y=>{var A=rs();b(y,A)};G(Ee,y=>{i()?y(B):y(R,!1)})}n(xe),n(ne);var X=c(ne,2);let Z;var U=c(X,2);{var ee=y=>{var A=ds();let J;var q=o(A),be=o(q);{var ke=Q=>{var Te=is();b(Q,Te)},ce=Q=>{var Te=Ue(),Be=Fe(Te);{var ve=Le=>{var $e=ls();b(Le,$e)},Oe=Le=>{var $e=Ue(),je=Fe($e);{var ye=Pe=>{var Ie=cs();b(Pe,Ie)},_e=Pe=>{var Ie=vs();b(Pe,Ie)};G(je,Pe=>{w()==="side-y"?Pe(ye):Pe(_e,!1)},!0)}b(Le,$e)};G(Be,Le=>{w()==="side-x"?Le(ve):Le(Oe,!1)},!0)}b(Q,Te)};G(be,Q=>{w()==="overlay"?Q(ke):Q(ce,!1)})}n(q),n(A),K(()=>J=Me(A,1,"control-btn svelte-ua832v",null,J,{active:e(f)})),z("click",A,D),b(y,A)};G(U,y=>{C()&&y(ee)})}var oe=c(U,2);{var Se=y=>{var A=us();let J;K(()=>J=Me(A,1,"control-btn svelte-ua832v",null,J,{active:e(I)})),z("click",A,O),b(y,A)};G(oe,y=>{C()&&y(Se)})}n(ue);var we=c(ue,2);{var re=y=>{var A=ps(),J=o(A),q=c(o(J),2),be=o(q,!0);n(q),n(J);var ke=c(J,2),ce=o(ke);let Q;var Te=c(o(ce),2),Be=o(Te,!0);n(Te),n(ce);var ve=c(ce,2);let Oe;var Le=c(o(ve),2),$e=o(Le,!0);n(Le),n(ve);var je=c(ve,2);let ye;var _e=c(o(je),2),Pe=o(_e,!0);n(_e),n(je);var Ie=c(je,2);let et;var tt=c(o(Ie),2),yt=o(tt,!0);n(tt),n(Ie),n(ke),n(A),K(()=>{E(be,(t(),_(()=>t().viewControls.viewMode))),Q=Me(ce,1,"view-mode-btn svelte-ua832v",null,Q,{selected:w()==="overlay"}),E(Be,(t(),_(()=>t().viewControls.overlay))),Oe=Me(ve,1,"view-mode-btn svelte-ua832v",null,Oe,{selected:w()==="side-x"}),E($e,(t(),_(()=>t().viewControls.sideX))),ye=Me(je,1,"view-mode-btn svelte-ua832v",null,ye,{selected:w()==="side-y"}),E(Pe,(t(),_(()=>t().viewControls.sideY))),et=Me(Ie,1,"view-mode-btn svelte-ua832v",null,et,{selected:w()==="spy"}),E(yt,(t(),_(()=>t().viewControls.spyglass)))}),z("click",ce,()=>M("overlay")),z("click",ve,()=>M("side-x")),z("click",je,()=>M("side-y")),z("click",Ie,()=>M("spy")),b(y,A)};G(we,y=>{e(f)&&C()&&y(re)})}var se=c(we,2);{var fe=y=>{var A=fs(),J=o(A),q=o(J),be=o(q,!0);n(q);var ke=c(q,2);vt(ke);var ce=c(ke,2),Q=o(ce);n(ce),n(J),n(A),K(Te=>{E(be,(t(),_(()=>t().viewControls.opacity))),Ea(ke,h()),E(Q,`${Te??""}%`)},[()=>(ie(h()),_(()=>Math.round(h()*100)))]),z("input",ke,me),b(y,A)};G(se,y=>{e(I)&&C()&&y(fe)})}var ge=c(se,2);{var Xe=y=>{var A=ms(),J=c(o(A),2),q=o(J);vt(q);var be=c(q,2),ke=o(be,!0);n(be),n(J);var ce=c(J,2);{var Q=ve=>{var Oe=gs(),Le=o(Oe,!0);n(Oe),K(()=>E(Le,e(k))),b(ve,Oe)};G(ce,ve=>{e(k)&&ve(Q)})}var Te=c(ce,2);{var Be=ve=>{var Oe=ys();dt(Oe,5,()=>e(d),ea,(Le,$e)=>{var je=hs(),ye=c(o(je),2),_e=o(ye),Pe=o(_e,!0);n(_e);var Ie=c(_e,2),et=o(Ie,!0);n(Ie),n(ye),n(je),K(tt=>{E(Pe,tt),E(et,(e($e),_(()=>e($e).display_name)))},[()=>(e($e),_(()=>e($e).name||e($e).display_name.split(",")[0]))]),z("click",je,()=>H(e($e))),b(Le,je)}),n(Oe),b(ve,Oe)};G(Te,ve=>{e(d),_(()=>e(d).length>0)&&ve(Be)})}n(A),K(ve=>{q.disabled=e(x),be.disabled=ve,E(ke,e(x)?"...":"üîç")},[()=>(e(x),e(m),_(()=>e(x)||!e(m).trim()))]),ht(q,()=>e(m),ve=>r(m,ve)),z("keydown",q,te),z("click",be,j),b(y,A)};G(ge,y=>{v()&&y(Xe)})}var Qe=c(ge,2);{var he=y=>{var A=ws(),J=o(A,!0);n(A),K(()=>E(J,S())),b(y,A)};G(Qe,y=>{S()&&y(he)})}n(ae),K(()=>{pe=Me(ne,1,"control-btn svelte-ua832v",null,pe,{active:i()}),De(ne,"title",i()?"Stop tracking":"Start tracking"),Z=Me(X,1,"control-btn svelte-ua832v",null,Z,{active:v()})}),z("click",ne,le),z("click",X,g),b(s,ae),Ve(),u()}const xs="vma-trip-preferences-v1",ks={hasSeenWelcome:!1,hasCompletedTutorial:!1,hasSeenMapHint:!1,autoStartLocation:!1,lastKnownPosition:null};function Ss(){const s=na({key:xs,defaultValue:ks,debounceMs:100});return{subscribe:s.subscribe,setHasSeenWelcome:a=>{s.update(t=>({...t,hasSeenWelcome:a}))},setHasCompletedTutorial:a=>{s.update(t=>({...t,hasCompletedTutorial:a}))},setHasSeenMapHint:a=>{s.update(t=>({...t,hasSeenMapHint:a}))},setAutoStartLocation:a=>{s.update(t=>({...t,autoStartLocation:a}))},setLastKnownPosition:a=>{s.update(t=>({...t,lastKnownPosition:a}))},reset:()=>{s.reset()}}}const Zt={currentYear:new Date().getFullYear(),availableYears:[],activeMapId:null,isTransitioning:!1};function Cs(){const{subscribe:s,set:a,update:t}=ta(Zt);return{subscribe:s,setCurrentYear:l=>{t(u=>({...u,currentYear:l}))},setAvailableYears:l=>{t(u=>{const i=[...l].sort((h,C)=>h-C),S=i.length>0?Math.max(...i):u.currentYear;return{...u,availableYears:i,currentYear:S}})},setActiveMap:l=>{t(u=>({...u,activeMapId:l}))},setIsTransitioning:l=>{t(u=>({...u,isTransitioning:l}))},reset:()=>{a(Zt)}}}const Ms=Symbol("trip-context");function Ts(s){Ma(Ms,s)}const ot=new Map;async function Ls(s){if(ot.has(s))return ot.get(s)||null;try{const a=await fetch(`https://annotations.allmaps.org/images/${s}`);if(!a.ok)return console.warn(`Failed to fetch annotation for ${s}: ${a.status}`),ot.set(s,null),null;const t=await a.json(),l=$s(t);if(!l||l.length===0)return ot.set(s,null),null;const u=l.map(h=>h.world[0]),i=l.map(h=>h.world[1]),S=[Math.min(...u),Math.min(...i),Math.max(...u),Math.max(...i)];return ot.set(s,S),S}catch(a){return console.error(`Error fetching bounds for ${s}:`,a),ot.set(s,null),null}}function $s(s){if(!s||typeof s!="object")return[];const a=s;if(a.body&&typeof a.body=="object"){const t=a.body;if(t.features&&Array.isArray(t.features)){const l=[];for(const u of t.features)if(u&&typeof u=="object"&&"geometry"in u&&u.geometry&&typeof u.geometry=="object"){const i=u.geometry;if(i.coordinates&&Array.isArray(i.coordinates)){const S=i.coordinates;S.length>=2&&typeof S[0]=="number"&&typeof S[1]=="number"&&l.push({world:[S[0],S[1]]})}}if(l.length>0)return l}if(t.transformation&&typeof t.transformation=="object"){const l=t.transformation;if(l.gcps&&Array.isArray(l.gcps))return l.gcps.filter(u=>u!==null&&typeof u=="object").filter(u=>{const i=u.world;return Array.isArray(i)&&i.length>=2}).map(u=>{const i=u.world;return{world:[i[0],i[1]]}})}}return a.gcps&&Array.isArray(a.gcps)?a.gcps.filter(t=>t!==null&&typeof t=="object").filter(t=>{const l=t.world;return Array.isArray(l)&&l.length>=2}).map(t=>{const l=t.world;return{world:[l[0],l[1]]}}):[]}async function Ps(s,a=5){const t=new Map;for(let l=0;l<s.length;l+=a){const i=s.slice(l,l+a).map(async S=>{const h=await Ls(S);t.set(S,h)});await Promise.all(i)}return t}let At=null,ct=null;function As(s){if(typeof window>"u"||!window.DeviceOrientationEvent)return console.warn("DeviceOrientation API not supported"),null;At=s;let a=0;const t=100;return ct=l=>{const u=Date.now();if(u-a<t||(a=u,l.alpha===null||l.beta===null||l.gamma===null))return;const i={alpha:l.alpha,beta:l.beta,gamma:l.gamma};At?.(i)},window.addEventListener("deviceorientation",ct,!0),()=>{sa()}}function sa(){ct&&(window.removeEventListener("deviceorientation",ct,!0),ct=null),At=null}async function Es(){if(!("serviceWorker"in navigator))return console.warn("[ServiceWorker] Not supported in this browser"),null;try{const s=await navigator.serviceWorker.register("/sw.js",{scope:"/"});return console.log("[ServiceWorker] Registered successfully:",s.scope),s.addEventListener("updatefound",()=>{const a=s.installing;a&&a.addEventListener("statechange",()=>{a.state==="activated"&&console.log("[ServiceWorker] Updated and activated")})}),s}catch(s){return console.error("[ServiceWorker] Registration failed:",s),null}}const Os="allmaps-cache",Et="catalog",js="annotations",Ns=1440*60*1e3,oa=dn({dbName:Os,version:1,stores:[Et,js]});async function Bs(s){await oa.set(Et,"maps",s,Ns),console.log("[MapCache] Cached map catalog:",s.length,"maps")}async function Is(){const s=await oa.getIfValid(Et,"maps");return s?(console.log("[MapCache] Using cached catalog:",s.length,"maps"),s):(console.log("[MapCache] Catalog cache miss or expired"),null)}var Fs=F('<div class="trip-container svelte-1id9u82"><div class="map svelte-1id9u82"></div> <div class="divider divider-x svelte-1id9u82"></div> <div class="divider-handle divider-handle-x svelte-1id9u82" role="slider" aria-label="Adjust horizontal split" tabindex="0"></div> <div class="divider divider-y svelte-1id9u82"></div> <div class="divider-handle divider-handle-y svelte-1id9u82" role="slider" aria-label="Adjust vertical split" tabindex="0"></div> <div class="lens svelte-1id9u82"></div> <div class="lens-handle svelte-1id9u82" role="slider" aria-label="Adjust lens size" tabindex="0"></div> <!> <!> <!> <!> <!> <!> <!> <!> <!></div>');function Ds(s,a){ze(a,!1);const t=()=>He(le,"$tripState",l),[l,u]=Ke(),i=P();let S=W(a,"initialMapId",8,null),h=W(a,"initialCity",8,null),C=P(),v=P(null),w=null,N=null,I=null,f=null,m=null,d=P("inactive"),x=null,k=null,O=P(null),D=[],M=P(null),g=P(null),j=P([]),H=P(!1),te=P(null);const le=Ss(),me=Cs();Ts({preferences:le,timeline:me});let ae=P(0),ue=P(!1),ne=P(null),pe=null,xe=P(!1),Ee=P(null),B=P(!1),R=P(!1),X=P(.8),Z=P("overlay"),U=P(.5),ee=P(150),oe=P(),Se=P(),we=P(),re=P(),se=P(),fe=P(),ge=P({sideX:!1,sideY:!1,lensR:!1});function Xe(p){return new Tt({stroke:new Lt({color:"#ea580c",width:4,lineCap:"round",lineJoin:"round"})})}function Qe(p){return new Tt({image:new Va({radius:8,fill:new Qt({color:"#ffffff"}),stroke:new Lt({color:"#ea580c",width:3})})})}Jt(()=>{const p=new Ya({source:new Ka({urls:["https://mt0.google.com/vt/lyrs=y&x={x}&y={y}&z={z}","https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}","https://mt2.google.com/vt/lyrs=y&x={x}&y={y}&z={z}","https://mt3.google.com/vt/lyrs=y&x={x}&y={y}&z={z}"],attributions:"Tiles ¬© Google",maxZoom:22,crossOrigin:"anonymous"}),zIndex:0});w=new Oa,w.setZIndex(10),I=new Ct,N=new Mt({source:I,zIndex:20,style:Xe}),m=new Ct,f=new Mt({source:m,zIndex:25,style:Qe});const T=t().lastKnownPosition;return r(v,new ja({target:e(C),layers:[p,N,f],view:new Wa({center:T?st([T.lon,T.lat]):Ua,zoom:16,enableRotation:!0}),interactions:Ba().extend([new Ra({condition:za})]),controls:Na({attribution:!1,rotate:!1,zoom:!1}).extend([new Ia,new Fa,new Da])})),w.setMap?.(e(v)),e(v).on("change:size",()=>{Q()}),(async()=>{Es().then(L=>{L&&console.log("[TripTracker] Service worker registered for map caching")}),await he(),h()&&(r(te,h()),tt(h())),S()?y(S()):h()||r(xe,!0);const $=e(j).map(L=>L.id);Ps($,5).then(L=>{r(j,e(j).map(Y=>{const Ce=L.get(Y.id);return Ce?{...Y,bounds:Ce}:Y}))})})(),As($=>{console.log("[TripTracker] Orientation update:",$),r(ae,$.alpha)}),()=>{x!==null&&kt(x),sa(),e(v)?.dispose()}});async function he(){try{const p=await Is();if(p){r(j,p),console.log("[TripTracker] Loaded map catalog from cache");return}const T=await fetch(Xa);if(!T.ok)throw new Error(`HTTP ${T.status}`);const $=(await T.text()).trim().split(/\r?\n/),L=$.shift()?.split(",").map(Ce=>Ce.trim().toLowerCase())||[],Y=[];for(const Ce of $){if(!Ce.trim())continue;const qe=[],it=Ce.matchAll(/(".*?"|[^",\r\n]+)(?=\s*,|\s*$)/g);for(const We of it)qe.push(We[1].replace(/^"|"$/g,"").trim());const Ae={};L.forEach((We,ua)=>{Ae[We]=qe[ua]||""});const wt=L.find(We=>We==="id"),bt=L.find(We=>We==="name"),Yt=L.find(We=>We==="type");if(!wt||!bt||!Ae[wt]||!Ae[bt])continue;const Kt=parseInt(Ae.year,10),da={id:Ae[wt],name:Ae[bt],type:Yt&&Ae[Yt]||"",summary:Ae.summary||void 0,description:Ae.description||Ae.details||Ae.detail||void 0,thumbnail:Ae.thumbnail||Ae.image||void 0,isFeatured:Ae.featured==="TRUE"||Ae.is_featured==="TRUE",year:isNaN(Kt)?void 0:Kt};Y.push(da)}r(j,Y),await Bs(Y),console.log("[TripTracker] Cached map catalog")}catch(p){console.error("Failed to load map catalog:",p),r(j,[])}}async function y(p){if(!(!e(v)||!w)){r(H,!0);try{w.clear();const T=`https://annotations.allmaps.org/images/${p}`;await w.addGeoreferenceAnnotationByUrl(T),A(),r(g,p)}catch(T){console.error("Failed to load map overlay:",T),r(M,"Could not load historical map"),r(g,null)}finally{r(H,!1)}}}function A(){if(!e(v)||!w){console.log("[TripTracker] No map or warped layer available");return}const p=w;p.setOpacity&&(console.log(`[TripTracker] Setting opacity directly on WarpedMapLayer to ${e(X)}`),p.setOpacity(e(X)));const T=e(v).getLayers().getArray();console.log(`[TripTracker] Total map layers: ${T.length}`);let V=0;T.forEach(($,L)=>{const Y=$.getZIndex(),Ce=$.constructor.name;console.log(`[TripTracker] Layer ${L}: type=${Ce}, zIndex=${Y}`),Y!==0&&Y!==20&&Y!==25&&Y!==void 0&&(console.log(`[TripTracker] Applying opacity ${e(X)} to layer ${L} (${Ce})`),$.setOpacity&&$.setOpacity(e(X)),V++)}),console.log(`[TripTracker] Applied opacity to ${V} warped layers`),e(v).render()}function J(){w&&w.clear(),r(g,null)}function q(){return w?.getCanvas()??null}function be(){const p=q();if(!p||!e(v))return;const T=e(v).getSize();if(!T)return;const[V,$]=T;if(e(Z)==="overlay")p.style.clipPath="";else if(e(Z)==="side-x"){const L=V*e(U);p.style.clipPath=`polygon(${L}px 0, ${V}px 0, ${V}px ${$}px, ${L}px ${$}px)`}else if(e(Z)==="side-y"){const L=$*e(U);p.style.clipPath=`polygon(0 ${L}px, ${V}px ${L}px, ${V}px ${$}px, 0 ${$}px)`}else if(e(Z)==="spy"){const L=e(ee);p.style.clipPath=`circle(${L}px at ${V/2}px ${$/2}px)`}}function ke(){if(!e(v))return;const p=e(v).getSize();if(!p)return;const[T,V]=p,$=e(Z)==="side-x",L=e(Z)==="side-y";if(e(oe)&&(de(oe,e(oe).style.display=$?"block":"none"),$)){const Y=T*e(U);de(oe,e(oe).style.left=`${Y}px`),de(oe,e(oe).style.height=`${V}px`)}if(e(we)&&(de(we,e(we).style.display=$?"block":"none"),$)){const Y=T*e(U)-8;de(we,e(we).style.left=`${Y}px`),de(we,e(we).style.top=`${V/2-8}px`)}if(e(Se)&&(de(Se,e(Se).style.display=L?"block":"none"),L)){const Y=V*e(U);de(Se,e(Se).style.top=`${Y}px`),de(Se,e(Se).style.width=`${T}px`)}if(e(re)&&(de(re,e(re).style.display=L?"block":"none"),L)){const Y=V*e(U)-8;de(re,e(re).style.left=`${T/2-8}px`),de(re,e(re).style.top=`${Y}px`)}}function ce(){if(!e(v))return;const p=e(v).getSize();if(!p)return;const[T,V]=p,$=e(Z)==="spy";if(e(se)&&(de(se,e(se).style.display=$?"block":"none"),$)){const L=Math.max(20,e(ee)*2);de(se,e(se).style.width=`${L}px`),de(se,e(se).style.height=`${L}px`),de(se,e(se).style.left=`${T/2-e(ee)}px`),de(se,e(se).style.top=`${V/2-e(ee)}px`)}e(fe)&&(de(fe,e(fe).style.display=$?"block":"none"),$&&(de(fe,e(fe).style.left=`${T/2+e(ee)-8}px`),de(fe,e(fe).style.top=`${V/2-8}px`)))}function Q(){be(),ke(),ce()}function Te(p){r(Z,p),Q()}function Be(p){Te(p.detail.viewMode)}function ve(p){if(!e(v)||!e(ge).sideX&&!e(ge).sideY&&!e(ge).lensR)return;const T=e(C).getBoundingClientRect(),V=p.clientX-T.left,$=p.clientY-T.top,L=e(v).getSize();if(!L)return;const[Y,Ce]=L;if(e(ge).sideX)r(U,Math.max(.1,Math.min(.9,V/Y))),Q();else if(e(ge).sideY)r(U,Math.max(.1,Math.min(.9,$/Ce))),Q();else if(e(ge).lensR){const qe=Y/2,it=Ce/2,Ae=Math.sqrt((V-qe)**2+($-it)**2);r(ee,Math.max(50,Math.min(Math.min(Y,Ce)/2-20,Ae))),Q()}}function Oe(){r(ge,{sideX:!1,sideY:!1,lensR:!1})}async function Le(p){const{longitude:T,latitude:V}=p.coords,$=st([T,V]);if(le.setLastKnownPosition({lat:V,lon:T}),D=[...D,$],!k)k=new $t({geometry:new Ha(D)}),k.setId("current-track"),I?.addFeature(k);else{const L=k.getGeometry();L&&L.setCoordinates(D)}if(!e(O))r(O,new $t({geometry:new Ga($)})),e(O).setId("current-position"),m?.addFeature(e(O));else{const L=e(O).getGeometry();L&&L.setCoordinates($)}e(v)&&e(v).getView().animate({center:$,duration:300})}function $e(p){const T=p.detail.mapId;T?y(T):J()}function je(p){const{bounds:T}=p.detail;if(!e(v)||!T||T.length!==4){console.warn("[TripTracker] Cannot zoom: missing map or bounds");return}const[V,$,L,Y]=T,Ce=st([V,$]),qe=st([L,Y]),it=[Ce[0],Ce[1],qe[0],qe[1]];e(v).getView().fit(it,{padding:[50,50,50,50],duration:1e3}),console.log("[TripTracker] Zoomed to map bounds:",T)}function ye(p){r(X,p.detail.opacity),console.log("[TripTracker] Opacity changed to:",e(X))}function _e(){e(d)==="inactive"&&(D=[],k=null,r(O,null),I?.clear(),m?.clear(),r(M,null),x=on({onPosition:Le,onError:p=>{r(M,rn(p)),r(d,"inactive"),x!==null&&(kt(x),x=null)}}),x!==null&&r(d,"active"))}function Pe(){x!==null&&(kt(x),x=null),r(d,"inactive"),r(M,null)}function Ie(p){if(!e(v))return;const{lat:T,lon:V,name:$,address:L}=p.detail;console.log("[TripTracker] Searching location:",$,T,V,L);const Y=L?.city||L?.town||L?.village||L?.municipality;if(Y&&e(j).filter(qe=>qe.type&&qe.type.toLowerCase()===Y.toLowerCase()).length>0){r(ne,Y),pe={lat:T,lon:V},r(ue,!0);return}et(T,V)}function et(p,T){if(!e(v))return;const V=st([T,p]);e(v).getView().animate({center:V,zoom:16,duration:1e3})}async function tt(p){try{const T=await fetch("https://nominatim.openstreetmap.org/search?"+new URLSearchParams({q:p,format:"json",limit:"1"}));if(T.ok){const V=await T.json();if(V.length>0){const{lat:$,lon:L}=V[0];if(console.log("[TripTracker] Zooming to city:",p,$,L),e(v)){const Y=st([parseFloat(L),parseFloat($)]);e(v).getView().animate({center:Y,zoom:14,duration:1e3})}}}}catch(T){console.error("[TripTracker] Failed to geocode city:",T)}}function yt(p){r(ue,!1),p.detail.filter&&e(ne)?(r(te,e(ne)),console.log("[TripTracker] Filtering maps by city:",e(ne))):r(te,null),pe&&et(pe.lat,pe.lon),r(ne,null),pe=null}async function ra(p){const T=p.detail.city;console.log("[TripTracker] Selected starting city:",T),r(Ee,T),r(te,T),await tt(T);const V=e(j).filter($=>$.type&&$.type.toLowerCase()===T.toLowerCase());if(V.length>0){const $=V.reduce((L,Y)=>Y.year?L.year?Y.year<L.year?Y:L:Y:L,V[0]);$&&(console.log("[TripTracker] Loading earliest map:",$.name,$.year),await y($.id))}r(xe,!1),r(Ee,null),t().hasSeenMapHint||setTimeout(()=>{r(B,!0)},800)}function ia(){console.log("[TripTracker] Skipped welcome"),r(xe,!1),t().hasSeenMapHint||setTimeout(()=>{r(B,!0)},800)}function la(){r(B,!1),le.setHasSeenMapHint(!0)}Ne(()=>e(j),()=>{r(i,Array.from(new Set(e(j).map(p=>p.type).filter(Boolean))).sort())}),Ne(()=>(e(v),e(g),e(X)),()=>{e(v)&&e(g)&&(e(X),A())}),Ne(()=>(e(v),e(g),e(Z),e(U),e(ee)),()=>{e(v)&&e(g)&&(e(Z),e(U),e(ee),Q())}),nt(),Re();var mt=Fs();z("pointermove",Ut,ve),z("pointerup",Ut,Oe);var Ot=o(mt);at(Ot,p=>r(C,p),()=>e(C));var jt=c(Ot,2);at(jt,p=>r(oe,p),()=>e(oe));var ut=c(jt,2);at(ut,p=>r(we,p),()=>e(we));var Nt=c(ut,2);at(Nt,p=>r(Se,p),()=>e(Se));var pt=c(Nt,2);at(pt,p=>r(re,p),()=>e(re));var Bt=c(pt,2);at(Bt,p=>r(se,p),()=>e(se));var ft=c(Bt,2);at(ft,p=>r(fe,p),()=>e(fe));var It=c(ft,2);{let p=gt(()=>e(d)==="active");In(It,{get isTracking(){return e(p)},get error(){return e(M)},$$events:{start:_e,stop:Pe}})}var Ft=c(It,2);Yn(Ft,{get isOpen(){return e(R)},$$events:{select:Ie}});var Dt=c(Ft,2);Pn(Dt,{get map(){return e(v)},get position(){return e(O)},get heading(){return e(ae)}});var Rt=c(Dt,2);$n(Rt,{get maps(){return e(j)},get selected(){return e(g)},get loading(){return e(H)},get filterCity(){return e(te)},$$events:{select:$e,zoom:je}});var zt=c(Rt,2);{let p=gt(()=>e(ne)||"");Un(zt,{get cityName(){return e(p)},get isOpen(){return e(ue)},$$events:{confirm:yt}})}var Vt=c(zt,2);es(Vt,{get isOpen(){return e(xe)},get cities(){return e(i)},get loadingCity(){return e(Ee)},$$events:{select:ra,skip:ia}});var Ht=c(Vt,2);ns(Ht,{get isVisible(){return e(B)},$$events:{dismiss:la}});var qt=c(Ht,2);{var ca=p=>{On(p,{get opacity(){return e(X)},get viewMode(){return e(Z)},$$events:{opacityChange:ye,viewModeChange:Be}})};G(qt,p=>{e(g)&&p(ca)})}var va=c(qt,2);{let p=gt(()=>e(d)==="active"),T=gt(()=>!!e(g));_s(va,{get isTracking(){return e(p)},get error(){return e(M)},get opacity(){return e(X)},get viewMode(){return e(Z)},get hasMapSelected(){return e(T)},get searchOpen(){return e(R)},$$events:{startTracking:_e,stopTracking:Pe,opacityChange:ye,viewModeChange:Be,toggleSearch:()=>r(R,!e(R)),locationSelect:Ie}})}n(mt),K((p,T)=>{De(ut,"aria-valuenow",p),De(pt,"aria-valuenow",T),De(ft,"aria-valuenow",e(ee))},[()=>(e(U),_(()=>Math.round(e(U)*100))),()=>(e(U),_(()=>Math.round(e(U)*100)))]),z("pointerdown",ut,()=>{de(ge,e(ge).sideX=!0)}),z("pointerdown",pt,()=>{de(ge,e(ge).sideY=!0)}),z("pointerdown",ft,()=>{de(ge,e(ge).lensR=!0)}),b(s,mt),Ve(),u()}function Zs(s,a){ze(a,!1);const t=()=>He(nn,"$page",l),[l,u]=Ke(),i=P(),S=P();Ne(()=>t(),()=>{r(i,t().url.searchParams.get("map"))}),Ne(()=>t(),()=>{r(S,t().url.searchParams.get("city"))}),nt(),Re(),Ds(s,{get initialMapId(){return e(i)},get initialCity(){return e(S)}}),Ve(),u()}export{Zs as component};
