import"../chunks/DsnmJJEf.js";import{i as ke}from"../chunks/ZgKF10oA.js";import{w as bt,d as It,c as Pe,s as N,o as Ot,b as Bt}from"../chunks/DMYoFwTQ.js";import{y as Le,z as pt,a6 as ct,bm as Dt,x as zt,E as Ht,D as Rt,bn as qt,aE as Vt,bo as Wt,ar as Kt,ac as Ut,F as xt,C as vt,T as Yt,K as Gt,aJ as Zt,p as Se,bg as _e,N as v,M as P,e as J,g as e,bh as Ve,i as Fe,k as je,l as h,o as Te,m as j,j as $e,t as V,bi as U,q as c,v as l,w as u,b as M,aY as dt,bp as at,ak as Jt,aT as Qt,V as Xe}from"../chunks/CFLsuAxJ.js";import{l as Ct,p as R,i as G,s as We,a as Ie,b as Xt}from"../chunks/ubKGujoG.js";import{bl as nt,bn as Ye,Y as ft,b5 as gt,aZ as ht,a$ as mt,a_ as Et,a5 as yt,M as ea,bo as jt,br as ta,bs as aa,b4 as na,bb as oa,b6 as sa,bc as ra,b9 as ia,ba as la,bk as He,bd as ca,bi as va,b0 as da,L as ua,P as pa}from"../chunks/JEDPzHsJ.js";import{e as fa,a as Ne,r as Ge,s as kt,i as ga,f as ha,d as ma}from"../chunks/B-hTwBeA.js";function ya(n,a,t,o,s){Le&&pt();var i=a.$$slots?.[t],d=!1;i===!0&&(i=a.children,d=!0),i===void 0||i(n,d?()=>o:o)}function wa(n,a,t,o,s,i){let d=Le;Le&&pt();var r=null;Le&&ct.nodeType===Dt&&(r=ct,pt());var f=Le?ct:n,w=new Rt(f,!1);zt(()=>{const _=a()||null;var O=_==="svg"?qt:null;if(_===null){w.ensure(null,null);return}return w.ensure(_,x=>{if(_){if(r=Le?r:O?document.createElementNS(O,_):document.createElement(_),Vt(r,r),o){Le&&Wt(_)&&r.append(document.createComment(""));var b=Le?Kt(r):r.appendChild(Ut());Le&&(b===null?xt(!1):vt(b)),o(r,b)}Yt.nodes_end=r,x.before(r)}Le&&vt(x)}),()=>{}},Ht),Gt(()=>{}),d&&(xt(!0),vt(f))}function _a(n){return function(...a){var t=a[0];return t.stopPropagation(),n?.apply(this,a)}}function ba(n,a){var t=n.$$events?.[a.type],o=Zt(t)?t.slice():t==null?[]:[t];for(var s of o)s.call(this,a)}const ka={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};function Sa(n,a=ka){return"geolocation"in navigator?navigator.geolocation.watchPosition(n.onPosition,n.onError,a):(n.onError({code:0,message:"Geolocation not supported",PERMISSION_DENIED:1,POSITION_UNAVAILABLE:2,TIMEOUT:3}),null)}function ut(n){navigator.geolocation.clearWatch(n)}function Ta(n){switch(n.code){case n.PERMISSION_DENIED:return"Location access denied. Please enable location permissions.";case n.POSITION_UNAVAILABLE:return"Location unavailable. Please check your device settings.";case n.TIMEOUT:return"Location request timed out. Please try again.";default:return"An unknown location error occurred."}}function xa(n,a){const t=Ct(a,["children","$$slots","$$events","$$legacy"]),o=Ct(t,["as","gap","align","justify","wrap","className","style"]);Se(a,!1);const s=P(),i=P(),d=P(),r=P(),f={start:"flex-start",center:"center",end:"flex-end",stretch:"stretch",baseline:"baseline"},w={start:"flex-start",center:"center",end:"flex-end",between:"space-between",around:"space-around",evenly:"space-evenly"};let _=R(a,"as",8,"div"),O=R(a,"gap",8,"var(--space-4)"),x=R(a,"align",8,"stretch"),b=R(a,"justify",8,"start"),y=R(a,"wrap",8,!1),L=R(a,"className",8,""),E=R(a,"style",8,void 0);const D=(g,C)=>C in g?g[C]:C;_e(()=>J(x()),()=>{v(s,D(f,String(x())))}),_e(()=>J(b()),()=>{v(i,D(w,String(b())))}),_e(()=>(J(y()),J(L()),J(t)),()=>{v(d,["stack",y()?"stack--wrap":"",L(),t.class].filter(Boolean).join(" "))}),_e(()=>(J(E()),J(t),J(O()),e(s),e(i)),()=>{v(r,[E(),t.style,`--stack-gap:${O()}`,`--stack-align:${e(s)}`,`--stack-justify:${e(i)}`].filter(Boolean).join(";"))}),Ve(),ke();var S=Fe(),A=je(S);wa(A,_,!1,(g,C)=>{fa(g,()=>({...o,class:e(d),style:e(r)}),void 0,void 0,"svelte-h657km");var $=Fe(),W=je($);ya(W,a,"default",{}),h(C,$)}),h(n,S),Te()}const et="vma-trip-language-v1";function Ca(){const n=(()=>{if(typeof window<"u"){const o=localStorage.getItem(et);if(o==="vi"||o==="en")return o}return"en"})(),{subscribe:a,set:t}=bt(n);return{subscribe:a,setLanguage:o=>{typeof window<"u"&&localStorage.setItem(et,o),t(o)},toggleLanguage:()=>{if(typeof window<"u"){const s=(localStorage.getItem(et)||"en")==="en"?"vi":"en";localStorage.setItem(et,s),t(s)}}}}const wt=Ca(),La={welcome:{title:"Welcome to Historical Maps",message:"Choose your starting city to explore historical maps from different eras.",skipButton:"Skip for Now",cityIcon:"üìç"},mapSelector:{consultingAtlas:"Consulting Atlas...",mapCollection:"Map Collection",allRegions:"All Regions",searchPlaceholder:"Search by year or name",zoomButton:"üîç Zoom to Map",anno:"Anno",noMapsFound:"‚äò No maps discovered in this region",buttonOrnament:"‚ßâ"},location:{tracking:"Tracking",myLocation:"My Location"},mapHint:{icon:"üëÜ",title:"Explore Historical Maps",description:"Click here to browse our collection of vintage maps",button:"Got it!"},cityFilter:{icon:"üó∫Ô∏è",title:"Filter Map Collection?",message:"Would you like to filter the map collection to show only maps from",noShowAll:"No, Show All",yesFilter:"Yes, Filter"},cities:{hanoi:"Hanoi",hue:"Hue",hochiminh:"Ho Chi Minh City",danang:"Da Nang",haiphong:"Hai Phong",cantho:"Can Tho",nhatrang:"Nha Trang",dalat:"Da Lat",vungtau:"Vung Tau",quinhon:"Quy Nhon"},common:{loading:"Loading...",error:"Error",close:"Close",cancel:"Cancel",confirm:"Confirm",save:"Save"}},Ma={welcome:{title:"Ch√†o m·ª´ng ƒë·∫øn v·ªõi B·∫£n ƒë·ªì L·ªãch s·ª≠",message:"Ch·ªçn th√†nh ph·ªë b·∫Øt ƒë·∫ßu ƒë·ªÉ kh√°m ph√° b·∫£n ƒë·ªì l·ªãch s·ª≠ t·ª´ nhi·ªÅu th·ªùi k·ª≥ kh√°c nhau.",skipButton:"B·ªè qua",cityIcon:"üìç"},mapSelector:{consultingAtlas:"ƒêang t·∫£i b·∫£n ƒë·ªì...",mapCollection:"B·ªô s∆∞u t·∫≠p B·∫£n ƒë·ªì",allRegions:"T·∫•t c·∫£ V√πng",searchPlaceholder:"T√¨m ki·∫øm theo nƒÉm ho·∫∑c t√™n",zoomButton:"üîç Ph√≥ng to B·∫£n ƒë·ªì",anno:"NƒÉm",noMapsFound:"‚äò Kh√¥ng t√¨m th·∫•y b·∫£n ƒë·ªì trong khu v·ª±c n√†y",buttonOrnament:"‚ßâ"},location:{tracking:"ƒêang theo d√µi",myLocation:"V·ªã tr√≠ c·ªßa t√¥i"},mapHint:{icon:"üëÜ",title:"Kh√°m ph√° B·∫£n ƒë·ªì L·ªãch s·ª≠",description:"Nh·∫•n v√†o ƒë√¢y ƒë·ªÉ xem b·ªô s∆∞u t·∫≠p b·∫£n ƒë·ªì c·ªï c·ªßa ch√∫ng t√¥i",button:"ƒê√£ hi·ªÉu!"},cityFilter:{icon:"üó∫Ô∏è",title:"L·ªçc B·ªô s∆∞u t·∫≠p B·∫£n ƒë·ªì?",message:"B·∫°n c√≥ mu·ªën l·ªçc b·ªô s∆∞u t·∫≠p b·∫£n ƒë·ªì ƒë·ªÉ ch·ªâ hi·ªÉn th·ªã b·∫£n ƒë·ªì t·ª´",noShowAll:"Kh√¥ng, Hi·ªÉn th·ªã T·∫•t c·∫£",yesFilter:"C√≥, L·ªçc"},cities:{hanoi:"H√† N·ªôi",hue:"Hu·∫ø",hochiminh:"Th√†nh ph·ªë H·ªì Ch√≠ Minh",danang:"ƒê√† N·∫µng",haiphong:"H·∫£i Ph√≤ng",cantho:"C·∫ßn Th∆°",nhatrang:"Nha Trang",dalat:"ƒê√† L·∫°t",vungtau:"V≈©ng T√†u",quinhon:"Quy Nh∆°n"},common:{loading:"ƒêang t·∫£i...",error:"L·ªói",close:"ƒê√≥ng",cancel:"H·ªßy",confirm:"X√°c nh·∫≠n",save:"L∆∞u"}},Oa={en:La,vi:Ma},Ze=It(wt,n=>Oa[n]);var Ea=j('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>'),ja=j('<option class="svelte-1twr28"> </option>'),Aa=j('<select class="city-select svelte-1twr28"><option class="svelte-1twr28"> </option><!></select>'),Na=j('<button class="map-item zoom svelte-1twr28"><span class="zoom-icon svelte-1twr28">üîç</span> <span> </span></button>'),Pa=j('<div class="empty-state svelte-1twr28"><div class="empty-icon svelte-1twr28">‚äò</div> <p class="svelte-1twr28"> </p></div>'),$a=j('<div class="map-type svelte-1twr28"> </div>'),Fa=j('<div class="map-year svelte-1twr28"> </div>'),Ia=j('<div class="selected-mark svelte-1twr28">‚úì</div>'),Ba=j('<button><div class="map-info svelte-1twr28"><div class="map-name svelte-1twr28"> </div> <!> <!></div> <!></button>'),Da=j('<!> <input type="text" class="search-input svelte-1twr28"/> <div class="map-list svelte-1twr28"><!> <!></div>',1),za=j('<div class="selector-panel svelte-1twr28"><!></div>'),Ha=j('<div class="selector-container svelte-1twr28"><button class="selector-button svelte-1twr28"><span class="button-ornament svelte-1twr28"> </span> <span class="button-text svelte-1twr28"><!></span> <span>‚ñº</span></button> <!></div>');function Ra(n,a){Se(a,!1);const t=()=>Ie(Ze,"$t",o),[o,s]=We(),i=P(),d=P(),r=P();let f=R(a,"maps",24,()=>[]),w=R(a,"selected",8,null),_=R(a,"loading",8,!1),O=R(a,"filterCity",8,null);const x=Pe();let b=P(""),y=P("all"),L=P(!1);function E(T){x("select",{mapId:T}),v(L,!1),v(b,"")}function D(){e(r)&&x("zoom",{mapId:e(r).id,bounds:e(r).bounds})}function S(){v(L,!e(L)),e(L)||v(b,"")}function A(T){const Y=T.target;v(y,Y.value)}_e(()=>J(O()),()=>{O()&&v(y,O())}),_e(()=>J(f()),()=>{v(i,Array.from(new Set(f().map(T=>T.type).filter(Boolean))).sort())}),_e(()=>(J(f()),e(y),e(b)),()=>{v(d,f().filter(T=>{if(e(y)!=="all"&&T.type!==e(y))return!1;if(!e(b).trim())return!0;const Y=e(b).toLowerCase();return T.name.toLowerCase().includes(Y)||T.type.toLowerCase().includes(Y)||T.summary?.toLowerCase().includes(Y)}))}),_e(()=>(J(f()),J(w())),()=>{v(r,f().find(T=>T.id===w()))}),Ve(),ke();var g=Ha();$e(T=>{var Y=Ea();h(T,Y)});var C=c(g),$=c(C),W=c($,!0);l($);var Q=u($,2),ve=c(Q);{var re=T=>{var Y=dt();V(()=>N(Y,(t(),M(()=>t().mapSelector.consultingAtlas)))),h(T,Y)},X=T=>{var Y=Fe(),de=je(Y);{var ye=ne=>{var m=dt();V(()=>N(m,(e(r),M(()=>e(r).name)))),h(ne,m)},pe=ne=>{var m=dt();V(()=>N(m,(t(),M(()=>t().mapSelector.mapCollection)))),h(ne,m)};G(de,ne=>{e(r)?ne(ye):ne(pe,!1)},!0)}h(T,Y)};G(ve,T=>{_()?T(re):T(X,!1)})}l(Q);var q=u(Q,2);let Z;l(C);var ie=u(C,2);{var ae=T=>{var Y=za(),de=c(Y);xa(de,{gap:"var(--space-2)",children:(ye,pe)=>{var ne=Da(),m=je(ne);{var H=se=>{var I=Aa(),ee=c(I),fe=c(ee,!0);l(ee),ee.value=ee.__value="all";var z=u(ee);Ye(z,1,()=>e(i),be=>be,(be,he)=>{var me=ja(),Oe=c(me,!0);l(me);var xe={};V(()=>{N(Oe,e(he)),xe!==(xe=e(he))&&(me.value=(me.__value=e(he))??"")}),h(be,me)}),l(I);var ue;ga(I),V(()=>{N(fe,(t(),M(()=>t().mapSelector.allRegions))),ue!==(ue=e(y))&&(I.value=(I.__value=e(y))??"",ha(I,e(y)))}),U("change",I,A),h(se,I)};G(m,se=>{e(i),M(()=>e(i).length>0)&&se(H)})}var oe=u(m,2);Ge(oe);var le=u(oe,2),we=c(le);{var Ae=se=>{var I=Na(),ee=u(c(I),2),fe=c(ee,!0);l(ee),l(I),V(z=>N(fe,z),[()=>(t(),M(()=>t().mapSelector.zoomButton.replace("üîç ","")))]),U("click",I,D),h(se,I)};G(we,se=>{J(w()),e(r),M(()=>w()&&e(r)?.bounds)&&se(Ae)})}var Me=u(we,2);{var Be=se=>{var I=Pa(),ee=u(c(I),2),fe=c(ee,!0);l(ee),l(I),V(z=>N(fe,z),[()=>(t(),M(()=>t().mapSelector.noMapsFound.replace("‚äò ","")))]),h(se,I)},De=se=>{var I=Fe(),ee=je(I);Ye(ee,1,()=>e(d),fe=>fe.id,(fe,z)=>{var ue=Ba();let be;var he=c(ue),me=c(he),Oe=c(me,!0);l(me);var xe=u(me,2);{var ze=p=>{var k=$a(),te=c(k,!0);l(k),V(()=>N(te,(e(z),M(()=>e(z).type)))),h(p,k)};G(xe,p=>{e(z),M(()=>e(z).type)&&p(ze)})}var Je=u(xe,2);{var Qe=p=>{var k=Fa(),te=c(k);l(k),V(()=>N(te,`${t(),M(()=>t().mapSelector.anno)??""} ${e(z),M(()=>e(z).year)??""}`)),h(p,k)};G(Je,p=>{e(z),M(()=>e(z).year)&&p(Qe)})}l(he);var ot=u(he,2);{var st=p=>{var k=Ia();h(p,k)};G(ot,p=>{e(z),J(w()),M(()=>e(z).id===w())&&p(st)})}l(ue),V(()=>{be=Ne(ue,1,"map-item svelte-1twr28",null,be,{selected:e(z).id===w()}),N(Oe,(e(z),M(()=>e(z).name)))}),U("click",ue,()=>E(e(z).id)),h(fe,ue)}),h(se,I)};G(Me,se=>{e(d),M(()=>e(d).length===0)?se(Be):se(De,!1)})}l(le),V(()=>kt(oe,"placeholder",(t(),M(()=>t().mapSelector.searchPlaceholder)))),nt(oe,()=>e(b),se=>v(b,se)),h(ye,ne)},$$slots:{default:!0}}),l(Y),h(T,Y)};G(ie,T=>{e(L)&&T(ae)})}l(g),V(()=>{C.disabled=_(),N(W,(t(),M(()=>t().mapSelector.buttonOrnament))),Z=Ne(q,1,"arrow svelte-1twr28",null,Z,{open:e(L)})}),U("click",C,S),h(n,g),Te(),s()}function qa(n,a){Se(a,!1);let t=R(a,"map",8),o=R(a,"position",8),s=R(a,"heading",8,0),i=R(a,"fieldOfView",8,60),d=R(a,"radius",8,200),r=null,f=P(null),w=null;function _(b,y,L,E){const D=L,S=(90-y)*Math.PI/180,A=E/2*Math.PI/180,g=[b],C=S-A,$=S+A,W=20;for(let Q=0;Q<=W;Q++){const ve=C+Q/W*($-C),re=b[0]+D*Math.cos(ve),X=b[1]+D*Math.sin(ve);g.push([re,X])}return g.push(b),new ea([g])}function O(){if(!o()||!t()){console.log("[DirectionCone] Cannot update: position or map missing",{position:!!o(),map:!!t()});return}const b=o().getGeometry();if(!b){console.log("[DirectionCone] Cannot update: position geometry missing");return}const y=b.getCoordinates();if(console.log("[DirectionCone] Updating cone:",{center:y,heading:s(),radius:d(),fieldOfView:i(),hasFeature:!!w,hasSource:!!e(f)}),w){const L=_(y,s(),d(),i());w.setGeometry(L),console.log("[DirectionCone] Updated cone geometry")}else{const L=_(y,s(),d(),i());w=new yt({geometry:L}),w.setId("direction-cone"),e(f)?.addFeature(w),console.log("[DirectionCone] Created new cone feature")}}function x(){return new ht({fill:new Et({color:"rgba(37, 99, 235, 0.3)"}),stroke:new mt({color:"rgba(37, 99, 235, 0.8)",width:3})})}Ot(()=>{console.log("[DirectionCone] onMount called",{hasMap:!!t()}),t()&&(v(f,new ft),r=new gt({source:e(f),zIndex:24,style:x()}),t().addLayer(r),console.log("[DirectionCone] Layer added to map",{zIndex:24}),O())}),Bt(()=>{t()&&r&&t().removeLayer(r)}),_e(()=>(J(t()),J(o()),J(s()),e(f)),()=>{t()&&o()&&s()!==void 0&&(console.log("[DirectionCone] Reactive update triggered",{hasMap:!!t(),hasPosition:!!o(),heading:s(),hasDirectionSource:!!e(f)}),O())}),Ve(),ke(),Te()}var Va=j('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>'),Wa=j('<div class="controls-container svelte-pwt3by"><div class="controls-panel svelte-pwt3by"><div class="control-group svelte-pwt3by"><div class="control-label svelte-pwt3by"><span class="label-icon svelte-pwt3by">‚óê</span> <span class="label-text svelte-pwt3by">Overlay Opacity</span></div> <div class="slider-container svelte-pwt3by"><span class="slider-value svelte-pwt3by"> </span> <input type="range" min="0" max="1" step="0.05" class="opacity-slider svelte-pwt3by"/></div></div></div></div>');function Ka(n,a){Se(a,!1);let t=R(a,"opacity",12,1);const o=Pe();function s(x){const b=x.target,y=parseFloat(b.value);console.log("[ViewControls] Opacity slider changed:",y),o("opacityChange",{opacity:y})}ke();var i=Wa();$e(x=>{var b=Va();h(x,b)});var d=c(i),r=c(d),f=u(c(r),2),w=c(f),_=c(w);l(w);var O=u(w,2);Ge(O),l(f),l(r),l(d),l(i),V(x=>N(_,`${x??""}%`),[()=>(J(t()),M(()=>Math.round(t()*100)))]),nt(O,t),U("input",O,s),h(n,i),Te()}var Ua=j('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet" class="svelte-1wnqptu"/>'),Ya=at('<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="svelte-1wnqptu"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" stroke="#6b5d52" stroke-width="1.5" fill="#d4af37" stroke-linejoin="round" class="svelte-1wnqptu"></path></svg>'),Ga=at('<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="svelte-1wnqptu"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" stroke="#6b5d52" stroke-width="1.5" fill="none" stroke-linejoin="round" class="svelte-1wnqptu"></path></svg>'),Za=j('<div class="error-tooltip svelte-1wnqptu"> </div>'),Ja=j('<div class="location-button-container svelte-1wnqptu"><button><span class="icon svelte-1wnqptu"><!></span> <span class="label svelte-1wnqptu"> </span></button> <!></div>');function Qa(n,a){Se(a,!1);const t=()=>Ie(Ze,"$t",o),[o,s]=We();let i=R(a,"isTracking",8,!1),d=R(a,"error",8,null);const r=Pe();function f(){i()?r("stop"):r("start")}ke();var w=Ja();$e(g=>{var C=Ua();h(g,C)});var _=c(w);let O;var x=c(_),b=c(x);{var y=g=>{var C=Ya();h(g,C)},L=g=>{var C=Ga();h(g,C)};G(b,g=>{i()?g(y):g(L,!1)})}l(x);var E=u(x,2),D=c(E,!0);l(E),l(_);var S=u(_,2);{var A=g=>{var C=Za(),$=c(C,!0);l(C),V(()=>N($,d())),h(g,C)};G(S,g=>{d()&&g(A)})}l(w),V(()=>{O=Ne(_,1,"location-button svelte-1wnqptu",null,O,{active:i(),error:!!d()}),kt(_,"title",i()?"Stop location tracking":"Start location tracking"),N(D,(J(i()),t(),M(()=>i()?t().location.tracking:t().location.myLocation)))}),U("click",_,f),h(n,w),Te(),s()}var Xa=j('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>'),en=j('<span class="label svelte-td9aje">Search</span>'),tn=j('<div class="error-message svelte-td9aje"> </div>'),an=j('<button class="result-item svelte-td9aje"><span class="result-icon svelte-td9aje">üìå</span> <div class="result-content svelte-td9aje"><div class="result-name svelte-td9aje"> </div> <div class="result-address svelte-td9aje"> </div></div></button>'),nn=j('<div class="results-list svelte-td9aje"></div>'),on=j('<div class="search-panel svelte-td9aje"><div class="search-header svelte-td9aje"><span class="header-icon svelte-td9aje">üìç</span> <span class="header-text svelte-td9aje">Search Location</span></div> <div class="search-input-container svelte-td9aje"><input type="text" class="search-input svelte-td9aje" placeholder="Enter city, address, or landmark..."/> <button class="search-button svelte-td9aje"> </button></div> <!> <!></div>'),sn=j('<div class="search-container svelte-td9aje"><button class="search-toggle svelte-td9aje" title="Search location"><span class="icon svelte-td9aje"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="svelte-td9aje"><circle cx="11" cy="11" r="7" stroke="#6b5d52" stroke-width="1.5"></circle><path d="M16 16L21 21" stroke="#6b5d52" stroke-width="1.5" stroke-linecap="round"></path></svg></span> <!></button> <!></div>');function rn(n,a){Se(a,!1);let t=R(a,"isOpen",12,!1);const o=Pe();let s=P(""),i=P([]),d=P(!1),r=P(null);async function f(){if(e(s).trim()){v(d,!0),v(r,null);try{const S=await fetch("https://nominatim.openstreetmap.org/search?"+new URLSearchParams({q:e(s),format:"json",limit:"5",addressdetails:"1"}));if(!S.ok)throw new Error("Search failed");v(i,await S.json()),e(i).length===0&&v(r,"No locations found")}catch(S){console.error("[LocationSearch] Search error:",S),v(r,"Failed to search location"),v(i,[])}finally{v(d,!1)}}}function w(S){o("select",{lat:parseFloat(S.lat),lon:parseFloat(S.lon),name:S.display_name,address:S.address}),v(s,""),v(i,[]),t(!1)}function _(S){S.key==="Enter"&&f()}function O(){t(!t()),t()||(v(s,""),v(i,[]),v(r,null))}_e(()=>J(t()),()=>{t()||(v(s,""),v(i,[]),v(r,null))}),Ve(),ke();var x=sn();$e(S=>{var A=Xa();h(S,A)});var b=c(x),y=u(c(b),2);{var L=S=>{var A=en();h(S,A)};G(y,S=>{t()||S(L)})}l(b);var E=u(b,2);{var D=S=>{var A=on(),g=u(c(A),2),C=c(g);Ge(C);var $=u(C,2),W=c($,!0);l($),l(g);var Q=u(g,2);{var ve=q=>{var Z=tn(),ie=c(Z,!0);l(Z),V(()=>N(ie,e(r))),h(q,Z)};G(Q,q=>{e(r)&&q(ve)})}var re=u(Q,2);{var X=q=>{var Z=nn();Ye(Z,5,()=>e(i),jt,(ie,ae)=>{var T=an(),Y=u(c(T),2),de=c(Y),ye=c(de,!0);l(de);var pe=u(de,2),ne=c(pe,!0);l(pe),l(Y),l(T),V(m=>{N(ye,m),N(ne,(e(ae),M(()=>e(ae).display_name)))},[()=>(e(ae),M(()=>e(ae).name||e(ae).display_name.split(",")[0]))]),U("click",T,()=>w(e(ae))),h(ie,T)}),l(Z),h(q,Z)};G(re,q=>{e(i),M(()=>e(i).length>0)&&q(X)})}l(A),V(q=>{C.disabled=e(d),$.disabled=q,N(W,e(d)?"...":"Search")},[()=>(e(d),e(s),M(()=>e(d)||!e(s).trim()))]),nt(C,()=>e(s),q=>v(s,q)),U("keydown",C,_),U("click",$,f),h(S,A)};G(E,S=>{t()&&S(D)})}l(x),U("click",b,O),h(n,x),Te()}var ln=j('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>'),cn=j('<div class="dialog-overlay svelte-r8jync"><div class="dialog-container svelte-r8jync"><div class="dialog-icon svelte-r8jync"> </div> <div class="dialog-content svelte-r8jync"><h3 class="dialog-title svelte-r8jync"> </h3> <p class="dialog-message svelte-r8jync"> <strong class="svelte-r8jync"> </strong>?</p></div> <div class="dialog-actions svelte-r8jync"><button class="dialog-button secondary svelte-r8jync"> </button> <button class="dialog-button primary svelte-r8jync"> </button></div></div></div>');function vn(n,a){Se(a,!1);const t=()=>Ie(Ze,"$t",o),[o,s]=We();let i=R(a,"cityName",8,""),d=R(a,"isOpen",8,!1);const r=Pe();function f(){r("confirm",{filter:!0})}function w(){r("confirm",{filter:!1})}function _(y){const L=y.toLowerCase().replace(/\s+/g,"");return t().cities[L]||y}ke();var O=Fe();$e(y=>{var L=ln();h(y,L)});var x=je(O);{var b=y=>{var L=cn(),E=c(L),D=c(E),S=c(D,!0);l(D);var A=u(D,2),g=c(A),C=c(g,!0);l(g);var $=u(g,2),W=c($),Q=u(W),ve=c(Q,!0);l(Q),Jt(),l($),l(A);var re=u(A,2),X=c(re),q=c(X,!0);l(X);var Z=u(X,2),ie=c(Z,!0);l(Z),l(re),l(E),l(L),V(ae=>{N(S,(t(),M(()=>t().cityFilter.icon))),N(C,(t(),M(()=>t().cityFilter.title))),N(W,`${t(),M(()=>t().cityFilter.message)??""} `),N(ve,ae),N(q,(t(),M(()=>t().cityFilter.noShowAll))),N(ie,(t(),M(()=>t().cityFilter.yesFilter)))},[()=>(J(i()),M(()=>_(i())))]),U("click",X,w),U("click",Z,f),U("click",E,_a(function(ae){ba.call(this,a,ae)})),U("click",L,w),h(y,L)};G(x,y=>{d()&&y(b)})}h(n,O),Te(),s()}var dn=j('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>'),un=j('<button class="city-button svelte-1vbp4hf"><span class="city-icon svelte-1vbp4hf"> </span> <span class="city-name svelte-1vbp4hf"> </span></button>'),pn=j('<div class="dialog-overlay svelte-1vbp4hf"><div class="dialog-container svelte-1vbp4hf"><div class="dialog-header svelte-1vbp4hf"><div class="dialog-icon svelte-1vbp4hf">üó∫Ô∏è</div> <h2 class="dialog-title svelte-1vbp4hf"> </h2> <div class="language-toggle svelte-1vbp4hf"><button>EN</button> <span class="lang-separator svelte-1vbp4hf">|</span> <button>VI</button></div></div> <div class="dialog-content svelte-1vbp4hf"><p class="dialog-message svelte-1vbp4hf"> </p> <div class="city-grid svelte-1vbp4hf"></div></div> <div class="dialog-actions svelte-1vbp4hf"><button class="dialog-button secondary svelte-1vbp4hf"> </button></div></div></div>');function fn(n,a){Se(a,!1);const t=()=>Ie(Ze,"$t",s),o=()=>Ie(wt,"$currentLanguage",s),[s,i]=We();let d=R(a,"isOpen",8,!1),r=R(a,"cities",24,()=>[]);const f=Pe();function w(E){f("select",{city:E})}function _(){f("skip")}function O(E){wt.setLanguage(E)}function x(E){const D=E.toLowerCase().replace(/\s+/g,"");return t().cities[D]||E}ke();var b=Fe();$e(E=>{var D=dn();h(E,D)});var y=je(b);{var L=E=>{var D=pn(),S=c(D),A=c(S),g=u(c(A),2),C=c(g,!0);l(g);var $=u(g,2),W=c($);let Q;var ve=u(W,4);let re;l($),l(A);var X=u(A,2),q=c(X),Z=c(q,!0);l(q);var ie=u(q,2);Ye(ie,5,r,de=>de,(de,ye)=>{var pe=un(),ne=c(pe),m=c(ne,!0);l(ne);var H=u(ne,2),oe=c(H,!0);l(H),l(pe),V(le=>{N(m,(t(),M(()=>t().welcome.cityIcon))),N(oe,le)},[()=>(e(ye),M(()=>x(e(ye))))]),U("click",pe,()=>w(e(ye))),h(de,pe)}),l(ie),l(X);var ae=u(X,2),T=c(ae),Y=c(T,!0);l(T),l(ae),l(S),l(D),V(()=>{N(C,(t(),M(()=>t().welcome.title))),Q=Ne(W,1,"lang-button svelte-1vbp4hf",null,Q,{active:o()==="en"}),re=Ne(ve,1,"lang-button svelte-1vbp4hf",null,re,{active:o()==="vi"}),N(Z,(t(),M(()=>t().welcome.message))),N(Y,(t(),M(()=>t().welcome.skipButton)))}),U("click",W,()=>O("en")),U("click",ve,()=>O("vi")),U("click",T,_),h(E,D)};G(y,E=>{d()&&E(L)})}h(n,b),Te(),i()}var gn=j('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet" class="svelte-1lpq58w"/>'),hn=j('<div class="hint-overlay svelte-1lpq58w"><div class="spotlight svelte-1lpq58w"></div></div> <div class="hint-popup svelte-1lpq58w"><div class="hint-content svelte-1lpq58w"><div class="hint-icon svelte-1lpq58w"> </div> <div class="hint-text svelte-1lpq58w"><div class="hint-title svelte-1lpq58w"> </div> <div class="hint-description svelte-1lpq58w"> </div></div></div> <button class="hint-dismiss svelte-1lpq58w"> </button></div>',1);function mn(n,a){Se(a,!1);const t=()=>Ie(Ze,"$t",o),[o,s]=We();let i=R(a,"isVisible",8,!1);const d=Pe();function r(){d("dismiss")}ke();var f=Fe();$e(O=>{var x=gn();h(O,x)});var w=je(f);{var _=O=>{var x=hn(),b=je(x),y=u(b,2),L=c(y),E=c(L),D=c(E,!0);l(E);var S=u(E,2),A=c(S),g=c(A,!0);l(A);var C=u(A,2),$=c(C,!0);l(C),l(S),l(L);var W=u(L,2),Q=c(W,!0);l(W),l(y),V(()=>{N(D,(t(),M(()=>t().mapHint.icon))),N(g,(t(),M(()=>t().mapHint.title))),N($,(t(),M(()=>t().mapHint.description))),N(Q,(t(),M(()=>t().mapHint.button)))}),U("click",b,r),U("click",W,r),h(O,x)};G(w,O=>{i()&&O(_)})}h(n,f),Te(),s()}var yn=j('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet" class="svelte-ua832v"/>'),wn=at('<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="svelte-ua832v"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" stroke="#6b5d52" stroke-width="1.5" fill="#d4af37" stroke-linejoin="round" class="svelte-ua832v"></path></svg>'),_n=at('<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="svelte-ua832v"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" stroke="#6b5d52" stroke-width="1.5" fill="none" stroke-linejoin="round" class="svelte-ua832v"></path></svg>'),bn=j('<button title="Adjust opacity"><span class="btn-icon svelte-ua832v">‚óê</span></button>'),kn=j('<div class="expansion-panel opacity-panel svelte-ua832v"><div class="panel-content svelte-ua832v"><span class="panel-label svelte-ua832v">Overlay</span> <input type="range" min="0" max="1" step="0.05" class="opacity-slider svelte-ua832v"/> <span class="panel-value svelte-ua832v"> </span></div></div>'),Sn=j('<div class="search-error svelte-ua832v"> </div>'),Tn=j('<button class="result-item svelte-ua832v"><span class="result-icon svelte-ua832v">üìå</span> <div class="result-content svelte-ua832v"><div class="result-name svelte-ua832v"> </div> <div class="result-address svelte-ua832v"> </div></div></button>'),xn=j('<div class="search-results svelte-ua832v"></div>'),Cn=j('<div class="expansion-panel search-panel svelte-ua832v"><div class="search-header svelte-ua832v"><span class="header-icon svelte-ua832v">üìç</span> <span class="header-text svelte-ua832v">Search Location</span></div> <div class="search-input-wrapper svelte-ua832v"><input type="text" class="search-input svelte-ua832v" placeholder="Enter city, address..."/> <button class="search-btn svelte-ua832v"> </button></div> <!> <!></div>'),Ln=j('<div class="error-badge svelte-ua832v"> </div>'),Mn=j('<div class="mobile-controls svelte-ua832v"><div class="control-bar svelte-ua832v"><button><span class="btn-icon svelte-ua832v"><!></span></button> <button title="Search location"><span class="btn-icon svelte-ua832v"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="svelte-ua832v"><circle cx="11" cy="11" r="7" stroke="#6b5d52" stroke-width="1.5" class="svelte-ua832v"></circle><path d="M16 16L21 21" stroke="#6b5d52" stroke-width="1.5" stroke-linecap="round" class="svelte-ua832v"></path></svg></span></button> <!></div> <!> <!> <!></div>');function On(n,a){Se(a,!1);let t=R(a,"isTracking",8,!1),o=R(a,"error",8,null),s=R(a,"opacity",8,1),i=R(a,"hasMapSelected",8,!1),d=R(a,"searchOpen",8,!1);const r=Pe();let f=P(!1),w=P(""),_=P([]),O=P(!1),x=P(null);function b(){v(f,!e(f))}function y(){r("toggleSearch")}async function L(){if(e(w).trim()){v(O,!0),v(x,null);try{const m=await fetch("https://nominatim.openstreetmap.org/search?"+new URLSearchParams({q:e(w),format:"json",limit:"5",addressdetails:"1"}));if(!m.ok)throw new Error("Search failed");v(_,await m.json()),e(_).length===0&&v(x,"No locations found")}catch(m){console.error("[MobileControls] Search error:",m),v(x,"Failed to search location"),v(_,[])}finally{v(O,!1)}}}function E(m){r("locationSelect",{lat:parseFloat(m.lat),lon:parseFloat(m.lon),name:m.display_name,address:m.address}),v(w,""),v(_,[]),r("toggleSearch")}function D(m){m.key==="Enter"&&L()}function S(){t()?r("stopTracking"):r("startTracking")}function A(m){const H=m.target;r("opacityChange",{opacity:parseFloat(H.value)})}_e(()=>J(d()),()=>{d()||(v(w,""),v(_,[]),v(x,null))}),Ve(),ke();var g=Mn();$e(m=>{var H=yn();h(m,H)});var C=c(g),$=c(C);let W;var Q=c($),ve=c(Q);{var re=m=>{var H=wn();h(m,H)},X=m=>{var H=_n();h(m,H)};G(ve,m=>{t()?m(re):m(X,!1)})}l(Q),l($);var q=u($,2);let Z;var ie=u(q,2);{var ae=m=>{var H=bn();let oe;V(()=>oe=Ne(H,1,"control-btn svelte-ua832v",null,oe,{active:e(f)})),U("click",H,b),h(m,H)};G(ie,m=>{i()&&m(ae)})}l(C);var T=u(C,2);{var Y=m=>{var H=kn(),oe=c(H),le=u(c(oe),2);Ge(le);var we=u(le,2),Ae=c(we);l(we),l(oe),l(H),V(Me=>{ma(le,s()),N(Ae,`${Me??""}%`)},[()=>(J(s()),M(()=>Math.round(s()*100)))]),U("input",le,A),h(m,H)};G(T,m=>{e(f)&&i()&&m(Y)})}var de=u(T,2);{var ye=m=>{var H=Cn(),oe=u(c(H),2),le=c(oe);Ge(le);var we=u(le,2),Ae=c(we,!0);l(we),l(oe);var Me=u(oe,2);{var Be=I=>{var ee=Sn(),fe=c(ee,!0);l(ee),V(()=>N(fe,e(x))),h(I,ee)};G(Me,I=>{e(x)&&I(Be)})}var De=u(Me,2);{var se=I=>{var ee=xn();Ye(ee,5,()=>e(_),jt,(fe,z)=>{var ue=Tn(),be=u(c(ue),2),he=c(be),me=c(he,!0);l(he);var Oe=u(he,2),xe=c(Oe,!0);l(Oe),l(be),l(ue),V(ze=>{N(me,ze),N(xe,(e(z),M(()=>e(z).display_name)))},[()=>(e(z),M(()=>e(z).name||e(z).display_name.split(",")[0]))]),U("click",ue,()=>E(e(z))),h(fe,ue)}),l(ee),h(I,ee)};G(De,I=>{e(_),M(()=>e(_).length>0)&&I(se)})}l(H),V(I=>{le.disabled=e(O),we.disabled=I,N(Ae,e(O)?"...":"üîç")},[()=>(e(O),e(w),M(()=>e(O)||!e(w).trim()))]),nt(le,()=>e(w),I=>v(w,I)),U("keydown",le,D),U("click",we,L),h(m,H)};G(de,m=>{d()&&m(ye)})}var pe=u(de,2);{var ne=m=>{var H=Ln(),oe=c(H,!0);l(H),V(()=>N(oe,o())),h(m,H)};G(pe,m=>{o()&&m(ne)})}l(g),V(()=>{W=Ne($,1,"control-btn svelte-ua832v",null,W,{active:t()}),kt($,"title",t()?"Stop tracking":"Start tracking"),Z=Ne(q,1,"control-btn svelte-ua832v",null,Z,{active:d()})}),U("click",$,S),U("click",q,y),h(n,g),Te()}const At="vma-trip-preferences-v1",Ke={hasSeenWelcome:!1,hasCompletedTutorial:!1,hasSeenMapHint:!1,autoStartLocation:!1,lastKnownPosition:null};function En(){if(typeof window>"u")return Ke;try{const n=window.localStorage.getItem(At);if(n){const a=JSON.parse(n);return{...Ke,...a}}}catch(n){console.warn("Failed to load trip preferences:",n)}return Ke}function Re(n){if(!(typeof window>"u"))try{window.localStorage.setItem(At,JSON.stringify(n))}catch(a){console.warn("Failed to save trip preferences:",a)}}function jn(){const{subscribe:n,set:a,update:t}=bt(En());return{subscribe:n,setHasSeenWelcome:o=>{t(s=>{const i={...s,hasSeenWelcome:o};return Re(i),i})},setHasCompletedTutorial:o=>{t(s=>{const i={...s,hasCompletedTutorial:o};return Re(i),i})},setHasSeenMapHint:o=>{t(s=>{const i={...s,hasSeenMapHint:o};return Re(i),i})},setAutoStartLocation:o=>{t(s=>{const i={...s,autoStartLocation:o};return Re(i),i})},setLastKnownPosition:o=>{t(s=>{const i={...s,lastKnownPosition:o};return Re(i),i})},reset:()=>{a(Ke),Re(Ke)}}}const Lt={currentYear:new Date().getFullYear(),availableYears:[],activeMapId:null,isTransitioning:!1};function An(){const{subscribe:n,set:a,update:t}=bt(Lt);return{subscribe:n,setCurrentYear:o=>{t(s=>({...s,currentYear:o}))},setAvailableYears:o=>{t(s=>{const i=[...o].sort((r,f)=>r-f),d=i.length>0?Math.max(...i):s.currentYear;return{...s,availableYears:i,currentYear:d}})},setActiveMap:o=>{t(s=>({...s,activeMapId:o}))},setIsTransitioning:o=>{t(s=>({...s,isTransitioning:o}))},reset:()=>{a(Lt)}}}const Nn=Symbol("trip-context");function Pn(n){Qt(Nn,n)}const qe=new Map;async function $n(n){if(qe.has(n))return qe.get(n)||null;try{const a=await fetch(`https://annotations.allmaps.org/images/${n}`);if(!a.ok)return console.warn(`Failed to fetch annotation for ${n}: ${a.status}`),qe.set(n,null),null;const t=await a.json(),o=Fn(t);if(!o||o.length===0)return qe.set(n,null),null;const s=o.map(r=>r.world[0]),i=o.map(r=>r.world[1]),d=[Math.min(...s),Math.min(...i),Math.max(...s),Math.max(...i)];return qe.set(n,d),d}catch(a){return console.error(`Error fetching bounds for ${n}:`,a),qe.set(n,null),null}}function Fn(n){if(!n||typeof n!="object")return[];const a=n;if(a.body&&typeof a.body=="object"){const t=a.body;if(t.features&&Array.isArray(t.features)){const o=[];for(const s of t.features)if(s&&typeof s=="object"&&"geometry"in s&&s.geometry&&typeof s.geometry=="object"){const i=s.geometry;if(i.coordinates&&Array.isArray(i.coordinates)){const d=i.coordinates;d.length>=2&&typeof d[0]=="number"&&typeof d[1]=="number"&&o.push({world:[d[0],d[1]]})}}if(o.length>0)return o}if(t.transformation&&typeof t.transformation=="object"){const o=t.transformation;if(o.gcps&&Array.isArray(o.gcps))return o.gcps.filter(s=>s!==null&&typeof s=="object").filter(s=>{const i=s.world;return Array.isArray(i)&&i.length>=2}).map(s=>{const i=s.world;return{world:[i[0],i[1]]}})}}return a.gcps&&Array.isArray(a.gcps)?a.gcps.filter(t=>t!==null&&typeof t=="object").filter(t=>{const o=t.world;return Array.isArray(o)&&o.length>=2}).map(t=>{const o=t.world;return{world:[o[0],o[1]]}}):[]}async function In(n,a=5){const t=new Map;for(let o=0;o<n.length;o+=a){const i=n.slice(o,o+a).map(async d=>{const r=await $n(d);t.set(d,r)});await Promise.all(i)}return t}let _t=null,Ue=null;function Bn(n){if(typeof window>"u"||!window.DeviceOrientationEvent)return console.warn("DeviceOrientation API not supported"),null;_t=n;let a=0;const t=100;return Ue=o=>{const s=Date.now();if(s-a<t||(a=s,o.alpha===null||o.beta===null||o.gamma===null))return;const i={alpha:o.alpha,beta:o.beta,gamma:o.gamma};_t?.(i)},window.addEventListener("deviceorientation",Ue,!0),()=>{Nt()}}function Nt(){Ue&&(window.removeEventListener("deviceorientation",Ue,!0),Ue=null),_t=null}async function Dn(){if(!("serviceWorker"in navigator))return console.warn("[ServiceWorker] Not supported in this browser"),null;try{const n=await navigator.serviceWorker.register("/sw.js",{scope:"/"});return console.log("[ServiceWorker] Registered successfully:",n.scope),n.addEventListener("updatefound",()=>{const a=n.installing;a&&a.addEventListener("statechange",()=>{a.state==="activated"&&console.log("[ServiceWorker] Updated and activated")})}),n}catch(n){return console.error("[ServiceWorker] Registration failed:",n),null}}const zn="allmaps-cache",Hn=1,tt="catalog",Mt="annotations";function Pt(){return new Promise((n,a)=>{const t=indexedDB.open(zn,Hn);t.onerror=()=>a(t.error),t.onsuccess=()=>n(t.result),t.onupgradeneeded=o=>{const s=o.target.result;s.objectStoreNames.contains(tt)||s.createObjectStore(tt),s.objectStoreNames.contains(Mt)||s.createObjectStore(Mt)}})}async function Rn(n,a){try{const t=await Pt();return new Promise((o,s)=>{const r=t.transaction(n,"readonly").objectStore(n).get(a);r.onerror=()=>s(r.error),r.onsuccess=()=>{const f=r.result;o(f||null)}})}catch(t){return console.error("[MapCache] Error reading from IndexedDB:",t),null}}async function qn(n,a,t,o){try{const s=await Pt();return new Promise((i,d)=>{const f=s.transaction(n,"readwrite").objectStore(n),w={data:t,timestamp:Date.now(),expiresAt:Date.now()+o},_=f.put(w,a);_.onerror=()=>d(_.error),_.onsuccess=()=>i(!0)})}catch(s){return console.error("[MapCache] Error writing to IndexedDB:",s),!1}}async function Vn(n){await qn(tt,"maps",n,864e5),console.log("[MapCache] Cached map catalog:",n.length,"maps")}async function Wn(){const n=await Rn(tt,"maps");return n?Date.now()>n.expiresAt?(console.log("[MapCache] Catalog cache expired"),null):(console.log("[MapCache] Using cached catalog:",n.data.length,"maps"),n.data):null}var Kn=j('<div class="trip-container svelte-1id9u82"><div class="map svelte-1id9u82"></div> <!> <!> <!> <!> <!> <!> <!> <!> <!></div>');function Un(n,a){Se(a,!1);const t=()=>Ie(W,"$tripState",o),[o,s]=We(),i=P();let d=P(),r=P(null),f=null,w=null,_=null,O=null,x=null,b=P("inactive"),y=null,L=null,E=P(null),D=[],S=P(null),A=P(null),g=P([]),C=P(!1),$=P(null);const W=jn(),Q=An();Pn({preferences:W,timeline:Q});let ve=P(0),re=P(!1),X=P(null),q=null,Z=P(!1),ie=P(!1),ae=P(!1),T=P(.8);function Y(p){return new ht({stroke:new mt({color:"#ea580c",width:4,lineCap:"round",lineJoin:"round"})})}function de(p){return new ht({image:new da({radius:8,fill:new Et({color:"#ffffff"}),stroke:new mt({color:"#ea580c",width:3})})})}Ot(()=>{const p=new ta({source:new aa({urls:["https://mt0.google.com/vt/lyrs=y&x={x}&y={y}&z={z}","https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}","https://mt2.google.com/vt/lyrs=y&x={x}&y={y}&z={z}","https://mt3.google.com/vt/lyrs=y&x={x}&y={y}&z={z}"],attributions:"Tiles ¬© Google",maxZoom:22,crossOrigin:"anonymous"}),zIndex:0});f=new na,f.setZIndex(10),_=new ft,w=new gt({source:_,zIndex:20,style:Y}),x=new ft,O=new gt({source:x,zIndex:25,style:de});const k=t().lastKnownPosition;return v(r,new oa({target:e(d),layers:[p,w,O],view:new ra({center:k?He([k.lon,k.lat]):ca,zoom:16,enableRotation:!1}),controls:sa({attribution:!1,rotate:!1,zoom:!1}).extend([new ia,new la])})),f.setMap?.(e(r)),(async()=>{Dn().then(F=>{F&&console.log("[TripTracker] Service worker registered for map caching")}),await ye(),v(Z,!0);const B=e(g).map(F=>F.id);In(B,5).then(F=>{v(g,e(g).map(K=>{const ce=F.get(K.id);return ce?{...K,bounds:ce}:K}))})})(),Bn(B=>{console.log("[TripTracker] Orientation update:",B),v(ve,B.alpha)}),()=>{y!==null&&ut(y),Nt(),e(r)?.dispose()}});async function ye(){try{const p=await Wn();if(p){v(g,p),console.log("[TripTracker] Loaded map catalog from cache");return}const k=await fetch(va);if(!k.ok)throw new Error(`HTTP ${k.status}`);const B=(await k.text()).trim().split(/\r?\n/),F=B.shift()?.split(",").map(ce=>ce.trim().toLowerCase())||[],K=[];for(const ce of B){if(!ce.trim())continue;const Ce=[],rt=ce.matchAll(/(".*?"|[^",\r\n]+)(?=\s*,|\s*$)/g);for(const Ee of rt)Ce.push(Ee[1].replace(/^"|"$/g,"").trim());const ge={};F.forEach((Ee,Ft)=>{ge[Ee]=Ce[Ft]||""});const it=F.find(Ee=>Ee==="id"),lt=F.find(Ee=>Ee==="name"),St=F.find(Ee=>Ee==="type");if(!it||!lt||!ge[it]||!ge[lt])continue;const Tt=parseInt(ge.year,10),$t={id:ge[it],name:ge[lt],type:St&&ge[St]||"",summary:ge.summary||void 0,description:ge.description||ge.details||ge.detail||void 0,thumbnail:ge.thumbnail||ge.image||void 0,isFeatured:ge.featured==="TRUE"||ge.is_featured==="TRUE",year:isNaN(Tt)?void 0:Tt};K.push($t)}v(g,K),await Vn(K),console.log("[TripTracker] Cached map catalog")}catch(p){console.error("Failed to load map catalog:",p),v(g,[])}}async function pe(p){if(!(!e(r)||!f)){v(C,!0);try{f.clear();const k=`https://annotations.allmaps.org/images/${p}`;await f.addGeoreferenceAnnotationByUrl(k),ne(),v(A,p)}catch(k){console.error("Failed to load map overlay:",k),v(S,"Could not load historical map"),v(A,null)}finally{v(C,!1)}}}function ne(){if(!e(r)||!f){console.log("[TripTracker] No map or warped layer available");return}const p=f;p.setOpacity&&(console.log(`[TripTracker] Setting opacity directly on WarpedMapLayer to ${e(T)}`),p.setOpacity(e(T)));const k=e(r).getLayers().getArray();console.log(`[TripTracker] Total map layers: ${k.length}`);let te=0;k.forEach((B,F)=>{const K=B.getZIndex(),ce=B.constructor.name;console.log(`[TripTracker] Layer ${F}: type=${ce}, zIndex=${K}`),K!==0&&K!==20&&K!==25&&K!==void 0&&(console.log(`[TripTracker] Applying opacity ${e(T)} to layer ${F} (${ce})`),B.setOpacity&&B.setOpacity(e(T)),te++)}),console.log(`[TripTracker] Applied opacity to ${te} warped layers`),e(r).render()}function m(){f&&f.clear(),v(A,null)}async function H(p){const{longitude:k,latitude:te}=p.coords,B=He([k,te]);if(W.setLastKnownPosition({lat:te,lon:k}),D=[...D,B],!L)L=new yt({geometry:new ua(D)}),L.setId("current-track"),_?.addFeature(L);else{const F=L.getGeometry();F&&F.setCoordinates(D)}if(!e(E))v(E,new yt({geometry:new pa(B)})),e(E).setId("current-position"),x?.addFeature(e(E));else{const F=e(E).getGeometry();F&&F.setCoordinates(B)}e(r)&&e(r).getView().animate({center:B,duration:300})}function oe(p){const k=p.detail.mapId;k?pe(k):m()}function le(p){const{bounds:k}=p.detail;if(!e(r)||!k||k.length!==4){console.warn("[TripTracker] Cannot zoom: missing map or bounds");return}const[te,B,F,K]=k,ce=He([te,B]),Ce=He([F,K]),rt=[ce[0],ce[1],Ce[0],Ce[1]];e(r).getView().fit(rt,{padding:[50,50,50,50],duration:1e3}),console.log("[TripTracker] Zoomed to map bounds:",k)}function we(p){v(T,p.detail.opacity),console.log("[TripTracker] Opacity changed to:",e(T))}function Ae(){e(b)==="inactive"&&(D=[],L=null,v(E,null),_?.clear(),x?.clear(),v(S,null),y=Sa({onPosition:H,onError:p=>{v(S,Ta(p)),v(b,"inactive"),y!==null&&(ut(y),y=null)}}),y!==null&&v(b,"active"))}function Me(){y!==null&&(ut(y),y=null),v(b,"inactive"),v(S,null)}function Be(p){if(!e(r))return;const{lat:k,lon:te,name:B,address:F}=p.detail;console.log("[TripTracker] Searching location:",B,k,te,F);const K=F?.city||F?.town||F?.village||F?.municipality;if(K&&e(g).filter(Ce=>Ce.type&&Ce.type.toLowerCase()===K.toLowerCase()).length>0){v(X,K),q={lat:k,lon:te},v(re,!0);return}De(k,te)}function De(p,k){if(!e(r))return;const te=He([k,p]);e(r).getView().animate({center:te,zoom:16,duration:1e3})}function se(p){v(re,!1),p.detail.filter&&e(X)?(v($,e(X)),console.log("[TripTracker] Filtering maps by city:",e(X))):v($,null),q&&De(q.lat,q.lon),v(X,null),q=null}async function I(p){const k=p.detail.city;console.log("[TripTracker] Selected starting city:",k),v($,k);try{const B=await fetch("https://nominatim.openstreetmap.org/search?"+new URLSearchParams({q:k,format:"json",limit:"1"}));if(B.ok){const F=await B.json();if(F.length>0){const{lat:K,lon:ce}=F[0];if(console.log("[TripTracker] Zooming to city:",k,K,ce),e(r)){const Ce=He([parseFloat(ce),parseFloat(K)]);e(r).getView().animate({center:Ce,zoom:14,duration:1e3})}}}}catch(B){console.error("[TripTracker] Failed to geocode city:",B)}const te=e(g).filter(B=>B.type&&B.type.toLowerCase()===k.toLowerCase());if(te.length>0){const B=te.reduce((F,K)=>K.year?F.year?K.year<F.year?K:F:K:F,te[0]);B&&(console.log("[TripTracker] Loading earliest map:",B.name,B.year),pe(B.id))}v(Z,!1),t().hasSeenMapHint||setTimeout(()=>{v(ie,!0)},800)}function ee(){console.log("[TripTracker] Skipped welcome"),v(Z,!1),t().hasSeenMapHint||setTimeout(()=>{v(ie,!0)},800)}function fe(){v(ie,!1),W.setHasSeenMapHint(!0)}_e(()=>e(g),()=>{v(i,Array.from(new Set(e(g).map(p=>p.type).filter(Boolean))).sort())}),_e(()=>(e(r),e(A),e(T)),()=>{e(r)&&e(A)&&(e(T),ne())}),Ve(),ke();var z=Kn(),ue=c(z);Xt(ue,p=>v(d,p),()=>e(d));var be=u(ue,2);{let p=Xe(()=>e(b)==="active");Qa(be,{get isTracking(){return e(p)},get error(){return e(S)},$$events:{start:Ae,stop:Me}})}var he=u(be,2);rn(he,{get isOpen(){return e(ae)},$$events:{select:Be}});var me=u(he,2);qa(me,{get map(){return e(r)},get position(){return e(E)},get heading(){return e(ve)}});var Oe=u(me,2);Ra(Oe,{get maps(){return e(g)},get selected(){return e(A)},get loading(){return e(C)},get filterCity(){return e($)},$$events:{select:oe,zoom:le}});var xe=u(Oe,2);{let p=Xe(()=>e(X)||"");vn(xe,{get cityName(){return e(p)},get isOpen(){return e(re)},$$events:{confirm:se}})}var ze=u(xe,2);fn(ze,{get isOpen(){return e(Z)},get cities(){return e(i)},$$events:{select:I,skip:ee}});var Je=u(ze,2);mn(Je,{get isVisible(){return e(ie)},$$events:{dismiss:fe}});var Qe=u(Je,2);{var ot=p=>{Ka(p,{get opacity(){return e(T)},$$events:{opacityChange:we}})};G(Qe,p=>{e(A)&&p(ot)})}var st=u(Qe,2);{let p=Xe(()=>e(b)==="active"),k=Xe(()=>!!e(A));On(st,{get isTracking(){return e(p)},get error(){return e(S)},get opacity(){return e(T)},get hasMapSelected(){return e(k)},get searchOpen(){return e(ae)},$$events:{startTracking:Ae,stopTracking:Me,opacityChange:we,toggleSearch:()=>v(ae,!e(ae)),locationSelect:Be}})}l(z),h(n,z),Te(),s()}function to(n){Un(n,{})}export{to as component};
