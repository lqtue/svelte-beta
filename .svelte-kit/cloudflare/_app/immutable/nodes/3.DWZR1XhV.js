import"../chunks/DsnmJJEf.js";import{i as Co}from"../chunks/D444ibiU.js";import{p as Mi,b as Nt,s as Po,a as Vr}from"../chunks/7Y9Eh46m.js";import{o as Fo,a as Io,s as z}from"../chunks/CLAw4lq8.js";import{aX as Eo,A as To,L as M,I as _e,J as Mo,y as T,z as q,N as k,x as P,C as Ao,l as t,K as h,D as v,G as m,F as f,bk as Ge,v as st,u as A,q as Ft,bl as wi,bm as Ur}from"../chunks/BIWrGPwp.js";import{i as j}from"../chunks/bLLYHiUB.js";import{S as Hn,c as Lo,a as Do,f as Go,d as Oo,r as Ro,G as No,u as jo,l as Vo,E as Un,b as Xn,g as Uo,h as $o,j as Bo,k as ps,m as zo,n as Yo,o as qo,p as Ho,q as Xo,s as Vi,t as Ui,v as Jo,P as Xt,w as Ko,x as Wo,y as Zo,z as Qo,A as el,B as tl,C as Ai,F as sl,H as nl,I as Wr,J as il,K as hn,L as rl,M as Zr,N as al,T as Li,O as dt,Q as $n,R as It,U as Bn,V as $r,W as $i,X as ol,Y as ll,Z as ki,_ as Tt,$ as jt,a0 as zn,a1 as cl,a2 as dl,a3 as ul,a4 as hl,a5 as fl,a6 as gl,a7 as vl,a8 as vs,a9 as rt,aa as pl,ab as ml,ac as yl,ad as _l,ae as bl,af as Xs,ag as Bi,ah as fs,ai as wl,aj as Os,ak as kl,D as xl,al as xi,am as Si,an as Sl,e as it,i as An,ao as Cl,ap as Pl}from"../chunks/DjeodknY.js";import{a as te,b as Fl,s as bt,r as rs,c as Br,d as Rs}from"../chunks/CNuyH17j.js";import{l as Il,L as Ps,a as El,i as Tl,b as Ml,B as Al,C as Ll,P as Qr,V as js,n as Dl,c as Di,s as ea,I as Gl,M as Et,d as Ol,F as wt,e as Gi,f as zi,p as Rl,g as Nl,h as ta,R as jl,j as Oi,k as zr,m as Vs,o as Vl,q as sa,r as Ul,t as Is,u as Yi,v as qi,w as Hi,x as Xi,y as Ji,E as Ri,z as Ys,A as Yn,D as na,G as ia,H as $l,J as Vn,K as Ki,N as Wi,O as ra,Q as Bl,S as zl,T as Yl,U as ql,W as Ni,X as Us,Y as qn,Z as aa,_ as Hl,$ as Xl,a0 as Yr,a1 as Jl,a2 as Kl,a3 as Wl,a4 as Zl,a5 as Ql,a6 as ec,a7 as tc,a8 as sc,a9 as nc,aa as Ns}from"../chunks/7m7KEctv.js";import{w as oa}from"../chunks/CzxzY2VL.js";class Jn extends Hn{constructor(e,s,n){super(),n!==void 0&&s===void 0?this.setFlatCoordinates(n,e):(s=s||0,this.setCenterAndRadius(e,s,n))}clone(){const e=new Jn(this.flatCoordinates.slice(),void 0,this.layout);return e.applyProperties(this),e}closestPointXY(e,s,n,r){const a=this.flatCoordinates,l=e-a[0],d=s-a[1],p=l*l+d*d;if(p<r){if(p===0)for(let _=0;_<this.stride;++_)n[_]=a[_];else{const _=this.getRadius()/Math.sqrt(p);n[0]=a[0]+_*l,n[1]=a[1]+_*d;for(let y=2;y<this.stride;++y)n[y]=a[y]}return n.length=this.stride,p}return r}containsXY(e,s){const n=this.flatCoordinates,r=e-n[0],a=s-n[1];return r*r+a*a<=this.getRadiusSquared_()}getCenter(){return this.flatCoordinates.slice(0,this.stride)}computeExtent(e){const s=this.flatCoordinates,n=s[this.stride]-s[0];return Lo(s[0]-n,s[1]-n,s[0]+n,s[1]+n,e)}getRadius(){return Math.sqrt(this.getRadiusSquared_())}getRadiusSquared_(){const e=this.flatCoordinates[this.stride]-this.flatCoordinates[0],s=this.flatCoordinates[this.stride+1]-this.flatCoordinates[1];return e*e+s*s}getType(){return"Circle"}intersectsExtent(e){const s=this.getExtent();if(Do(e,s)){const n=this.getCenter();return e[0]<=n[0]&&e[2]>=n[0]||e[1]<=n[1]&&e[3]>=n[1]?!0:Go(e,this.intersectsCoordinate.bind(this))}return!1}setCenter(e){const s=this.stride,n=this.flatCoordinates[s]-this.flatCoordinates[0],r=e.slice();r[s]=r[0]+n;for(let a=1;a<s;++a)r[s+a]=e[a];this.setFlatCoordinates(this.layout,r),this.changed()}setCenterAndRadius(e,s,n){this.setLayout(n,e,0),this.flatCoordinates||(this.flatCoordinates=[]);const r=this.flatCoordinates;let a=Oo(r,0,e,this.stride);r[a++]=r[0]+s;for(let l=1,d=this.stride;l<d;++l)r[a++]=r[l];r.length=a,this.changed()}getCoordinates(){return null}setCoordinates(e,s){}setRadius(e){this.flatCoordinates[this.stride]=this.flatCoordinates[0]+e,this.changed()}rotate(e,s){const n=this.getCenter(),r=this.getStride();this.setCenter(Ro(n,0,n.length,r,e,s,n)),this.changed()}}Jn.prototype.transform;class fn extends No{constructor(e){super(),this.geometries_=e,this.changeEventsKeys_=[],this.listenGeometriesChange_()}unlistenGeometriesChange_(){this.changeEventsKeys_.forEach(jo),this.changeEventsKeys_.length=0}listenGeometriesChange_(){const e=this.geometries_;for(let s=0,n=e.length;s<n;++s)this.changeEventsKeys_.push(Vo(e[s],Un.CHANGE,this.changed,this))}clone(){const e=new fn(Ci(this.geometries_));return e.applyProperties(this),e}closestPointXY(e,s,n,r){if(r<Xn(this.getExtent(),e,s))return r;const a=this.geometries_;for(let l=0,d=a.length;l<d;++l)r=a[l].closestPointXY(e,s,n,r);return r}containsXY(e,s){const n=this.geometries_;for(let r=0,a=n.length;r<a;++r)if(n[r].containsXY(e,s))return!0;return!1}computeExtent(e){Uo(e);const s=this.geometries_;for(let n=0,r=s.length;n<r;++n)$o(e,s[n].getExtent());return e}getGeometries(){return Ci(this.geometries_)}getGeometriesArray(){return this.geometries_}getGeometriesArrayRecursive(){let e=[];const s=this.geometries_;for(let n=0,r=s.length;n<r;++n)s[n].getType()===this.getType()?e=e.concat(s[n].getGeometriesArrayRecursive()):e.push(s[n]);return e}getSimplifiedGeometry(e){if(this.simplifiedGeometryRevision!==this.getRevision()&&(this.simplifiedGeometryMaxMinSquaredTolerance=0,this.simplifiedGeometryRevision=this.getRevision()),e<0||this.simplifiedGeometryMaxMinSquaredTolerance!==0&&e<this.simplifiedGeometryMaxMinSquaredTolerance)return this;const s=[],n=this.geometries_;let r=!1;for(let a=0,l=n.length;a<l;++a){const d=n[a],p=d.getSimplifiedGeometry(e);s.push(p),p!==d&&(r=!0)}return r?new fn(s):(this.simplifiedGeometryMaxMinSquaredTolerance=e,this)}getType(){return"GeometryCollection"}intersectsExtent(e){const s=this.geometries_;for(let n=0,r=s.length;n<r;++n)if(s[n].intersectsExtent(e))return!0;return!1}isEmpty(){return this.geometries_.length===0}rotate(e,s){const n=this.geometries_;for(let r=0,a=n.length;r<a;++r)n[r].rotate(e,s);this.changed()}scale(e,s,n){n||(n=Bo(this.getExtent()));const r=this.geometries_;for(let a=0,l=r.length;a<l;++a)r[a].scale(e,s,n);this.changed()}setGeometries(e){this.setGeometriesArray(Ci(e))}setGeometriesArray(e){this.unlistenGeometriesChange_(),this.geometries_=e,this.listenGeometriesChange_(),this.changed()}applyTransform(e){const s=this.geometries_;for(let n=0,r=s.length;n<r;++n)s[n].applyTransform(e);this.changed()}translate(e,s){const n=this.geometries_;for(let r=0,a=n.length;r<a;++r)n[r].translate(e,s);this.changed()}disposeInternal(){this.unlistenGeometriesChange_(),super.disposeInternal()}}function Ci(c){return c.map(e=>e.clone())}class qs extends Hn{constructor(e,s,n){if(super(),this.ends_=[],this.maxDelta_=-1,this.maxDeltaRevision_=-1,Array.isArray(e[0]))this.setCoordinates(e,s);else if(s!==void 0&&n)this.setFlatCoordinates(s,e),this.ends_=n;else{const r=e,a=[],l=[];for(let p=0,_=r.length;p<_;++p){const y=r[p];ps(a,y.getFlatCoordinates()),l.push(a.length)}const d=r.length===0?this.getLayout():r[0].getLayout();this.setFlatCoordinates(d,a),this.ends_=l}}appendLineString(e){ps(this.flatCoordinates,e.getFlatCoordinates().slice()),this.ends_.push(this.flatCoordinates.length),this.changed()}clone(){const e=new qs(this.flatCoordinates.slice(),this.layout,this.ends_.slice());return e.applyProperties(this),e}closestPointXY(e,s,n,r){return r<Xn(this.getExtent(),e,s)?r:(this.maxDeltaRevision_!=this.getRevision()&&(this.maxDelta_=Math.sqrt(zo(this.flatCoordinates,0,this.ends_,this.stride,0)),this.maxDeltaRevision_=this.getRevision()),Yo(this.flatCoordinates,0,this.ends_,this.stride,this.maxDelta_,!1,e,s,n,r))}getCoordinateAtM(e,s,n){return this.layout!="XYM"&&this.layout!="XYZM"||this.flatCoordinates.length===0?null:(s=s!==void 0?s:!1,n=n!==void 0?n:!1,Il(this.flatCoordinates,0,this.ends_,this.stride,e,s,n))}getCoordinates(){return qo(this.flatCoordinates,0,this.ends_,this.stride)}getEnds(){return this.ends_}getLineString(e){return e<0||this.ends_.length<=e?null:new Ps(this.flatCoordinates.slice(e===0?0:this.ends_[e-1],this.ends_[e]),this.layout)}getLineStrings(){const e=this.flatCoordinates,s=this.ends_,n=this.layout,r=[];let a=0;for(let l=0,d=s.length;l<d;++l){const p=s[l],_=new Ps(e.slice(a,p),n);r.push(_),a=p}return r}getLength(){const e=this.ends_;let s=0,n=0;for(let r=0,a=e.length;r<a;++r)n+=El(this.flatCoordinates,s,e[r],this.stride),s=e[r];return n}getFlatMidpoints(){const e=[],s=this.flatCoordinates;let n=0;const r=this.ends_,a=this.stride;for(let l=0,d=r.length;l<d;++l){const p=r[l],_=Tl(s,n,p,a,.5);ps(e,_),n=p}return e}getSimplifiedGeometryInternal(e){const s=[],n=[];return s.length=Ho(this.flatCoordinates,0,this.ends_,this.stride,e,s,0,n),new qs(s,"XY",n)}getType(){return"MultiLineString"}intersectsExtent(e){return Xo(this.flatCoordinates,0,this.ends_,this.stride,e)}setCoordinates(e,s){this.setLayout(s,e,2),this.flatCoordinates||(this.flatCoordinates=[]);const n=Vi(this.flatCoordinates,0,e,this.stride,this.ends_);this.flatCoordinates.length=n.length===0?0:n[n.length-1],this.changed()}}class gn extends Hn{constructor(e,s){super(),s&&!Array.isArray(e[0])?this.setFlatCoordinates(s,e):this.setCoordinates(e,s)}appendPoint(e){ps(this.flatCoordinates,e.getFlatCoordinates()),this.changed()}clone(){const e=new gn(this.flatCoordinates.slice(),this.layout);return e.applyProperties(this),e}closestPointXY(e,s,n,r){if(r<Xn(this.getExtent(),e,s))return r;const a=this.flatCoordinates,l=this.stride;for(let d=0,p=a.length;d<p;d+=l){const _=Ui(e,s,a[d],a[d+1]);if(_<r){r=_;for(let y=0;y<l;++y)n[y]=a[d+y];n.length=l}}return r}getCoordinates(){return Jo(this.flatCoordinates,0,this.flatCoordinates.length,this.stride)}getPoint(e){const s=this.flatCoordinates.length/this.stride;return e<0||s<=e?null:new Xt(this.flatCoordinates.slice(e*this.stride,(e+1)*this.stride),this.layout)}getPoints(){const e=this.flatCoordinates,s=this.layout,n=this.stride,r=[];for(let a=0,l=e.length;a<l;a+=n){const d=new Xt(e.slice(a,a+n),s);r.push(d)}return r}getType(){return"MultiPoint"}intersectsExtent(e){const s=this.flatCoordinates,n=this.stride;for(let r=0,a=s.length;r<a;r+=n){const l=s[r],d=s[r+1];if(Ko(e,l,d))return!0}return!1}setCoordinates(e,s){this.setLayout(s,e,1),this.flatCoordinates||(this.flatCoordinates=[]),this.flatCoordinates.length=Wo(this.flatCoordinates,0,e,this.stride),this.changed()}}class Hs extends Hn{constructor(e,s,n){if(super(),this.endss_=[],this.flatInteriorPointsRevision_=-1,this.flatInteriorPoints_=null,this.maxDelta_=-1,this.maxDeltaRevision_=-1,this.orientedRevision_=-1,this.orientedFlatCoordinates_=null,!n&&!Array.isArray(e[0])){const r=e,a=[],l=[];for(let d=0,p=r.length;d<p;++d){const _=r[d],y=a.length,E=_.getEnds();for(let I=0,L=E.length;I<L;++I)E[I]+=y;ps(a,_.getFlatCoordinates()),l.push(E)}s=r.length===0?this.getLayout():r[0].getLayout(),e=a,n=l}s!==void 0&&n?(this.setFlatCoordinates(s,e),this.endss_=n):this.setCoordinates(e,s)}appendPolygon(e){let s;if(!this.flatCoordinates)this.flatCoordinates=e.getFlatCoordinates().slice(),s=e.getEnds().slice(),this.endss_.push();else{const n=this.flatCoordinates.length;ps(this.flatCoordinates,e.getFlatCoordinates()),s=e.getEnds().slice();for(let r=0,a=s.length;r<a;++r)s[r]+=n}this.endss_.push(s),this.changed()}clone(){const e=this.endss_.length,s=new Array(e);for(let r=0;r<e;++r)s[r]=this.endss_[r].slice();const n=new Hs(this.flatCoordinates.slice(),this.layout,s);return n.applyProperties(this),n}closestPointXY(e,s,n,r){return r<Xn(this.getExtent(),e,s)?r:(this.maxDeltaRevision_!=this.getRevision()&&(this.maxDelta_=Math.sqrt(Zo(this.flatCoordinates,0,this.endss_,this.stride,0)),this.maxDeltaRevision_=this.getRevision()),Qo(this.getOrientedFlatCoordinates(),0,this.endss_,this.stride,this.maxDelta_,!0,e,s,n,r))}containsXY(e,s){return el(this.getOrientedFlatCoordinates(),0,this.endss_,this.stride,e,s)}getArea(){return tl(this.getOrientedFlatCoordinates(),0,this.endss_,this.stride)}getCoordinates(e){let s;return e!==void 0?(s=this.getOrientedFlatCoordinates().slice(),Ai(s,0,this.endss_,this.stride,e)):s=this.flatCoordinates,sl(s,0,this.endss_,this.stride)}getEndss(){return this.endss_}getFlatInteriorPoints(){if(this.flatInteriorPointsRevision_!=this.getRevision()){const e=Ml(this.flatCoordinates,0,this.endss_,this.stride);this.flatInteriorPoints_=nl(this.getOrientedFlatCoordinates(),0,this.endss_,this.stride,e),this.flatInteriorPointsRevision_=this.getRevision()}return this.flatInteriorPoints_}getInteriorPoints(){return new gn(this.getFlatInteriorPoints().slice(),"XYM")}getOrientedFlatCoordinates(){if(this.orientedRevision_!=this.getRevision()){const e=this.flatCoordinates;Wr(e,0,this.endss_,this.stride)?this.orientedFlatCoordinates_=e:(this.orientedFlatCoordinates_=e.slice(),this.orientedFlatCoordinates_.length=Ai(this.orientedFlatCoordinates_,0,this.endss_,this.stride)),this.orientedRevision_=this.getRevision()}return this.orientedFlatCoordinates_}getSimplifiedGeometryInternal(e){const s=[],n=[];return s.length=il(this.flatCoordinates,0,this.endss_,this.stride,Math.sqrt(e),s,0,n),new Hs(s,"XY",n)}getPolygon(e){if(e<0||this.endss_.length<=e)return null;let s;if(e===0)s=0;else{const a=this.endss_[e-1];s=a[a.length-1]}const n=this.endss_[e].slice(),r=n[n.length-1];if(s!==0)for(let a=0,l=n.length;a<l;++a)n[a]-=s;return new hn(this.flatCoordinates.slice(s,r),this.layout,n)}getPolygons(){const e=this.layout,s=this.flatCoordinates,n=this.endss_,r=[];let a=0;for(let l=0,d=n.length;l<d;++l){const p=n[l].slice(),_=p[p.length-1];if(a!==0)for(let E=0,I=p.length;E<I;++E)p[E]-=a;const y=new hn(s.slice(a,_),e,p);r.push(y),a=_}return r}getType(){return"MultiPolygon"}intersectsExtent(e){return rl(this.getOrientedFlatCoordinates(),0,this.endss_,this.stride,e)}setCoordinates(e,s){this.setLayout(s,e,3),this.flatCoordinates||(this.flatCoordinates=[]);const n=Zr(this.flatCoordinates,0,e,this.stride,this.endss_);if(n.length===0)this.flatCoordinates.length=0;else{const r=n[n.length-1];this.flatCoordinates.length=r.length===0?0:r[r.length-1]}this.changed()}}class Zi extends Al{constructor(e){super(e)}createRenderer(){return new Ll(this)}}const Ln={DRAWSTART:"drawstart",DRAWEND:"drawend",DRAWABORT:"drawabort"};class Dn extends $i{constructor(e,s){super(e),this.feature=s}}function ic(c,e){const s=[];for(let n=0;n<e.length;++n){const a=e[n].getGeometry();la(c,a,s)}return s}function Gn(c,e){return Ui(c[0],c[1],e[0],e[1])}function $s(c,e){const s=c.length;return e<0?c[e+s]:e>=s?c[e-s]:c[e]}function On(c,e,s){let n,r;e<s?(n=e,r=s):(n=s,r=e);const a=Math.ceil(n),l=Math.floor(r);if(a>l){const p=Bs(c,n),_=Bs(c,r);return Gn(p,_)}let d=0;if(n<a){const p=Bs(c,n),_=$s(c,a);d+=Gn(p,_)}if(l<r){const p=$s(c,l),_=Bs(c,r);d+=Gn(p,_)}for(let p=a;p<l-1;++p){const _=$s(c,p),y=$s(c,p+1);d+=Gn(_,y)}return d}function la(c,e,s){if(e instanceof Ps){Rn(c,e.getCoordinates(),!1,s);return}if(e instanceof qs){const n=e.getCoordinates();for(let r=0,a=n.length;r<a;++r)Rn(c,n[r],!1,s);return}if(e instanceof hn){const n=e.getCoordinates();for(let r=0,a=n.length;r<a;++r)Rn(c,n[r],!0,s);return}if(e instanceof Hs){const n=e.getCoordinates();for(let r=0,a=n.length;r<a;++r){const l=n[r];for(let d=0,p=l.length;d<p;++d)Rn(c,l[d],!0,s)}return}if(e instanceof fn){const n=e.getGeometries();for(let r=0;r<n.length;++r)la(c,n[r],s);return}}const Pi={index:-1,endIndex:NaN};function rc(c,e,s,n){const r=c[0],a=c[1];let l=1/0,d=-1,p=NaN;for(let E=0;E<e.targets.length;++E){const I=e.targets[E],L=I.coordinates;let R=1/0,Ee;for(let He=0;He<L.length-1;++He){const ut=L[He],os=L[He+1],Vt=ca(r,a,ut,os);Vt.squaredDistance<R&&(R=Vt.squaredDistance,Ee=He+Vt.along)}R<l&&(l=R,I.ring&&e.targetIndex===E&&(I.endIndex>I.startIndex?Ee<I.startIndex&&(Ee+=L.length):I.endIndex<I.startIndex&&Ee>I.startIndex&&(Ee-=L.length)),p=Ee,d=E)}const _=e.targets[d];let y=_.ring;if(e.targetIndex===d&&y){const E=Bs(_.coordinates,p),I=s.getPixelFromCoordinate(E);Bn(I,e.startPx)>n&&(y=!1)}if(y){const E=_.coordinates,I=E.length,L=_.startIndex,R=p;if(L<R){const Ee=On(E,L,R);On(E,L,R-I)<Ee&&(p-=I)}else{const Ee=On(E,L,R);On(E,L,R+I)<Ee&&(p+=I)}}return Pi.index=d,Pi.endIndex=p,Pi}function Rn(c,e,s,n){const r=c[0],a=c[1];for(let l=0,d=e.length-1;l<d;++l){const p=e[l],_=e[l+1],y=ca(r,a,p,_);if(y.squaredDistance===0){const E=l+y.along;n.push({coordinates:e,ring:s,startIndex:E,endIndex:E});return}}}const Fi={along:0,squaredDistance:0};function ca(c,e,s,n){const r=s[0],a=s[1],l=n[0],d=n[1],p=l-r,_=d-a;let y=0,E=r,I=a;return(p!==0||_!==0)&&(y=ll(((c-r)*p+(e-a)*_)/(p*p+_*_),0,1),E+=p*y,I+=_*y),Fi.along=y,Fi.squaredDistance=ol(Ui(c,e,E,I),10),Fi}function Bs(c,e){const s=c.length;let n=Math.floor(e);const r=e-n;n>=s?n-=s:n<0&&(n+=s);let a=n+1;a>=s&&(a-=s);const l=c[n],d=l[0],p=l[1],_=c[a],y=_[0]-d,E=_[1]-p;return[d+y*r,p+E*r]}class ac extends Qr{constructor(e){const s=e;s.stopDown||(s.stopDown=al),super(s),this.on,this.once,this.un,this.shouldHandle_=!1,this.downPx_=null,this.downTimeout_,this.lastDragTime_,this.pointerType_,this.freehand_=!1,this.source_=e.source?e.source:null,this.features_=e.features?e.features:null,this.snapTolerance_=e.snapTolerance?e.snapTolerance:12,this.type_=e.type,this.mode_=lc(this.type_),this.stopClick_=!!e.stopClick,this.minPoints_=e.minPoints?e.minPoints:this.mode_==="Polygon"?3:2,this.maxPoints_=this.mode_==="Circle"?2:e.maxPoints?e.maxPoints:1/0,this.finishCondition_=e.finishCondition?e.finishCondition:Li,this.geometryLayout_=e.geometryLayout?e.geometryLayout:"XY";let n=e.geometryFunction;if(!n){const r=this.mode_;if(r==="Circle")n=(a,l,d)=>{const p=l||new Jn([NaN,NaN]),_=dt(a[0]),y=$n(_,dt(a[a.length-1]));return p.setCenterAndRadius(_,Math.sqrt(y),this.geometryLayout_),p};else{let a;r==="Point"?a=Xt:r==="LineString"?a=Ps:r==="Polygon"&&(a=hn),n=(l,d,p)=>(d?r==="Polygon"?l[0].length?d.setCoordinates([l[0].concat([l[0][0]])],this.geometryLayout_):d.setCoordinates([],this.geometryLayout_):d.setCoordinates(l,this.geometryLayout_):d=new a(l,this.geometryLayout_),d)}}this.geometryFunction_=n,this.dragVertexDelay_=e.dragVertexDelay!==void 0?e.dragVertexDelay:500,this.finishCoordinate_=null,this.sketchFeature_=null,this.sketchPoint_=null,this.sketchCoords_=null,this.sketchLine_=null,this.sketchLineCoords_=null,this.squaredClickTolerance_=e.clickTolerance?e.clickTolerance*e.clickTolerance:36,this.overlay_=new Zi({source:new js({useSpatialIndex:!1,wrapX:e.wrapX?e.wrapX:!1}),style:e.style?e.style:oc(),updateWhileInteracting:!0}),this.geometryName_=e.geometryName,this.condition_=e.condition?e.condition:Dl,this.freehandCondition_,e.freehand?this.freehandCondition_=Di:this.freehandCondition_=e.freehandCondition?e.freehandCondition:ea,this.traceCondition_,this.setTrace(e.trace||!1),this.traceState_={active:!1},this.traceSource_=e.traceSource||e.source||null,this.addChangeListener(Gl.ACTIVE,this.updateState_)}setTrace(e){let s;e?e===!0?s=Di:s=e:s=Gi,this.traceCondition_=s}setMap(e){super.setMap(e),this.updateState_()}getOverlay(){return this.overlay_}handleEvent(e){e.originalEvent.type===Un.CONTEXTMENU&&e.originalEvent.preventDefault(),this.freehand_=this.mode_!=="Point"&&this.freehandCondition_(e);let s=e.type===Et.POINTERMOVE,n=!0;return!this.freehand_&&this.lastDragTime_&&e.type===Et.POINTERDRAG&&(Date.now()-this.lastDragTime_>=this.dragVertexDelay_?(this.downPx_=e.pixel,this.shouldHandle_=!this.freehand_,s=!0):this.lastDragTime_=void 0,this.shouldHandle_&&this.downTimeout_!==void 0&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0)),this.freehand_&&e.type===Et.POINTERDRAG&&this.sketchFeature_!==null?(this.addToDrawing_(e.coordinate),n=!1):this.freehand_&&e.type===Et.POINTERDOWN?n=!1:s&&this.getPointerCount()<2?(n=e.type===Et.POINTERMOVE,n&&this.freehand_?(this.handlePointerMove_(e),this.shouldHandle_&&e.originalEvent.preventDefault()):(e.originalEvent.pointerType==="mouse"||e.type===Et.POINTERDRAG&&this.downTimeout_===void 0)&&this.handlePointerMove_(e)):e.type===Et.DBLCLICK&&(n=!1),super.handleEvent(e)&&n}handleDownEvent(e){return this.shouldHandle_=!this.freehand_,this.freehand_?(this.downPx_=e.pixel,this.finishCoordinate_||this.startDrawing_(e.coordinate),!0):this.condition_(e)?(this.lastDragTime_=Date.now(),this.downTimeout_=setTimeout(()=>{this.handlePointerMove_(new Ol(Et.POINTERMOVE,e.map,e.originalEvent,!1,e.frameState))},this.dragVertexDelay_),this.downPx_=e.pixel,!0):(this.lastDragTime_=void 0,!1)}deactivateTrace_(){this.traceState_={active:!1}}toggleTraceState_(e){if(!this.traceSource_||!this.traceCondition_(e))return;if(this.traceState_.active){this.deactivateTrace_();return}const s=this.getMap(),n=s.getCoordinateFromPixel([e.pixel[0]-this.snapTolerance_,e.pixel[1]+this.snapTolerance_]),r=s.getCoordinateFromPixel([e.pixel[0]+this.snapTolerance_,e.pixel[1]-this.snapTolerance_]),a=It([n,r]),l=this.traceSource_.getFeaturesInExtent(a);if(l.length===0)return;const d=ic(e.coordinate,l);d.length&&(this.traceState_={active:!0,startPx:e.pixel.slice(),targets:d,targetIndex:-1})}addOrRemoveTracedCoordinates_(e,s){const n=e.startIndex<=e.endIndex,r=e.startIndex<=s;n===r?n&&s>e.endIndex||!n&&s<e.endIndex?this.addTracedCoordinates_(e,e.endIndex,s):(n&&s<e.endIndex||!n&&s>e.endIndex)&&this.removeTracedCoordinates_(s,e.endIndex):(this.removeTracedCoordinates_(e.startIndex,e.endIndex),this.addTracedCoordinates_(e,e.startIndex,s))}removeTracedCoordinates_(e,s){if(e===s)return;let n=0;if(e<s){const r=Math.ceil(e);let a=Math.floor(s);a===s&&(a-=1),n=a-r+1}else{const r=Math.floor(e);let a=Math.ceil(s);a===s&&(a+=1),n=r-a+1}n>0&&this.removeLastPoints_(n)}addTracedCoordinates_(e,s,n){if(s===n)return;const r=[];if(s<n){const a=Math.ceil(s);let l=Math.floor(n);l===n&&(l-=1);for(let d=a;d<=l;++d)r.push($s(e.coordinates,d))}else{const a=Math.floor(s);let l=Math.ceil(n);l===n&&(l+=1);for(let d=a;d>=l;--d)r.push($s(e.coordinates,d))}r.length&&this.appendCoordinates(r)}updateTrace_(e){const s=this.traceState_;if(!s.active||s.targetIndex===-1&&Bn(s.startPx,e.pixel)<this.snapTolerance_)return;const n=rc(e.coordinate,s,this.getMap(),this.snapTolerance_);if(s.targetIndex!==n.index){if(s.targetIndex!==-1){const p=s.targets[s.targetIndex];this.removeTracedCoordinates_(p.startIndex,p.endIndex)}const d=s.targets[n.index];this.addTracedCoordinates_(d,d.startIndex,n.endIndex)}else{const d=s.targets[s.targetIndex];this.addOrRemoveTracedCoordinates_(d,n.endIndex)}s.targetIndex=n.index;const r=s.targets[s.targetIndex];r.endIndex=n.endIndex;const a=Bs(r.coordinates,r.endIndex),l=this.getMap().getPixelFromCoordinate(a);e.coordinate=a,e.pixel=[Math.round(l[0]),Math.round(l[1])]}handleUpEvent(e){let s=!0;if(this.getPointerCount()===0){this.downTimeout_&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0),this.handlePointerMove_(e);const n=this.traceState_.active;if(this.toggleTraceState_(e),this.shouldHandle_){const r=!this.finishCoordinate_;r&&this.startDrawing_(e.coordinate),!r&&this.freehand_?this.finishDrawing():!this.freehand_&&(!r||this.mode_==="Point")&&(this.atFinish_(e.pixel,n)?this.finishCondition_(e)&&this.finishDrawing():this.addToDrawing_(e.coordinate)),s=!1}else this.freehand_&&this.abortDrawing()}return!s&&this.stopClick_&&e.preventDefault(),s}handlePointerMove_(e){if(this.pointerType_=e.originalEvent.pointerType,this.downPx_&&(!this.freehand_&&this.shouldHandle_||this.freehand_&&!this.shouldHandle_)){const s=this.downPx_,n=e.pixel,r=s[0]-n[0],a=s[1]-n[1],l=r*r+a*a;if(this.shouldHandle_=this.freehand_?l>this.squaredClickTolerance_:l<=this.squaredClickTolerance_,!this.shouldHandle_)return}if(!this.finishCoordinate_){this.createOrUpdateSketchPoint_(e.coordinate.slice());return}this.updateTrace_(e),this.modifyDrawing_(e.coordinate)}atFinish_(e,s){let n=!1;if(this.sketchFeature_){let r=!1,a=[this.finishCoordinate_];const l=this.mode_;if(l==="Point")n=!0;else if(l==="Circle")n=this.sketchCoords_.length===2;else if(l==="LineString")r=!s&&this.sketchCoords_.length>this.minPoints_;else if(l==="Polygon"){const d=this.sketchCoords_;r=d[0].length>this.minPoints_,a=[d[0][0],d[0][d[0].length-2]],s?a=[d[0][0]]:a=[d[0][0],d[0][d[0].length-2]]}if(r){const d=this.getMap();for(let p=0,_=a.length;p<_;p++){const y=a[p],E=d.getPixelFromCoordinate(y),I=e[0]-E[0],L=e[1]-E[1],R=this.freehand_?1:this.snapTolerance_;if(n=Math.sqrt(I*I+L*L)<=R,n){this.finishCoordinate_=y;break}}}}return n}createOrUpdateSketchPoint_(e){this.sketchPoint_?this.sketchPoint_.getGeometry().setCoordinates(e):(this.sketchPoint_=new wt(new Xt(e)),this.updateSketchFeatures_())}createOrUpdateCustomSketchLine_(e){this.sketchLine_||(this.sketchLine_=new wt);const s=e.getLinearRing(0);let n=this.sketchLine_.getGeometry();n?(n.setFlatCoordinates(s.getLayout(),s.getFlatCoordinates()),n.changed()):(n=new Ps(s.getFlatCoordinates(),s.getLayout()),this.sketchLine_.setGeometry(n))}startDrawing_(e){const s=this.getMap().getView().getProjection(),n=$r(this.geometryLayout_);for(;e.length<n;)e.push(0);this.finishCoordinate_=e,this.mode_==="Point"?this.sketchCoords_=e.slice():this.mode_==="Polygon"?(this.sketchCoords_=[[e.slice(),e.slice()]],this.sketchLineCoords_=this.sketchCoords_[0]):this.sketchCoords_=[e.slice(),e.slice()],this.sketchLineCoords_&&(this.sketchLine_=new wt(new Ps(this.sketchLineCoords_)));const r=this.geometryFunction_(this.sketchCoords_,void 0,s);this.sketchFeature_=new wt,this.geometryName_&&this.sketchFeature_.setGeometryName(this.geometryName_),this.sketchFeature_.setGeometry(r),this.updateSketchFeatures_(),this.dispatchEvent(new Dn(Ln.DRAWSTART,this.sketchFeature_))}modifyDrawing_(e){const s=this.getMap(),n=this.sketchFeature_.getGeometry(),r=s.getView().getProjection(),a=$r(this.geometryLayout_);let l,d;for(;e.length<a;)e.push(0);this.mode_==="Point"?d=this.sketchCoords_:this.mode_==="Polygon"?(l=this.sketchCoords_[0],d=l[l.length-1],this.atFinish_(s.getPixelFromCoordinate(e))&&(e=this.finishCoordinate_.slice())):(l=this.sketchCoords_,d=l[l.length-1]),d[0]=e[0],d[1]=e[1],this.geometryFunction_(this.sketchCoords_,n,r),this.sketchPoint_&&this.sketchPoint_.getGeometry().setCoordinates(e),n.getType()==="Polygon"&&this.mode_!=="Polygon"?this.createOrUpdateCustomSketchLine_(n):this.sketchLineCoords_&&this.sketchLine_.getGeometry().setCoordinates(this.sketchLineCoords_),this.updateSketchFeatures_()}addToDrawing_(e){const s=this.sketchFeature_.getGeometry(),n=this.getMap().getView().getProjection();let r,a;const l=this.mode_;return l==="LineString"||l==="Circle"?(this.finishCoordinate_=e.slice(),a=this.sketchCoords_,a.length>=this.maxPoints_&&(this.freehand_?a.pop():r=!0),a.push(e.slice()),this.geometryFunction_(a,s,n)):l==="Polygon"&&(a=this.sketchCoords_[0],a.length>=this.maxPoints_&&(this.freehand_?a.pop():r=!0),a.push(e.slice()),r&&(this.finishCoordinate_=a[0]),this.geometryFunction_(this.sketchCoords_,s,n)),this.createOrUpdateSketchPoint_(e.slice()),this.updateSketchFeatures_(),r?this.finishDrawing():this.sketchFeature_}removeLastPoints_(e){if(!this.sketchFeature_)return;const s=this.sketchFeature_.getGeometry(),n=this.getMap().getView().getProjection(),r=this.mode_;for(let a=0;a<e;++a){let l;if(r==="LineString"||r==="Circle"){if(l=this.sketchCoords_,l.splice(-2,1),l.length>=2){this.finishCoordinate_=l[l.length-2].slice();const d=this.finishCoordinate_.slice();l[l.length-1]=d,this.createOrUpdateSketchPoint_(d)}this.geometryFunction_(l,s,n),s.getType()==="Polygon"&&this.sketchLine_&&this.createOrUpdateCustomSketchLine_(s)}else if(r==="Polygon"){l=this.sketchCoords_[0],l.splice(-2,1);const d=this.sketchLine_.getGeometry();if(l.length>=2){const p=l[l.length-2].slice();l[l.length-1]=p,this.createOrUpdateSketchPoint_(p)}d.setCoordinates(l),this.geometryFunction_(this.sketchCoords_,s,n)}if(l.length===1){this.abortDrawing();break}}this.updateSketchFeatures_()}removeLastPoint(){this.removeLastPoints_(1)}finishDrawing(){const e=this.abortDrawing_();if(!e)return null;let s=this.sketchCoords_;const n=e.getGeometry(),r=this.getMap().getView().getProjection();return this.mode_==="LineString"?(s.pop(),this.geometryFunction_(s,n,r)):this.mode_==="Polygon"&&(s[0].pop(),this.geometryFunction_(s,n,r),s=n.getCoordinates()),this.type_==="MultiPoint"?e.setGeometry(new gn([s])):this.type_==="MultiLineString"?e.setGeometry(new qs([s])):this.type_==="MultiPolygon"&&e.setGeometry(new Hs([s])),this.dispatchEvent(new Dn(Ln.DRAWEND,e)),this.features_&&this.features_.push(e),this.source_&&this.source_.addFeature(e),e}abortDrawing_(){this.finishCoordinate_=null;const e=this.sketchFeature_;return this.sketchFeature_=null,this.sketchPoint_=null,this.sketchLine_=null,this.overlay_.getSource().clear(!0),this.deactivateTrace_(),e}abortDrawing(){const e=this.abortDrawing_();e&&this.dispatchEvent(new Dn(Ln.DRAWABORT,e))}appendCoordinates(e){const s=this.mode_,n=!this.sketchFeature_;n&&this.startDrawing_(e[0]);let r;if(s==="LineString"||s==="Circle")r=this.sketchCoords_;else if(s==="Polygon")r=this.sketchCoords_&&this.sketchCoords_.length?this.sketchCoords_[0]:[];else return;n&&r.shift(),r.pop();for(let l=0;l<e.length;l++)this.addToDrawing_(e[l]);const a=e[e.length-1];this.sketchFeature_=this.addToDrawing_(a),this.modifyDrawing_(a)}extend(e){const n=e.getGeometry();this.sketchFeature_=e,this.sketchCoords_=n.getCoordinates();const r=this.sketchCoords_[this.sketchCoords_.length-1];this.finishCoordinate_=r.slice(),this.sketchCoords_.push(r.slice()),this.sketchPoint_=new wt(new Xt(r)),this.updateSketchFeatures_(),this.dispatchEvent(new Dn(Ln.DRAWSTART,this.sketchFeature_))}updateSketchFeatures_(){const e=[];this.sketchFeature_&&e.push(this.sketchFeature_),this.sketchLine_&&e.push(this.sketchLine_),this.sketchPoint_&&e.push(this.sketchPoint_);const s=this.overlay_.getSource();s.clear(!0),s.addFeatures(e)}updateState_(){const e=this.getMap(),s=this.getActive();(!e||!s)&&this.abortDrawing(),this.overlay_.setMap(s?e:null)}}function oc(){const c=zi();return function(e,s){return c[e.getGeometry().getType()]}}function lc(c){switch(c){case"Point":case"MultiPoint":return"Point";case"LineString":case"MultiLineString":return"LineString";case"Polygon":case"MultiPolygon":return"Polygon";case"Circle":return"Circle";default:throw new Error("Invalid type: "+c)}}const qr=0,un=1,Hr=[0,0,0,0],zs=[],Ii={MODIFYSTART:"modifystart",MODIFYEND:"modifyend"};class Ei extends $i{constructor(e,s,n){super(e),this.features=s,this.mapBrowserEvent=n}}class cc extends Qr{constructor(e){super(e),this.on,this.once,this.un,this.boundHandleFeatureChange_=this.handleFeatureChange_.bind(this),this.condition_=e.condition?e.condition:Rl,this.defaultDeleteCondition_=function(n){return Nl(n)&&ta(n)},this.deleteCondition_=e.deleteCondition?e.deleteCondition:this.defaultDeleteCondition_,this.insertVertexCondition_=e.insertVertexCondition?e.insertVertexCondition:Di,this.vertexFeature_=null,this.vertexSegments_=null,this.lastPixel_=[0,0],this.ignoreNextSingleClick_=!1,this.featuresBeingModified_=null,this.rBush_=new jl,this.pixelTolerance_=e.pixelTolerance!==void 0?e.pixelTolerance:10,this.snappedToVertex_=!1,this.changingFeature_=!1,this.dragSegments_=[],this.overlay_=new Zi({source:new js({useSpatialIndex:!1,wrapX:!!e.wrapX}),style:e.style?e.style:uc(),updateWhileAnimating:!0,updateWhileInteracting:!0}),this.SEGMENT_WRITERS_={Point:this.writePointGeometry_.bind(this),LineString:this.writeLineStringGeometry_.bind(this),LinearRing:this.writeLineStringGeometry_.bind(this),Polygon:this.writePolygonGeometry_.bind(this),MultiPoint:this.writeMultiPointGeometry_.bind(this),MultiLineString:this.writeMultiLineStringGeometry_.bind(this),MultiPolygon:this.writeMultiPolygonGeometry_.bind(this),Circle:this.writeCircleGeometry_.bind(this),GeometryCollection:this.writeGeometryCollectionGeometry_.bind(this)},this.source_=null,this.hitDetection_=null;let s;if(e.features?s=e.features:e.source&&(this.source_=e.source,s=new Oi(this.source_.getFeatures()),this.source_.addEventListener(zr.ADDFEATURE,this.handleSourceAdd_.bind(this)),this.source_.addEventListener(zr.REMOVEFEATURE,this.handleSourceRemove_.bind(this))),!s)throw new Error("The modify interaction requires features, a source or a layer");e.hitDetection&&(this.hitDetection_=e.hitDetection),this.features_=s,this.features_.forEach(this.addFeature_.bind(this)),this.features_.addEventListener(Vs.ADD,this.handleFeatureAdd_.bind(this)),this.features_.addEventListener(Vs.REMOVE,this.handleFeatureRemove_.bind(this)),this.lastPointerEvent_=null,this.delta_=[0,0],this.snapToPointer_=e.snapToPointer===void 0?!this.hitDetection_:e.snapToPointer}addFeature_(e){const s=e.getGeometry();if(s){const r=this.SEGMENT_WRITERS_[s.getType()];r&&r(e,s)}const n=this.getMap();n&&n.isRendered()&&this.getActive()&&this.handlePointerAtPixel_(n.getCoordinateFromPixel(this.lastPixel_)),e.addEventListener(Un.CHANGE,this.boundHandleFeatureChange_)}willModifyFeatures_(e,s){if(!this.featuresBeingModified_){this.featuresBeingModified_=new Oi;const n=this.featuresBeingModified_.getArray();for(let r=0,a=s.length;r<a;++r){const l=s[r].feature;l&&!n.includes(l)&&this.featuresBeingModified_.push(l)}this.featuresBeingModified_.getLength()===0?this.featuresBeingModified_=null:this.dispatchEvent(new Ei(Ii.MODIFYSTART,this.featuresBeingModified_,e))}}removeFeature_(e){this.removeFeatureSegmentData_(e),this.vertexFeature_&&this.features_.getLength()===0&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),e.removeEventListener(Un.CHANGE,this.boundHandleFeatureChange_)}removeFeatureSegmentData_(e){const s=this.rBush_,n=[];s.forEach(function(r){e===r.feature&&n.push(r)});for(let r=n.length-1;r>=0;--r){const a=n[r];for(let l=this.dragSegments_.length-1;l>=0;--l)this.dragSegments_[l][0]===a&&this.dragSegments_.splice(l,1);s.remove(a)}}setActive(e){this.vertexFeature_&&!e&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),super.setActive(e)}setMap(e){this.overlay_.setMap(e),super.setMap(e)}getOverlay(){return this.overlay_}handleSourceAdd_(e){e.feature&&this.features_.push(e.feature)}handleSourceRemove_(e){e.feature&&this.features_.remove(e.feature)}handleFeatureAdd_(e){this.addFeature_(e.element)}handleFeatureChange_(e){if(!this.changingFeature_){const s=e.target;this.removeFeature_(s),this.addFeature_(s)}}handleFeatureRemove_(e){this.removeFeature_(e.element)}writePointGeometry_(e,s){const n=s.getCoordinates(),r={feature:e,geometry:s,segment:[n,n]};this.rBush_.insert(s.getExtent(),r)}writeMultiPointGeometry_(e,s){const n=s.getCoordinates();for(let r=0,a=n.length;r<a;++r){const l=n[r],d={feature:e,geometry:s,depth:[r],index:r,segment:[l,l]};this.rBush_.insert(s.getExtent(),d)}}writeLineStringGeometry_(e,s){const n=s.getCoordinates();for(let r=0,a=n.length-1;r<a;++r){const l=n.slice(r,r+2),d={feature:e,geometry:s,index:r,segment:l};this.rBush_.insert(It(l),d)}}writeMultiLineStringGeometry_(e,s){const n=s.getCoordinates();for(let r=0,a=n.length;r<a;++r){const l=n[r];for(let d=0,p=l.length-1;d<p;++d){const _=l.slice(d,d+2),y={feature:e,geometry:s,depth:[r],index:d,segment:_};this.rBush_.insert(It(_),y)}}}writePolygonGeometry_(e,s){const n=s.getCoordinates();for(let r=0,a=n.length;r<a;++r){const l=n[r];for(let d=0,p=l.length-1;d<p;++d){const _=l.slice(d,d+2),y={feature:e,geometry:s,depth:[r],index:d,segment:_};this.rBush_.insert(It(_),y)}}}writeMultiPolygonGeometry_(e,s){const n=s.getCoordinates();for(let r=0,a=n.length;r<a;++r){const l=n[r];for(let d=0,p=l.length;d<p;++d){const _=l[d];for(let y=0,E=_.length-1;y<E;++y){const I=_.slice(y,y+2),L={feature:e,geometry:s,depth:[d,r],index:y,segment:I};this.rBush_.insert(It(I),L)}}}}writeCircleGeometry_(e,s){const n=s.getCenter(),r={feature:e,geometry:s,index:qr,segment:[n,n]},a={feature:e,geometry:s,index:un,segment:[n,n]},l=[r,a];r.featureSegments=l,a.featureSegments=l,this.rBush_.insert(ki(n),r);let d=s;this.rBush_.insert(d.getExtent(),a)}writeGeometryCollectionGeometry_(e,s){const n=s.getGeometriesArray();for(let r=0;r<n.length;++r){const a=n[r],l=this.SEGMENT_WRITERS_[a.getType()];l(e,a)}}createOrUpdateVertexFeature_(e,s,n,r){let a=this.vertexFeature_;return a?a.getGeometry().setCoordinates(e):(a=new wt(new Xt(e)),this.vertexFeature_=a,this.overlay_.getSource().addFeature(a)),a.set("features",s),a.set("geometries",n),a.set("existing",r),a}handleEvent(e){if(!e.originalEvent)return!0;this.lastPointerEvent_=e;let s;return!e.map.getView().getInteracting()&&e.type==Et.POINTERMOVE&&!this.handlingDownUpSequence&&this.handlePointerMove_(e),this.vertexFeature_&&this.deleteCondition_(e)&&(e.type!=Et.SINGLECLICK||!this.ignoreNextSingleClick_?s=this.removePoint():s=!0),e.type==Et.SINGLECLICK&&(this.ignoreNextSingleClick_=!1),super.handleEvent(e)&&!s}findInsertVerticesAndUpdateDragSegments_(e){this.handlePointerAtPixel_(e),this.dragSegments_.length=0,this.featuresBeingModified_=null;const s=this.vertexFeature_;if(!s)return;this.getMap().getView().getProjection();const n=[],r=s.getGeometry().getCoordinates(),a=It([r]),l=this.rBush_.getInExtent(a),d={};l.sort(dc);for(let p=0,_=l.length;p<_;++p){const y=l[p],E=y.segment;let I=Tt(y.geometry);const L=y.depth;if(L&&(I+="-"+L.join("-")),d[I]||(d[I]=new Array(2)),y.geometry.getType()==="Circle"&&y.index===un){const R=Jr(e,y);jt(R,r)&&!d[I][0]&&(this.dragSegments_.push([y,0]),d[I][0]=y);continue}if(jt(E[0],r)&&!d[I][0]){this.dragSegments_.push([y,0]),d[I][0]=y;continue}if(jt(E[1],r)&&!d[I][1]){if(d[I][0]&&d[I][0].index===0){let R=y.geometry.getCoordinates();switch(y.geometry.getType()){case"LineString":case"MultiLineString":continue;case"MultiPolygon":R=R[L[1]];case"Polygon":if(y.index!==R[L[0]].length-2)continue;break}}this.dragSegments_.push([y,1]),d[I][1]=y;continue}Tt(E)in this.vertexSegments_&&!d[I][0]&&!d[I][1]&&n.push(y)}return n}handleDragEvent(e){this.ignoreNextSingleClick_=!1,this.willModifyFeatures_(e,this.dragSegments_.map(([a])=>a));const s=[e.coordinate[0]+this.delta_[0],e.coordinate[1]+this.delta_[1]],n=[],r=[];for(let a=0,l=this.dragSegments_.length;a<l;++a){const d=this.dragSegments_[a],p=d[0],_=p.feature;n.includes(_)||n.push(_);const y=p.geometry;r.includes(y)||r.push(y);const E=p.depth;let I;const L=p.segment,R=d[1];for(;s.length<y.getStride();)s.push(L[R][s.length]);switch(y.getType()){case"Point":I=s,L[0]=s,L[1]=s;break;case"MultiPoint":I=y.getCoordinates(),I[p.index]=s,L[0]=s,L[1]=s;break;case"LineString":I=y.getCoordinates(),I[p.index+R]=s,L[R]=s;break;case"MultiLineString":I=y.getCoordinates(),I[E[0]][p.index+R]=s,L[R]=s;break;case"Polygon":I=y.getCoordinates(),I[E[0]][p.index+R]=s,L[R]=s;break;case"MultiPolygon":I=y.getCoordinates(),I[E[1]][E[0]][p.index+R]=s,L[R]=s;break;case"Circle":const Ee=y;if(L[0]=s,L[1]=s,p.index===qr)this.changingFeature_=!0,Ee.setCenter(s),this.changingFeature_=!1;else{this.changingFeature_=!0,e.map.getView().getProjection();let He=Bn(dt(Ee.getCenter()),dt(s));Ee.setRadius(He),this.changingFeature_=!1}break}I&&this.setGeometryCoordinates_(y,I)}this.createOrUpdateVertexFeature_(s,n,r,!0)}handleDownEvent(e){if(!this.condition_(e))return!1;const s=e.coordinate,n=this.findInsertVerticesAndUpdateDragSegments_(s);if(n?.length&&this.insertVertexCondition_(e)&&(this.willModifyFeatures_(e,n),this.vertexFeature_)){const r=this.vertexFeature_.getGeometry().getCoordinates();for(let a=n.length-1;a>=0;--a)this.insertVertex_(n[a],r);this.ignoreNextSingleClick_=!0}return!!this.vertexFeature_}handleUpEvent(e){for(let s=this.dragSegments_.length-1;s>=0;--s){const n=this.dragSegments_[s][0],r=n.geometry;if(r.getType()==="Circle"){const a=r,l=a.getCenter(),d=n.featureSegments[0],p=n.featureSegments[1];d.segment[0]=l,d.segment[1]=l,p.segment[0]=l,p.segment[1]=l,this.rBush_.update(ki(l),d);let _=a;this.rBush_.update(_.getExtent(),p)}else this.rBush_.update(It(n.segment),n)}return this.featuresBeingModified_&&(this.dispatchEvent(new Ei(Ii.MODIFYEND,this.featuresBeingModified_,e)),this.featuresBeingModified_=null),!1}handlePointerMove_(e){this.lastPixel_=e.pixel,this.handlePointerAtPixel_(e.coordinate)}handlePointerAtPixel_(e){const s=this.getMap(),n=s.getPixelFromCoordinate(e);s.getView().getProjection();const r=function(d,p){return Xr(e,d)-Xr(e,p)};let a,l;if(this.hitDetection_){const d=typeof this.hitDetection_=="object"?p=>p===this.hitDetection_:void 0;s.forEachFeatureAtPixel(n,(p,_,y)=>{y&&y.getType()==="Point"&&(y=new Xt(zn(y.getCoordinates())));const E=y||p.getGeometry();if(E&&E.getType()==="Point"&&p instanceof wt&&this.features_.getArray().includes(p)){l=E;const I=p.getGeometry().getFlatCoordinates().slice(0,2);a=[{feature:p,geometry:l,segment:[I,I]}]}return!0},{layerFilter:d})}if(!a){const d=cl(ki(e,Hr)),p=s.getView().getResolution()*this.pixelTolerance_,_=dl(ul(d,p,Hr));a=this.rBush_.getInExtent(_)}if(a&&a.length>0){const d=a.sort(r)[0],p=d.segment;let _=Jr(e,d);const y=s.getPixelFromCoordinate(_);let E=Bn(n,y);if(l||E<=this.pixelTolerance_){const I={};if(I[Tt(p)]=!0,this.snapToPointer_||(this.delta_[0]=_[0]-e[0],this.delta_[1]=_[1]-e[1]),d.geometry.getType()==="Circle"&&d.index===un)this.snappedToVertex_=!0,this.createOrUpdateVertexFeature_(_,[d.feature],[d.geometry],this.snappedToVertex_);else{const L=s.getPixelFromCoordinate(p[0]),R=s.getPixelFromCoordinate(p[1]),Ee=$n(y,L),He=$n(y,R);if(E=Math.sqrt(Math.min(Ee,He)),this.snappedToVertex_=E<=this.pixelTolerance_,!this.snappedToVertex_&&!this.insertVertexCondition_(this.lastPointerEvent_)){this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null);return}this.snappedToVertex_&&(_=Ee>He?p[1]:p[0]),this.createOrUpdateVertexFeature_(_,[d.feature],[d.geometry],this.snappedToVertex_);const ut={};ut[Tt(d.geometry)]=!0;for(let os=1,Vt=a.length;os<Vt;++os){const nt=a[os].segment;if(jt(p[0],nt[0])&&jt(p[1],nt[1])||jt(p[0],nt[1])&&jt(p[1],nt[0])){const kt=Tt(a[os].geometry);kt in ut||(ut[kt]=!0,I[Tt(nt)]=!0)}else break}}this.vertexSegments_=I;return}}this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null)}insertVertex_(e,s){const n=e.segment,r=e.feature,a=e.geometry,l=e.depth,d=e.index;let p;for(;s.length<a.getStride();)s.push(0);switch(a.getType()){case"MultiLineString":p=a.getCoordinates(),p[l[0]].splice(d+1,0,s);break;case"Polygon":p=a.getCoordinates(),p[l[0]].splice(d+1,0,s);break;case"MultiPolygon":p=a.getCoordinates(),p[l[1]][l[0]].splice(d+1,0,s);break;case"LineString":p=a.getCoordinates(),p.splice(d+1,0,s);break;default:return!1}this.setGeometryCoordinates_(a,p);const _=this.rBush_;_.remove(e),this.updateSegmentIndices_(a,d,l,1);const y={segment:[n[0],s],feature:r,geometry:a,depth:l,index:d};_.insert(It(y.segment),y),this.dragSegments_.push([y,1]);const E={segment:[s,n[1]],feature:r,geometry:a,depth:l,index:d+1};return _.insert(It(E.segment),E),this.dragSegments_.push([E,0]),!0}updatePointer_(e){return e&&this.findInsertVerticesAndUpdateDragSegments_(e),this.vertexFeature_?.getGeometry().getCoordinates()}getPoint(){const e=this.vertexFeature_?.getGeometry().getCoordinates();return e?zn(e,this.getMap().getView().getProjection()):null}canRemovePoint(){if(!this.vertexFeature_||this.vertexFeature_.get("geometries").every(n=>n.getType()==="Circle"||n.getType().endsWith("Point")))return!1;const e=this.vertexFeature_.getGeometry().getCoordinates();return this.rBush_.getInExtent(It([e])).some(({segment:n})=>jt(n[0],e)||jt(n[1],e))}removePoint(e){if(e&&(e=dt(e,this.getMap().getView().getProjection()),this.updatePointer_(e)),!this.lastPointerEvent_||this.lastPointerEvent_&&this.lastPointerEvent_.type!=Et.POINTERDRAG){const s=this.lastPointerEvent_;this.willModifyFeatures_(s,this.dragSegments_.map(([r])=>r));const n=this.removeVertex_();return this.featuresBeingModified_&&this.dispatchEvent(new Ei(Ii.MODIFYEND,this.featuresBeingModified_,s)),this.featuresBeingModified_=null,n}return!1}removeVertex_(){const e=this.dragSegments_,s={};let n=!1,r,a,l,d,p,_,y,E,I,L,R;for(p=e.length-1;p>=0;--p)l=e[p],L=l[0],R=Tt(L.feature),L.depth&&(R+="-"+L.depth.join("-")),R in s||(s[R]={}),l[1]===0?(s[R].right=L,s[R].index=L.index):l[1]==1&&(s[R].left=L,s[R].index=L.index+1);for(R in s){switch(I=s[R].right,y=s[R].left,_=s[R].index,E=_-1,y!==void 0?L=y:L=I,E<0&&(E=0),d=L.geometry,a=d.getCoordinates(),r=a,n=!1,d.getType()){case"MultiLineString":a[L.depth[0]].length>2&&(a[L.depth[0]].splice(_,1),n=!0);break;case"LineString":a.length>2&&(a.splice(_,1),n=!0);break;case"MultiPolygon":r=r[L.depth[1]];case"Polygon":r=r[L.depth[0]],r.length>4&&(_==r.length-1&&(_=0),r.splice(_,1),n=!0,_===0&&(r.pop(),r.push(r[0]),E=r.length-1));break}if(n){this.setGeometryCoordinates_(d,a);const Ee=[];if(y!==void 0&&(this.rBush_.remove(y),Ee.push(y.segment[0])),I!==void 0&&(this.rBush_.remove(I),Ee.push(I.segment[1])),y!==void 0&&I!==void 0){const He={depth:L.depth,feature:L.feature,geometry:L.geometry,index:E,segment:Ee};this.rBush_.insert(It(He.segment),He)}this.updateSegmentIndices_(d,_,L.depth,-1),this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),e.length=0}}return n}canInsertPoint(){if(!this.vertexFeature_||this.vertexFeature_.get("geometries").every(n=>n.getType()==="Circle"||n.getType().endsWith("Point")))return!1;const e=this.vertexFeature_.getGeometry().getCoordinates();return this.rBush_.getInExtent(It([e])).some(({segment:n})=>!(jt(n[0],e)||jt(n[1],e)))}insertPoint(e){const s=e?dt(e,this.getMap().getView().getProjection()):this.vertexFeature_?.getGeometry().getCoordinates();return s?this.findInsertVerticesAndUpdateDragSegments_(s).reduce((r,a)=>r||this.insertVertex_(a,s),!1):!1}setGeometryCoordinates_(e,s){this.changingFeature_=!0,e.setCoordinates(s),this.changingFeature_=!1}updateSegmentIndices_(e,s,n,r){this.rBush_.forEachInExtent(e.getExtent(),function(a){a.geometry===e&&(n===void 0||a.depth===void 0||hl(a.depth,n))&&a.index>s&&(a.index+=r)})}}function dc(c,e){return c.index-e.index}function Xr(c,e,s){const n=e.geometry;if(n.getType()==="Circle"){let a=n;if(e.index===un){const l=$n(a.getCenter(),dt(c)),d=Math.sqrt(l)-a.getRadius();return d*d}}const r=dt(c);return zs[0]=dt(e.segment[0]),zs[1]=dt(e.segment[1]),gl(r,zs)}function Jr(c,e,s){const n=e.geometry;if(n.getType()==="Circle"&&e.index===un)return zn(n.getClosestPoint(dt(c)));const r=dt(c);return zs[0]=dt(e.segment[0]),zs[1]=dt(e.segment[1]),zn(fl(r,zs))}function uc(){const c=zi();return function(e,s){return c.Point}}const hc={SELECT:"select"};class fc extends $i{constructor(e,s,n,r){super(e),this.selected=s,this.deselected=n,this.mapBrowserEvent=r}}const Nn={};class Qi extends Vl{constructor(e){super(),this.on,this.once,this.un,e=e||{},this.boundAddFeature_=this.addFeature_.bind(this),this.boundRemoveFeature_=this.removeFeature_.bind(this),this.condition_=e.condition?e.condition:ta,this.addCondition_=e.addCondition?e.addCondition:Gi,this.removeCondition_=e.removeCondition?e.removeCondition:Gi,this.toggleCondition_=e.toggleCondition?e.toggleCondition:ea,this.multi_=e.multi?e.multi:!1,this.filter_=e.filter?e.filter:Li,this.hitTolerance_=e.hitTolerance?e.hitTolerance:0,this.style_=e.style!==void 0?e.style:gc(),this.features_=e.features||new Oi;let s;if(e.layers)if(typeof e.layers=="function")s=e.layers;else{const n=e.layers;s=function(r){return n.includes(r)}}else s=Li;this.layerFilter_=s,this.featureLayerAssociation_={}}addFeatureLayerAssociation_(e,s){this.featureLayerAssociation_[Tt(e)]=s}getFeatures(){return this.features_}getHitTolerance(){return this.hitTolerance_}getLayer(e){return this.featureLayerAssociation_[Tt(e)]}setHitTolerance(e){this.hitTolerance_=e}setMap(e){this.getMap()&&this.style_&&this.features_.forEach(this.restorePreviousStyle_.bind(this)),super.setMap(e),e?(this.features_.addEventListener(Vs.ADD,this.boundAddFeature_),this.features_.addEventListener(Vs.REMOVE,this.boundRemoveFeature_),this.style_&&this.features_.forEach(this.applySelectedStyle_.bind(this))):(this.features_.removeEventListener(Vs.ADD,this.boundAddFeature_),this.features_.removeEventListener(Vs.REMOVE,this.boundRemoveFeature_))}addFeature_(e){const s=e.element;if(this.style_&&this.applySelectedStyle_(s),!this.getLayer(s)){const n=this.getMap().getAllLayers().find(function(r){if(r instanceof Zi&&r.getSource()&&r.getSource().hasFeature(s))return r});n&&this.addFeatureLayerAssociation_(s,n)}}removeFeature_(e){this.style_&&this.restorePreviousStyle_(e.element)}getStyle(){return this.style_}applySelectedStyle_(e){const s=Tt(e);s in Nn||(Nn[s]=e.getStyle()),e.setStyle(this.style_)}restorePreviousStyle_(e){const s=this.getMap().getInteractions().getArray();for(let r=s.length-1;r>=0;--r){const a=s[r];if(a!==this&&a instanceof Qi&&a.getStyle()&&a.getFeatures().getArray().lastIndexOf(e)!==-1){e.setStyle(a.getStyle());return}}const n=Tt(e);e.setStyle(Nn[n]),delete Nn[n]}removeFeatureLayerAssociation_(e){delete this.featureLayerAssociation_[Tt(e)]}handleEvent(e){if(!this.condition_(e))return!0;const s=this.addCondition_(e),n=this.removeCondition_(e),r=this.toggleCondition_(e),a=!s&&!n&&!r,l=e.map,d=this.getFeatures(),p=[],_=[];if(a){vl(this.featureLayerAssociation_),l.forEachFeatureAtPixel(e.pixel,(y,E)=>{if(!(!(y instanceof wt)||!this.filter_(y,E)))return this.addFeatureLayerAssociation_(y,E),_.push(y),!this.multi_},{layerFilter:this.layerFilter_,hitTolerance:this.hitTolerance_});for(let y=d.getLength()-1;y>=0;--y){const E=d.item(y),I=_.indexOf(E);I>-1?_.splice(I,1):(d.remove(E),p.push(E))}_.length!==0&&d.extend(_)}else{l.forEachFeatureAtPixel(e.pixel,(y,E)=>{if(!(!(y instanceof wt)||!this.filter_(y,E)))return(s||r)&&!d.getArray().includes(y)?(this.addFeatureLayerAssociation_(y,E),_.push(y)):(n||r)&&d.getArray().includes(y)&&(p.push(y),this.removeFeatureLayerAssociation_(y)),!this.multi_},{layerFilter:this.layerFilter_,hitTolerance:this.hitTolerance_});for(let y=p.length-1;y>=0;--y)d.remove(p[y]);d.extend(_)}return(_.length>0||p.length>0)&&this.dispatchEvent(new fc(hc.SELECT,_,p,e)),!0}}function gc(){const c=zi();return ps(c.Polygon,c.LineString),ps(c.GeometryCollection,c.LineString),function(e){return e.getGeometry()?c[e.getGeometry().getType()]:null}}class vc{constructor(){this.dataProjection=void 0,this.defaultFeatureProjection=void 0,this.featureClass=wt,this.supportedMediaTypes=null}getReadOptions(e,s){if(s){let n=s.dataProjection?vs(s.dataProjection):this.readProjection(e);s.extent&&n&&n.getUnits()==="tile-pixels"&&(n=vs(n),n.setWorldExtent(s.extent)),s={dataProjection:n,featureProjection:s.featureProjection}}return this.adaptOptions(s)}adaptOptions(e){return Object.assign({dataProjection:this.dataProjection,featureProjection:this.defaultFeatureProjection,featureClass:this.featureClass},e)}getType(){return rt()}readFeature(e,s){return rt()}readFeatures(e,s){return rt()}readGeometry(e,s){return rt()}readProjection(e){return rt()}writeFeature(e,s){return rt()}writeFeatures(e,s){return rt()}writeGeometry(e,s){return rt()}}function er(c,e,s){const n=s?vs(s.featureProjection):null,r=s?vs(s.dataProjection):null;let a=c;if(n&&r&&!pl(n,r)){e&&(a=c.clone());const l=e?n:r,d=e?r:n;l.getUnits()==="tile-pixels"?a.transform(l,d):a.applyTransform(ml(l,d))}if(e&&s&&s.decimals!==void 0){const l=Math.pow(10,s.decimals),d=function(p){for(let _=0,y=p.length;_<y;++_)p[_]=Math.round(p[_]*l)/l;return p};a===c&&(a=c.clone()),a.applyTransform(d)}return a}const pc={Point:Xt,LineString:Ps,Polygon:hn,MultiPoint:gn,MultiLineString:qs,MultiPolygon:Hs};function mc(c,e,s){return Array.isArray(e[0])?(Wr(c,0,e,s)||(c=c.slice(),Ai(c,0,e,s)),c):(yl(c,0,e,s)||(c=c.slice(),_l(c,0,e,s)),c)}function da(c,e){const s=c.geometry;if(!s)return[];if(Array.isArray(s))return s.map(a=>da({...c,geometry:a})).flat();const n=s.type==="MultiPolygon"?"Polygon":s.type;if(n==="GeometryCollection"||n==="Circle")throw new Error("Unsupported geometry type: "+n);const r=s.layout.length;return er(new sa(n,n==="Polygon"?mc(s.flatCoordinates,s.ends,r):s.flatCoordinates,s.ends?.flat(),r,c.properties||{},c.id).enableSimplifyTransformed(),!1,e)}function tr(c,e){if(!c)return null;if(Array.isArray(c)){const n=c.map(r=>tr(r,e));return new fn(n)}const s=pc[c.type];return er(new s(c.flatCoordinates,c.layout||"XY",c.ends),!1,e)}class yc extends vc{constructor(){super()}getType(){return"json"}readFeature(e,s){return this.readFeatureFromObject(jn(e),this.getReadOptions(e,s))}readFeatures(e,s){return this.readFeaturesFromObject(jn(e),this.getReadOptions(e,s))}readFeatureFromObject(e,s){return rt()}readFeaturesFromObject(e,s){return rt()}readGeometry(e,s){return this.readGeometryFromObject(jn(e),this.getReadOptions(e,s))}readGeometryFromObject(e,s){return rt()}readProjection(e){return this.readProjectionFromObject(jn(e))}readProjectionFromObject(e){return rt()}writeFeature(e,s){return JSON.stringify(this.writeFeatureObject(e,s))}writeFeatureObject(e,s){return rt()}writeFeatures(e,s){return JSON.stringify(this.writeFeaturesObject(e,s))}writeFeaturesObject(e,s){return rt()}writeGeometry(e,s){return JSON.stringify(this.writeGeometryObject(e,s))}writeGeometryObject(e,s){return rt()}}function jn(c){if(typeof c=="string"){const e=JSON.parse(c);return e||null}return c!==null?c:null}class sr extends yc{constructor(e){e=e||{},super(),this.dataProjection=vs(e.dataProjection?e.dataProjection:"EPSG:4326"),e.featureProjection&&(this.defaultFeatureProjection=vs(e.featureProjection)),e.featureClass&&(this.featureClass=e.featureClass),this.geometryName_=e.geometryName,this.extractGeometryName_=e.extractGeometryName,this.supportedMediaTypes=["application/geo+json","application/vnd.geo+json"]}readFeatureFromObject(e,s){let n=null;e.type==="Feature"?n=e:n={type:"Feature",geometry:e,properties:null};const r=nr(n.geometry);if(this.featureClass===sa)return da({geometry:r,id:n.id,properties:n.properties},s);const a=new wt;return this.geometryName_?a.setGeometryName(this.geometryName_):this.extractGeometryName_&&n.geometry_name&&a.setGeometryName(n.geometry_name),a.setGeometry(tr(r,s)),"id"in n&&a.setId(n.id),n.properties&&a.setProperties(n.properties,!0),a}readFeaturesFromObject(e,s){const n=e;let r=null;if(n.type==="FeatureCollection"){const a=e;r=[];const l=a.features;for(let d=0,p=l.length;d<p;++d){const _=this.readFeatureFromObject(l[d],s);_&&r.push(_)}}else r=[this.readFeatureFromObject(e,s)];return r.flat()}readGeometryFromObject(e,s){return _c(e,s)}readProjectionFromObject(e){const s=e.crs;let n;if(s)if(s.type=="name")n=vs(s.properties.name);else if(s.type==="EPSG")n=vs("EPSG:"+s.properties.code);else throw new Error("Unknown SRS type");else n=this.dataProjection;return n}writeFeatureObject(e,s){s=this.adaptOptions(s);const n={type:"Feature",geometry:null,properties:null},r=e.getId();if(r!==void 0&&(n.id=r),!e.hasProperties())return n;const a=e.getProperties(),l=e.getGeometry();return l&&(n.geometry=ji(l,s),delete a[e.getGeometryName()]),bl(a)||(n.properties=a),n}writeFeaturesObject(e,s){s=this.adaptOptions(s);const n=[];for(let r=0,a=e.length;r<a;++r)n.push(this.writeFeatureObject(e[r],s));return{type:"FeatureCollection",features:n}}writeGeometryObject(e,s){return ji(e,this.adaptOptions(s))}}function nr(c,e){if(!c)return null;let s;switch(c.type){case"Point":{s=wc(c);break}case"LineString":{s=kc(c);break}case"Polygon":{s=Pc(c);break}case"MultiPoint":{s=Sc(c);break}case"MultiLineString":{s=xc(c);break}case"MultiPolygon":{s=Cc(c);break}case"GeometryCollection":{s=bc(c);break}default:throw new Error("Unsupported GeoJSON type: "+c.type)}return s}function _c(c,e){const s=nr(c);return tr(s,e)}function bc(c,e){return c.geometries.map(function(n){return nr(n)})}function wc(c){const e=c.coordinates;return{type:"Point",flatCoordinates:e,layout:Xs(e.length)}}function kc(c){const e=c.coordinates,s=e.flat();return{type:"LineString",flatCoordinates:s,ends:[s.length],layout:Xs(e[0]?.length||2)}}function xc(c){const e=c.coordinates,s=e[0]?.[0]?.length||2,n=[],r=Vi(n,0,e,s);return{type:"MultiLineString",flatCoordinates:n,ends:r,layout:Xs(s)}}function Sc(c){const e=c.coordinates;return{type:"MultiPoint",flatCoordinates:e.flat(),layout:Xs(e[0]?.length||2)}}function Cc(c){const e=c.coordinates,s=[],n=e[0]?.[0]?.[0].length||2,r=Zr(s,0,e,n);return{type:"MultiPolygon",flatCoordinates:s,ends:r,layout:Xs(n)}}function Pc(c){const e=c.coordinates,s=[],n=e[0]?.[0]?.length,r=Vi(s,0,e,n);return{type:"Polygon",flatCoordinates:s,ends:r,layout:Xs(n)}}function ji(c,e){c=er(c,!0,e);const s=c.getType();let n;switch(s){case"Point":{n=Ac(c);break}case"LineString":{n=Ic(c);break}case"Polygon":{n=Lc(c,e);break}case"MultiPoint":{n=Tc(c);break}case"MultiLineString":{n=Ec(c);break}case"MultiPolygon":{n=Mc(c,e);break}case"GeometryCollection":{n=Fc(c,e);break}case"Circle":{n={type:"GeometryCollection",geometries:[]};break}default:throw new Error("Unsupported geometry type: "+s)}return n}function Fc(c,e){return e=Object.assign({},e),delete e.featureProjection,{type:"GeometryCollection",geometries:c.getGeometriesArray().map(function(n){return ji(n,e)})}}function Ic(c,e){return{type:"LineString",coordinates:c.getCoordinates()}}function Ec(c,e){return{type:"MultiLineString",coordinates:c.getCoordinates()}}function Tc(c,e){return{type:"MultiPoint",coordinates:c.getCoordinates()}}function Mc(c,e){let s;return e&&(s=e.rightHanded),{type:"MultiPolygon",coordinates:c.getCoordinates(s)}}function Ac(c,e){return{type:"Point",coordinates:c.getCoordinates()}}function Lc(c,e){let s;return e&&(s=e.rightHanded),{type:"Polygon",coordinates:c.getCoordinates(s)}}function ir(c){return Ul(`https://annotations.allmaps.org/?url=${c}`)}async function ua(c){try{return[await ir(`${c.uri}/info.json`)]}catch{return[]}}async function ha(c){try{return[await ir(c.uri)]}catch{const s=[];for(const n of c.canvases){const r=await ua(n.image);s.push(...r)}return s}}async function fa(c){try{return[await ir(c.uri)]}catch{const s=[];if("items"in c){for(const n of c.items)if(n.type==="collection"){const r=await fa(n);s.push(...r)}else if(n.type==="manifest"&&"canvases"in n){const r=await ha(n);s.push(...r)}}return s}}function Dc(c){if(c.type==="image")return ua(c);if(c.type==="manifest")return ha(c);if(c.type==="collection")return fa(c);throw new Error("Unsupported IIIF resource")}const Gc="canvas";class Kr{uri;type=Gc;height;width;image;label;description;metadata;navDate;navPlace;homepage;thumbnail;rendering;seeAlso;summary;requiredStatement;annotations;constructor(e){if(this.width=e.width,this.height=e.height,"@id"in e)this.uri=e["@id"],this.description=Is(e.description),this.label=Is(e.label),this.metadata=Yi(e.metadata),this.navDate=e.navDate,this.navPlace=e.navPlace,this.requiredStatement=qi(e.attribution),this.thumbnail=Hi(e.thumbnail),this.rendering=Xi(e.rendering),this.homepage=Ji(e.related),this.image=new Ri(e.images[0].resource,e);else if("id"in e){this.uri=e.id,this.label=Ys(e.label),this.description=Ys(e.description),this.metadata=Yn(e.metadata),this.navDate=e.navDate,this.navPlace=e.navPlace,this.homepage=e.homepage,this.thumbnail=e.thumbnail,this.rendering=e.rendering,this.seeAlso=e.seeAlso,this.summary=e.summary,this.requiredStatement=e.requiredStatement,this.annotations=e.annotations;const s=e.items[0].items[0].body;let n;if(Array.isArray(s))n=s[0];else if(s.type==="Image")n=s;else if(s.type==="Choice")n=s.items[0];else throw new Error("Invalid IIIF Canvas");this.image=new Ri(n,e)}else throw new Error("Invalid IIIF Canvas")}}const Oc="manifest";class dn{embedded=!0;uri;type=Oc;label;majorVersion;constructor(e){if("@type"in e)this.uri=e["@id"],this.majorVersion=2,this.label=Is(e.label);else if("type"in e)this.uri=e.id,this.majorVersion=3,this.label=Ys(e.label);else throw new Error("Unsupported Manifest")}}class Fs extends dn{canvases=[];description;metadata;navDate;navPlace;homepage;thumbnail;rendering;seeAlso;summary;requiredStatement;annotations;embedded=!1;constructor(e){if(super(e),"@type"in e){this.description=Is(e.description),this.metadata=Yi(e.metadata);const s=e.sequences[0];this.canvases=s.canvases.map(n=>new Kr(n)),this.navDate=e.navDate,this.navPlace=e.navPlace,this.requiredStatement=qi(e.attribution),this.thumbnail=Hi(e.thumbnail),this.rendering=Xi(e.rendering),this.homepage=Ji(e.related)}else if("type"in e)this.description=Ys(e.description),this.metadata=Yn(e.metadata),this.metadata=Yn(e.metadata),this.navDate=e.navDate,this.navPlace=e.navPlace,this.homepage=e.homepage,this.thumbnail=e.thumbnail,this.rendering=e.rendering,this.seeAlso=e.seeAlso,this.summary=e.summary,this.requiredStatement=e.requiredStatement,this.annotations=e.annotations,this.canvases=e.items.map(s=>new Kr(s));else throw new Error("Unsupported Manifest")}static parse(e,s=null){let n;return s===2?n=na.parse(e):s===3?n=ia.parse(e):n=$l.parse(e),new Fs(n)}get images(){return this.canvases.map(e=>e.image)}async#e(e,s){if(e instanceof Ri){const n=`${e.uri}/info.json`,r=await s(n).then(l=>l.json());return Vn.parse(r)}else return e}async fetchAll(e=globalThis.fetch){const s=[];for await(const n of this.fetchNext(e))s.push(n);return s}async*fetchNext(e=globalThis.fetch,s=0){for(const n of this.canvases){const r=await this.#e(n.image,e);n.image=r,yield{item:r,depth:s,parent:{uri:this.uri,type:this.type}}}}async fetchImageByUri(e,s=globalThis.fetch){for(const n of this.canvases)if(n.image.uri===e){const r=await this.#e(n.image,s);return n.image=r,r}}}const Rc="collection",cn={maxDepth:Number.POSITIVE_INFINITY,fetchCollections:!0,fetchManifests:!0,fetchImages:!1,fetchFn:globalThis.fetch};class Ti{uri;type=Rc;majorVersion;label;embedded=!0;constructor(e){if("@type"in e)this.uri=e["@id"],this.majorVersion=2,this.label=Is(e.label);else if("type"in e)this.uri=e.id,this.majorVersion=3,this.label=Ys(e.label);else throw new Error("Unsupported Collection")}static parse(e,s=null){let n;return s===2?n=Ki.parse(e):s===3?n=Wi.parse(e):n=ra.parse(e),new as(n)}}class as extends Ti{items=[];embedded=!1;description;metadata;navDate;navPlace;homepage;thumbnail;rendering;seeAlso;summary;requiredStatement;annotations;constructor(e){if(super(e),"@type"in e){this.description=Is(e.description),this.label=Is(e.label),this.metadata=Yi(e.metadata),this.navDate=e.navDate,this.navPlace=e.navPlace,this.requiredStatement=qi(e.attribution),this.thumbnail=Hi(e.thumbnail),this.rendering=Xi(e.rendering),this.homepage=Ji(e.related);const s="manifests"in e&&e.manifests?e.manifests:[],n="collections"in e&&e.collections?e.collections:[],r="members"in e&&e.members?e.members:[],a=[...s,...n,...r];this.items=a.map(l=>l["@type"]==="sc:Collection"?new as(l):new dn(l))}else if("type"in e)this.description=Ys(e.description),this.metadata=Yn(e.metadata),this.navDate=e.navDate,this.navPlace=e.navPlace,this.homepage=e.homepage,this.thumbnail=e.thumbnail,this.rendering=e.rendering,this.seeAlso=e.seeAlso,this.summary=e.summary,this.requiredStatement=e.requiredStatement,this.annotations=e.annotations,"items"in e&&(this.items=e.items.map(s=>s.type==="Collection"?"items"in s?new as(s):new Ti(s):new dn(s)));else throw new Error("Unsupported Collection")}static parse(e,s=null){let n;return s===2?n=Ki.parse(e):s===3?n=Wi.parse(e):n=ra.parse(e),new as(n)}get canvases(){const e=[];return this.items.reduce((s,n)=>n instanceof Fs?[...s,...n.canvases]:n instanceof dn?s:n instanceof as?[...s,...n.canvases]:s,e)}get images(){return this.canvases.map(e=>e.image)}async fetchAll(e){const s=[];for await(const n of this.fetchNext(e))s.push(n);return s}async*fetchNext(e,s=0){if(e={...cn,...e},Number.isNaN(e.maxDepth))return;e.maxDepth===void 0&&(e.maxDepth=cn.maxDepth),e.fetchImages===void 0&&(e.fetchImages=cn.fetchImages),e.fetchManifests===void 0&&(e.fetchManifests=cn.fetchManifests);let n=cn.fetchFn;if(e.fetchFn&&(n=e.fetchFn),!(s>=e.maxDepth))for(const r in this.items){let a=this.items[r];if(a instanceof Fs)e.fetchImages&&(yield*a.fetchNext(n,s+1));else if(a instanceof dn&&e.fetchManifests){const l=a.uri,d=await n(l).then(_=>_.json()),p=Fs.parse(d);this.items[r]=p,yield{item:p,depth:s+1,parent:{uri:this.uri,type:this.type}},s+1<e.maxDepth&&e.fetchImages&&(yield*p.fetchNext(n,s+2))}else if(a instanceof Ti&&e.fetchCollections){const l=a.uri,d=await n(l).then(_=>_.json()),p=as.parse(d);this.items[r]=p,yield{item:p,depth:s+1,parent:{uri:this.uri,type:this.type}},a=p,s+1<e.maxDepth&&(yield*p.fetchNext(e,s+2))}}}}class Nc{static parse(e,s=null){if(e&&typeof e=="object"){if(s===1||"@context"in e&&e["@context"]===Bl){const n=zl.parse(e);return new Vn(n)}else if(s===2||"@id"in e){if("protocol"in e&&e.protocol==="http://iiif.io/api/image"){const n=Yl.parse(e);return new Vn(n)}else if("@type"in e&&e["@type"]==="sc:Manifest"){const n=na.parse(e);return new Fs(n)}else if("@type"in e&&e["@type"]==="sc:Collection"){const n=Ki.parse(e);return new as(n)}}else if(s===3||"id"in e){if("protocol"in e&&e.protocol==="http://iiif.io/api/image"){const n=ql.parse(e);return new Vn(n)}else if("type"in e&&e.type==="Manifest"){const n=ia.parse(e);return new Fs(n)}else if("type"in e&&e.type==="Collection"){const n=Wi.parse(e);return new as(n)}}}throw new Error("Invalid IIIF data or unsupported IIIF type")}}function jc(c="id"){if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return`${c}-${crypto.randomUUID()}`;const e=Math.random().toString(36).slice(2,8);return`${c}-${Date.now().toString(36)}-${e}`}function Vc(c="anno"){return jc(c)}function gs(c){let e=c.getId();e||(e=Vc(),c.setId(e)),c.get("label")||c.set("label","Untitled"),c.get("color")||c.set("color",Bi),typeof c.get("hidden")!="boolean"&&c.set("hidden",!1)}function Uc(c){return gs(c),{id:c.getId(),label:c.get("label")??"Untitled",type:c.getGeometry()?.getType()??"Geometry",color:c.get("color")??Bi,details:c.get("details")??"",hidden:!!c.get("hidden")}}function $c(c,e){const s=c.replace("#","");if(![3,6].includes(s.length))return`rgba(37, 99, 235, ${e})`;const n=s.length===3?s.split("").map(p=>p+p).join(""):s,r=Number.parseInt(n,16),a=r>>16&255,l=r>>8&255,d=r&255;return`rgba(${a}, ${l}, ${d}, ${e})`}function Bc(c){const e=c;if(gs(e),e.get("hidden"))return;const s=e.get("color")??Bi,n=e.getGeometry()?.getType()??"Geometry",r=e.get("label"),a=r&&r.trim().length?new Hl({text:r,font:'600 13px "Inter", system-ui, sans-serif',fill:new Us({color:"#111827"}),padding:[3,6,2,6],backgroundFill:new Us({color:"rgba(255,255,255,0.85)"}),overflow:!0,offsetY:n==="Point"?-18:0}):void 0;return n==="Point"?new Ni({image:new aa({radius:7,fill:new Us({color:"#ffffff"}),stroke:new qn({color:s,width:3})}),text:a}):new Ni({stroke:new qn({color:s,width:3}),fill:new Us({color:$c(s,.15)}),text:a})}const zc=new Ni({image:new aa({radius:6,fill:new Us({color:"#06b6d4"}),stroke:new qn({color:"#0e7490",width:2})}),stroke:new qn({color:"#06b6d4",width:2}),fill:new Us({color:"rgba(6, 182, 212, 0.18)"})}),Yc=100;function qc(c=Yc){const{subscribe:e,update:s,set:n}=oa({history:[],future:[]});return{subscribe:e,limit:c,push(r){s(a=>({history:[...a.history.slice(-c+1),r],future:[]}))},undo(){let r=null;return s(a=>a.history.length?(r=a.history[a.history.length-1],{history:a.history.slice(0,-1),future:[...a.future,r]}):a),r},redo(){let r=null;return s(a=>a.future.length?(r=a.future[a.future.length-1],{history:[...a.history,r],future:a.future.slice(0,-1)}):a),r},reset(){n({history:[],future:[]})}}}function Hc(c,e={}){const{geoJson:s=new sr}=e,n=String(c.getId()),r=s.writeFeatureObject(c,{featureProjection:"EPSG:3857",dataProjection:"EPSG:4326"});return r.id=n,{id:n,feature:r}}function Xc(c,e={}){const{geoJson:s=new sr}=e,n=s.readFeature(c.feature,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"});return n.setId(c.id),n}function Jc(c,e){return e&&c.some(s=>s.id===e)?e:null}function Kc(){const{subscribe:c,update:e,set:s}=oa({list:[],selectedId:null});return{subscribe:c,setList(n){e(r=>({list:n,selectedId:Jc(n,r.selectedId)}))},setSelected(n){e(r=>({...r,selectedId:n}))},clearSelection(){e(n=>({...n,selectedId:null}))},clearSelectionIfMatches(n){n&&e(r=>({...r,selectedId:r.selectedId===n?null:r.selectedId}))},reset(){s({list:[],selectedId:null})}}}const Wc=Symbol("annotation-context");function Zc(c){Eo(Wc,c)}var Qc=T('<div class="welcome-overlay svelte-1gd50sk"><div class="welcome-card svelte-1gd50sk"><h1 class="svelte-1gd50sk">Welcome to the VMA studio</h1> <p class="svelte-1gd50sk">Choose how you want to start. Viewer lets you explore; Creator unlocks annotation and storytelling tools.</p> <div class="welcome-actions svelte-1gd50sk"><button type="button">Viewer</button> <button type="button">Creator</button></div></div></div>'),ed=T('<button type="button" class="panel-toggle left svelte-1gd50sk">Show tools</button>'),td=T('<span class="history-meta svelte-1gd50sk"> </span>'),sd=T('<button type="button"><span class="history-title svelte-1gd50sk"> </span> <!></button>'),nd=T('<section class="panel-card-section svelte-1gd50sk"><span class="section-title svelte-1gd50sk">Featured</span> <div class="history-featured svelte-1gd50sk"></div></section>'),id=T("<option> </option>"),rd=T('<button type="button"><span class="history-title svelte-1gd50sk"> </span> <span class="history-meta svelte-1gd50sk"> </span></button>'),ad=T('<p class="empty-state svelte-1gd50sk">Map catalog is loading</p>'),od=T('<button type="button"> </button>'),ld=T('<aside class="creator-panel left svelte-1gd50sk"><button type="button" class="panel-collapse svelte-1gd50sk" aria-expanded="true">Hide tools</button> <div class="panel-scroll custom-scrollbar svelte-1gd50sk"><section class="panel-card svelte-1gd50sk"><header class="panel-card-header svelte-1gd50sk"><h2 class="svelte-1gd50sk">View control</h2></header> <section class="panel-card-section svelte-1gd50sk"><span class="section-title svelte-1gd50sk">View mode</span> <div class="button-group wrap svelte-1gd50sk"><button type="button">Overlay</button> <button type="button">Side-X</button> <button type="button">Side-Y</button> <button type="button">Glass</button></div></section> <section class="panel-card-section svelte-1gd50sk"><span class="section-title svelte-1gd50sk">Overlay opacity</span> <div class="slider svelte-1gd50sk"><input type="range" min="0" max="1" step="0.05" class="svelte-1gd50sk"/> <span> </span></div></section></section> <section class="panel-card svelte-1gd50sk"><header class="panel-card-header svelte-1gd50sk"><h2 class="svelte-1gd50sk">Historical maps</h2></header> <!> <section class="panel-card-section svelte-1gd50sk"><label class="history-filter svelte-1gd50sk"><span>Filter by type</span> <select class="svelte-1gd50sk"><option> </option><!></select></label></section> <div class="history-list custom-scrollbar svelte-1gd50sk"><!></div></section> <section class="panel-card svelte-1gd50sk"><header class="panel-card-header svelte-1gd50sk"><h2 class="svelte-1gd50sk">Basemap</h2></header> <section class="panel-card-section svelte-1gd50sk"><div class="button-group wrap svelte-1gd50sk"></div></section></section></div></aside>'),cd=T("<!> <!>",1),dd=T("<p> </p>"),ud=T('<p class="muted svelte-1gd50sk">No additional details for this scene.</p>'),hd=T('<div class="story-presenter"><div class="story-presenter-content"><div class="story-presenter-nav"><span class="counter"> </span> <button type="button" class="chip ghost"> Prev</button> <button type="button"> </button> <button type="button" class="chip ghost">Next </button> <button type="button" class="chip danger">Exit</button></div> <div class="story-presenter-body"><h2> </h2> <!></div></div></div>'),fd=T('<div class="toolbar-menu svelte-1gd50sk"><button type="button">Point</button> <button type="button">Line</button> <button type="button">Polygon</button> <button type="button"> </button> <button type="button" class="svelte-1gd50sk">Finish drawing</button></div>'),gd=T('<div class="toolbar-menu svelte-1gd50sk"><button type="button" class="svelte-1gd50sk">Switch to Viewer</button> <button type="button" class="svelte-1gd50sk">Clear cached state</button></div>'),vd=T('<div class="creator-toolbar svelte-1gd50sk"><div class="toolbar-cluster svelte-1gd50sk"><button type="button" title="Search places" aria-label="Search places" class="svelte-1gd50sk"><span class="toolbar-icon svelte-1gd50sk"></span></button></div> <div class="toolbar-cluster svelte-1gd50sk"><button type="button" title="Pan the map" aria-label="Pan the map"><span class="toolbar-icon svelte-1gd50sk"></span></button> <div class="toolbar-group svelte-1gd50sk"><button type="button" title="Draw annotations" aria-label="Draw annotations" aria-haspopup="true"><span class="toolbar-icon svelte-1gd50sk"></span></button> <!></div> <button type="button" title="Undo" aria-label="Undo" class="svelte-1gd50sk"><span class="toolbar-icon svelte-1gd50sk"></span></button> <button type="button" title="Redo" aria-label="Redo" class="svelte-1gd50sk"><span class="toolbar-icon svelte-1gd50sk"></span></button></div> <div class="toolbar-cluster svelte-1gd50sk"><button type="button" title="Capture current view" aria-label="Capture scene" class="svelte-1gd50sk"><span class="toolbar-icon svelte-1gd50sk"></span></button> <button type="button" title="Present story" aria-label="Present story" class="svelte-1gd50sk"><span class="toolbar-icon svelte-1gd50sk"></span></button></div> <div class="toolbar-cluster svelte-1gd50sk"><div class="toolbar-group svelte-1gd50sk"><button type="button" title="Settings" aria-label="Settings" aria-haspopup="true"><span class="toolbar-icon svelte-1gd50sk"></span></button> <!></div></div></div>'),pd=T('<img loading="lazy" class="svelte-1gd50sk"/>'),md=T('<button type="button"><!> <div class="map-card-body svelte-1gd50sk"><span class="map-card-title svelte-1gd50sk"> </span> <span class="map-card-meta svelte-1gd50sk"> </span></div></button>'),yd=T('<p class="empty-state svelte-1gd50sk">No featured maps yet.</p>'),_d=T('<p class="muted svelte-1gd50sk"> </p> <button type="button" class="chip ghost">Open metadata</button>',1),bd=T('<p class="empty-state svelte-1gd50sk">Select a map to view its metadata.</p>'),wd=T('<button type="button"> </button>'),kd=T("<option> </option>"),xd=T('<img loading="lazy" class="svelte-1gd50sk"/>'),Sd=T('<button type="button"><!> <div class="catalog-text svelte-1gd50sk"><span class="catalog-title svelte-1gd50sk"> </span> <span class="catalog-meta svelte-1gd50sk"> </span></div></button>'),Cd=T('<p class="empty-state svelte-1gd50sk">Map catalog is loading</p>'),Pd=T('<div class="section-group svelte-1gd50sk"><div class="section-block svelte-1gd50sk"><h3 class="svelte-1gd50sk">Featured historical maps</h3> <div class="map-grid svelte-1gd50sk"><!></div></div> <div class="section-block svelte-1gd50sk"><h3 class="svelte-1gd50sk">Metadata</h3> <!></div> <div class="section-block svelte-1gd50sk"><h3 class="svelte-1gd50sk">Basemap</h3> <div class="button-group svelte-1gd50sk"></div></div> <div class="section-block svelte-1gd50sk"><h3 class="svelte-1gd50sk">More historical maps</h3> <details class="map-accordion svelte-1gd50sk"><summary class="svelte-1gd50sk"> </summary> <div class="catalog-filter svelte-1gd50sk"><label class="svelte-1gd50sk"><span>Filter by type</span> <select class="svelte-1gd50sk"><option> </option><!></select></label></div> <div class="catalog-list custom-scrollbar svelte-1gd50sk"><!></div></details></div></div>'),Fd=T('<p class="muted svelte-1gd50sk">Searching</p>'),Id=T("<p> </p>"),Ed=T('<span class="result-type svelte-1gd50sk"> </span>'),Td=T('<div class="search-result svelte-1gd50sk"><button type="button" class="result-main svelte-1gd50sk"><span class="result-title svelte-1gd50sk"> </span> <!></button></div>'),Md=T('<div class="search-results custom-scrollbar svelte-1gd50sk"></div>'),Ad=T('<div class="section-group svelte-1gd50sk"><div class="section-block svelte-1gd50sk"><h3 class="svelte-1gd50sk">View mode</h3> <div class="button-group wrap svelte-1gd50sk"><button type="button">Overlay</button> <button type="button">Side-X</button> <button type="button">Side-Y</button> <button type="button">Glass</button></div></div> <div class="section-block svelte-1gd50sk"><h3 class="svelte-1gd50sk">Opacity</h3> <div class="slider svelte-1gd50sk"><input type="range" min="0" max="1" step="0.05" class="svelte-1gd50sk"/> <span> </span></div></div> <div class="section-block svelte-1gd50sk"><h3 class="svelte-1gd50sk">Search</h3> <div class="search-row svelte-1gd50sk"><input type="text" placeholder="Search for a place or address" class="svelte-1gd50sk"/> <button type="button" class="chip ghost">Locate</button> <button type="button" class="chip ghost">Clear</button></div> <!> <!></div></div>'),Ld=T('<div class="story-card svelte-1gd50sk"><h4 class="svelte-1gd50sk"> </h4> <p class="svelte-1gd50sk"> </p> <div class="story-card-actions svelte-1gd50sk"><button type="button" class="chip svelte-1gd50sk">View</button></div></div>'),Dd=T('<p class="empty-state svelte-1gd50sk">No stories captured yet. Switch to Creator to add one.</p>'),Gd=T('<button type="button" class="chip ghost">Present</button>'),Od=T('<div class="story-row svelte-1gd50sk"><div class="story-info svelte-1gd50sk"><span class="story-title svelte-1gd50sk"> </span> <span class="story-meta svelte-1gd50sk"> </span></div> <div class="story-row-actions svelte-1gd50sk"><button type="button" class="chip ghost svelte-1gd50sk">View</button> <button type="button" class="chip ghost svelte-1gd50sk">Play</button></div></div>'),Rd=T('<p class="empty-state svelte-1gd50sk">No story slides yet.</p>'),Nd=T('<div class="section-group svelte-1gd50sk"><div class="section-block svelte-1gd50sk"><h3 class="svelte-1gd50sk">Feature stories</h3> <div class="story-grid svelte-1gd50sk"><!></div></div> <div class="section-block svelte-1gd50sk"><div class="section-header svelte-1gd50sk"><h3 class="svelte-1gd50sk">View all stories</h3> <!></div> <div class="story-list custom-scrollbar svelte-1gd50sk"><!></div></div></div>'),jd=T('<div class="section-group svelte-1gd50sk"><div class="section-block svelte-1gd50sk"><h3 class="svelte-1gd50sk">Share</h3> <p class="muted svelte-1gd50sk">Copy a link to this view to share it with your team.</p> <button type="button" class="chip"> </button></div> <div class="section-block svelte-1gd50sk"><h3 class="svelte-1gd50sk">Status</h3> <p> </p></div> <div class="section-block svelte-1gd50sk"><h3 class="svelte-1gd50sk">Settings</h3> <div class="button-stack"><button type="button" class="chip ghost"> </button> <button type="button" class="chip danger">Clear cached state</button></div></div></div>'),Vd=T('<div class="viewer-section custom-scrollbar svelte-1gd50sk"><!></div>'),Ud=T('<div><div class="viewer-tabs svelte-1gd50sk"><button type="button">Map</button> <button type="button">Controls</button> <button type="button">Story</button> <button type="button">Share & Settings</button></div> <!></div>'),$d=T('<button type="button" class="panel-toggle right svelte-1gd50sk">Show panel</button>'),Bd=T("<p> </p>"),zd=T('<div class="card-menu svelte-1gd50sk"><button type="button" class="svelte-1gd50sk">Zoom to</button> <button type="button" class="svelte-1gd50sk">Select</button></div>'),Yd=T('<div><div class="list-card-header svelte-1gd50sk"><input type="text" placeholder="Annotation name" class="svelte-1gd50sk"/> <div class="list-card-actions svelte-1gd50sk"><input type="color" title="Annotation colour" class="svelte-1gd50sk"/> <button type="button" class="chip ghost"> </button> <button type="button" class="chip danger">Delete</button> <button type="button" class="icon-button svelte-1gd50sk" aria-label="Annotation actions"></button></div></div> <textarea rows="2" placeholder="Annotation details" class="svelte-1gd50sk"></textarea> <!></div>'),qd=T('<p class="empty-state svelte-1gd50sk">Draw or import annotations to see them here.</p>'),Hd=T("<!> <!>",1),Xd=T('<div class="card-menu svelte-1gd50sk"><button type="button" class="svelte-1gd50sk">Apply view</button> <button type="button" class="svelte-1gd50sk"> </button> <button type="button" class="svelte-1gd50sk">Delete</button></div>'),Jd=T('<div><div class="list-card-header svelte-1gd50sk"><input type="text" placeholder="Scene title" class="svelte-1gd50sk"/> <div class="list-card-actions svelte-1gd50sk"><button type="button" class="chip ghost">Go to</button> <button type="button" class="chip ghost">Edit</button> <button type="button" class="chip ghost">Duplicate</button> <button type="button" class="icon-button svelte-1gd50sk"></button></div></div> <textarea rows="2" placeholder="Scene details" class="svelte-1gd50sk"></textarea> <!></div>'),Kd=T('<p class="empty-state svelte-1gd50sk">Capture scenes to build your story.</p>'),Wd=T('<div class="story-list-panel svelte-1gd50sk"><!></div>'),Zd=T('<aside class="creator-panel right svelte-1gd50sk"><header class="creator-right-header svelte-1gd50sk"><button type="button" class="panel-collapse svelte-1gd50sk">Hide panel</button> <div class="creator-right-controls svelte-1gd50sk"><div class="toggle-group svelte-1gd50sk"><button type="button">Annotations</button> <button type="button">Story slides</button></div> <div class="right-actions svelte-1gd50sk"><button type="button" class="chip ghost">Clear</button> <button type="button" class="chip ghost">Export</button> <label class="chip ghost upload">Import <input type="file" accept="application/geo+json,.geojson,.json"/></label></div></div></header> <div class="creator-right-body custom-scrollbar svelte-1gd50sk"><!></div></aside>'),Qd=T("<!> <!>",1),eu=T('<div><dt class="svelte-1gd50sk">Summary</dt> <dd class="svelte-1gd50sk"> </dd></div>'),tu=T('<div><dt class="svelte-1gd50sk">Details</dt> <dd class="svelte-1gd50sk"> </dd></div>'),su=T('<section class="metadata-section svelte-1gd50sk"><h3 class="svelte-1gd50sk"> </h3> <dl class="svelte-1gd50sk"><div><dt class="svelte-1gd50sk">Type</dt> <dd class="svelte-1gd50sk"> </dd></div> <!> <!></dl></section>'),nu=T('<p class="empty-state svelte-1gd50sk">Select a map to view its metadata.</p>'),iu=T('<div class="metadata-overlay svelte-1gd50sk" role="dialog" aria-modal="true" tabindex="0"><div class="metadata-card svelte-1gd50sk"><header class="svelte-1gd50sk"><h2 class="svelte-1gd50sk">Map metadata</h2> <button type="button" class="chip ghost svelte-1gd50sk">Close</button></header> <!></div></div>'),ru=T('<p class="muted svelte-1gd50sk">Searching</p>'),au=T("<p> </p>"),ou=T('<span class="result-type svelte-1gd50sk"> </span>'),lu=T('<div class="search-result-actions svelte-1gd50sk"><button type="button" class="chip ghost">Add to annotations</button></div>'),cu=T('<div class="search-result-item svelte-1gd50sk"><button type="button" class="search-result-main svelte-1gd50sk"><span class="result-title svelte-1gd50sk"> </span> <!></button> <!></div>'),du=T('<div class="search-results-list custom-scrollbar svelte-1gd50sk"></div>'),uu=T('<div class="search-dialog svelte-1gd50sk" role="dialog" aria-modal="true" tabindex="0"><button type="button" class="dialog-backdrop svelte-1gd50sk" aria-label="Dismiss search"></button> <div class="search-card svelte-1gd50sk"><header class="svelte-1gd50sk"><h2 class="svelte-1gd50sk">Search</h2> <button type="button" class="chip ghost">Close</button></header> <div class="search-form svelte-1gd50sk"><input type="text" placeholder="Search for a place or address" class="svelte-1gd50sk"/> <div class="search-form-actions svelte-1gd50sk"><button type="button" class="chip ghost">Locate me</button> <button type="button" class="chip ghost">Clear</button></div></div> <!> <!></div></div>'),hu=T('<button type="button"> </button>'),fu=T('<div class="modal-chip-group svelte-1gd50sk"></div>'),gu=T('<p class="muted svelte-1gd50sk">No annotations yet.</p>'),vu=T('<div class="modal-backdrop svelte-1gd50sk"><div class="modal-card svelte-1gd50sk"><header><h2> </h2></header> <div class="modal-body svelte-1gd50sk"><label class="svelte-1gd50sk"><span>Title</span> <input type="text" placeholder="Scene title" class="svelte-1gd50sk"/></label> <label class="svelte-1gd50sk"><span>Details</span> <textarea rows="3" placeholder="What should viewers know?" class="svelte-1gd50sk"></textarea></label> <label class="svelte-1gd50sk"><span>Delay (seconds)</span> <input type="number" class="svelte-1gd50sk"/></label> <fieldset class="svelte-1gd50sk"><legend>Visible annotations</legend> <!></fieldset></div> <footer class="modal-footer svelte-1gd50sk"><button type="button" class="ghost">Cancel</button> <button type="button"> </button></footer></div></div>'),pu=T('<div><!> <div class="workspace svelte-1gd50sk"><!> <div class="map-stage svelte-1gd50sk"><div class="map-surface svelte-1gd50sk"><div class="map svelte-1gd50sk"></div> <div class="divider vertical svelte-1gd50sk" aria-hidden="true"></div> <div class="divider horizontal svelte-1gd50sk" aria-hidden="true"></div> <button class="handle vertical svelte-1gd50sk" type="button" aria-label="Drag vertical split" title="Drag vertical split"></button> <button class="handle horizontal svelte-1gd50sk" type="button" aria-label="Drag horizontal split" title="Drag horizontal split"></button> <div class="lens svelte-1gd50sk" aria-hidden="true"></div> <button class="lens-handle svelte-1gd50sk" type="button" aria-label="Adjust spyglass radius" title="Adjust spyglass radius"></button></div> <!> <!></div> <!></div> <!> <!> <!></div>');function mu(c,e){To(e,!1);const s=()=>Vr(Ws,"$annotationHistory",r),n=()=>Vr(et,"$annotationState",r),[r,a]=Po(),l=M(),d=M(),p=M(),_=M(),y=M(),E=M(),I=M(),L=M(),R=new sr,Ee=1,He=60,ut=5,os=100;let Vt=M(),nt=M(),kt=M(),Jt=M(),Kt=M(),ht=M(),Wt=M(),ga=Mi(e,"initialMode",8,"explore"),va=Mi(e,"showWelcomeOverlay",8,!0),qe=M(null),Js=M([]),ms=M([]),Zt=M([]),Qt=M(!1),Mt=M(!1),Ut=M(!1),xt=M(!1),ls=M(!1),Xe=M("g-streets"),es=M("all"),at=M(""),rr=M("Select a map from the list."),Ne=M([]),Kn=M([]),ar=M(!1),Ze=M(.8),$t=M(va()),je=M(ga()),At=M(!1),ys=M(!1),_s=M(!1),ft=M("map"),gt=M(!1),Bt=M("annotations"),St=M(!1),bs=M(null),cs=M(null),vn=M(!1),Le=M({title:"",details:"",delay:ut,annotations:[]}),pn=M(!1),Es=null,Ks=M(!0),or=M();const Ws=qc(os),et=Kc();Zc({history:Ws,state:et});let Zs=!1,mn=new globalThis.Map,zt=M(null),Ct=M([]),lr=M(null),Lt=M(""),vt=M([]),Yt=M(!1),ot=M(null),lt=M("info"),Wn=null,Zn=null,ds=null,Qn=M(null),ei=M("info"),ws=!1,Y=M([]),Ve=M(null),Qs=M(!1),pt=M(0),qt=M(!1),yn=null,cr=M(null),D=M(null),Ue=null,ts=M(null),H=null,_n=null,ss=null,bn=null,Dt=null,ks=null,Ts=null,Ms=null,ti=[],As=M(null),si=M(null),en=M(null);const ni={};let ct=null,xs=null,tn=null,mt=M({sideX:!1,sideY:!1,lensR:!1}),Te=M("overlay"),yt=.5,Gt=150,ii=null,Ss=null,sn=null;function Cs(i,o=!1){h(rr,i),h(ar,o)}function tt(){const i=H?H.getFeatures().map(o=>Uc(o)):[];et.setList(i)}function Ls(i){return H?.getFeatureById(i)??null}function Pt(i,o="info"){h(Qn,i),h(ei,o)}function pa(){if(typeof window>"u"||!ws)return;const i=t(D)?.getView(),o={basemapSelection:t(Xe),selectedMapId:t(at)||void 0,overlayId:xs||void 0,view:{mode:t(Te),sideRatio:yt,lensRadius:Gt,opacity:t(Ze)}};if(i){const u=i.getCenter(),g=i.getZoom(),w=i.getRotation();u&&typeof g=="number"&&typeof w=="number"&&(o.mapView={center:u,zoom:g,rotation:w})}if(H){const u=H.getFeatures();u.length&&(o.annotations=R.writeFeaturesObject(u,{featureProjection:"EPSG:3857",dataProjection:"EPSG:4326"}))}t(Y).length&&(o.storyScenes=t(Y));try{window.localStorage.setItem(xi,JSON.stringify(o))}catch(u){console.warn("Unable to save viewer state",u)}}function ce(){typeof window>"u"||!ws||(Zn&&window.clearTimeout(Zn),Zn=window.setTimeout(pa,500))}async function ma(){if(typeof window>"u"){ws=!0;return}const i=new URLSearchParams(window.location.search),u=["map","view","lat","lon","zoom","rotation","basemap"].some(b=>i.has(b));let g=!1;const w=window.localStorage.getItem(xi);if(!w){u&&await xr(i)&&(ns(),g=!0),ws=!0,g&&ce();return}try{ws=!1;const b=JSON.parse(w);if(b.basemapSelection&&fs.some(C=>C.key===b.basemapSelection)&&h(Xe,b.basemapSelection),b.view&&(h(Te,b.view.mode??t(Te)),yt=b.view.sideRatio??yt,Gt=b.view.lensRadius??Gt,h(Ze,b.view.opacity??t(Ze))),H&&b.annotations)try{const C=R.readFeatures(b.annotations,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"});H.clear(),C.forEach(F=>gs(F)),H.addFeatures(C),tt()}catch(C){console.warn("Could not restore saved annotations",C),H.clear()}const S=t(D)?.getView();if(S&&b.mapView){const{center:C,zoom:F,rotation:G}=b.mapView;C&&S.setCenter(C),typeof F=="number"&&S.setZoom(F),typeof G=="number"&&S.setRotation(G)}const x=b.overlayId??b.selectedMapId;x&&t(Ne).some(C=>C.id===x)?(h(at,x),await Cn(x)):b.selectedMapId&&t(Ne).some(C=>C.id===b.selectedMapId)&&h(at,b.selectedMapId),Array.isArray(b.storyScenes)&&h(Y,b.storyScenes.map((C,F)=>Sa(C,F))),u&&await xr(i)&&(ns(),g=!0)}catch(b){console.warn("Failed to load saved viewer state",b)}finally{ws=!0,g&&ce(),hs()}}function ya(){if(!(typeof window>"u")){try{window.localStorage.removeItem(xi)}catch(i){console.warn("Failed to clear saved state",i)}window.location.reload()}}function wn(){if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return`scene-${crypto.randomUUID()}`;const i=Math.random().toString(36).slice(2,8);return`scene-${Date.now().toString(36)}-${i}`}function nn(i){return Number.isFinite(i)?Math.max(Ee,Math.min(He,Math.round(i))):ut}function rn(){return t(Ct).filter(i=>!i.hidden).map(i=>i.id)}function Ds(i){return gs(i),Hc(i,{geoJson:R})}function _a(i){const o=Xc(i,{geoJson:R});return gs(o),o}function an(i){if(!H)return null;const o=H.getFeatureById(i.id);o&&H.removeFeature(o);const u=_a(i);return H.addFeature(u),u}function ri(i){if(!H)return null;const o=H.getFeatureById(i);return o&&H.removeFeature(o),o}function Gs(i){Zs||Ws.push(i)}function dr(i){Gs({kind:"annotation-add",snapshot:Ds(i)})}function ba(i){Gs({kind:"annotation-delete",snapshot:Ds(i)})}function kn(i,o,u,g){u!==g&&Gs({kind:"annotation-update",id:String(i.getId()),changes:[{field:o,before:u,after:g}]})}function wa(i){if(!i.length)return;const o=i.map(u=>Ds(u));Gs({kind:"annotation-clear",snapshots:o})}function ka(i){if(!i.length)return;const o=i.map(u=>Ds(u));Gs({kind:"annotation-bulk-add",snapshots:o})}function xa(i,o){Gs({kind:"annotation-geometry",before:i,after:o})}function ur(i,o){switch(i.kind){case"annotation-add":{o==="undo"?(ri(i.snapshot.id),et.clearSelectionIfMatches(i.snapshot.id)):an(i.snapshot)&&et.setSelected(i.snapshot.id);break}case"annotation-delete":{o==="undo"?an(i.snapshot)&&et.setSelected(i.snapshot.id):(ri(i.snapshot.id),et.clearSelectionIfMatches(i.snapshot.id));break}case"annotation-update":{const u=H?.getFeatureById(i.id);if(!u)break;i.changes.forEach(g=>{const w=o==="undo"?g.before:g.after;g.field==="hidden"?u.set("hidden",!!w):u.set(g.field,w)}),u.changed?.();break}case"annotation-geometry":{const u=o==="undo"?i.before:i.after;an(u),et.setSelected(u.id);break}case"annotation-clear":{o==="undo"?(H?.clear(),i.snapshots.forEach(u=>an(u))):(H?.clear(),et.clearSelection());break}case"annotation-bulk-add":{o==="undo"?i.snapshots.forEach(u=>{ri(u.id),et.clearSelectionIfMatches(u.id)}):i.snapshots.forEach(u=>an(u));break}}tt()}function hr(){const i=Ws.undo();i&&(Zs=!0,ur(i,"undo"),Zs=!1,Pt("Undid last action.","info"),ce())}function ai(){const i=Ws.redo();i&&(Zs=!0,ur(i,"redo"),Zs=!1,Pt("Redid last action.","info"),ce())}function on(){yn&&(window.clearTimeout(yn),yn=null)}function Sa(i,o=0){let u=[Number.isFinite(Os[0])?Os[0]:0,Number.isFinite(Os[1])?Os[1]:0];if(Array.isArray(i.center)&&i.center.length===2){const G=i.center.map(U=>Number(U));G.every(U=>Number.isFinite(U))&&(u=G)}else if(i.center&&typeof i.center=="object"&&"x"in i.center&&"y"in i.center){const G=Number(i.center.x),U=Number(i.center.y);Number.isFinite(G)&&Number.isFinite(U)&&(u=[G,U])}const g=typeof i.basemap=="string"&&fs.some(G=>G.key===i.basemap)?i.basemap:t(Xe),w=t(D)?.getView(),b=typeof i.zoom=="number"?i.zoom:w?.getZoom()??14,S=typeof i.rotation=="number"?i.rotation:0,x=i.viewMode,C=x==="side-x"||x==="side-y"||x==="spy"?x:"overlay",F=Array.isArray(i.visibleAnnotations)?i.visibleAnnotations.map(G=>String(G)):rn();return{id:typeof i.id=="string"?i.id:wn(),title:typeof i.title=="string"&&i.title.trim().length?i.title:`Scene ${Number(o)+1}`,details:typeof i.details=="string"?i.details:"",delay:nn(typeof i.delay=="number"?i.delay:ut),center:u,zoom:b,rotation:S,basemap:g,overlayId:typeof i.overlayId=="string"&&i.overlayId.length?i.overlayId:null,opacity:typeof i.opacity=="number"?i.opacity:t(Ze),viewMode:C,sideRatio:typeof i.sideRatio=="number"?i.sideRatio:.5,lensRadius:typeof i.lensRadius=="number"?i.lensRadius:150,visibleAnnotations:F,hidden:!!i.hidden}}function xn(i){t(D)&&t(D).getLayers().getArray().forEach(o=>{const u=o.getProperties();u.base&&o.setVisible(u.name===i)})}function Ca(){return Ue?.getCanvas()??null}function fr(){const i=Ca();if(!i||!t(D))return;const o=t(D).getSize();if(!o)return;const[u,g]=o;if(t(Te)==="overlay")i.style.clipPath="";else if(t(Te)==="side-x"){const w=u*yt;i.style.clipPath=`polygon(${w}px 0, ${u}px 0, ${u}px ${g}px, ${w}px ${g}px)`}else if(t(Te)==="side-y"){const w=g*yt;i.style.clipPath=`polygon(0 ${w}px, ${u}px ${w}px, ${u}px ${g}px, 0 ${g}px)`}else if(t(Te)==="spy"){const w=Gt;i.style.clipPath=`circle(${w}px at ${u/2}px ${g/2}px)`}}function oi(){if(!t(D))return;const i=t(D).getSize();if(!i)return;const[o,u]=i,g=t(Te)==="side-x",w=t(Te)==="side-y";if(t(nt)&&(Ge(nt,t(nt).style.display=g?"block":"none"),g)){const b=o*yt;Ge(nt,t(nt).style.left=`${b}px`),Ge(nt,t(nt).style.height=`${u}px`)}if(t(Jt)&&(Ge(Jt,t(Jt).style.display=g?"block":"none"),g)){const b=o*yt-8;Ge(Jt,t(Jt).style.left=`${b}px`),Ge(Jt,t(Jt).style.top=`${u/2-8}px`)}if(t(kt)&&(Ge(kt,t(kt).style.display=w?"block":"none"),w)){const b=u*yt;Ge(kt,t(kt).style.top=`${b}px`),Ge(kt,t(kt).style.width=`${o}px`)}if(t(Kt)&&(Ge(Kt,t(Kt).style.display=w?"block":"none"),w)){const b=u*yt-8;Ge(Kt,t(Kt).style.left=`${o/2-8}px`),Ge(Kt,t(Kt).style.top=`${b}px`)}}function gr(){if(!t(D))return;const i=t(D).getSize();if(!i)return;const[o,u]=i,g=t(Te)==="spy";if(t(ht)&&(Ge(ht,t(ht).style.display=g?"block":"none"),g)){const w=Math.max(20,Gt*2);Ge(ht,t(ht).style.width=`${w}px`),Ge(ht,t(ht).style.height=`${w}px`),Ge(ht,t(ht).style.left=`${o/2-Gt}px`),Ge(ht,t(ht).style.top=`${u/2-Gt}px`)}t(Wt)&&(Ge(Wt,t(Wt).style.display=g?"block":"none"),g&&(Ge(Wt,t(Wt).style.left=`${o/2+Gt-8}px`),Ge(Wt,t(Wt).style.top=`${u/2-8}px`)))}function ns(){fr(),oi(),gr()}function li(i){h(Te,i),Pa(i!=="overlay"),ns()}function Pa(i){if(!t(D)||!Ts||!Ms)return;const o=t(D).getInteractions(),u=o.getArray().includes(Ts),g=o.getArray().includes(Ms);i?(u&&t(D).removeInteraction(Ts),g&&t(D).removeInteraction(Ms),t(D).getView().setRotation(0)):(u||t(D).addInteraction(Ts),g||t(D).addInteraction(Ms))}function vr(i){if(!t(D)||!t(mt).sideX&&!t(mt).sideY&&!t(mt).lensR)return;const o=t(Vt).getBoundingClientRect(),u=i.clientX-o.left,g=i.clientY-o.top,w=t(D).getSize();if(!w)return;const[b,S]=w;if(t(mt).sideX)yt=Math.max(.01,Math.min(u/b,.99)),oi();else if(t(mt).sideY)yt=Math.max(.01,Math.min(g/S,.99)),oi();else if(t(mt).lensR){const x=u-b/2,C=g-S/2,F=Math.sqrt(x*x+C*C),G=Math.min(b,S)/2;Gt=Math.max(20,Math.min(F,G)),gr()}fr()}function Sn(){!t(mt).sideX&&!t(mt).sideY&&!t(mt).lensR||(ce(),h(mt,{sideX:!1,sideY:!1,lensR:!1}))}async function Fa(){try{Cs("Loading map list");const i=await fetch(xl);if(!i.ok)throw new Error(`HTTP ${i.status}`);const u=(await i.text()).trim().split(/\r?\n/);if(!u.length)throw new Error("No rows.");const g=(u.shift()??"").split(",").map(O=>O.trim().toLowerCase()),w=g.indexOf("name"),b=g.indexOf("id"),S=g.indexOf("type"),x=g.indexOf("summary"),C=g.indexOf("description")!==-1?g.indexOf("description"):g.indexOf("details")!==-1?g.indexOf("details"):g.indexOf("detail"),F=g.indexOf("thumbnail")!==-1?g.indexOf("thumbnail"):g.indexOf("image"),G=g.indexOf("featured")!==-1?g.indexOf("featured"):g.indexOf("is_featured");if(w===-1||b===-1)throw new Error("Missing 'name' or 'id' column.");const U=u.map(O=>O.match(/(".*?"|[^",\r\n]+)(?=\s*,|\s*$)/g)||[]).map(O=>{const ne=(O[w]||"").replace(/"/g,"").trim(),be=(O[b]||"").replace(/"/g,"").trim(),Pe=S>-1&&(O[S]||"").replace(/"/g,"").trim()||"Uncategorized",V=x>-1?(O[x]||"").replace(/"/g,"").trim():"",ge=C>-1?(O[C]||"").replace(/"/g,"").trim():"",ie=F>-1?(O[F]||"").replace(/"/g,"").trim():"",J=G>-1?(O[G]||"").replace(/"/g,"").trim():"",re=/^y(es)?$/i.test(J)||/^true$/i.test(J)||J==="1";if(!ne||!be)return null;const $={id:be,name:ne,type:Pe};return V&&($.summary=V),ge&&($.description=ge),ie&&($.thumbnail=ie),re&&($.isFeatured=!0),$}).filter(O=>!!O);h(Ne,U),Cs("Select a map from the list.")}catch(i){const o=i instanceof Error?i.message:"Unknown error";Cs(`Failed to load map list: ${o}`,!0),h(Ne,[])}}function Ia(i){if(!i)return!1;try{const o=new URL(i);return o.protocol==="http:"||o.protocol==="https:"}catch{return!1}}async function Ea(i,o){if(Ia(i)){const u=await fetch(i,{signal:o});if(!u.ok)throw new Error(`IIIF resource not accessible (HTTP ${u.status})`);const g=await u.json();if(o.aborted)return{annotations:[],cacheKey:i};let w;try{w=Nc.parse(g)}catch(x){throw new Error(`Failed to parse IIIF: ${x.message}`)}let b=[],S=null;try{b=await Dc(w)}catch(x){S=x instanceof Error?x:new Error("Unknown Allmaps API error.")}if(!b.length)try{const x=`https://annotations.allmaps.org/?url=${encodeURIComponent(i)}`,C=await fetch(x,{signal:o});if(C.ok){const F=await C.json();Array.isArray(F)?b=F:F&&Array.isArray(F.annotations)&&(b=F.annotations)}else{const F=await C.text();S??=new Error(`Fallback lookup failed (HTTP ${C.status}): ${F||"No body"}`)}}catch(x){S||(S=x instanceof Error?x:new Error("Unknown fallback lookup error."))}if(!b.length){const x=S?` ${S.message}`:"";throw new Error(`No Allmaps annotations found for that IIIF resource.${x?` ${x}`:""}`)}return{annotations:b,cacheKey:i}}else{const u=`https://annotations.allmaps.org/images/${i}`,g=await fetch(u,{signal:o});if(!g.ok)throw new Error(`Annotation not found (HTTP ${g.status})`);return{annotations:[await g.json()],cacheKey:i}}}async function Ta(i,o){if(!Ue)return[];const u=[];for(const g of i){if(o.aborted)return u;const w=await Ue.addGeoreferenceAnnotation(g);if(o.aborted)return u;if(!(!w||!w.length))for(const b of w){if(b instanceof Error)throw b;u.push(b)}}return u}async function Cn(i){if(!Ue)return;const o=i.trim();if(!o)return;tn&&tn.abort();const u=new AbortController;tn=u;const{signal:g}=u,w=o;if(w===xs&&ct){try{Ue.setMapOpacity(ct,t(Ze))}catch{}return}if(ct)try{Ue.setMapOpacity(ct,0)}catch{}Cs("Loading map");try{let b=[];if(w in ni)b=ni[w].mapIds;else{const{annotations:x}=await Ea(w,g);if(g.aborted)return;if(b=await Ta(x,g),!b.length)throw new Error("Map could not be added to the viewer.");ni[w]={mapIds:b}}const S=b[0];if(!S)throw new Error("Could not determine map identifier.");ct=S,xs=w;try{for(const x of b)Ue.setMapOpacity(x,t(Ze))}catch{}Cs("Map loaded. Tiles may take a moment to appear."),ns(),ce()}catch(b){if(b.name==="AbortError")return;const S=b instanceof Error?b.message:"Unknown error";Cs(`Failed to load map: ${S}`,!0)}finally{g.aborted||(tn=null)}}async function Pn(i){const o=i?.trim()??"";h(at,o),o?await Cn(o):(br(),ce())}function pr(i){const o=Number(i.target.value);if(h(Ze,o),ct&&Ue)try{Ue.setMapOpacity(ct,t(Ze))}catch{}ce()}function ci(i){t(At)&&(i="explore"),h(je,i),h(gt,i==="create"?t(gt):!1),i==="explore"?(In(),h(Ve,null),En()):(h(St,!1),h(Bt,"annotations")),h($t,!1),hs()}function us(i){li(i),ce(),hs()}function mr(){const i=t(je)==="explore"?"create":"explore";ci(i)}function hs(){t(D)&&(Ss!==null&&cancelAnimationFrame(Ss),Ss=requestAnimationFrame(()=>{Ss=null,t(D)?.updateSize(),ns()}))}function yr(i){return i?"0px":t(_s)?"minmax(200px, 0.24fr)":t(ys)?"minmax(220px, 0.25fr)":"minmax(260px, 0.25fr)"}function Ma(i,o){const g=t(_s)?.82:t(ys)?.78:.75,w=t(_s)?.56:t(ys)?.53:.5;return i&&o?"1":i||o?g.toString():w.toString()}function _r(){ya()}function Fn(i){t(ft)===i?h(gt,!t(gt)):(h(ft,i),h(gt,!0))}function di(){!t(D)||!bn||(t(D).removeInteraction(bn),bn=null)}function Aa(){if(!t(D)||!H||(di(),!t(zt)))return;const i=Cl[t(zt)],o=new ac({source:H,type:i});o.on("drawstart",()=>{ks?.getFeatures().clear()}),o.on("drawend",u=>{const g=u.feature;gs(g),et.setSelected(String(g.getId())),tt(),dr(g),ce(),Pt("Annotation added.","success")}),bn=o,t(D).addInteraction(o)}function In(){h(zt,null),di()}function La(){if(!t(D)||!Dt)return;h(Ks,!t(Ks));const o=t(D).getInteractions().getArray().includes(Dt);t(Ks)?o||t(D).addInteraction(Dt):o&&t(D).removeInteraction(Dt)}function ui(i){t(zt)===i?In():(h(zt,i),Aa())}function Da(i,o){const u=Ls(i);if(!u)return;const g=u.get("label")??"";g!==o&&(u.set("label",o),kn(u,"label",g,o),tt(),ce())}function Ga(i,o){const u=Ls(i);if(!u)return;const g=u.get("details")??"";g!==o&&(u.set("details",o),kn(u,"details",g,o),tt(),ce())}function Oa(i,o){const u=Ls(i);if(!u)return;const g=u.get("color")??"";g!==o&&(u.set("color",o),kn(u,"color",g,o),tt(),ce())}function Ra(i){const o=Ls(i);if(!o)return;const u=!!o.get("hidden");o.set("hidden",!u),kn(o,"hidden",u,!u),tt(),ce()}function Na(i){if(!t(D))return;const u=Ls(i)?.getGeometry();if(u)if(u.getType()==="Point"){const g=u.getCoordinates();t(D).getView().animate({center:g,zoom:Math.max(t(D).getView().getZoom()??16,17),duration:350})}else t(D).getView().fit(u.getExtent(),{padding:[80,80,80,80],duration:400,maxZoom:18})}function ja(i){const o=Ls(i);!o||!H||(ba(o),H.removeFeature(o),et.clearSelectionIfMatches(i),tt(),ce())}function Va(){if(!H)return;const i=H.getFeatures();wa(i),H.clear(),et.reset(),ce(),Pt("All annotations cleared.","info")}function br(){if(Ue&&ct)try{Ue.setMapOpacity(ct,0)}catch{}ct=null,xs=null,h(at,"")}async function Ua(i,o={}){const u=o.animate??!0,g=i.basemap&&fs.some(b=>b.key===i.basemap)?i.basemap:t(Xe);if(g!==t(Xe)&&h(Xe,g),xn(g),i.overlayId){if(i.overlayId!==xs)await Cn(i.overlayId);else if(ct&&Ue)try{Ue.setMapOpacity(ct,i.opacity)}catch{}h(at,i.overlayId)}else br();if(h(Ze,i.opacity),ct&&Ue)try{Ue.setMapOpacity(ct,t(Ze))}catch{}li(i.viewMode??"overlay"),yt=i.sideRatio??.5,Gt=i.lensRadius??150,ns();const w=t(D)?.getView();if(w){const b=i.viewMode==="overlay"?i.rotation??0:0;u?w.animate({center:i.center,zoom:i.zoom,rotation:b,duration:900,easing:Sl}):(w.setCenter(i.center),w.setZoom(i.zoom),w.setRotation(b))}if(H){const b=new Set(i.visibleAnnotations??[]);H.getFeatures().forEach(S=>{const x=String(S.getId()??"");S.set("hidden",!b.has(x))}),tt()}ce()}function hi(i=0){if(!t(Y).length)return null;for(let o=0;o<t(Y).length;o+=1){const u=(i+o)%t(Y).length;if(!t(Y)[u].hidden)return u}return null}function fi(i,o){if(!t(Y).length)return null;for(let u=1;u<=t(Y).length;u+=1){const g=(i+o*u+t(Y).length)%t(Y).length;if(!t(Y)[g].hidden)return g}return null}async function Ht(i,o={}){const u=t(Y)[i];u&&(h(pt,i),await Ua(u,o),t(qt)&&wr())}async function gi(i=0){const o=hi(i);if(o===null){Cs("Nothing to present  capture or show a scene first.",!1);return}h(Qs,!0),h(qt,!1),on(),await Ht(o,{animate:!1})}function En(){h(Qs,!1),h(qt,!1),on()}function wr(){if(on(),!t(qt))return;const i=fi(t(pt),1);if(i===null||i===t(pt)){h(qt,!1);return}const o=t(Y)[t(pt)],u=nn(o?.delay??ut)*1e3;yn=window.setTimeout(()=>{Ht(i).catch(g=>console.error("Failed to advance story scene",g))},u)}async function $a(){const i=fi(t(pt),1);i!==null&&i!==t(pt)&&await Ht(i)}async function Ba(){const i=fi(t(pt),-1);i!==null&&i!==t(pt)&&await Ht(i)}function za(){h(qt,!t(qt)),t(qt)?wr():on()}function Ya(i){if(!t(D))return;const o=t(D).getView(),u=o.getCenter()??Os,g=o.getZoom()??14,w=o.getRotation()??0,{title:b,details:S,delay:x,annotations:C}=i.detail,F={id:t(Ve)!==null?t(Y)[t(Ve)]?.id??wn():wn(),title:b.trim()||`Scene ${t(Y).length+1}`,details:S,delay:nn(x),center:u,zoom:g,rotation:w,basemap:t(Xe),overlayId:xs,opacity:t(Ze),viewMode:t(Te),sideRatio:yt,lensRadius:Gt,visibleAnnotations:C.length?C:rn(),hidden:t(Ve)!==null?t(Y)[t(Ve)]?.hidden??!1:!1};t(Ve)!==null&&t(Ve)>=0&&t(Ve)<t(Y).length?(h(Y,t(Y).map((G,U)=>U===t(Ve)?F:G)),h(Ve,null),Pt("Scene updated.","success")):(h(Y,[...t(Y),F]),Pt("Scene captured.","success")),ce()}async function qa(i){const{index:o}=i.detail;await Ht(o)}function Ha(i){const{index:o}=i.detail,u=t(Y)[o];if(!u)return;const g={...u,id:wn(),title:`${u.title} (Copy)`},w=[...t(Y)];w.splice(o+1,0,g),h(Y,w),ce(),Pt("Scene duplicated.","success")}function Xa(i){const{index:o}=i.detail;if(t(Y)[o]){if(h(Y,t(Y).map((g,w)=>w===o?{...g,hidden:!g.hidden}:g)),t(Qs)){const g=t(Y)[o];if(g&&g.hidden&&t(pt)===o){const w=hi(o);w===null?En():Ht(w,{animate:!1}).catch(b=>console.error("Failed to advance story scene",b))}}ce()}}function Ja(i){const{index:o}=i.detail;if(o<0||o>=t(Y).length)return;const u=[...t(Y)];if(u.splice(o,1),h(Y,u),t(Ve)!==null&&(t(Ve)===o?h(Ve,null):t(Ve)>o&&h(Ve,t(Ve)-1)),t(Qs)){const g=hi(t(pt));g===null?En():(h(pt,g),Ht(g,{animate:!1}).catch(w=>console.error("Failed to advance story scene",w)))}ce()}function Ka(i){qa({detail:{index:i}})}function Wa(i){Ha({detail:{index:i}})}function Za(i){Xa({detail:{index:i}})}function Qa(i){Ja({detail:{index:i}})}function kr(i={}){const{editIndex:o}=i,u=rn();if(typeof o=="number"&&o>=0&&o<t(Y).length){const g=t(Y)[o];h(Ve,o),h(Le,{title:g.title,details:g.details,delay:nn(g.delay),annotations:g.visibleAnnotations.length?[...g.visibleAnnotations]:u})}else h(Ve,null),h(Le,{title:"",details:"",delay:ut,annotations:u});h(vn,!0)}function eo(){h(vn,!1),h(St,!1),h(Ve,null),h(Le,{title:"",details:"",delay:ut,annotations:rn()})}function to(i){const o=t(Le).annotations.includes(i);h(Le,{...t(Le),annotations:o?t(Le).annotations.filter(u=>u!==i):[...t(Le).annotations,i]})}function so(){const i=nn(Number(t(Le).delay));Ya({detail:{title:t(Le).title,details:t(Le).details,delay:i,annotations:t(Le).annotations}}),h(vn,!1),h(Le,{title:"",details:"",delay:ut,annotations:rn()})}function no(){if(typeof window>"u")return"";const i=new URL(window.location.href),o=xs??t(at);o?i.searchParams.set("map",o):i.searchParams.delete("map"),i.searchParams.set("view",t(Te)),i.searchParams.set("basemap",t(Xe));const u=t(D)?.getView();if(u){const g=u.getCenter();if(g){const[S,x]=Pl(g);i.searchParams.set("lat",x.toFixed(6)),i.searchParams.set("lon",S.toFixed(6))}else i.searchParams.delete("lat"),i.searchParams.delete("lon");const w=u.getZoom();typeof w=="number"&&Number.isFinite(w)?i.searchParams.set("zoom",w.toFixed(2)):i.searchParams.delete("zoom");const b=u.getRotation()??0;Math.abs(b)>1e-4?i.searchParams.set("rotation",b.toFixed(3)):i.searchParams.delete("rotation")}else i.searchParams.delete("lat"),i.searchParams.delete("lon"),i.searchParams.delete("zoom"),i.searchParams.delete("rotation");return i.toString()}async function io(){if(console.log("copyShareLink called"),typeof window>"u")return;const i=no()||window.location.href;try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(i);else{const o=document.createElement("textarea");o.value=i,o.setAttribute("readonly","true"),o.style.position="absolute",o.style.left="-9999px",document.body.appendChild(o),o.select(),document.execCommand("copy"),document.body.removeChild(o)}h(pn,!0),Es&&clearTimeout(Es),Es=window.setTimeout(()=>{h(pn,!1)},2e3)}catch(o){console.warn("Failed to copy link",o),h(pn,!1)}}async function xr(i){if(!i.size)return!1;let o=!1;const u=i.get("basemap");u&&fs.some(S=>S.key===u)&&(h(Xe,u),xn(u),o=!0);const g=i.get("view");g&&["overlay","side-x","side-y","spy"].includes(g)&&(li(g),o=!0);const w=i.get("map");w&&t(Ne).some(S=>S.id===w)&&(h(at,w),await Cn(w),o=!0);const b=t(D)?.getView();if(b){const S=i.get("lat"),x=i.get("lon"),C=i.get("zoom"),F=i.get("rotation"),G=S?Number(S):NaN,U=x?Number(x):NaN;if(Number.isFinite(G)&&Number.isFinite(U)&&(b.setCenter(Si([U,G])),o=!0),C){const O=Number(C);Number.isFinite(O)&&(b.setZoom(O),o=!0)}if(F){const O=Number(F);Number.isFinite(O)&&(b.setRotation(O),o=!0)}}return o}function vi(){h(vt,[]),h(ot,null),h(lt,"info"),h(Yt,!1)}function Sr(i){try{if(i.geojson){const o=R.readFeature({type:"Feature",geometry:i.geojson,properties:{}},{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"});return o.set("label",i.display_name??i.type??"Search result"),o}if(i.lon&&i.lat){const o=new Xt(Si([Number(i.lon),Number(i.lat)])),u=new wt({geometry:o});return u.set("label",i.display_name??i.type??"Search result"),u}}catch(o){console.warn("Unable to create feature from search result",o)}return null}async function ro(i){const o=i.trim();if(h(Lt,i),!o){vi(),ss?.clear(),ds?.abort(),ds=null;return}ds?.abort(),ds=new AbortController,h(Yt,!0),h(ot,null),h(lt,"info");try{const u=new URLSearchParams({format:"jsonv2",q:o,addressdetails:"1",polygon_geojson:"1",limit:"10"}),g=await fetch(`https://nominatim.openstreetmap.org/search?${u.toString()}`,{signal:ds.signal,headers:{Accept:"application/json"}});if(!g.ok)throw new Error(`HTTP ${g.status}`);const w=await g.json();h(vt,w),w.length||(h(ot,"No results found."),h(lt,"info"))}catch(u){if(u.name==="AbortError")return;h(ot,"Search failed. Please try again."),h(lt,"error"),console.error("Search error:",u),h(vt,[])}finally{h(Yt,!1)}}function Cr(i){h(Lt,i),Wn&&clearTimeout(Wn),Wn=window.setTimeout(()=>{ro(i)},1e3)}function Pr(i){if(!t(D)||!ss)return;const o=Sr(i);if(!o)return;ss.clear(),ss.addFeature(o);const u=o.getGeometry();if(u)if(u.getType()==="Point"){const g=u.getCoordinates();t(D).getView().animate({center:g,zoom:Math.max(t(D).getView().getZoom()??12,16),duration:400})}else t(D).getView().fit(u.getExtent(),{padding:[80,80,80,80],duration:400,maxZoom:18})}function ao(i){if(!H)return;const o=Sr(i);o&&(gs(o),H.addFeature(o),dr(o),et.setSelected(String(o.getId())),tt(),ce(),vi(),h(ot,"Feature added to annotations."),h(lt,"success"),ss?.clear(),h(Lt,""),Pt("Annotation added from search.","success"))}function Fr(){h(Lt,""),vi(),ss?.clear(),ds?.abort(),ds=null,h(ot,null),h(lt,"info")}function Ir(){const i=t(D),o=ss;if(!(!i||!o)){if(!("geolocation"in navigator)){h(ot,"Geolocation is not available."),h(lt,"error");return}h(Yt,!0),h(ot,null),h(lt,"info"),navigator.geolocation.getCurrentPosition(u=>{const{latitude:g,longitude:w}=u.coords,b=Si([w,g]);o.clear();const S=new wt({geometry:new Xt(b)});S.set("label","Current location"),o.addFeature(S);const x=i.getView();x.animate({center:b,zoom:Math.max(x.getZoom()??12,16),duration:450}),h(Yt,!1),h(ot,"Centered on your location."),h(lt,"success")},u=>{h(Yt,!1),h(ot,`Could not get location: ${u.message}`),h(lt,"error")})}}function oo(i,o){const u=URL.createObjectURL(i),g=document.createElement("a");g.href=u,g.download=o,g.click(),URL.revokeObjectURL(u)}function lo(){if(!H)return;const i=H.getFeatures();if(!i.length){Pt("Nothing to export  the annotation list is empty.","info");return}const o=R.writeFeaturesObject(i,{featureProjection:"EPSG:3857",dataProjection:"EPSG:4326"}),u=new Blob([JSON.stringify(o,null,2)],{type:"application/geo+json;charset=utf-8;"}),g=new Date().toISOString().replace(/[:.]/g,"-");oo(u,`annotations-${g}.geojson`),Pt("GeoJSON downloaded.","success")}async function co(i){if(H)try{const o=JSON.parse(i),u=R.readFeatures(o,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"});u.forEach(g=>gs(g)),H.addFeatures(u),ka(u),tt(),Pt(`Imported ${u.length} feature${u.length!==1?"s":""}.`,"success"),ce()}catch(o){console.error("GeoJSON import failed",o),Pt("Failed to import GeoJSON file.","error")}}async function uo(i){const o=i.target,[u]=o.files??[];if(u)try{await co(await u.text())}finally{o.value=""}}Fo(()=>{const i=fs.map(F=>F.layer());Ue=new Xl,Ue.setZIndex(10),Ue.setProperties({name:"allmaps-overlay"});const o=Ue;o.getDeclutter||(o.getDeclutter=()=>!1),o.renderDeferred||(o.renderDeferred=()=>!1),h(ts,new Yr({source:new js,zIndex:20,properties:{name:"annotations"},declutter:!0})),t(ts).setStyle(Bc),H=t(ts).getSource()??new js,_n=new Yr({source:new js,zIndex:25,properties:{name:"search"},style:F=>zc}),ss=_n.getSource()??new js;const u=Jl({attribution:!1,rotate:!1,zoom:!1}).extend([new Kl({collapsible:!1}),new Wl({autoHide:!1}),new Zl,new Ql]),g=[...i,t(ts),_n];h(D,new ec({target:t(Vt),layers:g,view:new wl({center:Os,zoom:14,enableRotation:!0}),controls:u})),hs(),Ue.setMap?.(t(D)),Ts=new tc({condition:F=>F.originalEvent.ctrlKey||F.originalEvent.metaKey}),Ms=new sc,t(D).addInteraction(Ts),t(D).addInteraction(Ms),H&&(Dt=new cc({source:H}),t(D).addInteraction(Dt),Dt.on("modifystart",F=>{mn.clear(),F.features.forEach(G=>{const U=G,O=U.getId();O&&mn.set(String(O),Ds(U))})}),Dt.on("modifyend",F=>{F.features.forEach(G=>{const U=G,O=U.getId();if(!O)return;const ne=mn.get(String(O)),be=Ds(U);if(!ne)return;const Pe=JSON.stringify(ne.feature.geometry??null),V=JSON.stringify(be.feature.geometry??null);Pe!==V&&xa(ne,be)}),mn.clear(),tt(),ce()}),ks=new Qi({condition:nc,layers:F=>F===t(ts)}),t(D).addInteraction(ks),ks.on("select",F=>{const G=F.selected[0]??null;et.setSelected(G?String(G.getId()):null)}),ti=[H.on("addfeature",()=>{tt(),ce()}),H.on("removefeature",()=>{tt(),ce()}),H.on("changefeature",()=>{tt(),ce()}),H.on("clear",()=>{tt(),ce()})]),t(D).on("moveend",()=>{ns(),ce()}),t(D).on("change:size",ns);const b=window.matchMedia("(max-width: 900px)"),S=window.matchMedia("(max-width: 1400px)"),x=window.matchMedia("(max-width: 1180px)"),C=()=>{h(At,b.matches),t(At)&&(h(je,"explore"),h($t,!1)),h(ys,S.matches),h(_s,x.matches)};C(),b.addEventListener("change",C),S.addEventListener("change",C),x.addEventListener("change",C),ii=()=>{b.removeEventListener("change",C),S.removeEventListener("change",C),x.removeEventListener("change",C)},xn(t(Xe)),Fa().then(()=>ma()).catch(F=>{console.error("Failed to initialise dataset",F),ws=!0}),hs(),window.addEventListener("pointermove",vr),window.addEventListener("pointerup",Sn),window.addEventListener("pointercancel",Sn),window.addEventListener("resize",hs),sn=F=>{if(F.defaultPrevented)return;const G=F.target;if(G&&(G.isContentEditable||["INPUT","TEXTAREA"].includes(G.tagName))||!(F.metaKey||F.ctrlKey))return;const O=F.shiftKey,ne=F.key.toLowerCase();ne==="z"?(F.preventDefault(),O?ai():hr()):ne==="y"&&(F.preventDefault(),ai())},window.addEventListener("keydown",sn)}),Io(()=>{tn?.abort(),ds?.abort(),ii?.(),ii=null,window.removeEventListener("pointermove",vr),window.removeEventListener("pointerup",Sn),window.removeEventListener("pointercancel",Sn),window.removeEventListener("resize",hs),sn&&(window.removeEventListener("keydown",sn),sn=null),ti.forEach(i=>kl(i)),ti=[],di(),t(D)&&Dt&&t(D).removeInteraction(Dt),t(D)&&ks&&t(D).removeInteraction(ks),t(D)?.setTarget(void 0),h(D,null),Ue=null,h(ts,null),H=null,_n=null,ss=null,Dt=null,ks=null,on(),Es&&(clearTimeout(Es),Es=null),Ss!==null&&(cancelAnimationFrame(Ss),Ss=null)}),_e(()=>t(Y),()=>{h(l,t(Y).filter(i=>!i.hidden))}),_e(()=>(t(Y),t(pt)),()=>{h(d,t(Y)[t(pt)]??null)}),_e(()=>(t(d),t(l)),()=>{h(p,t(d)?t(l).findIndex(i=>i.id===t(d).id)+1:0)}),_e(()=>t(Xe),()=>{h(_,fs.find(i=>i.key===t(Xe))?.label??"Basemap")}),_e(()=>t(Ze),()=>{h(y,Math.round(t(Ze)*100))}),_e(()=>t(je),()=>{h(E,t(je)==="explore"?"Exploring":"Creating")}),_e(()=>(t(Ne),t(at)),()=>{h(qe,t(Ne).find(i=>i.id===t(at))??null)}),_e(()=>t(Ne),()=>{h(Js,Array.from(new Set(t(Ne).map(i=>i.type||"Uncategorized"))).filter(i=>i&&i.trim().length).sort((i,o)=>i.localeCompare(o)))}),_e(()=>t(Ne),()=>{h(ms,(()=>{const i=t(Ne).filter(u=>u.isFeatured);return(i.length?i:t(Ne)).slice(0,4)})())}),_e(()=>(t(es),t(Ne)),()=>{h(Kn,t(es)==="all"?t(Ne):t(Ne).filter(i=>i.type.toLowerCase()===t(es).toLowerCase()))}),_e(()=>t(Kn),()=>{h(Zt,t(Kn))}),_e(()=>t(Bt),()=>{t(Bt)!=="annotations"&&h(bs,null)}),_e(()=>t(Bt),()=>{t(Bt)!=="story"&&h(cs,null)}),_e(()=>s(),()=>{h(I,s().history.length>0)}),_e(()=>s(),()=>{h(L,s().future.length>0)}),_e(()=>n(),()=>{h(Ct,n().list)}),_e(()=>n(),()=>{h(lr,n().selectedId)}),_e(()=>t($t),()=>{t($t)&&h(Qt,!1)}),_e(()=>t(qe),()=>{t(qe)||h(Qt,!1)}),_e(()=>t($t),()=>{t($t)&&h(Mt,!1)}),_e(()=>t(je),()=>{t(je)!=="create"&&(h(Ut,!1),h(xt,!1),h(Mt,!1),h(ls,!1))}),_e(()=>(t(Mt),t(en)),()=>{t(Mt)&&t(en)&&queueMicrotask(()=>t(en)?.focus())}),_e(()=>(t(Qt),t(As)),()=>{t(Qt)&&t(As)&&t(As).focus()}),_e(()=>(t(At),t(je),t(Ut),t(xt),t(_s),t(ys)),()=>{h(or,!t(At)&&t(je)==="create"?`grid-template-columns: ${yr(t(Ut))} minmax(0, ${Ma(t(Ut),t(xt))}fr) ${yr(t(xt))}; gap: ${t(_s)?"1rem":t(ys)?"1.1rem":"1.2rem"}; padding: ${t(_s)?"1rem":t(ys)?"1.2rem":"1.4rem"};`:void 0)}),_e(()=>(t(D),t(je),t(Ut),t(xt),t($t),t(gt),t(At)),()=>{t(D)&&(t(je),t(Ut),t(xt),t($t),t(gt),t(At),hs())}),_e(()=>t(Xe),()=>{xn(t(Xe))}),_e(()=>{},()=>{ns()}),_e(()=>(t(ts),t(je)),()=>{t(ts)&&t(ts).setVisible(t(je)==="create")}),Mo(),Co();var Tn=pu();let Er;var Tr=v(Tn);{var ho=i=>{var o=Qc(),u=v(o),g=m(v(u),4),w=v(g);let b;var S=m(w,2);let x;f(g),f(u),f(o),q(()=>{b=te(w,1,"chip ghost svelte-1gd50sk",null,b,{active:t(je)==="explore"}),x=te(S,1,"chip svelte-1gd50sk",null,x,{active:t(je)==="create"})}),k("click",w,()=>ci("explore")),k("click",S,()=>ci("create")),P(i,o)};j(Tr,i=>{!t(At)&&t($t)&&i(ho)})}var Mn=m(Tr,2),Mr=v(Mn);{var fo=i=>{var o=cd(),u=st(o);{var g=S=>{var x=ed();k("click",x,()=>h(Ut,!1)),P(S,x)};j(u,S=>{t(Ut)&&S(g)})}var w=m(u,2);{var b=S=>{var x=ld(),C=v(x),F=m(C,2),G=v(F),U=m(v(G),2),O=m(v(U),2),ne=v(O);let be;var Pe=m(ne,2);let V;var ge=m(Pe,2);let ie;var J=m(ge,2);let re;f(O),f(U);var $=m(U,2),we=m(v($),2),pe=v(we);rs(pe);var xe=m(pe,2),ue=v(xe);f(xe),f(we),f($),f(G);var Se=m(G,2),ze=m(v(Se),2);{var Oe=se=>{var Q=nd(),ae=m(v(Q),2);it(ae,5,()=>t(ms),fe=>fe.id,(fe,oe)=>{var ve=sd();let Ae;var W=v(ve),Z=v(W,!0);f(W);var N=m(W,2);{var X=ee=>{var Ie=td(),B=v(Ie,!0);f(Ie),q(()=>z(B,(t(oe),A(()=>t(oe).summary)))),P(ee,Ie)};j(N,ee=>{t(oe),A(()=>t(oe).summary)&&ee(X)})}f(ve),q(()=>{Ae=te(ve,1,"history-featured-card svelte-1gd50sk",null,Ae,{selected:t(oe).id===t(at)}),z(Z,(t(oe),A(()=>t(oe).name)))}),k("click",ve,()=>void Pn(t(oe).id)),P(fe,ve)}),f(ae),f(Q),P(se,Q)};j(ze,se=>{t(ms),A(()=>t(ms).length)&&se(Oe)})}var me=m(ze,2),ke=v(me),Ce=m(v(ke),2);q(()=>{t(es),Ur(()=>{t(Ne),t(Js)})});var ye=v(Ce),Fe=v(ye);f(ye),ye.value=ye.__value="all";var he=m(ye);it(he,1,()=>t(Js),An,(se,Q)=>{var ae=id(),fe=v(ae,!0);f(ae);var oe={};q(()=>{z(fe,t(Q)),oe!==(oe=t(Q))&&(ae.value=(ae.__value=t(Q))??"")}),P(se,ae)}),f(Ce),f(ke),f(me);var de=m(me,2),K=v(de);{var De=se=>{var Q=Ft(),ae=st(Q);it(ae,1,()=>t(Zt),fe=>fe.id,(fe,oe)=>{var ve=rd();let Ae;var W=v(ve),Z=v(W,!0);f(W);var N=m(W,2),X=v(N,!0);f(N),f(ve),q(()=>{Ae=te(ve,1,"history-item svelte-1gd50sk",null,Ae,{selected:t(oe).id===t(at)}),z(Z,(t(oe),A(()=>t(oe).name))),z(X,(t(oe),A(()=>t(oe).summary||t(oe).type)))}),k("click",ve,()=>void Pn(t(oe).id)),P(fe,ve)}),P(se,Q)},Je=se=>{var Q=ad();P(se,Q)};j(K,se=>{t(Zt),A(()=>t(Zt).length)?se(De):se(Je,!1)})}f(de),f(Se);var Me=m(Se,2),$e=m(v(Me),2),Re=v($e);it(Re,5,()=>fs,An,(se,Q)=>{var ae=od();let fe;var oe=v(ae,!0);f(ae),q(()=>{fe=te(ae,1,"svelte-1gd50sk",null,fe,{selected:t(Xe)===t(Q).key}),z(oe,(t(Q),A(()=>t(Q).label)))}),k("click",ae,()=>{h(Xe,t(Q).key),ce()}),P(se,ae)}),f(Re),f($e),f(Me),f(F),f(x),q(()=>{be=te(ne,1,"svelte-1gd50sk",null,be,{selected:t(Te)==="overlay"}),V=te(Pe,1,"svelte-1gd50sk",null,V,{selected:t(Te)==="side-x"}),ie=te(ge,1,"svelte-1gd50sk",null,ie,{selected:t(Te)==="side-y"}),re=te(J,1,"svelte-1gd50sk",null,re,{selected:t(Te)==="spy"}),z(ue,`${t(y)??""}%`),z(Fe,`All maps (${t(Ne),A(()=>t(Ne).length)??""})`)}),k("click",C,()=>h(Ut,!0)),k("click",ne,()=>us("overlay")),k("click",Pe,()=>us("side-x")),k("click",ge,()=>us("side-y")),k("click",J,()=>us("spy")),Ns(pe,()=>t(Ze),se=>h(Ze,se)),k("input",pe,pr),Br(Ce,()=>t(es),se=>h(es,se)),P(S,x)};j(w,S=>{t(Ut)||S(b)})}P(i,o)};j(Mr,i=>{!t(At)&&t(je)==="create"&&i(fo)})}var pi=m(Mr,2),mi=v(pi),Ar=v(mi);Nt(Ar,i=>h(Vt,i),()=>t(Vt));var Lr=m(Ar,2);Nt(Lr,i=>h(nt,i),()=>t(nt));var Dr=m(Lr,2);Nt(Dr,i=>h(kt,i),()=>t(kt));var yi=m(Dr,2);Nt(yi,i=>h(Jt,i),()=>t(Jt));var _i=m(yi,2);Nt(_i,i=>h(Kt,i),()=>t(Kt));var Gr=m(_i,2);Nt(Gr,i=>h(ht,i),()=>t(ht));var Or=m(Gr,2);Nt(Or,i=>h(Wt,i),()=>t(Wt)),f(mi);var Rr=m(mi,2);{var go=i=>{var o=hd(),u=v(o),g=v(u),w=v(g),b=v(w);f(w);var S=m(w,2),x=m(S,2);let C;var F=v(x,!0);f(x);var G=m(x,2),U=m(G,2);f(g);var O=m(g,2),ne=v(O),be=v(ne,!0);f(ne);var Pe=m(ne,2);{var V=ie=>{var J=dd(),re=v(J,!0);f(J),q(()=>z(re,(t(d),A(()=>t(d).details)))),P(ie,J)},ge=ie=>{var J=ud();P(ie,J)};j(Pe,ie=>{t(d),A(()=>t(d).details?.trim().length)?ie(V):ie(ge,!1)})}f(O),f(u),f(o),q(ie=>{z(b,`${(t(p)||1)??""} / ${ie??""}`),S.disabled=(t(l),A(()=>t(l).length<2)),C=te(x,1,"chip",null,C,{active:t(qt)}),z(F,t(qt)?"Pause":"Play"),G.disabled=(t(l),A(()=>t(l).length<2)),z(be,(t(d),A(()=>t(d).title)))},[()=>(t(l),A(()=>Math.max(t(l).length,1)))]),k("click",S,Ba),k("click",x,za),k("click",G,$a),k("click",U,En),P(i,o)};j(Rr,i=>{t(Qs)&&t(d)&&i(go)})}var vo=m(Rr,2);{var po=i=>{var o=vd(),u=v(o),g=v(u);f(u);var w=m(u,2),b=v(w);let S;var x=m(b,2),C=v(x);let F;var G=m(C,2);{var U=pe=>{var xe=fd(),ue=v(xe);let Se;var ze=m(ue,2);let Oe;var me=m(ze,2);let ke;var Ce=m(me,2);let ye;var Fe=v(Ce,!0);f(Ce);var he=m(Ce,2);f(xe),q(()=>{Se=te(ue,1,"svelte-1gd50sk",null,Se,{selected:t(zt)==="point"}),Oe=te(ze,1,"svelte-1gd50sk",null,Oe,{selected:t(zt)==="line"}),ke=te(me,1,"svelte-1gd50sk",null,ke,{selected:t(zt)==="polygon"}),ye=te(Ce,1,"svelte-1gd50sk",null,ye,{selected:t(Ks)}),z(Fe,t(Ks)?"Disable edit":"Enable edit")}),k("click",ue,()=>{ui("point"),h(St,!1)}),k("click",ze,()=>{ui("line"),h(St,!1)}),k("click",me,()=>{ui("polygon"),h(St,!1)}),k("click",Ce,()=>{La(),h(St,!1)}),k("click",he,()=>{In(),h(St,!1)}),P(pe,xe)};j(G,pe=>{t(St)&&pe(U)})}f(x);var O=m(x,2),ne=m(O,2);f(w);var be=m(w,2),Pe=v(be),V=m(Pe,2);f(be);var ge=m(be,2),ie=v(ge),J=v(ie);let re;var $=m(J,2);{var we=pe=>{var xe=gd(),ue=v(xe),Se=m(ue,2);f(xe),k("click",ue,()=>{mr(),h(ls,!1)}),k("click",Se,()=>{_r(),h(ls,!1)}),P(pe,xe)};j($,pe=>{t(ls)&&pe(we)})}f(ie),f(ge),f(o),q(()=>{S=te(b,1,"svelte-1gd50sk",null,S,{selected:!t(zt)}),bt(C,"aria-expanded",t(St)),F=te(C,1,"svelte-1gd50sk",null,F,{selected:t(St)||!!t(zt)}),O.disabled=!t(I),ne.disabled=!t(L),V.disabled=(t(l),A(()=>!t(l).length)),bt(J,"aria-expanded",t(ls)),re=te(J,1,"svelte-1gd50sk",null,re,{selected:t(ls)})}),k("click",g,()=>h(Mt,!0)),k("click",b,In),k("click",C,()=>h(St,!t(St))),k("click",O,hr),k("click",ne,ai),k("click",Pe,()=>kr()),k("click",V,()=>gi(0)),k("click",J,()=>h(ls,!t(ls))),P(i,o)},mo=i=>{var o=Ft(),u=st(o);{var g=b=>{var S=Ud();let x;var C=v(S),F=v(C);let G;var U=m(F,2);let O;var ne=m(U,2);let be;var Pe=m(ne,2);let V;f(C);var ge=m(C,2);{var ie=J=>{var re=Vd(),$=v(re);{var we=xe=>{var ue=Pd(),Se=v(ue),ze=m(v(Se),2),Oe=v(ze);{var me=N=>{var X=Ft(),ee=st(X);it(ee,1,()=>t(ms),Ie=>Ie.id,(Ie,B)=>{var le=md();let Ye;var Qe=v(le);{var Ke=is=>{var Rt=pd();q(()=>{bt(Rt,"src",(t(B),A(()=>t(B).thumbnail))),bt(Rt,"alt",(t(B),A(()=>`Preview of ${t(B).name}`)))}),P(is,Rt)};j(Qe,is=>{t(B),A(()=>t(B).thumbnail)&&is(Ke)})}var We=m(Qe,2),Be=v(We),_t=v(Be,!0);f(Be);var Ot=m(Be,2),ln=v(Ot,!0);f(Ot),f(We),f(le),q(()=>{Ye=te(le,1,"map-card svelte-1gd50sk",null,Ye,{active:t(B).id===t(at)}),z(_t,(t(B),A(()=>t(B).name))),z(ln,(t(B),A(()=>t(B).summary||t(B).type)))}),k("click",le,()=>void Pn(t(B).id)),P(Ie,le)}),P(N,X)},ke=N=>{var X=yd();P(N,X)};j(Oe,N=>{t(ms),A(()=>t(ms).length)?N(me):N(ke,!1)})}f(ze),f(Se);var Ce=m(Se,2),ye=m(v(Ce),2);{var Fe=N=>{var X=_d(),ee=st(X),Ie=v(ee);f(ee);var B=m(ee,2);q(()=>z(Ie,`View additional information about ${t(qe),A(()=>t(qe).name)??""}.`)),k("click",B,()=>h(Qt,!0)),P(N,X)},he=N=>{var X=bd();P(N,X)};j(ye,N=>{t(qe)?N(Fe):N(he,!1)})}f(Ce);var de=m(Ce,2),K=m(v(de),2);it(K,5,()=>fs,An,(N,X)=>{var ee=wd();let Ie;var B=v(ee,!0);f(ee),q(()=>{Ie=te(ee,1,"svelte-1gd50sk",null,Ie,{selected:t(Xe)===t(X).key}),z(B,(t(X),A(()=>t(X).label)))}),k("click",ee,()=>{h(Xe,t(X).key),ce()}),P(N,ee)}),f(K),f(de);var De=m(de,2),Je=m(v(De),2),Me=v(Je),$e=v(Me);f(Me);var Re=m(Me,2),se=v(Re),Q=m(v(se),2);q(()=>{t(es),Ur(()=>{t(Ne),t(Js)})});var ae=v(Q),fe=v(ae);f(ae),ae.value=ae.__value="all";var oe=m(ae);it(oe,1,()=>t(Js),An,(N,X)=>{var ee=kd(),Ie=v(ee,!0);f(ee);var B={};q(()=>{z(Ie,t(X)),B!==(B=t(X))&&(ee.value=(ee.__value=t(X))??"")}),P(N,ee)}),f(Q),f(se),f(Re);var ve=m(Re,2),Ae=v(ve);{var W=N=>{var X=Ft(),ee=st(X);it(ee,1,()=>t(Zt),Ie=>Ie.id,(Ie,B)=>{var le=Sd();let Ye;var Qe=v(le);{var Ke=is=>{var Rt=xd();q(()=>{bt(Rt,"src",(t(B),A(()=>t(B).thumbnail))),bt(Rt,"alt",(t(B),A(()=>`Preview of ${t(B).name}`)))}),P(is,Rt)};j(Qe,is=>{t(B),A(()=>t(B).thumbnail)&&is(Ke)})}var We=m(Qe,2),Be=v(We),_t=v(Be,!0);f(Be);var Ot=m(Be,2),ln=v(Ot,!0);f(Ot),f(We),f(le),q(()=>{Ye=te(le,1,"catalog-item svelte-1gd50sk",null,Ye,{active:t(B).id===t(at)}),z(_t,(t(B),A(()=>t(B).name))),z(ln,(t(B),A(()=>t(B).summary||t(B).type)))}),k("click",le,()=>void Pn(t(B).id)),P(Ie,le)}),P(N,X)},Z=N=>{var X=Cd();P(N,X)};j(Ae,N=>{t(Zt),A(()=>t(Zt).length)?N(W):N(Z,!1)})}f(ve),f(Je),f(De),f(ue),q(()=>{z($e,`Browse catalog (${t(Zt),A(()=>t(Zt).length)??""})`),z(fe,`All maps (${t(Ne),A(()=>t(Ne).length)??""})`)}),Br(Q,()=>t(es),N=>h(es,N)),P(xe,ue)},pe=xe=>{var ue=Ft(),Se=st(ue);{var ze=me=>{var ke=Ad(),Ce=v(ke),ye=m(v(Ce),2),Fe=v(ye);let he;var de=m(Fe,2);let K;var De=m(de,2);let Je;var Me=m(De,2);let $e;f(ye),f(Ce);var Re=m(Ce,2),se=m(v(Re),2),Q=v(se);rs(Q);var ae=m(Q,2),fe=v(ae);f(ae),f(se),f(Re);var oe=m(Re,2),ve=m(v(oe),2),Ae=v(ve);rs(Ae);var W=m(Ae,2),Z=m(W,2);f(ve);var N=m(ve,2);{var X=le=>{var Ye=Fd();P(le,Ye)},ee=le=>{var Ye=Ft(),Qe=st(Ye);{var Ke=We=>{var Be=Id();let _t;var Ot=v(Be,!0);f(Be),q(()=>{_t=te(Be,1,"svelte-1gd50sk",null,_t,{errored:t(lt)==="error",success:t(lt)==="success"}),z(Ot,t(ot))}),P(We,Be)};j(Qe,We=>{t(ot)&&We(Ke)},!0)}P(le,Ye)};j(N,le=>{t(Yt)?le(X):le(ee,!1)})}var Ie=m(N,2);{var B=le=>{var Ye=Md();it(Ye,5,()=>t(vt),Qe=>Qe.display_name,(Qe,Ke)=>{var We=Td(),Be=v(We),_t=v(Be),Ot=v(_t,!0);f(_t);var ln=m(_t,2);{var is=Rt=>{var bi=Ed(),So=v(bi,!0);f(bi),q(()=>z(So,(t(Ke),A(()=>t(Ke).type)))),P(Rt,bi)};j(ln,Rt=>{t(Ke),A(()=>t(Ke).type)&&Rt(is)})}f(Be),f(We),q(()=>z(Ot,(t(Ke),A(()=>t(Ke).display_name)))),k("click",Be,()=>Pr(t(Ke))),P(Qe,We)}),f(Ye),P(le,Ye)};j(Ie,le=>{t(vt),A(()=>t(vt).length)&&le(B)})}f(oe),f(ke),q(()=>{he=te(Fe,1,"svelte-1gd50sk",null,he,{selected:t(Te)==="overlay"}),K=te(de,1,"svelte-1gd50sk",null,K,{selected:t(Te)==="side-x"}),Je=te(De,1,"svelte-1gd50sk",null,Je,{selected:t(Te)==="side-y"}),$e=te(Me,1,"svelte-1gd50sk",null,$e,{selected:t(Te)==="spy"}),z(fe,`${t(y)??""}%`),Rs(Ae,t(Lt)),W.disabled=t(Yt),Z.disabled=(t(Lt),t(vt),A(()=>!t(Lt)&&!t(vt).length))}),k("click",Fe,()=>us("overlay")),k("click",de,()=>us("side-x")),k("click",De,()=>us("side-y")),k("click",Me,()=>us("spy")),Ns(Q,()=>t(Ze),le=>h(Ze,le)),k("input",Q,pr),k("input",Ae,le=>Cr(le.target.value)),k("click",W,Ir),k("click",Z,Fr),P(me,ke)},Oe=me=>{var ke=Ft(),Ce=st(ke);{var ye=he=>{var de=Nd(),K=v(de),De=m(v(K),2),Je=v(De);{var Me=W=>{var Z=Ft(),N=st(Z);it(N,3,()=>(t(l),A(()=>t(l).slice(0,2))),X=>X.id,(X,ee,Ie)=>{var B=Ld(),le=v(B),Ye=v(le,!0);f(le);var Qe=m(le,2),Ke=v(Qe,!0);f(Qe);var We=m(Qe,2),Be=v(We);f(We),f(B),q(()=>{z(Ye,(t(ee),A(()=>t(ee).title))),z(Ke,(t(ee),A(()=>t(ee).details||"No description yet.")))}),k("click",Be,()=>Ht(t(Ie))),P(X,B)}),P(W,Z)},$e=W=>{var Z=Dd();P(W,Z)};j(Je,W=>{t(l),A(()=>t(l).length)?W(Me):W($e,!1)})}f(De),f(K);var Re=m(K,2),se=v(Re),Q=m(v(se),2);{var ae=W=>{var Z=Gd();k("click",Z,()=>gi(0)),P(W,Z)};j(Q,W=>{t(l),A(()=>t(l).length)&&W(ae)})}f(se);var fe=m(se,2),oe=v(fe);{var ve=W=>{var Z=Ft(),N=st(Z);it(N,3,()=>t(l),X=>X.id,(X,ee,Ie)=>{var B=Od(),le=v(B),Ye=v(le),Qe=v(Ye,!0);f(Ye);var Ke=m(Ye,2),We=v(Ke,!0);f(Ke),f(le);var Be=m(le,2),_t=v(Be),Ot=m(_t,2);f(Be),f(B),q(()=>{z(Qe,(t(ee),A(()=>t(ee).title))),z(We,(t(ee),A(()=>t(ee).details||"No description provided.")))}),k("click",_t,()=>Ht(t(Ie))),k("click",Ot,()=>gi(t(Ie))),P(X,B)}),P(W,Z)},Ae=W=>{var Z=Rd();P(W,Z)};j(oe,W=>{t(l),A(()=>t(l).length)?W(ve):W(Ae,!1)})}f(fe),f(Re),f(de),P(he,de)},Fe=he=>{var de=jd(),K=v(de),De=m(v(K),4),Je=v(De,!0);f(De),f(K);var Me=m(K,2),$e=m(v(Me),2);let Re;var se=v($e,!0);f($e),f(Me);var Q=m(Me,2),ae=m(v(Q),2),fe=v(ae),oe=v(fe);f(fe);var ve=m(fe,2);f(ae),f(Q),f(de),q(()=>{z(Je,t(pn)?"Copied!":"Copy link"),Re=te($e,1,"svelte-1gd50sk",null,Re,{errored:t(ar)}),z(se,t(rr)),z(oe,`Switch to ${t(je)==="explore"?"Creator":"Viewer"}`)}),k("click",De,io),k("click",fe,mr),k("click",ve,_r),P(he,de)};j(Ce,he=>{t(ft)==="story"?he(ye):he(Fe,!1)},!0)}P(me,ke)};j(Se,me=>{t(ft)==="control"?me(ze):me(Oe,!1)},!0)}P(xe,ue)};j($,xe=>{t(ft)==="map"?xe(we):xe(pe,!1)})}f(re),P(J,re)};j(ge,J=>{t(gt)&&J(ie)})}f(S),q(()=>{x=te(S,1,"viewer-panel svelte-1gd50sk",null,x,{collapsed:!t(gt)}),bt(F,"aria-expanded",t(ft)==="map"&&t(gt)),G=te(F,1,"svelte-1gd50sk",null,G,{selected:t(ft)==="map"}),bt(U,"aria-expanded",t(ft)==="control"&&t(gt)),O=te(U,1,"svelte-1gd50sk",null,O,{selected:t(ft)==="control"}),bt(ne,"aria-expanded",t(ft)==="story"&&t(gt)),be=te(ne,1,"svelte-1gd50sk",null,be,{selected:t(ft)==="story"}),bt(Pe,"aria-expanded",t(ft)==="info"&&t(gt)),V=te(Pe,1,"svelte-1gd50sk",null,V,{selected:t(ft)==="info"})}),k("click",F,()=>Fn("map")),k("click",U,()=>Fn("control")),k("click",ne,()=>Fn("story")),k("click",Pe,()=>Fn("info")),P(b,S)},w=b=>{};j(u,b=>{t($t)?b(w,!1):b(g)},!0)}P(i,o)};j(vo,i=>{t(je)==="create"?i(po):i(mo,!1)})}f(pi);var yo=m(pi,2);{var _o=i=>{var o=Qd(),u=st(o);{var g=S=>{var x=$d();k("click",x,()=>h(xt,!1)),P(S,x)};j(u,S=>{t(xt)&&S(g)})}var w=m(u,2);{var b=S=>{var x=Zd(),C=v(x),F=v(C),G=m(F,2),U=v(G),O=v(U);let ne;var be=m(O,2);let Pe;f(U);var V=m(U,2),ge=v(V),ie=m(ge,2),J=m(ie,2),re=m(v(J));Nt(re,ue=>h(cr,ue),()=>t(cr)),f(J),f(V),f(G),f(C);var $=m(C,2),we=v($);{var pe=ue=>{var Se=Hd(),ze=st(Se);{var Oe=ye=>{var Fe=Bd();let he;var de=v(Fe,!0);f(Fe),q(()=>{he=te(Fe,1,"notice svelte-1gd50sk",null,he,{errored:t(ei)==="error",success:t(ei)==="success"}),z(de,t(Qn))}),P(ye,Fe)};j(ze,ye=>{t(Qn)&&ye(Oe)})}var me=m(ze,2);{var ke=ye=>{var Fe=Ft(),he=st(Fe);it(he,1,()=>t(Ct),de=>de.id,(de,K)=>{var De=Yd();let Je;var Me=v(De),$e=v(Me);rs($e);var Re=m($e,2),se=v(Re);rs(se);var Q=m(se,2),ae=v(Q,!0);f(Q);var fe=m(Q,2),oe=m(fe,2);f(Re),f(Me);var ve=m(Me,2);wi(ve);var Ae=m(ve,2);{var W=Z=>{var N=zd(),X=v(N),ee=m(X,2);f(N),k("click",X,()=>{Na(t(K).id),h(bs,null)}),k("click",ee,()=>{et.setSelected(t(K).id),h(bs,null)}),P(Z,N)};j(Ae,Z=>{t(bs),t(K),A(()=>t(bs)===t(K).id)&&Z(W)})}f(De),q(()=>{Je=te(De,1,"list-card svelte-1gd50sk",null,Je,{selected:t(K).id===t(lr)}),Rs($e,(t(K),A(()=>t(K).label))),Rs(se,(t(K),A(()=>t(K).color))),z(ae,(t(K),A(()=>t(K).hidden?"Show":"Hide"))),Rs(ve,(t(K),A(()=>t(K).details)))}),k("input",$e,Z=>Da(t(K).id,Z.target.value)),k("input",se,Z=>Oa(t(K).id,Z.target.value)),k("click",Q,()=>Ra(t(K).id)),k("click",fe,()=>ja(t(K).id)),k("click",oe,()=>h(bs,t(bs)===t(K).id?null:t(K).id)),k("input",ve,Z=>Ga(t(K).id,Z.target.value)),P(de,De)}),P(ye,Fe)},Ce=ye=>{var Fe=qd();P(ye,Fe)};j(me,ye=>{t(Ct),A(()=>t(Ct).length)?ye(ke):ye(Ce,!1)})}P(ue,Se)},xe=ue=>{var Se=Wd(),ze=v(Se);{var Oe=ke=>{var Ce=Ft(),ye=st(Ce);it(ye,3,()=>t(Y),Fe=>Fe.id,(Fe,he,de)=>{var K=Jd();let De;var Je=v(K),Me=v(Je);rs(Me);var $e=m(Me,2),Re=v($e),se=m(Re,2),Q=m(se,2),ae=m(Q,2);f($e),f(Je);var fe=m(Je,2);wi(fe);var oe=m(fe,2);{var ve=Ae=>{var W=Xd(),Z=v(W),N=m(Z,2),X=v(N,!0);f(N);var ee=m(N,2);f(W),q(()=>z(X,(t(he),A(()=>t(he).hidden?"Show slide":"Hide slide")))),k("click",Z,()=>{Ka(t(de)),h(cs,null)}),k("click",N,()=>{Za(t(de)),h(cs,null)}),k("click",ee,()=>{Qa(t(de)),h(cs,null)}),P(Ae,W)};j(oe,Ae=>{t(cs),t(he),A(()=>t(cs)===t(he).id)&&Ae(ve)})}f(K),q(()=>{De=te(K,1,"list-card svelte-1gd50sk",null,De,{hidden:t(he).hidden}),Rs(Me,(t(he),A(()=>t(he).title))),Rs(fe,(t(he),A(()=>t(he).details)))}),k("input",Me,Ae=>{const W=Ae.target.value;h(Y,t(Y).map((Z,N)=>N===t(de)?{...Z,title:W}:Z)),ce()}),k("click",Re,()=>Ht(t(de))),k("click",se,()=>kr({editIndex:t(de)})),k("click",Q,()=>Wa(t(de))),k("click",ae,()=>h(cs,t(cs)===t(he).id?null:t(he).id)),k("input",fe,Ae=>{const W=Ae.target.value;h(Y,t(Y).map((Z,N)=>N===t(de)?{...Z,details:W}:Z)),ce()}),P(Fe,K)}),P(ke,Ce)},me=ke=>{var Ce=Kd();P(ke,Ce)};j(ze,ke=>{t(Y),A(()=>t(Y).length)?ke(Oe):ke(me,!1)})}f(Se),P(ue,Se)};j(we,ue=>{t(Bt)==="annotations"?ue(pe):ue(xe,!1)})}f($),f(x),q(()=>{bt(F,"aria-expanded",!t(xt)),ne=te(O,1,"svelte-1gd50sk",null,ne,{selected:t(Bt)==="annotations"}),Pe=te(be,1,"svelte-1gd50sk",null,Pe,{selected:t(Bt)==="story"}),ge.disabled=(t(Ct),A(()=>!t(Ct).length)),ie.disabled=(t(Ct),A(()=>!t(Ct).length))}),k("click",F,()=>h(xt,!t(xt))),k("click",O,()=>h(Bt,"annotations")),k("click",be,()=>h(Bt,"story")),k("click",ge,Va),k("click",ie,lo),k("change",re,uo),P(S,x)};j(w,S=>{t(xt)||S(b)})}P(i,o)};j(yo,i=>{!t(At)&&t(je)==="create"&&i(_o)})}f(Mn);var Nr=m(Mn,2);{var bo=i=>{var o=iu(),u=v(o),g=v(u),w=m(v(g),2);f(g);var b=m(g,2);{var S=C=>{var F=su(),G=v(F),U=v(G,!0);f(G);var O=m(G,2),ne=v(O),be=m(v(ne),2),Pe=v(be,!0);f(be),f(ne);var V=m(ne,2);{var ge=re=>{var $=eu(),we=m(v($),2),pe=v(we,!0);f(we),f($),q(()=>z(pe,(t(qe),A(()=>t(qe).summary)))),P(re,$)};j(V,re=>{t(qe),A(()=>t(qe).summary)&&re(ge)})}var ie=m(V,2);{var J=re=>{var $=tu(),we=m(v($),2),pe=v(we,!0);f(we),f($),q(()=>z(pe,(t(qe),A(()=>t(qe).description)))),P(re,$)};j(ie,re=>{t(qe),A(()=>t(qe).description)&&re(J)})}f(O),f(F),q(()=>{z(U,(t(qe),A(()=>t(qe).name))),z(Pe,(t(qe),A(()=>t(qe).type)))}),P(C,F)},x=C=>{var F=nu();P(C,F)};j(b,C=>{t(qe)?C(S):C(x,!1)})}f(u),f(o),Nt(o,C=>h(As,C),()=>t(As)),k("click",w,()=>h(Qt,!1)),k("keydown",o,C=>{C.key==="Escape"&&(C.preventDefault(),h(Qt,!1)),(C.key==="Enter"||C.key===" ")&&C.target===t(As)&&(C.preventDefault(),h(Qt,!1))}),P(i,o)};j(Nr,i=>{t(Qt)&&i(bo)})}var jr=m(Nr,2);{var wo=i=>{var o=uu(),u=v(o),g=m(u,2),w=v(g),b=m(v(w),2);f(w);var S=m(w,2),x=v(S);rs(x),Nt(x,V=>h(en,V),()=>t(en));var C=m(x,2),F=v(C),G=m(F,2);f(C),f(S);var U=m(S,2);{var O=V=>{var ge=ru();P(V,ge)},ne=V=>{var ge=Ft(),ie=st(ge);{var J=re=>{var $=au();let we;var pe=v($,!0);f($),q(()=>{we=te($,1,"svelte-1gd50sk",null,we,{errored:t(lt)==="error",success:t(lt)==="success"}),z(pe,t(ot))}),P(re,$)};j(ie,re=>{t(ot)&&re(J)},!0)}P(V,ge)};j(U,V=>{t(Yt)?V(O):V(ne,!1)})}var be=m(U,2);{var Pe=V=>{var ge=du();it(ge,5,()=>t(vt),ie=>ie.display_name,(ie,J)=>{var re=cu(),$=v(re),we=v($),pe=v(we,!0);f(we);var xe=m(we,2);{var ue=Oe=>{var me=ou(),ke=v(me,!0);f(me),q(()=>z(ke,(t(J),A(()=>t(J).type)))),P(Oe,me)};j(xe,Oe=>{t(J),A(()=>t(J).type)&&Oe(ue)})}f($);var Se=m($,2);{var ze=Oe=>{var me=lu(),ke=v(me);f(me),k("click",ke,()=>ao(t(J))),P(Oe,me)};j(Se,Oe=>{t(je)==="create"&&Oe(ze)})}f(re),q(()=>z(pe,(t(J),A(()=>t(J).display_name)))),k("click",$,()=>{Pr(t(J)),h(Mt,!1)}),P(ie,re)}),f(ge),P(V,ge)};j(be,V=>{t(vt),A(()=>t(vt).length)&&V(Pe)})}f(g),f(o),Nt(o,V=>h(si,V),()=>t(si)),q(()=>{F.disabled=t(Yt),G.disabled=(t(Lt),t(vt),A(()=>!t(Lt)&&!t(vt).length))}),k("click",u,()=>h(Mt,!1)),k("click",b,()=>h(Mt,!1)),Ns(x,()=>t(Lt),V=>h(Lt,V)),k("input",x,V=>Cr(V.target.value)),k("click",F,Ir),k("click",G,Fr),k("keydown",o,V=>{V.key==="Escape"&&(V.preventDefault(),h(Mt,!1)),(V.key==="Enter"||V.key===" ")&&V.target===t(si)&&(V.preventDefault(),h(Mt,!1))}),P(i,o)};j(jr,i=>{t(Mt)&&i(wo)})}var ko=m(jr,2);{var xo=i=>{var o=vu(),u=v(o),g=v(u),w=v(g),b=v(w,!0);f(w),f(g);var S=m(g,2),x=v(S),C=m(v(x),2);rs(C),f(x);var F=m(x,2),G=m(v(F),2);wi(G),f(F);var U=m(F,2),O=m(v(U),2);rs(O),bt(O,"min",Ee),bt(O,"max",He),f(U);var ne=m(U,2),be=m(v(ne),2);{var Pe=$=>{var we=fu();it(we,5,()=>t(Ct),pe=>pe.id,(pe,xe)=>{var ue=hu();let Se;var ze=v(ue,!0);f(ue),q(Oe=>{Se=te(ue,1,"svelte-1gd50sk",null,Se,Oe),z(ze,(t(xe),A(()=>t(xe).label)))},[()=>({selected:t(Le).annotations.includes(t(xe).id)})]),k("click",ue,()=>to(t(xe).id)),P(pe,ue)}),f(we),P($,we)},V=$=>{var we=gu();P($,we)};j(be,$=>{t(Ct),A(()=>t(Ct).length)?$(Pe):$(V,!1)})}f(ne),f(S);var ge=m(S,2),ie=v(ge),J=m(ie,2),re=v(J,!0);f(J),f(ge),f(u),f(o),q(()=>{z(b,t(Ve)!==null?"Update story scene":"Capture story scene"),z(re,t(Ve)!==null?"Update scene":"Add scene")}),Ns(C,()=>t(Le).title,$=>Ge(Le,t(Le).title=$)),Ns(G,()=>t(Le).details,$=>Ge(Le,t(Le).details=$)),Ns(O,()=>t(Le).delay,$=>Ge(Le,t(Le).delay=$)),k("click",ie,eo),k("click",J,so),P(i,o)};j(ko,i=>{t(vn)&&i(xo)})}f(Tn),q(()=>{Er=te(Tn,1,"viewer svelte-1gd50sk",null,Er,{mobile:t(At),creator:t(je)==="create"}),Fl(Mn,t(or))}),k("pointerdown",yi,i=>{t(Te)==="side-x"&&(h(mt,{sideX:!0,sideY:!1,lensR:!1}),i.currentTarget?.setPointerCapture(i.pointerId),i.preventDefault())}),k("pointerdown",_i,i=>{t(Te)==="side-y"&&(h(mt,{sideX:!1,sideY:!0,lensR:!1}),i.currentTarget?.setPointerCapture(i.pointerId),i.preventDefault())}),k("pointerdown",Or,i=>{t(Te)==="spy"&&(h(mt,{sideX:!1,sideY:!1,lensR:!0}),i.currentTarget?.setPointerCapture(i.pointerId),i.preventDefault())}),P(c,Tn),Ao(),a()}function yu(c,e){let s=Mi(e,"mode",8,"explore");mu(c,{get initialMode(){return s()}})}function Eu(c){yu(c,{})}export{Eu as component};
