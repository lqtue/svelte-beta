import"../chunks/DsnmJJEf.js";import{i as Ao}from"../chunks/CUqaGiYm.js";import{aX as Lo,A as Do,L as E,I as $,J as Go,y as N,z as ne,N as A,x as R,C as Oo,l as i,K as f,D as S,G as w,F as v,bk as te,v as gs,u as B,bl as Ro,q as jn,bm as jo,t as No}from"../chunks/obLiwMeQ.js";import{p as Kn,b as Ve,s as Vo,a as tr}from"../chunks/CeIZ_WK-.js";import{o as Uo,a as $o,s as oe}from"../chunks/6ds4e1Hj.js";import{i as X}from"../chunks/uRYNcqzp.js";import{S as Qs,c as Bo,a as Yo,f as qo,d as zo,r as Ho,G as Xo,u as Jo,l as Ko,E as Hs,b as en,g as Wo,h as Zo,j as Qo,k as bt,m as ea,n as ta,o as sa,p as na,q as ia,s as ri,t as oi,v as ra,P as Je,w as oa,x as aa,y as la,z as ca,A as da,B as ha,C as Wn,F as ua,H as fa,I as ur,J as ga,K as vs,L as ma,M as fr,N as pa,T as Zn,O as ve,Q as Xs,R as Te,U as Js,V as sr,W as ai,X as ya,Y as _a,Z as Nn,_ as Ae,$ as Ue,a0 as Ks,a1 as va,a2 as wa,a3 as ba,a4 as xa,a5 as Sa,a6 as Ca,a7 as ka,a8 as wt,a9 as ye,aa as Pa,ab as Fa,ac as Ea,ad as Ia,ae as Ta,af as is,ag as li,ah as Ht,ai as Ma,aj as ms,ak as Aa,D as La,al as Vn,am as Un,an as Da,e as Xt,i as nr}from"../chunks/iPpcYJ_L.js";import{a as ae,b as Ga,s as $n,r as js,c as Oa,d as Bn}from"../chunks/d6K977q5.js";import{l as Ra,L as Lt,a as ja,i as Na,b as Va,B as Ua,C as $a,P as gr,V as Jt,n as Ba,c as Qn,s as mr,I as Ya,M as Me,d as qa,F as xe,e as ei,f as ci,p as za,g as Ha,h as pr,R as Xa,j as ti,k as ir,m as Kt,o as Ja,q as yr,r as Ka,t as Gt,u as di,v as hi,w as ui,x as fi,y as gi,E as si,z as ts,A as Ws,D as _r,G as vr,H as Wa,J as zs,K as mi,N as pi,O as wr,Q as Za,S as Qa,T as el,U as tl,W as ni,X as Wt,Y as Zs,Z as br,_ as sl,$ as nl,a0 as rr,a1 as il,a2 as rl,a3 as ol,a4 as al,a5 as ll,a6 as cl,a7 as dl,a8 as hl,a9 as ul,aa as or}from"../chunks/DVjjavt6.js";import{w as xr}from"../chunks/ilhcaF4n.js";class tn extends Qs{constructor(e,t,s){super(),s!==void 0&&t===void 0?this.setFlatCoordinates(s,e):(t=t||0,this.setCenterAndRadius(e,t,s))}clone(){const e=new tn(this.flatCoordinates.slice(),void 0,this.layout);return e.applyProperties(this),e}closestPointXY(e,t,s,n){const r=this.flatCoordinates,l=e-r[0],c=t-r[1],u=l*l+c*c;if(u<n){if(u===0)for(let p=0;p<this.stride;++p)s[p]=r[p];else{const p=this.getRadius()/Math.sqrt(u);s[0]=r[0]+p*l,s[1]=r[1]+p*c;for(let g=2;g<this.stride;++g)s[g]=r[g]}return s.length=this.stride,u}return n}containsXY(e,t){const s=this.flatCoordinates,n=e-s[0],r=t-s[1];return n*n+r*r<=this.getRadiusSquared_()}getCenter(){return this.flatCoordinates.slice(0,this.stride)}computeExtent(e){const t=this.flatCoordinates,s=t[this.stride]-t[0];return Bo(t[0]-s,t[1]-s,t[0]+s,t[1]+s,e)}getRadius(){return Math.sqrt(this.getRadiusSquared_())}getRadiusSquared_(){const e=this.flatCoordinates[this.stride]-this.flatCoordinates[0],t=this.flatCoordinates[this.stride+1]-this.flatCoordinates[1];return e*e+t*t}getType(){return"Circle"}intersectsExtent(e){const t=this.getExtent();if(Yo(e,t)){const s=this.getCenter();return e[0]<=s[0]&&e[2]>=s[0]||e[1]<=s[1]&&e[3]>=s[1]?!0:qo(e,this.intersectsCoordinate.bind(this))}return!1}setCenter(e){const t=this.stride,s=this.flatCoordinates[t]-this.flatCoordinates[0],n=e.slice();n[t]=n[0]+s;for(let r=1;r<t;++r)n[t+r]=e[r];this.setFlatCoordinates(this.layout,n),this.changed()}setCenterAndRadius(e,t,s){this.setLayout(s,e,0),this.flatCoordinates||(this.flatCoordinates=[]);const n=this.flatCoordinates;let r=zo(n,0,e,this.stride);n[r++]=n[0]+t;for(let l=1,c=this.stride;l<c;++l)n[r++]=n[l];n.length=r,this.changed()}getCoordinates(){return null}setCoordinates(e,t){}setRadius(e){this.flatCoordinates[this.stride]=this.flatCoordinates[0]+e,this.changed()}rotate(e,t){const s=this.getCenter(),n=this.getStride();this.setCenter(Ho(s,0,s.length,n,e,t,s)),this.changed()}}tn.prototype.transform;class ws extends Xo{constructor(e){super(),this.geometries_=e,this.changeEventsKeys_=[],this.listenGeometriesChange_()}unlistenGeometriesChange_(){this.changeEventsKeys_.forEach(Jo),this.changeEventsKeys_.length=0}listenGeometriesChange_(){const e=this.geometries_;for(let t=0,s=e.length;t<s;++t)this.changeEventsKeys_.push(Ko(e[t],Hs.CHANGE,this.changed,this))}clone(){const e=new ws(Yn(this.geometries_));return e.applyProperties(this),e}closestPointXY(e,t,s,n){if(n<en(this.getExtent(),e,t))return n;const r=this.geometries_;for(let l=0,c=r.length;l<c;++l)n=r[l].closestPointXY(e,t,s,n);return n}containsXY(e,t){const s=this.geometries_;for(let n=0,r=s.length;n<r;++n)if(s[n].containsXY(e,t))return!0;return!1}computeExtent(e){Wo(e);const t=this.geometries_;for(let s=0,n=t.length;s<n;++s)Zo(e,t[s].getExtent());return e}getGeometries(){return Yn(this.geometries_)}getGeometriesArray(){return this.geometries_}getGeometriesArrayRecursive(){let e=[];const t=this.geometries_;for(let s=0,n=t.length;s<n;++s)t[s].getType()===this.getType()?e=e.concat(t[s].getGeometriesArrayRecursive()):e.push(t[s]);return e}getSimplifiedGeometry(e){if(this.simplifiedGeometryRevision!==this.getRevision()&&(this.simplifiedGeometryMaxMinSquaredTolerance=0,this.simplifiedGeometryRevision=this.getRevision()),e<0||this.simplifiedGeometryMaxMinSquaredTolerance!==0&&e<this.simplifiedGeometryMaxMinSquaredTolerance)return this;const t=[],s=this.geometries_;let n=!1;for(let r=0,l=s.length;r<l;++r){const c=s[r],u=c.getSimplifiedGeometry(e);t.push(u),u!==c&&(n=!0)}return n?new ws(t):(this.simplifiedGeometryMaxMinSquaredTolerance=e,this)}getType(){return"GeometryCollection"}intersectsExtent(e){const t=this.geometries_;for(let s=0,n=t.length;s<n;++s)if(t[s].intersectsExtent(e))return!0;return!1}isEmpty(){return this.geometries_.length===0}rotate(e,t){const s=this.geometries_;for(let n=0,r=s.length;n<r;++n)s[n].rotate(e,t);this.changed()}scale(e,t,s){s||(s=Qo(this.getExtent()));const n=this.geometries_;for(let r=0,l=n.length;r<l;++r)n[r].scale(e,t,s);this.changed()}setGeometries(e){this.setGeometriesArray(Yn(e))}setGeometriesArray(e){this.unlistenGeometriesChange_(),this.geometries_=e,this.listenGeometriesChange_(),this.changed()}applyTransform(e){const t=this.geometries_;for(let s=0,n=t.length;s<n;++s)t[s].applyTransform(e);this.changed()}translate(e,t){const s=this.geometries_;for(let n=0,r=s.length;n<r;++n)s[n].translate(e,t);this.changed()}disposeInternal(){this.unlistenGeometriesChange_(),super.disposeInternal()}}function Yn(a){return a.map(e=>e.clone())}class ss extends Qs{constructor(e,t,s){if(super(),this.ends_=[],this.maxDelta_=-1,this.maxDeltaRevision_=-1,Array.isArray(e[0]))this.setCoordinates(e,t);else if(t!==void 0&&s)this.setFlatCoordinates(t,e),this.ends_=s;else{const n=e,r=[],l=[];for(let u=0,p=n.length;u<p;++u){const g=n[u];bt(r,g.getFlatCoordinates()),l.push(r.length)}const c=n.length===0?this.getLayout():n[0].getLayout();this.setFlatCoordinates(c,r),this.ends_=l}}appendLineString(e){bt(this.flatCoordinates,e.getFlatCoordinates().slice()),this.ends_.push(this.flatCoordinates.length),this.changed()}clone(){const e=new ss(this.flatCoordinates.slice(),this.layout,this.ends_.slice());return e.applyProperties(this),e}closestPointXY(e,t,s,n){return n<en(this.getExtent(),e,t)?n:(this.maxDeltaRevision_!=this.getRevision()&&(this.maxDelta_=Math.sqrt(ea(this.flatCoordinates,0,this.ends_,this.stride,0)),this.maxDeltaRevision_=this.getRevision()),ta(this.flatCoordinates,0,this.ends_,this.stride,this.maxDelta_,!1,e,t,s,n))}getCoordinateAtM(e,t,s){return this.layout!="XYM"&&this.layout!="XYZM"||this.flatCoordinates.length===0?null:(t=t!==void 0?t:!1,s=s!==void 0?s:!1,Ra(this.flatCoordinates,0,this.ends_,this.stride,e,t,s))}getCoordinates(){return sa(this.flatCoordinates,0,this.ends_,this.stride)}getEnds(){return this.ends_}getLineString(e){return e<0||this.ends_.length<=e?null:new Lt(this.flatCoordinates.slice(e===0?0:this.ends_[e-1],this.ends_[e]),this.layout)}getLineStrings(){const e=this.flatCoordinates,t=this.ends_,s=this.layout,n=[];let r=0;for(let l=0,c=t.length;l<c;++l){const u=t[l],p=new Lt(e.slice(r,u),s);n.push(p),r=u}return n}getLength(){const e=this.ends_;let t=0,s=0;for(let n=0,r=e.length;n<r;++n)s+=ja(this.flatCoordinates,t,e[n],this.stride),t=e[n];return s}getFlatMidpoints(){const e=[],t=this.flatCoordinates;let s=0;const n=this.ends_,r=this.stride;for(let l=0,c=n.length;l<c;++l){const u=n[l],p=Na(t,s,u,r,.5);bt(e,p),s=u}return e}getSimplifiedGeometryInternal(e){const t=[],s=[];return t.length=na(this.flatCoordinates,0,this.ends_,this.stride,e,t,0,s),new ss(t,"XY",s)}getType(){return"MultiLineString"}intersectsExtent(e){return ia(this.flatCoordinates,0,this.ends_,this.stride,e)}setCoordinates(e,t){this.setLayout(t,e,2),this.flatCoordinates||(this.flatCoordinates=[]);const s=ri(this.flatCoordinates,0,e,this.stride,this.ends_);this.flatCoordinates.length=s.length===0?0:s[s.length-1],this.changed()}}class bs extends Qs{constructor(e,t){super(),t&&!Array.isArray(e[0])?this.setFlatCoordinates(t,e):this.setCoordinates(e,t)}appendPoint(e){bt(this.flatCoordinates,e.getFlatCoordinates()),this.changed()}clone(){const e=new bs(this.flatCoordinates.slice(),this.layout);return e.applyProperties(this),e}closestPointXY(e,t,s,n){if(n<en(this.getExtent(),e,t))return n;const r=this.flatCoordinates,l=this.stride;for(let c=0,u=r.length;c<u;c+=l){const p=oi(e,t,r[c],r[c+1]);if(p<n){n=p;for(let g=0;g<l;++g)s[g]=r[c+g];s.length=l}}return n}getCoordinates(){return ra(this.flatCoordinates,0,this.flatCoordinates.length,this.stride)}getPoint(e){const t=this.flatCoordinates.length/this.stride;return e<0||t<=e?null:new Je(this.flatCoordinates.slice(e*this.stride,(e+1)*this.stride),this.layout)}getPoints(){const e=this.flatCoordinates,t=this.layout,s=this.stride,n=[];for(let r=0,l=e.length;r<l;r+=s){const c=new Je(e.slice(r,r+s),t);n.push(c)}return n}getType(){return"MultiPoint"}intersectsExtent(e){const t=this.flatCoordinates,s=this.stride;for(let n=0,r=t.length;n<r;n+=s){const l=t[n],c=t[n+1];if(oa(e,l,c))return!0}return!1}setCoordinates(e,t){this.setLayout(t,e,1),this.flatCoordinates||(this.flatCoordinates=[]),this.flatCoordinates.length=aa(this.flatCoordinates,0,e,this.stride),this.changed()}}class ns extends Qs{constructor(e,t,s){if(super(),this.endss_=[],this.flatInteriorPointsRevision_=-1,this.flatInteriorPoints_=null,this.maxDelta_=-1,this.maxDeltaRevision_=-1,this.orientedRevision_=-1,this.orientedFlatCoordinates_=null,!s&&!Array.isArray(e[0])){const n=e,r=[],l=[];for(let c=0,u=n.length;c<u;++c){const p=n[c],g=r.length,x=p.getEnds();for(let _=0,I=x.length;_<I;++_)x[_]+=g;bt(r,p.getFlatCoordinates()),l.push(x)}t=n.length===0?this.getLayout():n[0].getLayout(),e=r,s=l}t!==void 0&&s?(this.setFlatCoordinates(t,e),this.endss_=s):this.setCoordinates(e,t)}appendPolygon(e){let t;if(!this.flatCoordinates)this.flatCoordinates=e.getFlatCoordinates().slice(),t=e.getEnds().slice(),this.endss_.push();else{const s=this.flatCoordinates.length;bt(this.flatCoordinates,e.getFlatCoordinates()),t=e.getEnds().slice();for(let n=0,r=t.length;n<r;++n)t[n]+=s}this.endss_.push(t),this.changed()}clone(){const e=this.endss_.length,t=new Array(e);for(let n=0;n<e;++n)t[n]=this.endss_[n].slice();const s=new ns(this.flatCoordinates.slice(),this.layout,t);return s.applyProperties(this),s}closestPointXY(e,t,s,n){return n<en(this.getExtent(),e,t)?n:(this.maxDeltaRevision_!=this.getRevision()&&(this.maxDelta_=Math.sqrt(la(this.flatCoordinates,0,this.endss_,this.stride,0)),this.maxDeltaRevision_=this.getRevision()),ca(this.getOrientedFlatCoordinates(),0,this.endss_,this.stride,this.maxDelta_,!0,e,t,s,n))}containsXY(e,t){return da(this.getOrientedFlatCoordinates(),0,this.endss_,this.stride,e,t)}getArea(){return ha(this.getOrientedFlatCoordinates(),0,this.endss_,this.stride)}getCoordinates(e){let t;return e!==void 0?(t=this.getOrientedFlatCoordinates().slice(),Wn(t,0,this.endss_,this.stride,e)):t=this.flatCoordinates,ua(t,0,this.endss_,this.stride)}getEndss(){return this.endss_}getFlatInteriorPoints(){if(this.flatInteriorPointsRevision_!=this.getRevision()){const e=Va(this.flatCoordinates,0,this.endss_,this.stride);this.flatInteriorPoints_=fa(this.getOrientedFlatCoordinates(),0,this.endss_,this.stride,e),this.flatInteriorPointsRevision_=this.getRevision()}return this.flatInteriorPoints_}getInteriorPoints(){return new bs(this.getFlatInteriorPoints().slice(),"XYM")}getOrientedFlatCoordinates(){if(this.orientedRevision_!=this.getRevision()){const e=this.flatCoordinates;ur(e,0,this.endss_,this.stride)?this.orientedFlatCoordinates_=e:(this.orientedFlatCoordinates_=e.slice(),this.orientedFlatCoordinates_.length=Wn(this.orientedFlatCoordinates_,0,this.endss_,this.stride)),this.orientedRevision_=this.getRevision()}return this.orientedFlatCoordinates_}getSimplifiedGeometryInternal(e){const t=[],s=[];return t.length=ga(this.flatCoordinates,0,this.endss_,this.stride,Math.sqrt(e),t,0,s),new ns(t,"XY",s)}getPolygon(e){if(e<0||this.endss_.length<=e)return null;let t;if(e===0)t=0;else{const r=this.endss_[e-1];t=r[r.length-1]}const s=this.endss_[e].slice(),n=s[s.length-1];if(t!==0)for(let r=0,l=s.length;r<l;++r)s[r]-=t;return new vs(this.flatCoordinates.slice(t,n),this.layout,s)}getPolygons(){const e=this.layout,t=this.flatCoordinates,s=this.endss_,n=[];let r=0;for(let l=0,c=s.length;l<c;++l){const u=s[l].slice(),p=u[u.length-1];if(r!==0)for(let x=0,_=u.length;x<_;++x)u[x]-=r;const g=new vs(t.slice(r,p),e,u);n.push(g),r=p}return n}getType(){return"MultiPolygon"}intersectsExtent(e){return ma(this.getOrientedFlatCoordinates(),0,this.endss_,this.stride,e)}setCoordinates(e,t){this.setLayout(t,e,3),this.flatCoordinates||(this.flatCoordinates=[]);const s=fr(this.flatCoordinates,0,e,this.stride,this.endss_);if(s.length===0)this.flatCoordinates.length=0;else{const n=s[s.length-1];this.flatCoordinates.length=n.length===0?0:n[n.length-1]}this.changed()}}class yi extends Ua{constructor(e){super(e)}createRenderer(){return new $a(this)}}const Ns={DRAWSTART:"drawstart",DRAWEND:"drawend",DRAWABORT:"drawabort"};class Vs extends ai{constructor(e,t){super(e),this.feature=t}}function fl(a,e){const t=[];for(let s=0;s<e.length;++s){const r=e[s].getGeometry();Sr(a,r,t)}return t}function Us(a,e){return oi(a[0],a[1],e[0],e[1])}function Zt(a,e){const t=a.length;return e<0?a[e+t]:e>=t?a[e-t]:a[e]}function $s(a,e,t){let s,n;e<t?(s=e,n=t):(s=t,n=e);const r=Math.ceil(s),l=Math.floor(n);if(r>l){const u=Qt(a,s),p=Qt(a,n);return Us(u,p)}let c=0;if(s<r){const u=Qt(a,s),p=Zt(a,r);c+=Us(u,p)}if(l<n){const u=Zt(a,l),p=Qt(a,n);c+=Us(u,p)}for(let u=r;u<l-1;++u){const p=Zt(a,u),g=Zt(a,u+1);c+=Us(p,g)}return c}function Sr(a,e,t){if(e instanceof Lt){Bs(a,e.getCoordinates(),!1,t);return}if(e instanceof ss){const s=e.getCoordinates();for(let n=0,r=s.length;n<r;++n)Bs(a,s[n],!1,t);return}if(e instanceof vs){const s=e.getCoordinates();for(let n=0,r=s.length;n<r;++n)Bs(a,s[n],!0,t);return}if(e instanceof ns){const s=e.getCoordinates();for(let n=0,r=s.length;n<r;++n){const l=s[n];for(let c=0,u=l.length;c<u;++c)Bs(a,l[c],!0,t)}return}if(e instanceof ws){const s=e.getGeometries();for(let n=0;n<s.length;++n)Sr(a,s[n],t);return}}const qn={index:-1,endIndex:NaN};function gl(a,e,t,s){const n=a[0],r=a[1];let l=1/0,c=-1,u=NaN;for(let x=0;x<e.targets.length;++x){const _=e.targets[x],I=_.coordinates;let M=1/0,z;for(let le=0;le<I.length-1;++le){const dt=I[le],ht=I[le+1],$e=Cr(n,r,dt,ht);$e.squaredDistance<M&&(M=$e.squaredDistance,z=le+$e.along)}M<l&&(l=M,_.ring&&e.targetIndex===x&&(_.endIndex>_.startIndex?z<_.startIndex&&(z+=I.length):_.endIndex<_.startIndex&&z>_.startIndex&&(z-=I.length)),u=z,c=x)}const p=e.targets[c];let g=p.ring;if(e.targetIndex===c&&g){const x=Qt(p.coordinates,u),_=t.getPixelFromCoordinate(x);Js(_,e.startPx)>s&&(g=!1)}if(g){const x=p.coordinates,_=x.length,I=p.startIndex,M=u;if(I<M){const z=$s(x,I,M);$s(x,I,M-_)<z&&(u-=_)}else{const z=$s(x,I,M);$s(x,I,M+_)<z&&(u+=_)}}return qn.index=c,qn.endIndex=u,qn}function Bs(a,e,t,s){const n=a[0],r=a[1];for(let l=0,c=e.length-1;l<c;++l){const u=e[l],p=e[l+1],g=Cr(n,r,u,p);if(g.squaredDistance===0){const x=l+g.along;s.push({coordinates:e,ring:t,startIndex:x,endIndex:x});return}}}const zn={along:0,squaredDistance:0};function Cr(a,e,t,s){const n=t[0],r=t[1],l=s[0],c=s[1],u=l-n,p=c-r;let g=0,x=n,_=r;return(u!==0||p!==0)&&(g=_a(((a-n)*u+(e-r)*p)/(u*u+p*p),0,1),x+=u*g,_+=p*g),zn.along=g,zn.squaredDistance=ya(oi(a,e,x,_),10),zn}function Qt(a,e){const t=a.length;let s=Math.floor(e);const n=e-s;s>=t?s-=t:s<0&&(s+=t);let r=s+1;r>=t&&(r-=t);const l=a[s],c=l[0],u=l[1],p=a[r],g=p[0]-c,x=p[1]-u;return[c+g*n,u+x*n]}class ml extends gr{constructor(e){const t=e;t.stopDown||(t.stopDown=pa),super(t),this.on,this.once,this.un,this.shouldHandle_=!1,this.downPx_=null,this.downTimeout_,this.lastDragTime_,this.pointerType_,this.freehand_=!1,this.source_=e.source?e.source:null,this.features_=e.features?e.features:null,this.snapTolerance_=e.snapTolerance?e.snapTolerance:12,this.type_=e.type,this.mode_=yl(this.type_),this.stopClick_=!!e.stopClick,this.minPoints_=e.minPoints?e.minPoints:this.mode_==="Polygon"?3:2,this.maxPoints_=this.mode_==="Circle"?2:e.maxPoints?e.maxPoints:1/0,this.finishCondition_=e.finishCondition?e.finishCondition:Zn,this.geometryLayout_=e.geometryLayout?e.geometryLayout:"XY";let s=e.geometryFunction;if(!s){const n=this.mode_;if(n==="Circle")s=(r,l,c)=>{const u=l||new tn([NaN,NaN]),p=ve(r[0]),g=Xs(p,ve(r[r.length-1]));return u.setCenterAndRadius(p,Math.sqrt(g),this.geometryLayout_),u};else{let r;n==="Point"?r=Je:n==="LineString"?r=Lt:n==="Polygon"&&(r=vs),s=(l,c,u)=>(c?n==="Polygon"?l[0].length?c.setCoordinates([l[0].concat([l[0][0]])],this.geometryLayout_):c.setCoordinates([],this.geometryLayout_):c.setCoordinates(l,this.geometryLayout_):c=new r(l,this.geometryLayout_),c)}}this.geometryFunction_=s,this.dragVertexDelay_=e.dragVertexDelay!==void 0?e.dragVertexDelay:500,this.finishCoordinate_=null,this.sketchFeature_=null,this.sketchPoint_=null,this.sketchCoords_=null,this.sketchLine_=null,this.sketchLineCoords_=null,this.squaredClickTolerance_=e.clickTolerance?e.clickTolerance*e.clickTolerance:36,this.overlay_=new yi({source:new Jt({useSpatialIndex:!1,wrapX:e.wrapX?e.wrapX:!1}),style:e.style?e.style:pl(),updateWhileInteracting:!0}),this.geometryName_=e.geometryName,this.condition_=e.condition?e.condition:Ba,this.freehandCondition_,e.freehand?this.freehandCondition_=Qn:this.freehandCondition_=e.freehandCondition?e.freehandCondition:mr,this.traceCondition_,this.setTrace(e.trace||!1),this.traceState_={active:!1},this.traceSource_=e.traceSource||e.source||null,this.addChangeListener(Ya.ACTIVE,this.updateState_)}setTrace(e){let t;e?e===!0?t=Qn:t=e:t=ei,this.traceCondition_=t}setMap(e){super.setMap(e),this.updateState_()}getOverlay(){return this.overlay_}handleEvent(e){e.originalEvent.type===Hs.CONTEXTMENU&&e.originalEvent.preventDefault(),this.freehand_=this.mode_!=="Point"&&this.freehandCondition_(e);let t=e.type===Me.POINTERMOVE,s=!0;return!this.freehand_&&this.lastDragTime_&&e.type===Me.POINTERDRAG&&(Date.now()-this.lastDragTime_>=this.dragVertexDelay_?(this.downPx_=e.pixel,this.shouldHandle_=!this.freehand_,t=!0):this.lastDragTime_=void 0,this.shouldHandle_&&this.downTimeout_!==void 0&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0)),this.freehand_&&e.type===Me.POINTERDRAG&&this.sketchFeature_!==null?(this.addToDrawing_(e.coordinate),s=!1):this.freehand_&&e.type===Me.POINTERDOWN?s=!1:t&&this.getPointerCount()<2?(s=e.type===Me.POINTERMOVE,s&&this.freehand_?(this.handlePointerMove_(e),this.shouldHandle_&&e.originalEvent.preventDefault()):(e.originalEvent.pointerType==="mouse"||e.type===Me.POINTERDRAG&&this.downTimeout_===void 0)&&this.handlePointerMove_(e)):e.type===Me.DBLCLICK&&(s=!1),super.handleEvent(e)&&s}handleDownEvent(e){return this.shouldHandle_=!this.freehand_,this.freehand_?(this.downPx_=e.pixel,this.finishCoordinate_||this.startDrawing_(e.coordinate),!0):this.condition_(e)?(this.lastDragTime_=Date.now(),this.downTimeout_=setTimeout(()=>{this.handlePointerMove_(new qa(Me.POINTERMOVE,e.map,e.originalEvent,!1,e.frameState))},this.dragVertexDelay_),this.downPx_=e.pixel,!0):(this.lastDragTime_=void 0,!1)}deactivateTrace_(){this.traceState_={active:!1}}toggleTraceState_(e){if(!this.traceSource_||!this.traceCondition_(e))return;if(this.traceState_.active){this.deactivateTrace_();return}const t=this.getMap(),s=t.getCoordinateFromPixel([e.pixel[0]-this.snapTolerance_,e.pixel[1]+this.snapTolerance_]),n=t.getCoordinateFromPixel([e.pixel[0]+this.snapTolerance_,e.pixel[1]-this.snapTolerance_]),r=Te([s,n]),l=this.traceSource_.getFeaturesInExtent(r);if(l.length===0)return;const c=fl(e.coordinate,l);c.length&&(this.traceState_={active:!0,startPx:e.pixel.slice(),targets:c,targetIndex:-1})}addOrRemoveTracedCoordinates_(e,t){const s=e.startIndex<=e.endIndex,n=e.startIndex<=t;s===n?s&&t>e.endIndex||!s&&t<e.endIndex?this.addTracedCoordinates_(e,e.endIndex,t):(s&&t<e.endIndex||!s&&t>e.endIndex)&&this.removeTracedCoordinates_(t,e.endIndex):(this.removeTracedCoordinates_(e.startIndex,e.endIndex),this.addTracedCoordinates_(e,e.startIndex,t))}removeTracedCoordinates_(e,t){if(e===t)return;let s=0;if(e<t){const n=Math.ceil(e);let r=Math.floor(t);r===t&&(r-=1),s=r-n+1}else{const n=Math.floor(e);let r=Math.ceil(t);r===t&&(r+=1),s=n-r+1}s>0&&this.removeLastPoints_(s)}addTracedCoordinates_(e,t,s){if(t===s)return;const n=[];if(t<s){const r=Math.ceil(t);let l=Math.floor(s);l===s&&(l-=1);for(let c=r;c<=l;++c)n.push(Zt(e.coordinates,c))}else{const r=Math.floor(t);let l=Math.ceil(s);l===s&&(l+=1);for(let c=r;c>=l;--c)n.push(Zt(e.coordinates,c))}n.length&&this.appendCoordinates(n)}updateTrace_(e){const t=this.traceState_;if(!t.active||t.targetIndex===-1&&Js(t.startPx,e.pixel)<this.snapTolerance_)return;const s=gl(e.coordinate,t,this.getMap(),this.snapTolerance_);if(t.targetIndex!==s.index){if(t.targetIndex!==-1){const u=t.targets[t.targetIndex];this.removeTracedCoordinates_(u.startIndex,u.endIndex)}const c=t.targets[s.index];this.addTracedCoordinates_(c,c.startIndex,s.endIndex)}else{const c=t.targets[t.targetIndex];this.addOrRemoveTracedCoordinates_(c,s.endIndex)}t.targetIndex=s.index;const n=t.targets[t.targetIndex];n.endIndex=s.endIndex;const r=Qt(n.coordinates,n.endIndex),l=this.getMap().getPixelFromCoordinate(r);e.coordinate=r,e.pixel=[Math.round(l[0]),Math.round(l[1])]}handleUpEvent(e){let t=!0;if(this.getPointerCount()===0){this.downTimeout_&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0),this.handlePointerMove_(e);const s=this.traceState_.active;if(this.toggleTraceState_(e),this.shouldHandle_){const n=!this.finishCoordinate_;n&&this.startDrawing_(e.coordinate),!n&&this.freehand_?this.finishDrawing():!this.freehand_&&(!n||this.mode_==="Point")&&(this.atFinish_(e.pixel,s)?this.finishCondition_(e)&&this.finishDrawing():this.addToDrawing_(e.coordinate)),t=!1}else this.freehand_&&this.abortDrawing()}return!t&&this.stopClick_&&e.preventDefault(),t}handlePointerMove_(e){if(this.pointerType_=e.originalEvent.pointerType,this.downPx_&&(!this.freehand_&&this.shouldHandle_||this.freehand_&&!this.shouldHandle_)){const t=this.downPx_,s=e.pixel,n=t[0]-s[0],r=t[1]-s[1],l=n*n+r*r;if(this.shouldHandle_=this.freehand_?l>this.squaredClickTolerance_:l<=this.squaredClickTolerance_,!this.shouldHandle_)return}if(!this.finishCoordinate_){this.createOrUpdateSketchPoint_(e.coordinate.slice());return}this.updateTrace_(e),this.modifyDrawing_(e.coordinate)}atFinish_(e,t){let s=!1;if(this.sketchFeature_){let n=!1,r=[this.finishCoordinate_];const l=this.mode_;if(l==="Point")s=!0;else if(l==="Circle")s=this.sketchCoords_.length===2;else if(l==="LineString")n=!t&&this.sketchCoords_.length>this.minPoints_;else if(l==="Polygon"){const c=this.sketchCoords_;n=c[0].length>this.minPoints_,r=[c[0][0],c[0][c[0].length-2]],t?r=[c[0][0]]:r=[c[0][0],c[0][c[0].length-2]]}if(n){const c=this.getMap();for(let u=0,p=r.length;u<p;u++){const g=r[u],x=c.getPixelFromCoordinate(g),_=e[0]-x[0],I=e[1]-x[1],M=this.freehand_?1:this.snapTolerance_;if(s=Math.sqrt(_*_+I*I)<=M,s){this.finishCoordinate_=g;break}}}}return s}createOrUpdateSketchPoint_(e){this.sketchPoint_?this.sketchPoint_.getGeometry().setCoordinates(e):(this.sketchPoint_=new xe(new Je(e)),this.updateSketchFeatures_())}createOrUpdateCustomSketchLine_(e){this.sketchLine_||(this.sketchLine_=new xe);const t=e.getLinearRing(0);let s=this.sketchLine_.getGeometry();s?(s.setFlatCoordinates(t.getLayout(),t.getFlatCoordinates()),s.changed()):(s=new Lt(t.getFlatCoordinates(),t.getLayout()),this.sketchLine_.setGeometry(s))}startDrawing_(e){const t=this.getMap().getView().getProjection(),s=sr(this.geometryLayout_);for(;e.length<s;)e.push(0);this.finishCoordinate_=e,this.mode_==="Point"?this.sketchCoords_=e.slice():this.mode_==="Polygon"?(this.sketchCoords_=[[e.slice(),e.slice()]],this.sketchLineCoords_=this.sketchCoords_[0]):this.sketchCoords_=[e.slice(),e.slice()],this.sketchLineCoords_&&(this.sketchLine_=new xe(new Lt(this.sketchLineCoords_)));const n=this.geometryFunction_(this.sketchCoords_,void 0,t);this.sketchFeature_=new xe,this.geometryName_&&this.sketchFeature_.setGeometryName(this.geometryName_),this.sketchFeature_.setGeometry(n),this.updateSketchFeatures_(),this.dispatchEvent(new Vs(Ns.DRAWSTART,this.sketchFeature_))}modifyDrawing_(e){const t=this.getMap(),s=this.sketchFeature_.getGeometry(),n=t.getView().getProjection(),r=sr(this.geometryLayout_);let l,c;for(;e.length<r;)e.push(0);this.mode_==="Point"?c=this.sketchCoords_:this.mode_==="Polygon"?(l=this.sketchCoords_[0],c=l[l.length-1],this.atFinish_(t.getPixelFromCoordinate(e))&&(e=this.finishCoordinate_.slice())):(l=this.sketchCoords_,c=l[l.length-1]),c[0]=e[0],c[1]=e[1],this.geometryFunction_(this.sketchCoords_,s,n),this.sketchPoint_&&this.sketchPoint_.getGeometry().setCoordinates(e),s.getType()==="Polygon"&&this.mode_!=="Polygon"?this.createOrUpdateCustomSketchLine_(s):this.sketchLineCoords_&&this.sketchLine_.getGeometry().setCoordinates(this.sketchLineCoords_),this.updateSketchFeatures_()}addToDrawing_(e){const t=this.sketchFeature_.getGeometry(),s=this.getMap().getView().getProjection();let n,r;const l=this.mode_;return l==="LineString"||l==="Circle"?(this.finishCoordinate_=e.slice(),r=this.sketchCoords_,r.length>=this.maxPoints_&&(this.freehand_?r.pop():n=!0),r.push(e.slice()),this.geometryFunction_(r,t,s)):l==="Polygon"&&(r=this.sketchCoords_[0],r.length>=this.maxPoints_&&(this.freehand_?r.pop():n=!0),r.push(e.slice()),n&&(this.finishCoordinate_=r[0]),this.geometryFunction_(this.sketchCoords_,t,s)),this.createOrUpdateSketchPoint_(e.slice()),this.updateSketchFeatures_(),n?this.finishDrawing():this.sketchFeature_}removeLastPoints_(e){if(!this.sketchFeature_)return;const t=this.sketchFeature_.getGeometry(),s=this.getMap().getView().getProjection(),n=this.mode_;for(let r=0;r<e;++r){let l;if(n==="LineString"||n==="Circle"){if(l=this.sketchCoords_,l.splice(-2,1),l.length>=2){this.finishCoordinate_=l[l.length-2].slice();const c=this.finishCoordinate_.slice();l[l.length-1]=c,this.createOrUpdateSketchPoint_(c)}this.geometryFunction_(l,t,s),t.getType()==="Polygon"&&this.sketchLine_&&this.createOrUpdateCustomSketchLine_(t)}else if(n==="Polygon"){l=this.sketchCoords_[0],l.splice(-2,1);const c=this.sketchLine_.getGeometry();if(l.length>=2){const u=l[l.length-2].slice();l[l.length-1]=u,this.createOrUpdateSketchPoint_(u)}c.setCoordinates(l),this.geometryFunction_(this.sketchCoords_,t,s)}if(l.length===1){this.abortDrawing();break}}this.updateSketchFeatures_()}removeLastPoint(){this.removeLastPoints_(1)}finishDrawing(){const e=this.abortDrawing_();if(!e)return null;let t=this.sketchCoords_;const s=e.getGeometry(),n=this.getMap().getView().getProjection();return this.mode_==="LineString"?(t.pop(),this.geometryFunction_(t,s,n)):this.mode_==="Polygon"&&(t[0].pop(),this.geometryFunction_(t,s,n),t=s.getCoordinates()),this.type_==="MultiPoint"?e.setGeometry(new bs([t])):this.type_==="MultiLineString"?e.setGeometry(new ss([t])):this.type_==="MultiPolygon"&&e.setGeometry(new ns([t])),this.dispatchEvent(new Vs(Ns.DRAWEND,e)),this.features_&&this.features_.push(e),this.source_&&this.source_.addFeature(e),e}abortDrawing_(){this.finishCoordinate_=null;const e=this.sketchFeature_;return this.sketchFeature_=null,this.sketchPoint_=null,this.sketchLine_=null,this.overlay_.getSource().clear(!0),this.deactivateTrace_(),e}abortDrawing(){const e=this.abortDrawing_();e&&this.dispatchEvent(new Vs(Ns.DRAWABORT,e))}appendCoordinates(e){const t=this.mode_,s=!this.sketchFeature_;s&&this.startDrawing_(e[0]);let n;if(t==="LineString"||t==="Circle")n=this.sketchCoords_;else if(t==="Polygon")n=this.sketchCoords_&&this.sketchCoords_.length?this.sketchCoords_[0]:[];else return;s&&n.shift(),n.pop();for(let l=0;l<e.length;l++)this.addToDrawing_(e[l]);const r=e[e.length-1];this.sketchFeature_=this.addToDrawing_(r),this.modifyDrawing_(r)}extend(e){const s=e.getGeometry();this.sketchFeature_=e,this.sketchCoords_=s.getCoordinates();const n=this.sketchCoords_[this.sketchCoords_.length-1];this.finishCoordinate_=n.slice(),this.sketchCoords_.push(n.slice()),this.sketchPoint_=new xe(new Je(n)),this.updateSketchFeatures_(),this.dispatchEvent(new Vs(Ns.DRAWSTART,this.sketchFeature_))}updateSketchFeatures_(){const e=[];this.sketchFeature_&&e.push(this.sketchFeature_),this.sketchLine_&&e.push(this.sketchLine_),this.sketchPoint_&&e.push(this.sketchPoint_);const t=this.overlay_.getSource();t.clear(!0),t.addFeatures(e)}updateState_(){const e=this.getMap(),t=this.getActive();(!e||!t)&&this.abortDrawing(),this.overlay_.setMap(t?e:null)}}function pl(){const a=ci();return function(e,t){return a[e.getGeometry().getType()]}}function yl(a){switch(a){case"Point":case"MultiPoint":return"Point";case"LineString":case"MultiLineString":return"LineString";case"Polygon":case"MultiPolygon":return"Polygon";case"Circle":return"Circle";default:throw new Error("Invalid type: "+a)}}const ar=0,_s=1,lr=[0,0,0,0],es=[],Hn={MODIFYSTART:"modifystart",MODIFYEND:"modifyend"};class Xn extends ai{constructor(e,t,s){super(e),this.features=t,this.mapBrowserEvent=s}}class _l extends gr{constructor(e){super(e),this.on,this.once,this.un,this.boundHandleFeatureChange_=this.handleFeatureChange_.bind(this),this.condition_=e.condition?e.condition:za,this.defaultDeleteCondition_=function(s){return Ha(s)&&pr(s)},this.deleteCondition_=e.deleteCondition?e.deleteCondition:this.defaultDeleteCondition_,this.insertVertexCondition_=e.insertVertexCondition?e.insertVertexCondition:Qn,this.vertexFeature_=null,this.vertexSegments_=null,this.lastPixel_=[0,0],this.ignoreNextSingleClick_=!1,this.featuresBeingModified_=null,this.rBush_=new Xa,this.pixelTolerance_=e.pixelTolerance!==void 0?e.pixelTolerance:10,this.snappedToVertex_=!1,this.changingFeature_=!1,this.dragSegments_=[],this.overlay_=new yi({source:new Jt({useSpatialIndex:!1,wrapX:!!e.wrapX}),style:e.style?e.style:wl(),updateWhileAnimating:!0,updateWhileInteracting:!0}),this.SEGMENT_WRITERS_={Point:this.writePointGeometry_.bind(this),LineString:this.writeLineStringGeometry_.bind(this),LinearRing:this.writeLineStringGeometry_.bind(this),Polygon:this.writePolygonGeometry_.bind(this),MultiPoint:this.writeMultiPointGeometry_.bind(this),MultiLineString:this.writeMultiLineStringGeometry_.bind(this),MultiPolygon:this.writeMultiPolygonGeometry_.bind(this),Circle:this.writeCircleGeometry_.bind(this),GeometryCollection:this.writeGeometryCollectionGeometry_.bind(this)},this.source_=null,this.hitDetection_=null;let t;if(e.features?t=e.features:e.source&&(this.source_=e.source,t=new ti(this.source_.getFeatures()),this.source_.addEventListener(ir.ADDFEATURE,this.handleSourceAdd_.bind(this)),this.source_.addEventListener(ir.REMOVEFEATURE,this.handleSourceRemove_.bind(this))),!t)throw new Error("The modify interaction requires features, a source or a layer");e.hitDetection&&(this.hitDetection_=e.hitDetection),this.features_=t,this.features_.forEach(this.addFeature_.bind(this)),this.features_.addEventListener(Kt.ADD,this.handleFeatureAdd_.bind(this)),this.features_.addEventListener(Kt.REMOVE,this.handleFeatureRemove_.bind(this)),this.lastPointerEvent_=null,this.delta_=[0,0],this.snapToPointer_=e.snapToPointer===void 0?!this.hitDetection_:e.snapToPointer}addFeature_(e){const t=e.getGeometry();if(t){const n=this.SEGMENT_WRITERS_[t.getType()];n&&n(e,t)}const s=this.getMap();s&&s.isRendered()&&this.getActive()&&this.handlePointerAtPixel_(s.getCoordinateFromPixel(this.lastPixel_)),e.addEventListener(Hs.CHANGE,this.boundHandleFeatureChange_)}willModifyFeatures_(e,t){if(!this.featuresBeingModified_){this.featuresBeingModified_=new ti;const s=this.featuresBeingModified_.getArray();for(let n=0,r=t.length;n<r;++n){const l=t[n].feature;l&&!s.includes(l)&&this.featuresBeingModified_.push(l)}this.featuresBeingModified_.getLength()===0?this.featuresBeingModified_=null:this.dispatchEvent(new Xn(Hn.MODIFYSTART,this.featuresBeingModified_,e))}}removeFeature_(e){this.removeFeatureSegmentData_(e),this.vertexFeature_&&this.features_.getLength()===0&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),e.removeEventListener(Hs.CHANGE,this.boundHandleFeatureChange_)}removeFeatureSegmentData_(e){const t=this.rBush_,s=[];t.forEach(function(n){e===n.feature&&s.push(n)});for(let n=s.length-1;n>=0;--n){const r=s[n];for(let l=this.dragSegments_.length-1;l>=0;--l)this.dragSegments_[l][0]===r&&this.dragSegments_.splice(l,1);t.remove(r)}}setActive(e){this.vertexFeature_&&!e&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),super.setActive(e)}setMap(e){this.overlay_.setMap(e),super.setMap(e)}getOverlay(){return this.overlay_}handleSourceAdd_(e){e.feature&&this.features_.push(e.feature)}handleSourceRemove_(e){e.feature&&this.features_.remove(e.feature)}handleFeatureAdd_(e){this.addFeature_(e.element)}handleFeatureChange_(e){if(!this.changingFeature_){const t=e.target;this.removeFeature_(t),this.addFeature_(t)}}handleFeatureRemove_(e){this.removeFeature_(e.element)}writePointGeometry_(e,t){const s=t.getCoordinates(),n={feature:e,geometry:t,segment:[s,s]};this.rBush_.insert(t.getExtent(),n)}writeMultiPointGeometry_(e,t){const s=t.getCoordinates();for(let n=0,r=s.length;n<r;++n){const l=s[n],c={feature:e,geometry:t,depth:[n],index:n,segment:[l,l]};this.rBush_.insert(t.getExtent(),c)}}writeLineStringGeometry_(e,t){const s=t.getCoordinates();for(let n=0,r=s.length-1;n<r;++n){const l=s.slice(n,n+2),c={feature:e,geometry:t,index:n,segment:l};this.rBush_.insert(Te(l),c)}}writeMultiLineStringGeometry_(e,t){const s=t.getCoordinates();for(let n=0,r=s.length;n<r;++n){const l=s[n];for(let c=0,u=l.length-1;c<u;++c){const p=l.slice(c,c+2),g={feature:e,geometry:t,depth:[n],index:c,segment:p};this.rBush_.insert(Te(p),g)}}}writePolygonGeometry_(e,t){const s=t.getCoordinates();for(let n=0,r=s.length;n<r;++n){const l=s[n];for(let c=0,u=l.length-1;c<u;++c){const p=l.slice(c,c+2),g={feature:e,geometry:t,depth:[n],index:c,segment:p};this.rBush_.insert(Te(p),g)}}}writeMultiPolygonGeometry_(e,t){const s=t.getCoordinates();for(let n=0,r=s.length;n<r;++n){const l=s[n];for(let c=0,u=l.length;c<u;++c){const p=l[c];for(let g=0,x=p.length-1;g<x;++g){const _=p.slice(g,g+2),I={feature:e,geometry:t,depth:[c,n],index:g,segment:_};this.rBush_.insert(Te(_),I)}}}}writeCircleGeometry_(e,t){const s=t.getCenter(),n={feature:e,geometry:t,index:ar,segment:[s,s]},r={feature:e,geometry:t,index:_s,segment:[s,s]},l=[n,r];n.featureSegments=l,r.featureSegments=l,this.rBush_.insert(Nn(s),n);let c=t;this.rBush_.insert(c.getExtent(),r)}writeGeometryCollectionGeometry_(e,t){const s=t.getGeometriesArray();for(let n=0;n<s.length;++n){const r=s[n],l=this.SEGMENT_WRITERS_[r.getType()];l(e,r)}}createOrUpdateVertexFeature_(e,t,s,n){let r=this.vertexFeature_;return r?r.getGeometry().setCoordinates(e):(r=new xe(new Je(e)),this.vertexFeature_=r,this.overlay_.getSource().addFeature(r)),r.set("features",t),r.set("geometries",s),r.set("existing",n),r}handleEvent(e){if(!e.originalEvent)return!0;this.lastPointerEvent_=e;let t;return!e.map.getView().getInteracting()&&e.type==Me.POINTERMOVE&&!this.handlingDownUpSequence&&this.handlePointerMove_(e),this.vertexFeature_&&this.deleteCondition_(e)&&(e.type!=Me.SINGLECLICK||!this.ignoreNextSingleClick_?t=this.removePoint():t=!0),e.type==Me.SINGLECLICK&&(this.ignoreNextSingleClick_=!1),super.handleEvent(e)&&!t}findInsertVerticesAndUpdateDragSegments_(e){this.handlePointerAtPixel_(e),this.dragSegments_.length=0,this.featuresBeingModified_=null;const t=this.vertexFeature_;if(!t)return;this.getMap().getView().getProjection();const s=[],n=t.getGeometry().getCoordinates(),r=Te([n]),l=this.rBush_.getInExtent(r),c={};l.sort(vl);for(let u=0,p=l.length;u<p;++u){const g=l[u],x=g.segment;let _=Ae(g.geometry);const I=g.depth;if(I&&(_+="-"+I.join("-")),c[_]||(c[_]=new Array(2)),g.geometry.getType()==="Circle"&&g.index===_s){const M=dr(e,g);Ue(M,n)&&!c[_][0]&&(this.dragSegments_.push([g,0]),c[_][0]=g);continue}if(Ue(x[0],n)&&!c[_][0]){this.dragSegments_.push([g,0]),c[_][0]=g;continue}if(Ue(x[1],n)&&!c[_][1]){if(c[_][0]&&c[_][0].index===0){let M=g.geometry.getCoordinates();switch(g.geometry.getType()){case"LineString":case"MultiLineString":continue;case"MultiPolygon":M=M[I[1]];case"Polygon":if(g.index!==M[I[0]].length-2)continue;break}}this.dragSegments_.push([g,1]),c[_][1]=g;continue}Ae(x)in this.vertexSegments_&&!c[_][0]&&!c[_][1]&&s.push(g)}return s}handleDragEvent(e){this.ignoreNextSingleClick_=!1,this.willModifyFeatures_(e,this.dragSegments_.map(([r])=>r));const t=[e.coordinate[0]+this.delta_[0],e.coordinate[1]+this.delta_[1]],s=[],n=[];for(let r=0,l=this.dragSegments_.length;r<l;++r){const c=this.dragSegments_[r],u=c[0],p=u.feature;s.includes(p)||s.push(p);const g=u.geometry;n.includes(g)||n.push(g);const x=u.depth;let _;const I=u.segment,M=c[1];for(;t.length<g.getStride();)t.push(I[M][t.length]);switch(g.getType()){case"Point":_=t,I[0]=t,I[1]=t;break;case"MultiPoint":_=g.getCoordinates(),_[u.index]=t,I[0]=t,I[1]=t;break;case"LineString":_=g.getCoordinates(),_[u.index+M]=t,I[M]=t;break;case"MultiLineString":_=g.getCoordinates(),_[x[0]][u.index+M]=t,I[M]=t;break;case"Polygon":_=g.getCoordinates(),_[x[0]][u.index+M]=t,I[M]=t;break;case"MultiPolygon":_=g.getCoordinates(),_[x[1]][x[0]][u.index+M]=t,I[M]=t;break;case"Circle":const z=g;if(I[0]=t,I[1]=t,u.index===ar)this.changingFeature_=!0,z.setCenter(t),this.changingFeature_=!1;else{this.changingFeature_=!0,e.map.getView().getProjection();let le=Js(ve(z.getCenter()),ve(t));z.setRadius(le),this.changingFeature_=!1}break}_&&this.setGeometryCoordinates_(g,_)}this.createOrUpdateVertexFeature_(t,s,n,!0)}handleDownEvent(e){if(!this.condition_(e))return!1;const t=e.coordinate,s=this.findInsertVerticesAndUpdateDragSegments_(t);if(s?.length&&this.insertVertexCondition_(e)&&(this.willModifyFeatures_(e,s),this.vertexFeature_)){const n=this.vertexFeature_.getGeometry().getCoordinates();for(let r=s.length-1;r>=0;--r)this.insertVertex_(s[r],n);this.ignoreNextSingleClick_=!0}return!!this.vertexFeature_}handleUpEvent(e){for(let t=this.dragSegments_.length-1;t>=0;--t){const s=this.dragSegments_[t][0],n=s.geometry;if(n.getType()==="Circle"){const r=n,l=r.getCenter(),c=s.featureSegments[0],u=s.featureSegments[1];c.segment[0]=l,c.segment[1]=l,u.segment[0]=l,u.segment[1]=l,this.rBush_.update(Nn(l),c);let p=r;this.rBush_.update(p.getExtent(),u)}else this.rBush_.update(Te(s.segment),s)}return this.featuresBeingModified_&&(this.dispatchEvent(new Xn(Hn.MODIFYEND,this.featuresBeingModified_,e)),this.featuresBeingModified_=null),!1}handlePointerMove_(e){this.lastPixel_=e.pixel,this.handlePointerAtPixel_(e.coordinate)}handlePointerAtPixel_(e){const t=this.getMap(),s=t.getPixelFromCoordinate(e);t.getView().getProjection();const n=function(c,u){return cr(e,c)-cr(e,u)};let r,l;if(this.hitDetection_){const c=typeof this.hitDetection_=="object"?u=>u===this.hitDetection_:void 0;t.forEachFeatureAtPixel(s,(u,p,g)=>{g&&g.getType()==="Point"&&(g=new Je(Ks(g.getCoordinates())));const x=g||u.getGeometry();if(x&&x.getType()==="Point"&&u instanceof xe&&this.features_.getArray().includes(u)){l=x;const _=u.getGeometry().getFlatCoordinates().slice(0,2);r=[{feature:u,geometry:l,segment:[_,_]}]}return!0},{layerFilter:c})}if(!r){const c=va(Nn(e,lr)),u=t.getView().getResolution()*this.pixelTolerance_,p=wa(ba(c,u,lr));r=this.rBush_.getInExtent(p)}if(r&&r.length>0){const c=r.sort(n)[0],u=c.segment;let p=dr(e,c);const g=t.getPixelFromCoordinate(p);let x=Js(s,g);if(l||x<=this.pixelTolerance_){const _={};if(_[Ae(u)]=!0,this.snapToPointer_||(this.delta_[0]=p[0]-e[0],this.delta_[1]=p[1]-e[1]),c.geometry.getType()==="Circle"&&c.index===_s)this.snappedToVertex_=!0,this.createOrUpdateVertexFeature_(p,[c.feature],[c.geometry],this.snappedToVertex_);else{const I=t.getPixelFromCoordinate(u[0]),M=t.getPixelFromCoordinate(u[1]),z=Xs(g,I),le=Xs(g,M);if(x=Math.sqrt(Math.min(z,le)),this.snappedToVertex_=x<=this.pixelTolerance_,!this.snappedToVertex_&&!this.insertVertexCondition_(this.lastPointerEvent_)){this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null);return}this.snappedToVertex_&&(p=z>le?u[1]:u[0]),this.createOrUpdateVertexFeature_(p,[c.feature],[c.geometry],this.snappedToVertex_);const dt={};dt[Ae(c.geometry)]=!0;for(let ht=1,$e=r.length;ht<$e;++ht){const ge=r[ht].segment;if(Ue(u[0],ge[0])&&Ue(u[1],ge[1])||Ue(u[0],ge[1])&&Ue(u[1],ge[0])){const Se=Ae(r[ht].geometry);Se in dt||(dt[Se]=!0,_[Ae(ge)]=!0)}else break}}this.vertexSegments_=_;return}}this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null)}insertVertex_(e,t){const s=e.segment,n=e.feature,r=e.geometry,l=e.depth,c=e.index;let u;for(;t.length<r.getStride();)t.push(0);switch(r.getType()){case"MultiLineString":u=r.getCoordinates(),u[l[0]].splice(c+1,0,t);break;case"Polygon":u=r.getCoordinates(),u[l[0]].splice(c+1,0,t);break;case"MultiPolygon":u=r.getCoordinates(),u[l[1]][l[0]].splice(c+1,0,t);break;case"LineString":u=r.getCoordinates(),u.splice(c+1,0,t);break;default:return!1}this.setGeometryCoordinates_(r,u);const p=this.rBush_;p.remove(e),this.updateSegmentIndices_(r,c,l,1);const g={segment:[s[0],t],feature:n,geometry:r,depth:l,index:c};p.insert(Te(g.segment),g),this.dragSegments_.push([g,1]);const x={segment:[t,s[1]],feature:n,geometry:r,depth:l,index:c+1};return p.insert(Te(x.segment),x),this.dragSegments_.push([x,0]),!0}updatePointer_(e){return e&&this.findInsertVerticesAndUpdateDragSegments_(e),this.vertexFeature_?.getGeometry().getCoordinates()}getPoint(){const e=this.vertexFeature_?.getGeometry().getCoordinates();return e?Ks(e,this.getMap().getView().getProjection()):null}canRemovePoint(){if(!this.vertexFeature_||this.vertexFeature_.get("geometries").every(s=>s.getType()==="Circle"||s.getType().endsWith("Point")))return!1;const e=this.vertexFeature_.getGeometry().getCoordinates();return this.rBush_.getInExtent(Te([e])).some(({segment:s})=>Ue(s[0],e)||Ue(s[1],e))}removePoint(e){if(e&&(e=ve(e,this.getMap().getView().getProjection()),this.updatePointer_(e)),!this.lastPointerEvent_||this.lastPointerEvent_&&this.lastPointerEvent_.type!=Me.POINTERDRAG){const t=this.lastPointerEvent_;this.willModifyFeatures_(t,this.dragSegments_.map(([n])=>n));const s=this.removeVertex_();return this.featuresBeingModified_&&this.dispatchEvent(new Xn(Hn.MODIFYEND,this.featuresBeingModified_,t)),this.featuresBeingModified_=null,s}return!1}removeVertex_(){const e=this.dragSegments_,t={};let s=!1,n,r,l,c,u,p,g,x,_,I,M;for(u=e.length-1;u>=0;--u)l=e[u],I=l[0],M=Ae(I.feature),I.depth&&(M+="-"+I.depth.join("-")),M in t||(t[M]={}),l[1]===0?(t[M].right=I,t[M].index=I.index):l[1]==1&&(t[M].left=I,t[M].index=I.index+1);for(M in t){switch(_=t[M].right,g=t[M].left,p=t[M].index,x=p-1,g!==void 0?I=g:I=_,x<0&&(x=0),c=I.geometry,r=c.getCoordinates(),n=r,s=!1,c.getType()){case"MultiLineString":r[I.depth[0]].length>2&&(r[I.depth[0]].splice(p,1),s=!0);break;case"LineString":r.length>2&&(r.splice(p,1),s=!0);break;case"MultiPolygon":n=n[I.depth[1]];case"Polygon":n=n[I.depth[0]],n.length>4&&(p==n.length-1&&(p=0),n.splice(p,1),s=!0,p===0&&(n.pop(),n.push(n[0]),x=n.length-1));break}if(s){this.setGeometryCoordinates_(c,r);const z=[];if(g!==void 0&&(this.rBush_.remove(g),z.push(g.segment[0])),_!==void 0&&(this.rBush_.remove(_),z.push(_.segment[1])),g!==void 0&&_!==void 0){const le={depth:I.depth,feature:I.feature,geometry:I.geometry,index:x,segment:z};this.rBush_.insert(Te(le.segment),le)}this.updateSegmentIndices_(c,p,I.depth,-1),this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),e.length=0}}return s}canInsertPoint(){if(!this.vertexFeature_||this.vertexFeature_.get("geometries").every(s=>s.getType()==="Circle"||s.getType().endsWith("Point")))return!1;const e=this.vertexFeature_.getGeometry().getCoordinates();return this.rBush_.getInExtent(Te([e])).some(({segment:s})=>!(Ue(s[0],e)||Ue(s[1],e)))}insertPoint(e){const t=e?ve(e,this.getMap().getView().getProjection()):this.vertexFeature_?.getGeometry().getCoordinates();return t?this.findInsertVerticesAndUpdateDragSegments_(t).reduce((n,r)=>n||this.insertVertex_(r,t),!1):!1}setGeometryCoordinates_(e,t){this.changingFeature_=!0,e.setCoordinates(t),this.changingFeature_=!1}updateSegmentIndices_(e,t,s,n){this.rBush_.forEachInExtent(e.getExtent(),function(r){r.geometry===e&&(s===void 0||r.depth===void 0||xa(r.depth,s))&&r.index>t&&(r.index+=n)})}}function vl(a,e){return a.index-e.index}function cr(a,e,t){const s=e.geometry;if(s.getType()==="Circle"){let r=s;if(e.index===_s){const l=Xs(r.getCenter(),ve(a)),c=Math.sqrt(l)-r.getRadius();return c*c}}const n=ve(a);return es[0]=ve(e.segment[0]),es[1]=ve(e.segment[1]),Ca(n,es)}function dr(a,e,t){const s=e.geometry;if(s.getType()==="Circle"&&e.index===_s)return Ks(s.getClosestPoint(ve(a)));const n=ve(a);return es[0]=ve(e.segment[0]),es[1]=ve(e.segment[1]),Ks(Sa(n,es))}function wl(){const a=ci();return function(e,t){return a.Point}}const bl={SELECT:"select"};class xl extends ai{constructor(e,t,s,n){super(e),this.selected=t,this.deselected=s,this.mapBrowserEvent=n}}const Ys={};class _i extends Ja{constructor(e){super(),this.on,this.once,this.un,e=e||{},this.boundAddFeature_=this.addFeature_.bind(this),this.boundRemoveFeature_=this.removeFeature_.bind(this),this.condition_=e.condition?e.condition:pr,this.addCondition_=e.addCondition?e.addCondition:ei,this.removeCondition_=e.removeCondition?e.removeCondition:ei,this.toggleCondition_=e.toggleCondition?e.toggleCondition:mr,this.multi_=e.multi?e.multi:!1,this.filter_=e.filter?e.filter:Zn,this.hitTolerance_=e.hitTolerance?e.hitTolerance:0,this.style_=e.style!==void 0?e.style:Sl(),this.features_=e.features||new ti;let t;if(e.layers)if(typeof e.layers=="function")t=e.layers;else{const s=e.layers;t=function(n){return s.includes(n)}}else t=Zn;this.layerFilter_=t,this.featureLayerAssociation_={}}addFeatureLayerAssociation_(e,t){this.featureLayerAssociation_[Ae(e)]=t}getFeatures(){return this.features_}getHitTolerance(){return this.hitTolerance_}getLayer(e){return this.featureLayerAssociation_[Ae(e)]}setHitTolerance(e){this.hitTolerance_=e}setMap(e){this.getMap()&&this.style_&&this.features_.forEach(this.restorePreviousStyle_.bind(this)),super.setMap(e),e?(this.features_.addEventListener(Kt.ADD,this.boundAddFeature_),this.features_.addEventListener(Kt.REMOVE,this.boundRemoveFeature_),this.style_&&this.features_.forEach(this.applySelectedStyle_.bind(this))):(this.features_.removeEventListener(Kt.ADD,this.boundAddFeature_),this.features_.removeEventListener(Kt.REMOVE,this.boundRemoveFeature_))}addFeature_(e){const t=e.element;if(this.style_&&this.applySelectedStyle_(t),!this.getLayer(t)){const s=this.getMap().getAllLayers().find(function(n){if(n instanceof yi&&n.getSource()&&n.getSource().hasFeature(t))return n});s&&this.addFeatureLayerAssociation_(t,s)}}removeFeature_(e){this.style_&&this.restorePreviousStyle_(e.element)}getStyle(){return this.style_}applySelectedStyle_(e){const t=Ae(e);t in Ys||(Ys[t]=e.getStyle()),e.setStyle(this.style_)}restorePreviousStyle_(e){const t=this.getMap().getInteractions().getArray();for(let n=t.length-1;n>=0;--n){const r=t[n];if(r!==this&&r instanceof _i&&r.getStyle()&&r.getFeatures().getArray().lastIndexOf(e)!==-1){e.setStyle(r.getStyle());return}}const s=Ae(e);e.setStyle(Ys[s]),delete Ys[s]}removeFeatureLayerAssociation_(e){delete this.featureLayerAssociation_[Ae(e)]}handleEvent(e){if(!this.condition_(e))return!0;const t=this.addCondition_(e),s=this.removeCondition_(e),n=this.toggleCondition_(e),r=!t&&!s&&!n,l=e.map,c=this.getFeatures(),u=[],p=[];if(r){ka(this.featureLayerAssociation_),l.forEachFeatureAtPixel(e.pixel,(g,x)=>{if(!(!(g instanceof xe)||!this.filter_(g,x)))return this.addFeatureLayerAssociation_(g,x),p.push(g),!this.multi_},{layerFilter:this.layerFilter_,hitTolerance:this.hitTolerance_});for(let g=c.getLength()-1;g>=0;--g){const x=c.item(g),_=p.indexOf(x);_>-1?p.splice(_,1):(c.remove(x),u.push(x))}p.length!==0&&c.extend(p)}else{l.forEachFeatureAtPixel(e.pixel,(g,x)=>{if(!(!(g instanceof xe)||!this.filter_(g,x)))return(t||n)&&!c.getArray().includes(g)?(this.addFeatureLayerAssociation_(g,x),p.push(g)):(s||n)&&c.getArray().includes(g)&&(u.push(g),this.removeFeatureLayerAssociation_(g)),!this.multi_},{layerFilter:this.layerFilter_,hitTolerance:this.hitTolerance_});for(let g=u.length-1;g>=0;--g)c.remove(u[g]);c.extend(p)}return(p.length>0||u.length>0)&&this.dispatchEvent(new xl(bl.SELECT,p,u,e)),!0}}function Sl(){const a=ci();return bt(a.Polygon,a.LineString),bt(a.GeometryCollection,a.LineString),function(e){return e.getGeometry()?a[e.getGeometry().getType()]:null}}class Cl{constructor(){this.dataProjection=void 0,this.defaultFeatureProjection=void 0,this.featureClass=xe,this.supportedMediaTypes=null}getReadOptions(e,t){if(t){let s=t.dataProjection?wt(t.dataProjection):this.readProjection(e);t.extent&&s&&s.getUnits()==="tile-pixels"&&(s=wt(s),s.setWorldExtent(t.extent)),t={dataProjection:s,featureProjection:t.featureProjection}}return this.adaptOptions(t)}adaptOptions(e){return Object.assign({dataProjection:this.dataProjection,featureProjection:this.defaultFeatureProjection,featureClass:this.featureClass},e)}getType(){return ye()}readFeature(e,t){return ye()}readFeatures(e,t){return ye()}readGeometry(e,t){return ye()}readProjection(e){return ye()}writeFeature(e,t){return ye()}writeFeatures(e,t){return ye()}writeGeometry(e,t){return ye()}}function vi(a,e,t){const s=t?wt(t.featureProjection):null,n=t?wt(t.dataProjection):null;let r=a;if(s&&n&&!Pa(s,n)){e&&(r=a.clone());const l=e?s:n,c=e?n:s;l.getUnits()==="tile-pixels"?r.transform(l,c):r.applyTransform(Fa(l,c))}if(e&&t&&t.decimals!==void 0){const l=Math.pow(10,t.decimals),c=function(u){for(let p=0,g=u.length;p<g;++p)u[p]=Math.round(u[p]*l)/l;return u};r===a&&(r=a.clone()),r.applyTransform(c)}return r}const kl={Point:Je,LineString:Lt,Polygon:vs,MultiPoint:bs,MultiLineString:ss,MultiPolygon:ns};function Pl(a,e,t){return Array.isArray(e[0])?(ur(a,0,e,t)||(a=a.slice(),Wn(a,0,e,t)),a):(Ea(a,0,e,t)||(a=a.slice(),Ia(a,0,e,t)),a)}function kr(a,e){const t=a.geometry;if(!t)return[];if(Array.isArray(t))return t.map(r=>kr({...a,geometry:r})).flat();const s=t.type==="MultiPolygon"?"Polygon":t.type;if(s==="GeometryCollection"||s==="Circle")throw new Error("Unsupported geometry type: "+s);const n=t.layout.length;return vi(new yr(s,s==="Polygon"?Pl(t.flatCoordinates,t.ends,n):t.flatCoordinates,t.ends?.flat(),n,a.properties||{},a.id).enableSimplifyTransformed(),!1,e)}function wi(a,e){if(!a)return null;if(Array.isArray(a)){const s=a.map(n=>wi(n,e));return new ws(s)}const t=kl[a.type];return vi(new t(a.flatCoordinates,a.layout||"XY",a.ends),!1,e)}class Fl extends Cl{constructor(){super()}getType(){return"json"}readFeature(e,t){return this.readFeatureFromObject(qs(e),this.getReadOptions(e,t))}readFeatures(e,t){return this.readFeaturesFromObject(qs(e),this.getReadOptions(e,t))}readFeatureFromObject(e,t){return ye()}readFeaturesFromObject(e,t){return ye()}readGeometry(e,t){return this.readGeometryFromObject(qs(e),this.getReadOptions(e,t))}readGeometryFromObject(e,t){return ye()}readProjection(e){return this.readProjectionFromObject(qs(e))}readProjectionFromObject(e){return ye()}writeFeature(e,t){return JSON.stringify(this.writeFeatureObject(e,t))}writeFeatureObject(e,t){return ye()}writeFeatures(e,t){return JSON.stringify(this.writeFeaturesObject(e,t))}writeFeaturesObject(e,t){return ye()}writeGeometry(e,t){return JSON.stringify(this.writeGeometryObject(e,t))}writeGeometryObject(e,t){return ye()}}function qs(a){if(typeof a=="string"){const e=JSON.parse(a);return e||null}return a!==null?a:null}class bi extends Fl{constructor(e){e=e||{},super(),this.dataProjection=wt(e.dataProjection?e.dataProjection:"EPSG:4326"),e.featureProjection&&(this.defaultFeatureProjection=wt(e.featureProjection)),e.featureClass&&(this.featureClass=e.featureClass),this.geometryName_=e.geometryName,this.extractGeometryName_=e.extractGeometryName,this.supportedMediaTypes=["application/geo+json","application/vnd.geo+json"]}readFeatureFromObject(e,t){let s=null;e.type==="Feature"?s=e:s={type:"Feature",geometry:e,properties:null};const n=xi(s.geometry);if(this.featureClass===yr)return kr({geometry:n,id:s.id,properties:s.properties},t);const r=new xe;return this.geometryName_?r.setGeometryName(this.geometryName_):this.extractGeometryName_&&s.geometry_name&&r.setGeometryName(s.geometry_name),r.setGeometry(wi(n,t)),"id"in s&&r.setId(s.id),s.properties&&r.setProperties(s.properties,!0),r}readFeaturesFromObject(e,t){const s=e;let n=null;if(s.type==="FeatureCollection"){const r=e;n=[];const l=r.features;for(let c=0,u=l.length;c<u;++c){const p=this.readFeatureFromObject(l[c],t);p&&n.push(p)}}else n=[this.readFeatureFromObject(e,t)];return n.flat()}readGeometryFromObject(e,t){return El(e,t)}readProjectionFromObject(e){const t=e.crs;let s;if(t)if(t.type=="name")s=wt(t.properties.name);else if(t.type==="EPSG")s=wt("EPSG:"+t.properties.code);else throw new Error("Unknown SRS type");else s=this.dataProjection;return s}writeFeatureObject(e,t){t=this.adaptOptions(t);const s={type:"Feature",geometry:null,properties:null},n=e.getId();if(n!==void 0&&(s.id=n),!e.hasProperties())return s;const r=e.getProperties(),l=e.getGeometry();return l&&(s.geometry=ii(l,t),delete r[e.getGeometryName()]),Ta(r)||(s.properties=r),s}writeFeaturesObject(e,t){t=this.adaptOptions(t);const s=[];for(let n=0,r=e.length;n<r;++n)s.push(this.writeFeatureObject(e[n],t));return{type:"FeatureCollection",features:s}}writeGeometryObject(e,t){return ii(e,this.adaptOptions(t))}}function xi(a,e){if(!a)return null;let t;switch(a.type){case"Point":{t=Tl(a);break}case"LineString":{t=Ml(a);break}case"Polygon":{t=Gl(a);break}case"MultiPoint":{t=Ll(a);break}case"MultiLineString":{t=Al(a);break}case"MultiPolygon":{t=Dl(a);break}case"GeometryCollection":{t=Il(a);break}default:throw new Error("Unsupported GeoJSON type: "+a.type)}return t}function El(a,e){const t=xi(a);return wi(t,e)}function Il(a,e){return a.geometries.map(function(s){return xi(s)})}function Tl(a){const e=a.coordinates;return{type:"Point",flatCoordinates:e,layout:is(e.length)}}function Ml(a){const e=a.coordinates,t=e.flat();return{type:"LineString",flatCoordinates:t,ends:[t.length],layout:is(e[0]?.length||2)}}function Al(a){const e=a.coordinates,t=e[0]?.[0]?.length||2,s=[],n=ri(s,0,e,t);return{type:"MultiLineString",flatCoordinates:s,ends:n,layout:is(t)}}function Ll(a){const e=a.coordinates;return{type:"MultiPoint",flatCoordinates:e.flat(),layout:is(e[0]?.length||2)}}function Dl(a){const e=a.coordinates,t=[],s=e[0]?.[0]?.[0].length||2,n=fr(t,0,e,s);return{type:"MultiPolygon",flatCoordinates:t,ends:n,layout:is(s)}}function Gl(a){const e=a.coordinates,t=[],s=e[0]?.[0]?.length,n=ri(t,0,e,s);return{type:"Polygon",flatCoordinates:t,ends:n,layout:is(s)}}function ii(a,e){a=vi(a,!0,e);const t=a.getType();let s;switch(t){case"Point":{s=Ul(a);break}case"LineString":{s=Rl(a);break}case"Polygon":{s=$l(a,e);break}case"MultiPoint":{s=Nl(a);break}case"MultiLineString":{s=jl(a);break}case"MultiPolygon":{s=Vl(a,e);break}case"GeometryCollection":{s=Ol(a,e);break}case"Circle":{s={type:"GeometryCollection",geometries:[]};break}default:throw new Error("Unsupported geometry type: "+t)}return s}function Ol(a,e){return e=Object.assign({},e),delete e.featureProjection,{type:"GeometryCollection",geometries:a.getGeometriesArray().map(function(s){return ii(s,e)})}}function Rl(a,e){return{type:"LineString",coordinates:a.getCoordinates()}}function jl(a,e){return{type:"MultiLineString",coordinates:a.getCoordinates()}}function Nl(a,e){return{type:"MultiPoint",coordinates:a.getCoordinates()}}function Vl(a,e){let t;return e&&(t=e.rightHanded),{type:"MultiPolygon",coordinates:a.getCoordinates(t)}}function Ul(a,e){return{type:"Point",coordinates:a.getCoordinates()}}function $l(a,e){let t;return e&&(t=e.rightHanded),{type:"Polygon",coordinates:a.getCoordinates(t)}}function Si(a){return Ka(`https://annotations.allmaps.org/?url=${a}`)}async function Pr(a){try{return[await Si(`${a.uri}/info.json`)]}catch{return[]}}async function Fr(a){try{return[await Si(a.uri)]}catch{const t=[];for(const s of a.canvases){const n=await Pr(s.image);t.push(...n)}return t}}async function Er(a){try{return[await Si(a.uri)]}catch{const t=[];if("items"in a){for(const s of a.items)if(s.type==="collection"){const n=await Er(s);t.push(...n)}else if(s.type==="manifest"&&"canvases"in s){const n=await Fr(s);t.push(...n)}}return t}}function Bl(a){if(a.type==="image")return Pr(a);if(a.type==="manifest")return Fr(a);if(a.type==="collection")return Er(a);throw new Error("Unsupported IIIF resource")}const Yl="canvas";class hr{uri;type=Yl;height;width;image;label;description;metadata;navDate;navPlace;homepage;thumbnail;rendering;seeAlso;summary;requiredStatement;annotations;constructor(e){if(this.width=e.width,this.height=e.height,"@id"in e)this.uri=e["@id"],this.description=Gt(e.description),this.label=Gt(e.label),this.metadata=di(e.metadata),this.navDate=e.navDate,this.navPlace=e.navPlace,this.requiredStatement=hi(e.attribution),this.thumbnail=ui(e.thumbnail),this.rendering=fi(e.rendering),this.homepage=gi(e.related),this.image=new si(e.images[0].resource,e);else if("id"in e){this.uri=e.id,this.label=ts(e.label),this.description=ts(e.description),this.metadata=Ws(e.metadata),this.navDate=e.navDate,this.navPlace=e.navPlace,this.homepage=e.homepage,this.thumbnail=e.thumbnail,this.rendering=e.rendering,this.seeAlso=e.seeAlso,this.summary=e.summary,this.requiredStatement=e.requiredStatement,this.annotations=e.annotations;const t=e.items[0].items[0].body;let s;if(Array.isArray(t))s=t[0];else if(t.type==="Image")s=t;else if(t.type==="Choice")s=t.items[0];else throw new Error("Invalid IIIF Canvas");this.image=new si(s,e)}else throw new Error("Invalid IIIF Canvas")}}const ql="manifest";class ys{embedded=!0;uri;type=ql;label;majorVersion;constructor(e){if("@type"in e)this.uri=e["@id"],this.majorVersion=2,this.label=Gt(e.label);else if("type"in e)this.uri=e.id,this.majorVersion=3,this.label=ts(e.label);else throw new Error("Unsupported Manifest")}}class Dt extends ys{canvases=[];description;metadata;navDate;navPlace;homepage;thumbnail;rendering;seeAlso;summary;requiredStatement;annotations;embedded=!1;constructor(e){if(super(e),"@type"in e){this.description=Gt(e.description),this.metadata=di(e.metadata);const t=e.sequences[0];this.canvases=t.canvases.map(s=>new hr(s)),this.navDate=e.navDate,this.navPlace=e.navPlace,this.requiredStatement=hi(e.attribution),this.thumbnail=ui(e.thumbnail),this.rendering=fi(e.rendering),this.homepage=gi(e.related)}else if("type"in e)this.description=ts(e.description),this.metadata=Ws(e.metadata),this.metadata=Ws(e.metadata),this.navDate=e.navDate,this.navPlace=e.navPlace,this.homepage=e.homepage,this.thumbnail=e.thumbnail,this.rendering=e.rendering,this.seeAlso=e.seeAlso,this.summary=e.summary,this.requiredStatement=e.requiredStatement,this.annotations=e.annotations,this.canvases=e.items.map(t=>new hr(t));else throw new Error("Unsupported Manifest")}static parse(e,t=null){let s;return t===2?s=_r.parse(e):t===3?s=vr.parse(e):s=Wa.parse(e),new Dt(s)}get images(){return this.canvases.map(e=>e.image)}async#e(e,t){if(e instanceof si){const s=`${e.uri}/info.json`,n=await t(s).then(l=>l.json());return zs.parse(n)}else return e}async fetchAll(e=globalThis.fetch){const t=[];for await(const s of this.fetchNext(e))t.push(s);return t}async*fetchNext(e=globalThis.fetch,t=0){for(const s of this.canvases){const n=await this.#e(s.image,e);s.image=n,yield{item:n,depth:t,parent:{uri:this.uri,type:this.type}}}}async fetchImageByUri(e,t=globalThis.fetch){for(const s of this.canvases)if(s.image.uri===e){const n=await this.#e(s.image,t);return s.image=n,n}}}const zl="collection",ps={maxDepth:Number.POSITIVE_INFINITY,fetchCollections:!0,fetchManifests:!0,fetchImages:!1,fetchFn:globalThis.fetch};class Jn{uri;type=zl;majorVersion;label;embedded=!0;constructor(e){if("@type"in e)this.uri=e["@id"],this.majorVersion=2,this.label=Gt(e.label);else if("type"in e)this.uri=e.id,this.majorVersion=3,this.label=ts(e.label);else throw new Error("Unsupported Collection")}static parse(e,t=null){let s;return t===2?s=mi.parse(e):t===3?s=pi.parse(e):s=wr.parse(e),new ct(s)}}class ct extends Jn{items=[];embedded=!1;description;metadata;navDate;navPlace;homepage;thumbnail;rendering;seeAlso;summary;requiredStatement;annotations;constructor(e){if(super(e),"@type"in e){this.description=Gt(e.description),this.label=Gt(e.label),this.metadata=di(e.metadata),this.navDate=e.navDate,this.navPlace=e.navPlace,this.requiredStatement=hi(e.attribution),this.thumbnail=ui(e.thumbnail),this.rendering=fi(e.rendering),this.homepage=gi(e.related);const t="manifests"in e&&e.manifests?e.manifests:[],s="collections"in e&&e.collections?e.collections:[],n="members"in e&&e.members?e.members:[],r=[...t,...s,...n];this.items=r.map(l=>l["@type"]==="sc:Collection"?new ct(l):new ys(l))}else if("type"in e)this.description=ts(e.description),this.metadata=Ws(e.metadata),this.navDate=e.navDate,this.navPlace=e.navPlace,this.homepage=e.homepage,this.thumbnail=e.thumbnail,this.rendering=e.rendering,this.seeAlso=e.seeAlso,this.summary=e.summary,this.requiredStatement=e.requiredStatement,this.annotations=e.annotations,"items"in e&&(this.items=e.items.map(t=>t.type==="Collection"?"items"in t?new ct(t):new Jn(t):new ys(t)));else throw new Error("Unsupported Collection")}static parse(e,t=null){let s;return t===2?s=mi.parse(e):t===3?s=pi.parse(e):s=wr.parse(e),new ct(s)}get canvases(){const e=[];return this.items.reduce((t,s)=>s instanceof Dt?[...t,...s.canvases]:s instanceof ys?t:s instanceof ct?[...t,...s.canvases]:t,e)}get images(){return this.canvases.map(e=>e.image)}async fetchAll(e){const t=[];for await(const s of this.fetchNext(e))t.push(s);return t}async*fetchNext(e,t=0){if(e={...ps,...e},Number.isNaN(e.maxDepth))return;e.maxDepth===void 0&&(e.maxDepth=ps.maxDepth),e.fetchImages===void 0&&(e.fetchImages=ps.fetchImages),e.fetchManifests===void 0&&(e.fetchManifests=ps.fetchManifests);let s=ps.fetchFn;if(e.fetchFn&&(s=e.fetchFn),!(t>=e.maxDepth))for(const n in this.items){let r=this.items[n];if(r instanceof Dt)e.fetchImages&&(yield*r.fetchNext(s,t+1));else if(r instanceof ys&&e.fetchManifests){const l=r.uri,c=await s(l).then(p=>p.json()),u=Dt.parse(c);this.items[n]=u,yield{item:u,depth:t+1,parent:{uri:this.uri,type:this.type}},t+1<e.maxDepth&&e.fetchImages&&(yield*u.fetchNext(s,t+2))}else if(r instanceof Jn&&e.fetchCollections){const l=r.uri,c=await s(l).then(p=>p.json()),u=ct.parse(c);this.items[n]=u,yield{item:u,depth:t+1,parent:{uri:this.uri,type:this.type}},r=u,t+1<e.maxDepth&&(yield*u.fetchNext(e,t+2))}}}}class Hl{static parse(e,t=null){if(e&&typeof e=="object"){if(t===1||"@context"in e&&e["@context"]===Za){const s=Qa.parse(e);return new zs(s)}else if(t===2||"@id"in e){if("protocol"in e&&e.protocol==="http://iiif.io/api/image"){const s=el.parse(e);return new zs(s)}else if("@type"in e&&e["@type"]==="sc:Manifest"){const s=_r.parse(e);return new Dt(s)}else if("@type"in e&&e["@type"]==="sc:Collection"){const s=mi.parse(e);return new ct(s)}}else if(t===3||"id"in e){if("protocol"in e&&e.protocol==="http://iiif.io/api/image"){const s=tl.parse(e);return new zs(s)}else if("type"in e&&e.type==="Manifest"){const s=vr.parse(e);return new Dt(s)}else if("type"in e&&e.type==="Collection"){const s=pi.parse(e);return new ct(s)}}}throw new Error("Invalid IIIF data or unsupported IIIF type")}}function Xl(a="id"){if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return`${a}-${crypto.randomUUID()}`;const e=Math.random().toString(36).slice(2,8);return`${a}-${Date.now().toString(36)}-${e}`}function Jl(a="anno"){return Xl(a)}function vt(a){let e=a.getId();e||(e=Jl(),a.setId(e)),a.get("label")||a.set("label","Untitled"),a.get("color")||a.set("color",li),typeof a.get("hidden")!="boolean"&&a.set("hidden",!1)}function Kl(a){return vt(a),{id:a.getId(),label:a.get("label")??"Untitled",type:a.getGeometry()?.getType()??"Geometry",color:a.get("color")??li,details:a.get("details")??"",hidden:!!a.get("hidden")}}function Wl(a,e){const t=a.replace("#","");if(![3,6].includes(t.length))return`rgba(37, 99, 235, ${e})`;const s=t.length===3?t.split("").map(u=>u+u).join(""):t,n=Number.parseInt(s,16),r=n>>16&255,l=n>>8&255,c=n&255;return`rgba(${r}, ${l}, ${c}, ${e})`}function Zl(a){const e=a;if(vt(e),e.get("hidden"))return;const t=e.get("color")??li,s=e.getGeometry()?.getType()??"Geometry",n=e.get("label"),r=n&&n.trim().length?new sl({text:n,font:'600 13px "Inter", system-ui, sans-serif',fill:new Wt({color:"#111827"}),padding:[3,6,2,6],backgroundFill:new Wt({color:"rgba(255,255,255,0.85)"}),overflow:!0,offsetY:s==="Point"?-18:0}):void 0;return s==="Point"?new ni({image:new br({radius:7,fill:new Wt({color:"#ffffff"}),stroke:new Zs({color:t,width:3})}),text:r}):new ni({stroke:new Zs({color:t,width:3}),fill:new Wt({color:Wl(t,.15)}),text:r})}const Ql=new ni({image:new br({radius:6,fill:new Wt({color:"#06b6d4"}),stroke:new Zs({color:"#0e7490",width:2})}),stroke:new Zs({color:"#06b6d4",width:2}),fill:new Wt({color:"rgba(6, 182, 212, 0.18)"})}),ec=100;function tc(a=ec){const{subscribe:e,update:t,set:s}=xr({history:[],future:[]});return{subscribe:e,limit:a,push(n){t(r=>({history:[...r.history.slice(-a+1),n],future:[]}))},undo(){let n=null;return t(r=>r.history.length?(n=r.history[r.history.length-1],{history:r.history.slice(0,-1),future:[...r.future,n]}):r),n},redo(){let n=null;return t(r=>r.future.length?(n=r.future[r.future.length-1],{history:[...r.history,n],future:r.future.slice(0,-1)}):r),n},reset(){s({history:[],future:[]})}}}function sc(a,e={}){const{geoJson:t=new bi}=e,s=String(a.getId()),n=t.writeFeatureObject(a,{featureProjection:"EPSG:3857",dataProjection:"EPSG:4326"});return n.id=s,{id:s,feature:n}}function nc(a,e={}){const{geoJson:t=new bi}=e,s=t.readFeature(a.feature,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"});return s.setId(a.id),s}function ic(a,e){return e&&a.some(t=>t.id===e)?e:null}function rc(){const{subscribe:a,update:e,set:t}=xr({list:[],selectedId:null});return{subscribe:a,setList(s){e(n=>({list:s,selectedId:ic(s,n.selectedId)}))},setSelected(s){e(n=>({...n,selectedId:s}))},clearSelection(){e(s=>({...s,selectedId:null}))},clearSelectionIfMatches(s){s&&e(n=>({...n,selectedId:n.selectedId===s?null:n.selectedId}))},reset(){t({list:[],selectedId:null})}}}const oc=Symbol("annotation-context");function ac(a){Lo(oc,a)}var lc=N('<button type="button" class="panel-toggle left svelte-1gd50sk">Show tools</button>'),cc=N('<span class="history-meta svelte-1gd50sk"> </span>'),dc=N('<button type="button"><span class="history-title svelte-1gd50sk"> </span> <!></button>'),hc=N('<section class="panel-card-section svelte-1gd50sk"><span class="section-title svelte-1gd50sk">Featured</span> <div class="history-featured svelte-1gd50sk"></div></section>'),uc=N("<option> </option>"),fc=N('<button type="button"><span class="history-title svelte-1gd50sk"> </span> <span class="history-meta svelte-1gd50sk"> </span></button>'),gc=N('<p class="empty-state svelte-1gd50sk">Map catalog is loading</p>'),mc=N('<button type="button"> </button>'),pc=N('<aside class="creator-panel left svelte-1gd50sk"><button type="button" class="panel-collapse svelte-1gd50sk" aria-expanded="true">Hide tools</button> <div class="panel-scroll custom-scrollbar svelte-1gd50sk"><section class="panel-card svelte-1gd50sk"><header class="panel-card-header svelte-1gd50sk"><h2 class="svelte-1gd50sk">View control</h2></header> <section class="panel-card-section svelte-1gd50sk"><span class="section-title svelte-1gd50sk">View mode</span> <div class="button-group wrap svelte-1gd50sk"><button type="button">Overlay</button> <button type="button">Side-X</button> <button type="button">Side-Y</button> <button type="button">Glass</button></div></section> <section class="panel-card-section svelte-1gd50sk"><span class="section-title svelte-1gd50sk">Overlay opacity</span> <div class="slider svelte-1gd50sk"><input type="range" min="0" max="1" step="0.05" class="svelte-1gd50sk"/> <span> </span></div></section></section> <section class="panel-card svelte-1gd50sk"><header class="panel-card-header svelte-1gd50sk"><h2 class="svelte-1gd50sk">Historical maps</h2></header> <!> <section class="panel-card-section svelte-1gd50sk"><label class="history-filter svelte-1gd50sk"><span>Filter by type</span> <select class="svelte-1gd50sk"><option> </option><!></select></label></section> <div class="history-list custom-scrollbar svelte-1gd50sk"><!></div></section> <section class="panel-card svelte-1gd50sk"><header class="panel-card-header svelte-1gd50sk"><h2 class="svelte-1gd50sk">Basemap</h2></header> <section class="panel-card-section svelte-1gd50sk"><div class="button-group wrap svelte-1gd50sk"></div></section></section></div></aside>'),yc=N("<!> <!>",1),_c=N('<div class="toolbar-menu svelte-1gd50sk"><button type="button">Point</button> <button type="button">Line</button> <button type="button">Polygon</button> <button type="button"> </button> <button type="button" class="svelte-1gd50sk">Finish drawing</button></div>'),vc=N('<div class="toolbar-menu svelte-1gd50sk"><button type="button" class="svelte-1gd50sk">Clear cached state</button></div>'),wc=N('<button type="button" class="panel-toggle right svelte-1gd50sk">Show panel</button>'),bc=N("<p> </p>"),xc=N('<div class="card-menu svelte-1gd50sk"><button type="button" class="svelte-1gd50sk">Zoom to</button> <button type="button" class="svelte-1gd50sk">Select</button></div>'),Sc=N('<div><div class="list-card-header svelte-1gd50sk"><input type="text" placeholder="Annotation name" class="svelte-1gd50sk"/> <div class="list-card-actions svelte-1gd50sk"><input type="color" title="Annotation colour" class="svelte-1gd50sk"/> <button type="button" class="chip ghost"> </button> <button type="button" class="chip danger">Delete</button> <button type="button" class="icon-button svelte-1gd50sk" aria-label="Annotation actions"></button></div></div> <textarea rows="2" placeholder="Annotation details" class="svelte-1gd50sk"></textarea> <!></div>'),Cc=N('<p class="empty-state svelte-1gd50sk">Draw or import annotations to see them here.</p>'),kc=N('<aside class="creator-panel right svelte-1gd50sk"><header class="creator-right-header svelte-1gd50sk"><button type="button" class="panel-collapse svelte-1gd50sk">Hide panel</button> <div class="creator-right-controls svelte-1gd50sk"><h2 class="panel-heading svelte-1gd50sk">Annotations</h2> <div class="right-actions svelte-1gd50sk"><button type="button" class="chip ghost">Clear</button> <button type="button" class="chip ghost">Export</button> <label class="chip ghost upload">Import <input type="file" accept="application/geo+json,.geojson,.json"/></label></div></div></header> <div class="creator-right-body custom-scrollbar svelte-1gd50sk"><!> <!></div></aside>'),Pc=N("<!> <!>",1),Fc=N('<div><dt class="svelte-1gd50sk">Summary</dt> <dd class="svelte-1gd50sk"> </dd></div>'),Ec=N('<div><dt class="svelte-1gd50sk">Details</dt> <dd class="svelte-1gd50sk"> </dd></div>'),Ic=N('<section class="metadata-section svelte-1gd50sk"><h3 class="svelte-1gd50sk"> </h3> <dl class="svelte-1gd50sk"><div><dt class="svelte-1gd50sk">Type</dt> <dd class="svelte-1gd50sk"> </dd></div> <!> <!></dl></section>'),Tc=N('<p class="empty-state svelte-1gd50sk">Select a map to view its metadata.</p>'),Mc=N('<div class="metadata-overlay svelte-1gd50sk" role="dialog" aria-modal="true" tabindex="0"><div class="metadata-card svelte-1gd50sk"><header class="svelte-1gd50sk"><h2 class="svelte-1gd50sk">Map metadata</h2> <button type="button" class="chip ghost svelte-1gd50sk">Close</button></header> <!></div></div>'),Ac=N('<p class="muted svelte-1gd50sk">Searching</p>'),Lc=N("<p> </p>"),Dc=N('<span class="result-type"> </span>'),Gc=N('<div class="search-result-item svelte-1gd50sk"><button type="button" class="search-result-main svelte-1gd50sk"><span class="result-title"> </span> <!></button> <div class="search-result-actions svelte-1gd50sk"><button type="button" class="chip ghost">Add to annotations</button></div></div>'),Oc=N('<div class="search-results-list custom-scrollbar svelte-1gd50sk"></div>'),Rc=N('<div class="search-dialog svelte-1gd50sk" role="dialog" aria-modal="true" tabindex="0"><button type="button" class="dialog-backdrop svelte-1gd50sk" aria-label="Dismiss search"></button> <div class="search-card svelte-1gd50sk"><header class="svelte-1gd50sk"><h2 class="svelte-1gd50sk">Search</h2> <button type="button" class="chip ghost">Close</button></header> <div class="search-form svelte-1gd50sk"><input type="text" placeholder="Search for a place or address" class="svelte-1gd50sk"/> <div class="search-form-actions svelte-1gd50sk"><button type="button" class="chip ghost">Locate me</button> <button type="button" class="chip ghost">Clear</button></div></div> <!> <!></div></div>'),jc=N('<div><div class="workspace svelte-1gd50sk"><!> <div class="map-stage svelte-1gd50sk"><div class="map-surface svelte-1gd50sk"><div class="map svelte-1gd50sk"></div> <div class="divider vertical svelte-1gd50sk" aria-hidden="true"></div> <div class="divider horizontal svelte-1gd50sk" aria-hidden="true"></div> <button class="handle vertical svelte-1gd50sk" type="button" aria-label="Drag vertical split" title="Drag vertical split"></button> <button class="handle horizontal svelte-1gd50sk" type="button" aria-label="Drag horizontal split" title="Drag horizontal split"></button> <div class="lens svelte-1gd50sk" aria-hidden="true"></div> <button class="lens-handle svelte-1gd50sk" type="button" aria-label="Adjust spyglass radius" title="Adjust spyglass radius"></button></div> <div class="creator-toolbar svelte-1gd50sk"><div class="toolbar-cluster svelte-1gd50sk"><button type="button" title="Search places" aria-label="Search places" class="svelte-1gd50sk"><span class="toolbar-icon svelte-1gd50sk"></span></button></div> <div class="toolbar-cluster svelte-1gd50sk"><button type="button" title="Pan the map" aria-label="Pan the map"><span class="toolbar-icon svelte-1gd50sk"></span></button> <div class="toolbar-group svelte-1gd50sk"><button type="button" title="Draw annotations" aria-label="Draw annotations" aria-haspopup="true"><span class="toolbar-icon svelte-1gd50sk"></span></button> <!></div> <button type="button" title="Undo" aria-label="Undo" class="svelte-1gd50sk"><span class="toolbar-icon svelte-1gd50sk"></span></button> <button type="button" title="Redo" aria-label="Redo" class="svelte-1gd50sk"><span class="toolbar-icon svelte-1gd50sk"></span></button></div> <div class="toolbar-cluster svelte-1gd50sk"><div class="toolbar-group svelte-1gd50sk"><button type="button" title="Settings" aria-label="Settings" aria-haspopup="true"><span class="toolbar-icon svelte-1gd50sk"></span></button> <!></div></div></div></div> <!></div> <!> <!></div>');function Nc(a,e){Do(e,!1);const t=()=>tr(os,"$annotationHistory",n),s=()=>tr(he,"$annotationState",n),[n,r]=Vo(),l=E(),c=E(),u=E(),p=E(),g=E(),x=E(),_=E(),I=E(),M=new bi,z=1,le=60,dt=5,ht=100;let $e=E(),ge=E(),Se=E(),Ke=E(),We=E(),we=E(),Ze=E(),Ir=Kn(e,"initialMode",8,"explore"),Tr=Kn(e,"showWelcomeOverlay",8,!0),de=E(null),sn=E([]),xs=E([]),Ss=E([]),ut=E(!1),Le=E(!1),Be=E(!1),Ce=E(!1),xt=E(!1),De=E("g-streets"),Ot=E("all"),Ye=E(""),ie=E([]),nn=E([]),ke=E(.8),St=E(Tr()),Ge=E(Ir()),Qe=E(!1),Ct=E(!1),kt=E(!1),Ci=E(!1),Cs=E("annotations"),qe=E(!1),Pt=E(null),Mr=E(null),rs=E(!0),ki=E();const os=tc(ht),he=rc();ac({history:os,state:he});let as=!1,ks=new globalThis.Map,ze=E(null),et=E([]),Pi=E(null),ft=E(""),gt=E([]),mt=E(!1),Pe=E(null),Fe=E("info"),rn=null,on=null,pt=null,an=E(null),ln=E("info"),Ft=!1,Et=E([]),Fi=E(0),Ei=E(null),T=E(null),ce=null,tt=E(null),D=null,Ps=null,st=null,Fs=null,Oe=null,It=null,Rt=null,jt=null,cn=[],Nt=E(null),dn=E(null),ls=E(null);const hn={};let He=null,Es=null,cs=null,be=E({sideX:!1,sideY:!1,lensR:!1}),re=E("overlay"),Re=.5,nt=150,un=null,Tt=null,ds=null;function $c(o,d=!1){}function me(){const o=D?D.getFeatures().map(d=>Kl(d)):[];he.setList(o)}function Vt(o){return D?.getFeatureById(o)??null}function it(o,d="info"){f(an,o),f(ln,d)}function Ar(){if(typeof window>"u"||!Ft)return;const o=i(T)?.getView(),d={basemapSelection:i(De),selectedMapId:i(Ye)||void 0,overlayId:Es||void 0,view:{mode:i(re),sideRatio:Re,lensRadius:nt,opacity:i(ke)}};if(o){const h=o.getCenter(),m=o.getZoom(),b=o.getRotation();h&&typeof m=="number"&&typeof b=="number"&&(d.mapView={center:h,zoom:m,rotation:b})}if(D){const h=D.getFeatures();h.length&&(d.annotations=M.writeFeaturesObject(h,{featureProjection:"EPSG:3857",dataProjection:"EPSG:4326"}))}i(Et).length&&(d.storyScenes=i(Et));try{window.localStorage.setItem(Vn,JSON.stringify(d))}catch(h){console.warn("Unable to save viewer state",h)}}function q(){typeof window>"u"||!Ft||(on&&window.clearTimeout(on),on=window.setTimeout(Ar,500))}async function Lr(){if(typeof window>"u"){Ft=!0;return}const o=new URLSearchParams(window.location.search),h=["map","view","lat","lon","zoom","rotation","basemap"].some(y=>o.has(y));let m=!1;const b=window.localStorage.getItem(Vn);if(!b){h&&await ji(o)&&(yt(),m=!0),Ft=!0,m&&q();return}try{Ft=!1;const y=JSON.parse(b);if(y.basemapSelection&&Ht.some(C=>C.key===y.basemapSelection)&&f(De,y.basemapSelection),y.view&&(f(re,y.view.mode??i(re)),Re=y.view.sideRatio??Re,nt=y.view.lensRadius??nt,f(ke,y.view.opacity??i(ke))),D&&y.annotations)try{const C=M.readFeatures(y.annotations,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"});D.clear(),C.forEach(P=>vt(P)),D.addFeatures(C),me()}catch(C){console.warn("Could not restore saved annotations",C),D.clear()}const F=i(T)?.getView();if(F&&y.mapView){const{center:C,zoom:P,rotation:L}=y.mapView;C&&F.setCenter(C),typeof P=="number"&&F.setZoom(P),typeof L=="number"&&F.setRotation(L)}const k=y.overlayId??y.selectedMapId;k&&i(ie).some(C=>C.id===k)?(f(Ye,k),await yn(k)):y.selectedMapId&&i(ie).some(C=>C.id===y.selectedMapId)&&f(Ye,y.selectedMapId),Array.isArray(y.storyScenes)&&f(Et,y.storyScenes.map((C,P)=>Br(C,P))),h&&await ji(o)&&(yt(),m=!0)}catch(y){console.warn("Failed to load saved viewer state",y)}finally{Ft=!0,m&&q(),Mt()}}function Dr(){if(!(typeof window>"u")){try{window.localStorage.removeItem(Vn)}catch(o){console.warn("Failed to clear saved state",o)}window.location.reload()}}function Gr(){if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return`scene-${crypto.randomUUID()}`;const o=Math.random().toString(36).slice(2,8);return`scene-${Date.now().toString(36)}-${o}`}function Or(o){return Number.isFinite(o)?Math.max(z,Math.min(le,Math.round(o))):dt}function Rr(){return i(et).filter(o=>!o.hidden).map(o=>o.id)}function Ut(o){return vt(o),sc(o,{geoJson:M})}function jr(o){const d=nc(o,{geoJson:M});return vt(d),d}function hs(o){if(!D)return null;const d=D.getFeatureById(o.id);d&&D.removeFeature(d);const h=jr(o);return D.addFeature(h),h}function fn(o){if(!D)return null;const d=D.getFeatureById(o);return d&&D.removeFeature(d),d}function $t(o){as||os.push(o)}function Ii(o){$t({kind:"annotation-add",snapshot:Ut(o)})}function Nr(o){$t({kind:"annotation-delete",snapshot:Ut(o)})}function Is(o,d,h,m){h!==m&&$t({kind:"annotation-update",id:String(o.getId()),changes:[{field:d,before:h,after:m}]})}function Vr(o){if(!o.length)return;const d=o.map(h=>Ut(h));$t({kind:"annotation-clear",snapshots:d})}function Ur(o){if(!o.length)return;const d=o.map(h=>Ut(h));$t({kind:"annotation-bulk-add",snapshots:d})}function $r(o,d){$t({kind:"annotation-geometry",before:o,after:d})}function Ti(o,d){switch(o.kind){case"annotation-add":{d==="undo"?(fn(o.snapshot.id),he.clearSelectionIfMatches(o.snapshot.id)):hs(o.snapshot)&&he.setSelected(o.snapshot.id);break}case"annotation-delete":{d==="undo"?hs(o.snapshot)&&he.setSelected(o.snapshot.id):(fn(o.snapshot.id),he.clearSelectionIfMatches(o.snapshot.id));break}case"annotation-update":{const h=D?.getFeatureById(o.id);if(!h)break;o.changes.forEach(m=>{const b=d==="undo"?m.before:m.after;m.field==="hidden"?h.set("hidden",!!b):h.set(m.field,b)}),h.changed?.();break}case"annotation-geometry":{const h=d==="undo"?o.before:o.after;hs(h),he.setSelected(h.id);break}case"annotation-clear":{d==="undo"?(D?.clear(),o.snapshots.forEach(h=>hs(h))):(D?.clear(),he.clearSelection());break}case"annotation-bulk-add":{d==="undo"?o.snapshots.forEach(h=>{fn(h.id),he.clearSelectionIfMatches(h.id)}):o.snapshots.forEach(h=>hs(h));break}}me()}function Mi(){const o=os.undo();o&&(as=!0,Ti(o,"undo"),as=!1,it("Undid last action.","info"),q())}function gn(){const o=os.redo();o&&(as=!0,Ti(o,"redo"),as=!1,it("Redid last action.","info"),q())}function Br(o,d=0){let h=[Number.isFinite(ms[0])?ms[0]:0,Number.isFinite(ms[1])?ms[1]:0];if(Array.isArray(o.center)&&o.center.length===2){const L=o.center.map(j=>Number(j));L.every(j=>Number.isFinite(j))&&(h=L)}else if(o.center&&typeof o.center=="object"&&"x"in o.center&&"y"in o.center){const L=Number(o.center.x),j=Number(o.center.y);Number.isFinite(L)&&Number.isFinite(j)&&(h=[L,j])}const m=typeof o.basemap=="string"&&Ht.some(L=>L.key===o.basemap)?o.basemap:i(De),b=i(T)?.getView(),y=typeof o.zoom=="number"?o.zoom:b?.getZoom()??14,F=typeof o.rotation=="number"?o.rotation:0,k=o.viewMode,C=k==="side-x"||k==="side-y"||k==="spy"?k:"overlay",P=Array.isArray(o.visibleAnnotations)?o.visibleAnnotations.map(L=>String(L)):Rr();return{id:typeof o.id=="string"?o.id:Gr(),title:typeof o.title=="string"&&o.title.trim().length?o.title:`Scene ${Number(d)+1}`,details:typeof o.details=="string"?o.details:"",delay:Or(typeof o.delay=="number"?o.delay:dt),center:h,zoom:y,rotation:F,basemap:m,overlayId:typeof o.overlayId=="string"&&o.overlayId.length?o.overlayId:null,opacity:typeof o.opacity=="number"?o.opacity:i(ke),viewMode:C,sideRatio:typeof o.sideRatio=="number"?o.sideRatio:.5,lensRadius:typeof o.lensRadius=="number"?o.lensRadius:150,visibleAnnotations:P,hidden:!!o.hidden}}function mn(o){i(T)&&i(T).getLayers().getArray().forEach(d=>{const h=d.getProperties();h.base&&d.setVisible(h.name===o)})}function Yr(){return ce?.getCanvas()??null}function Ai(){const o=Yr();if(!o||!i(T))return;const d=i(T).getSize();if(!d)return;const[h,m]=d;if(i(re)==="overlay")o.style.clipPath="";else if(i(re)==="side-x"){const b=h*Re;o.style.clipPath=`polygon(${b}px 0, ${h}px 0, ${h}px ${m}px, ${b}px ${m}px)`}else if(i(re)==="side-y"){const b=m*Re;o.style.clipPath=`polygon(0 ${b}px, ${h}px ${b}px, ${h}px ${m}px, 0 ${m}px)`}else if(i(re)==="spy"){const b=nt;o.style.clipPath=`circle(${b}px at ${h/2}px ${m/2}px)`}}function pn(){if(!i(T))return;const o=i(T).getSize();if(!o)return;const[d,h]=o,m=i(re)==="side-x",b=i(re)==="side-y";if(i(ge)&&(te(ge,i(ge).style.display=m?"block":"none"),m)){const y=d*Re;te(ge,i(ge).style.left=`${y}px`),te(ge,i(ge).style.height=`${h}px`)}if(i(Ke)&&(te(Ke,i(Ke).style.display=m?"block":"none"),m)){const y=d*Re-8;te(Ke,i(Ke).style.left=`${y}px`),te(Ke,i(Ke).style.top=`${h/2-8}px`)}if(i(Se)&&(te(Se,i(Se).style.display=b?"block":"none"),b)){const y=h*Re;te(Se,i(Se).style.top=`${y}px`),te(Se,i(Se).style.width=`${d}px`)}if(i(We)&&(te(We,i(We).style.display=b?"block":"none"),b)){const y=h*Re-8;te(We,i(We).style.left=`${d/2-8}px`),te(We,i(We).style.top=`${y}px`)}}function Li(){if(!i(T))return;const o=i(T).getSize();if(!o)return;const[d,h]=o,m=i(re)==="spy";if(i(we)&&(te(we,i(we).style.display=m?"block":"none"),m)){const b=Math.max(20,nt*2);te(we,i(we).style.width=`${b}px`),te(we,i(we).style.height=`${b}px`),te(we,i(we).style.left=`${d/2-nt}px`),te(we,i(we).style.top=`${h/2-nt}px`)}i(Ze)&&(te(Ze,i(Ze).style.display=m?"block":"none"),m&&(te(Ze,i(Ze).style.left=`${d/2+nt-8}px`),te(Ze,i(Ze).style.top=`${h/2-8}px`)))}function yt(){Ai(),pn(),Li()}function Di(o){f(re,o),qr(o!=="overlay"),yt()}function qr(o){if(!i(T)||!Rt||!jt)return;const d=i(T).getInteractions(),h=d.getArray().includes(Rt),m=d.getArray().includes(jt);o?(h&&i(T).removeInteraction(Rt),m&&i(T).removeInteraction(jt),i(T).getView().setRotation(0)):(h||i(T).addInteraction(Rt),m||i(T).addInteraction(jt))}function Gi(o){if(!i(T)||!i(be).sideX&&!i(be).sideY&&!i(be).lensR)return;const d=i($e).getBoundingClientRect(),h=o.clientX-d.left,m=o.clientY-d.top,b=i(T).getSize();if(!b)return;const[y,F]=b;if(i(be).sideX)Re=Math.max(.01,Math.min(h/y,.99)),pn();else if(i(be).sideY)Re=Math.max(.01,Math.min(m/F,.99)),pn();else if(i(be).lensR){const k=h-y/2,C=m-F/2,P=Math.sqrt(k*k+C*C),L=Math.min(y,F)/2;nt=Math.max(20,Math.min(P,L)),Li()}Ai()}function Ts(){!i(be).sideX&&!i(be).sideY&&!i(be).lensR||(q(),f(be,{sideX:!1,sideY:!1,lensR:!1}))}async function zr(){try{const o=await fetch(La);if(!o.ok)throw new Error(`HTTP ${o.status}`);const h=(await o.text()).trim().split(/\r?\n/);if(!h.length)throw new Error("No rows.");const m=(h.shift()??"").split(",").map(G=>G.trim().toLowerCase()),b=m.indexOf("name"),y=m.indexOf("id"),F=m.indexOf("type"),k=m.indexOf("summary"),C=m.indexOf("description")!==-1?m.indexOf("description"):m.indexOf("details")!==-1?m.indexOf("details"):m.indexOf("detail"),P=m.indexOf("thumbnail")!==-1?m.indexOf("thumbnail"):m.indexOf("image"),L=m.indexOf("featured")!==-1?m.indexOf("featured"):m.indexOf("is_featured");if(b===-1||y===-1)throw new Error("Missing 'name' or 'id' column.");const j=h.map(G=>G.match(/(".*?"|[^",\r\n]+)(?=\s*,|\s*$)/g)||[]).map(G=>{const H=(G[b]||"").replace(/"/g,"").trim(),ue=(G[y]||"").replace(/"/g,"").trim(),_e=F>-1&&(G[F]||"").replace(/"/g,"").trim()||"Uncategorized",O=k>-1?(G[k]||"").replace(/"/g,"").trim():"",ee=C>-1?(G[C]||"").replace(/"/g,"").trim():"",pe=P>-1?(G[P]||"").replace(/"/g,"").trim():"",W=L>-1?(G[L]||"").replace(/"/g,"").trim():"",J=/^y(es)?$/i.test(W)||/^true$/i.test(W)||W==="1";if(!H||!ue)return null;const V={id:ue,name:H,type:_e};return O&&(V.summary=O),ee&&(V.description=ee),pe&&(V.thumbnail=pe),J&&(V.isFeatured=!0),V}).filter(G=>!!G);f(ie,j)}catch(o){o instanceof Error&&o.message,f(ie,[])}}function Hr(o){if(!o)return!1;try{const d=new URL(o);return d.protocol==="http:"||d.protocol==="https:"}catch{return!1}}async function Xr(o,d){if(Hr(o)){const h=await fetch(o,{signal:d});if(!h.ok)throw new Error(`IIIF resource not accessible (HTTP ${h.status})`);const m=await h.json();if(d.aborted)return{annotations:[],cacheKey:o};let b;try{b=Hl.parse(m)}catch(k){throw new Error(`Failed to parse IIIF: ${k.message}`)}let y=[],F=null;try{y=await Bl(b)}catch(k){F=k instanceof Error?k:new Error("Unknown Allmaps API error.")}if(!y.length)try{const k=`https://annotations.allmaps.org/?url=${encodeURIComponent(o)}`,C=await fetch(k,{signal:d});if(C.ok){const P=await C.json();Array.isArray(P)?y=P:P&&Array.isArray(P.annotations)&&(y=P.annotations)}else{const P=await C.text();F??=new Error(`Fallback lookup failed (HTTP ${C.status}): ${P||"No body"}`)}}catch(k){F||(F=k instanceof Error?k:new Error("Unknown fallback lookup error."))}if(!y.length){const k=F?` ${F.message}`:"";throw new Error(`No Allmaps annotations found for that IIIF resource.${k?` ${k}`:""}`)}return{annotations:y,cacheKey:o}}else{const h=`https://annotations.allmaps.org/images/${o}`,m=await fetch(h,{signal:d});if(!m.ok)throw new Error(`Annotation not found (HTTP ${m.status})`);return{annotations:[await m.json()],cacheKey:o}}}async function Jr(o,d){if(!ce)return[];const h=[];for(const m of o){if(d.aborted)return h;const b=await ce.addGeoreferenceAnnotation(m);if(d.aborted)return h;if(!(!b||!b.length))for(const y of b){if(y instanceof Error)throw y;h.push(y)}}return h}async function yn(o){if(!ce)return;const d=o.trim();if(!d)return;cs&&cs.abort();const h=new AbortController;cs=h;const{signal:m}=h,b=d;if(b===Es&&He){try{ce.setMapOpacity(He,i(ke))}catch{}return}if(He)try{ce.setMapOpacity(He,0)}catch{}try{let y=[];if(b in hn)y=hn[b].mapIds;else{const{annotations:k}=await Xr(b,m);if(m.aborted)return;if(y=await Jr(k,m),!y.length)throw new Error("Map could not be added to the viewer.");hn[b]={mapIds:y}}const F=y[0];if(!F)throw new Error("Could not determine map identifier.");He=F,Es=b;try{for(const k of y)ce.setMapOpacity(k,i(ke))}catch{}yt(),q()}catch(y){if(y.name==="AbortError")return;y instanceof Error&&y.message}finally{m.aborted||(cs=null)}}async function Oi(o){const d=o?.trim()??"";f(Ye,d),d?await yn(d):(lo(),q())}function Kr(o){const d=Number(o.target.value);if(f(ke,d),He&&ce)try{ce.setMapOpacity(He,i(ke))}catch{}q()}function Ms(o){Di(o),q(),Mt()}function Mt(){i(T)&&(Tt!==null&&cancelAnimationFrame(Tt),Tt=requestAnimationFrame(()=>{Tt=null,i(T)?.updateSize(),yt()}))}function Ri(o){return o?"0px":i(kt)?"minmax(200px, 0.24fr)":i(Ct)?"minmax(220px, 0.25fr)":"minmax(260px, 0.25fr)"}function Wr(o,d){const m=i(kt)?.82:i(Ct)?.78:.75,b=i(kt)?.56:i(Ct)?.53:.5;return o&&d?"1":o||d?m.toString():b.toString()}function Zr(){Dr()}function _n(){!i(T)||!Fs||(i(T).removeInteraction(Fs),Fs=null)}function Qr(){if(!i(T)||!D||(_n(),!i(ze)))return;const o=Da[i(ze)],d=new ml({source:D,type:o});d.on("drawstart",()=>{It?.getFeatures().clear()}),d.on("drawend",h=>{const m=h.feature;vt(m),he.setSelected(String(m.getId())),me(),Ii(m),q(),it("Annotation added.","success")}),Fs=d,i(T).addInteraction(d)}function vn(){f(ze,null),_n()}function eo(){if(!i(T)||!Oe)return;f(rs,!i(rs));const d=i(T).getInteractions().getArray().includes(Oe);i(rs)?d||i(T).addInteraction(Oe):d&&i(T).removeInteraction(Oe)}function wn(o){i(ze)===o?vn():(f(ze,o),Qr())}function to(o,d){const h=Vt(o);if(!h)return;const m=h.get("label")??"";m!==d&&(h.set("label",d),Is(h,"label",m,d),me(),q())}function so(o,d){const h=Vt(o);if(!h)return;const m=h.get("details")??"";m!==d&&(h.set("details",d),Is(h,"details",m,d),me(),q())}function no(o,d){const h=Vt(o);if(!h)return;const m=h.get("color")??"";m!==d&&(h.set("color",d),Is(h,"color",m,d),me(),q())}function io(o){const d=Vt(o);if(!d)return;const h=!!d.get("hidden");d.set("hidden",!h),Is(d,"hidden",h,!h),me(),q()}function ro(o){if(!i(T))return;const h=Vt(o)?.getGeometry();if(h)if(h.getType()==="Point"){const m=h.getCoordinates();i(T).getView().animate({center:m,zoom:Math.max(i(T).getView().getZoom()??16,17),duration:350})}else i(T).getView().fit(h.getExtent(),{padding:[80,80,80,80],duration:400,maxZoom:18})}function oo(o){const d=Vt(o);!d||!D||(Nr(d),D.removeFeature(d),he.clearSelectionIfMatches(o),me(),q())}function ao(){if(!D)return;const o=D.getFeatures();Vr(o),D.clear(),he.reset(),q(),it("All annotations cleared.","info")}function lo(){if(ce&&He)try{ce.setMapOpacity(He,0)}catch{}He=null,Es=null,f(Ye,"")}async function ji(o){if(!o.size)return!1;let d=!1;const h=o.get("basemap");h&&Ht.some(F=>F.key===h)&&(f(De,h),mn(h),d=!0);const m=o.get("view");m&&["overlay","side-x","side-y","spy"].includes(m)&&(Di(m),d=!0);const b=o.get("map");b&&i(ie).some(F=>F.id===b)&&(f(Ye,b),await yn(b),d=!0);const y=i(T)?.getView();if(y){const F=o.get("lat"),k=o.get("lon"),C=o.get("zoom"),P=o.get("rotation"),L=F?Number(F):NaN,j=k?Number(k):NaN;if(Number.isFinite(L)&&Number.isFinite(j)&&(y.setCenter(Un([j,L])),d=!0),C){const G=Number(C);Number.isFinite(G)&&(y.setZoom(G),d=!0)}if(P){const G=Number(P);Number.isFinite(G)&&(y.setRotation(G),d=!0)}}return d}function bn(){f(gt,[]),f(Pe,null),f(Fe,"info"),f(mt,!1)}function Ni(o){try{if(o.geojson){const d=M.readFeature({type:"Feature",geometry:o.geojson,properties:{}},{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"});return d.set("label",o.display_name??o.type??"Search result"),d}if(o.lon&&o.lat){const d=new Je(Un([Number(o.lon),Number(o.lat)])),h=new xe({geometry:d});return h.set("label",o.display_name??o.type??"Search result"),h}}catch(d){console.warn("Unable to create feature from search result",d)}return null}async function co(o){const d=o.trim();if(f(ft,o),!d){bn(),st?.clear(),pt?.abort(),pt=null;return}pt?.abort(),pt=new AbortController,f(mt,!0),f(Pe,null),f(Fe,"info");try{const h=new URLSearchParams({format:"jsonv2",q:d,addressdetails:"1",polygon_geojson:"1",limit:"10"}),m=await fetch(`https://nominatim.openstreetmap.org/search?${h.toString()}`,{signal:pt.signal,headers:{Accept:"application/json"}});if(!m.ok)throw new Error(`HTTP ${m.status}`);const b=await m.json();f(gt,b),b.length||(f(Pe,"No results found."),f(Fe,"info"))}catch(h){if(h.name==="AbortError")return;f(Pe,"Search failed. Please try again."),f(Fe,"error"),console.error("Search error:",h),f(gt,[])}finally{f(mt,!1)}}function ho(o){f(ft,o),rn&&clearTimeout(rn),rn=window.setTimeout(()=>{co(o)},1e3)}function uo(o){if(!i(T)||!st)return;const d=Ni(o);if(!d)return;st.clear(),st.addFeature(d);const h=d.getGeometry();if(h)if(h.getType()==="Point"){const m=h.getCoordinates();i(T).getView().animate({center:m,zoom:Math.max(i(T).getView().getZoom()??12,16),duration:400})}else i(T).getView().fit(h.getExtent(),{padding:[80,80,80,80],duration:400,maxZoom:18})}function fo(o){if(!D)return;const d=Ni(o);d&&(vt(d),D.addFeature(d),Ii(d),he.setSelected(String(d.getId())),me(),q(),bn(),f(Pe,"Feature added to annotations."),f(Fe,"success"),st?.clear(),f(ft,""),it("Annotation added from search.","success"))}function go(){f(ft,""),bn(),st?.clear(),pt?.abort(),pt=null,f(Pe,null),f(Fe,"info")}function mo(){const o=i(T),d=st;if(!(!o||!d)){if(!("geolocation"in navigator)){f(Pe,"Geolocation is not available."),f(Fe,"error");return}f(mt,!0),f(Pe,null),f(Fe,"info"),navigator.geolocation.getCurrentPosition(h=>{const{latitude:m,longitude:b}=h.coords,y=Un([b,m]);d.clear();const F=new xe({geometry:new Je(y)});F.set("label","Current location"),d.addFeature(F);const k=o.getView();k.animate({center:y,zoom:Math.max(k.getZoom()??12,16),duration:450}),f(mt,!1),f(Pe,"Centered on your location."),f(Fe,"success")},h=>{f(mt,!1),f(Pe,`Could not get location: ${h.message}`),f(Fe,"error")})}}function po(o,d){const h=URL.createObjectURL(o),m=document.createElement("a");m.href=h,m.download=d,m.click(),URL.revokeObjectURL(h)}function yo(){if(!D)return;const o=D.getFeatures();if(!o.length){it("Nothing to export  the annotation list is empty.","info");return}const d=M.writeFeaturesObject(o,{featureProjection:"EPSG:3857",dataProjection:"EPSG:4326"}),h=new Blob([JSON.stringify(d,null,2)],{type:"application/geo+json;charset=utf-8;"}),m=new Date().toISOString().replace(/[:.]/g,"-");po(h,`annotations-${m}.geojson`),it("GeoJSON downloaded.","success")}async function _o(o){if(D)try{const d=JSON.parse(o),h=M.readFeatures(d,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"});h.forEach(m=>vt(m)),D.addFeatures(h),Ur(h),me(),it(`Imported ${h.length} feature${h.length!==1?"s":""}.`,"success"),q()}catch(d){console.error("GeoJSON import failed",d),it("Failed to import GeoJSON file.","error")}}async function vo(o){const d=o.target,[h]=d.files??[];if(h)try{await _o(await h.text())}finally{d.value=""}}Uo(()=>{const o=Ht.map(P=>P.layer());ce=new nl,ce.setZIndex(10),ce.setProperties({name:"allmaps-overlay"});const d=ce;d.getDeclutter||(d.getDeclutter=()=>!1),d.renderDeferred||(d.renderDeferred=()=>!1),f(tt,new rr({source:new Jt,zIndex:20,properties:{name:"annotations"},declutter:!0})),i(tt).setStyle(Zl),D=i(tt).getSource()??new Jt,Ps=new rr({source:new Jt,zIndex:25,properties:{name:"search"},style:P=>Ql}),st=Ps.getSource()??new Jt;const h=il({attribution:!1,rotate:!1,zoom:!1}).extend([new rl({collapsible:!1}),new ol({autoHide:!1}),new al,new ll]),m=[...o,i(tt),Ps];f(T,new cl({target:i($e),layers:m,view:new Ma({center:ms,zoom:14,enableRotation:!0}),controls:h})),Mt(),ce.setMap?.(i(T)),Rt=new dl({condition:P=>P.originalEvent.ctrlKey||P.originalEvent.metaKey}),jt=new hl,i(T).addInteraction(Rt),i(T).addInteraction(jt),D&&(Oe=new _l({source:D}),i(T).addInteraction(Oe),Oe.on("modifystart",P=>{ks.clear(),P.features.forEach(L=>{const j=L,G=j.getId();G&&ks.set(String(G),Ut(j))})}),Oe.on("modifyend",P=>{P.features.forEach(L=>{const j=L,G=j.getId();if(!G)return;const H=ks.get(String(G)),ue=Ut(j);if(!H)return;const _e=JSON.stringify(H.feature.geometry??null),O=JSON.stringify(ue.feature.geometry??null);_e!==O&&$r(H,ue)}),ks.clear(),me(),q()}),It=new _i({condition:ul,layers:P=>P===i(tt)}),i(T).addInteraction(It),It.on("select",P=>{const L=P.selected[0]??null;he.setSelected(L?String(L.getId()):null)}),cn=[D.on("addfeature",()=>{me(),q()}),D.on("removefeature",()=>{me(),q()}),D.on("changefeature",()=>{me(),q()}),D.on("clear",()=>{me(),q()})]),i(T).on("moveend",()=>{yt(),q()}),i(T).on("change:size",yt);const y=window.matchMedia("(max-width: 900px)"),F=window.matchMedia("(max-width: 1400px)"),k=window.matchMedia("(max-width: 1180px)"),C=()=>{f(Qe,y.matches),i(Qe)&&(f(Ge,"explore"),f(St,!1)),f(Ct,F.matches),f(kt,k.matches)};C(),y.addEventListener("change",C),F.addEventListener("change",C),k.addEventListener("change",C),un=()=>{y.removeEventListener("change",C),F.removeEventListener("change",C),k.removeEventListener("change",C)},mn(i(De)),zr().then(()=>Lr()).catch(P=>{console.error("Failed to initialise dataset",P),Ft=!0}),Mt(),window.addEventListener("pointermove",Gi),window.addEventListener("pointerup",Ts),window.addEventListener("pointercancel",Ts),window.addEventListener("resize",Mt),ds=P=>{if(P.defaultPrevented)return;const L=P.target;if(L&&(L.isContentEditable||["INPUT","TEXTAREA"].includes(L.tagName))||!(P.metaKey||P.ctrlKey))return;const G=P.shiftKey,H=P.key.toLowerCase();H==="z"?(P.preventDefault(),G?gn():Mi()):H==="y"&&(P.preventDefault(),gn())},window.addEventListener("keydown",ds)}),$o(()=>{cs?.abort(),pt?.abort(),un?.(),un=null,window.removeEventListener("pointermove",Gi),window.removeEventListener("pointerup",Ts),window.removeEventListener("pointercancel",Ts),window.removeEventListener("resize",Mt),ds&&(window.removeEventListener("keydown",ds),ds=null),cn.forEach(o=>Aa(o)),cn=[],_n(),i(T)&&Oe&&i(T).removeInteraction(Oe),i(T)&&It&&i(T).removeInteraction(It),i(T)?.setTarget(void 0),f(T,null),ce=null,f(tt,null),D=null,Ps=null,st=null,Oe=null,It=null,Tt!==null&&(cancelAnimationFrame(Tt),Tt=null)}),$(()=>i(Et),()=>{f(l,i(Et).filter(o=>!o.hidden))}),$(()=>(i(Et),i(Fi)),()=>{f(c,i(Et)[i(Fi)]??null)}),$(()=>(i(c),i(l)),()=>{f(u,i(c)?i(l).findIndex(o=>o.id===i(c).id)+1:0)}),$(()=>i(De),()=>{f(p,Ht.find(o=>o.key===i(De))?.label??"Basemap")}),$(()=>i(ke),()=>{f(g,Math.round(i(ke)*100))}),$(()=>i(Ge),()=>{f(x,i(Ge)==="explore"?"Exploring":"Creating")}),$(()=>(i(ie),i(Ye)),()=>{f(de,i(ie).find(o=>o.id===i(Ye))??null)}),$(()=>i(ie),()=>{f(sn,Array.from(new Set(i(ie).map(o=>o.type||"Uncategorized"))).filter(o=>o&&o.trim().length).sort((o,d)=>o.localeCompare(d)))}),$(()=>i(ie),()=>{f(xs,(()=>{const o=i(ie).filter(h=>h.isFeatured);return(o.length?o:i(ie)).slice(0,4)})())}),$(()=>(i(Ot),i(ie)),()=>{f(nn,i(Ot)==="all"?i(ie):i(ie).filter(o=>o.type.toLowerCase()===i(Ot).toLowerCase()))}),$(()=>i(nn),()=>{f(Ss,i(nn))}),$(()=>i(Cs),()=>{i(Cs)!=="annotations"&&f(Pt,null)}),$(()=>i(Cs),()=>{i(Cs)!=="story"&&f(Mr,null)}),$(()=>t(),()=>{f(_,t().history.length>0)}),$(()=>t(),()=>{f(I,t().future.length>0)}),$(()=>s(),()=>{f(et,s().list)}),$(()=>s(),()=>{f(Pi,s().selectedId)}),$(()=>i(St),()=>{i(St)&&f(ut,!1)}),$(()=>i(de),()=>{i(de)||f(ut,!1)}),$(()=>i(St),()=>{i(St)&&f(Le,!1)}),$(()=>i(Ge),()=>{i(Ge)!=="create"&&(f(Be,!1),f(Ce,!1),f(Le,!1),f(xt,!1))}),$(()=>(i(Le),i(ls)),()=>{i(Le)&&i(ls)&&queueMicrotask(()=>i(ls)?.focus())}),$(()=>(i(ut),i(Nt)),()=>{i(ut)&&i(Nt)&&i(Nt).focus()}),$(()=>(i(Qe),i(Ge),i(Be),i(Ce),i(kt),i(Ct)),()=>{f(ki,!i(Qe)&&i(Ge)==="create"?`grid-template-columns: ${Ri(i(Be))} minmax(0, ${Wr(i(Be),i(Ce))}fr) ${Ri(i(Ce))}; gap: ${i(kt)?"1rem":i(Ct)?"1.1rem":"1.2rem"}; padding: ${i(kt)?"1rem":i(Ct)?"1.2rem":"1.4rem"};`:void 0)}),$(()=>(i(T),i(Ge),i(Be),i(Ce),i(St),i(Ci),i(Qe)),()=>{i(T)&&(i(Ge),i(Be),i(Ce),i(St),i(Ci),i(Qe),Mt())}),$(()=>i(De),()=>{mn(i(De))}),$(()=>{},()=>{yt()}),$(()=>(i(tt),i(Ge)),()=>{i(tt)&&i(tt).setVisible(i(Ge)==="create")}),Go(),Ao();var As=jc();let Vi;var Ls=S(As),Ui=S(Ls);{var wo=o=>{var d=yc(),h=gs(d);{var m=F=>{var k=lc();A("click",k,()=>f(Be,!1)),R(F,k)};X(h,F=>{i(Be)&&F(m)})}var b=w(h,2);{var y=F=>{var k=pc(),C=S(k),P=w(C,2),L=S(P),j=w(S(L),2),G=w(S(j),2),H=S(G);let ue;var _e=w(H,2);let O;var ee=w(_e,2);let pe;var W=w(ee,2);let J;v(G),v(j);var V=w(j,2),U=w(S(V),2),K=S(U);js(K);var rt=w(K,2),ot=S(rt);v(rt),v(U),v(V),v(L);var Y=w(L,2),at=w(S(Y),2);{var _t=Z=>{var se=hc(),fe=w(S(se),2);Xt(fe,5,()=>i(xs),Ie=>Ie.id,(Ie,Q)=>{var Ne=dc();let fs;var At=S(Ne),Dn=S(At,!0);v(At);var Rs=w(At,2);{var Gn=On=>{var Rn=cc(),Mo=S(Rn,!0);v(Rn),ne(()=>oe(Mo,(i(Q),B(()=>i(Q).summary)))),R(On,Rn)};X(Rs,On=>{i(Q),B(()=>i(Q).summary)&&On(Gn)})}v(Ne),ne(()=>{fs=ae(Ne,1,"history-featured-card svelte-1gd50sk",null,fs,{selected:i(Q).id===i(Ye)}),oe(Dn,(i(Q),B(()=>i(Q).name)))}),A("click",Ne,()=>void Oi(i(Q).id)),R(Ie,Ne)}),v(fe),v(se),R(Z,se)};X(at,Z=>{i(xs),B(()=>i(xs).length)&&Z(_t)})}var je=w(at,2),lt=S(je),Bt=w(S(lt),2);ne(()=>{i(Ot),Ro(()=>{i(ie),i(sn)})});var Xe=S(Bt),Yt=S(Xe);v(Xe),Xe.value=Xe.__value="all";var Mn=w(Xe);Xt(Mn,1,()=>i(sn),nr,(Z,se)=>{var fe=uc(),Ie=S(fe,!0);v(fe);var Q={};ne(()=>{oe(Ie,i(se)),Q!==(Q=i(se))&&(fe.value=(fe.__value=i(se))??"")}),R(Z,fe)}),v(Bt),v(lt),v(je);var us=w(je,2),An=S(us);{var qt=Z=>{var se=jn(),fe=gs(se);Xt(fe,1,()=>i(Ss),Ie=>Ie.id,(Ie,Q)=>{var Ne=fc();let fs;var At=S(Ne),Dn=S(At,!0);v(At);var Rs=w(At,2),Gn=S(Rs,!0);v(Rs),v(Ne),ne(()=>{fs=ae(Ne,1,"history-item svelte-1gd50sk",null,fs,{selected:i(Q).id===i(Ye)}),oe(Dn,(i(Q),B(()=>i(Q).name))),oe(Gn,(i(Q),B(()=>i(Q).summary||i(Q).type)))}),A("click",Ne,()=>void Oi(i(Q).id)),R(Ie,Ne)}),R(Z,se)},Ln=Z=>{var se=gc();R(Z,se)};X(An,Z=>{i(Ss),B(()=>i(Ss).length)?Z(qt):Z(Ln,!1)})}v(us),v(Y);var Os=w(Y,2),Ee=w(S(Os),2),zt=S(Ee);Xt(zt,5,()=>Ht,nr,(Z,se)=>{var fe=mc();let Ie;var Q=S(fe,!0);v(fe),ne(()=>{Ie=ae(fe,1,"svelte-1gd50sk",null,Ie,{selected:i(De)===i(se).key}),oe(Q,(i(se),B(()=>i(se).label)))}),A("click",fe,()=>{f(De,i(se).key),q()}),R(Z,fe)}),v(zt),v(Ee),v(Os),v(P),v(k),ne(()=>{ue=ae(H,1,"svelte-1gd50sk",null,ue,{selected:i(re)==="overlay"}),O=ae(_e,1,"svelte-1gd50sk",null,O,{selected:i(re)==="side-x"}),pe=ae(ee,1,"svelte-1gd50sk",null,pe,{selected:i(re)==="side-y"}),J=ae(W,1,"svelte-1gd50sk",null,J,{selected:i(re)==="spy"}),oe(ot,`${i(g)??""}%`),oe(Yt,`All maps (${i(ie),B(()=>i(ie).length)??""})`)}),A("click",C,()=>f(Be,!0)),A("click",H,()=>Ms("overlay")),A("click",_e,()=>Ms("side-x")),A("click",ee,()=>Ms("side-y")),A("click",W,()=>Ms("spy")),or(K,()=>i(ke),Z=>f(ke,Z)),A("input",K,Kr),Oa(Bt,()=>i(Ot),Z=>f(Ot,Z)),R(F,k)};X(b,F=>{i(Be)||F(y)})}R(o,d)};X(Ui,o=>{i(Qe)||o(wo)})}var xn=w(Ui,2),Sn=S(xn),$i=S(Sn);Ve($i,o=>f($e,o),()=>i($e));var Bi=w($i,2);Ve(Bi,o=>f(ge,o),()=>i(ge));var Yi=w(Bi,2);Ve(Yi,o=>f(Se,o),()=>i(Se));var Cn=w(Yi,2);Ve(Cn,o=>f(Ke,o),()=>i(Ke));var kn=w(Cn,2);Ve(kn,o=>f(We,o),()=>i(We));var qi=w(kn,2);Ve(qi,o=>f(we,o),()=>i(we));var zi=w(qi,2);Ve(zi,o=>f(Ze,o),()=>i(Ze)),v(Sn);var Hi=w(Sn,2),Pn=S(Hi),bo=S(Pn);v(Pn);var Fn=w(Pn,2),En=S(Fn);let Xi;var In=w(En,2),Ds=S(In);let Ji;var xo=w(Ds,2);{var So=o=>{var d=_c(),h=S(d);let m;var b=w(h,2);let y;var F=w(b,2);let k;var C=w(F,2);let P;var L=S(C,!0);v(C);var j=w(C,2);v(d),ne(()=>{m=ae(h,1,"svelte-1gd50sk",null,m,{selected:i(ze)==="point"}),y=ae(b,1,"svelte-1gd50sk",null,y,{selected:i(ze)==="line"}),k=ae(F,1,"svelte-1gd50sk",null,k,{selected:i(ze)==="polygon"}),P=ae(C,1,"svelte-1gd50sk",null,P,{selected:i(rs)}),oe(L,i(rs)?"Disable edit":"Enable edit")}),A("click",h,()=>{wn("point"),f(qe,!1)}),A("click",b,()=>{wn("line"),f(qe,!1)}),A("click",F,()=>{wn("polygon"),f(qe,!1)}),A("click",C,()=>{eo(),f(qe,!1)}),A("click",j,()=>{vn(),f(qe,!1)}),R(o,d)};X(xo,o=>{i(qe)&&o(So)})}v(In);var Tn=w(In,2),Ki=w(Tn,2);v(Fn);var Wi=w(Fn,2),Zi=S(Wi),Gs=S(Zi);let Qi;var Co=w(Gs,2);{var ko=o=>{var d=vc(),h=S(d);v(d),A("click",h,()=>{Zr(),f(xt,!1)}),R(o,d)};X(Co,o=>{i(xt)&&o(ko)})}v(Zi),v(Wi),v(Hi),v(xn);var Po=w(xn,2);{var Fo=o=>{var d=Pc(),h=gs(d);{var m=F=>{var k=wc();A("click",k,()=>f(Ce,!1)),R(F,k)};X(h,F=>{i(Ce)&&F(m)})}var b=w(h,2);{var y=F=>{var k=kc(),C=S(k),P=S(C),L=w(P,2),j=w(S(L),2),G=S(j),H=w(G,2),ue=w(H,2),_e=w(S(ue));Ve(_e,U=>f(Ei,U),()=>i(Ei)),v(ue),v(j),v(L),v(C);var O=w(C,2),ee=S(O);{var pe=U=>{var K=bc();let rt;var ot=S(K,!0);v(K),ne(()=>{rt=ae(K,1,"notice svelte-1gd50sk",null,rt,{errored:i(ln)==="error",success:i(ln)==="success"}),oe(ot,i(an))}),R(U,K)};X(ee,U=>{i(an)&&U(pe)})}var W=w(ee,2);{var J=U=>{var K=jn(),rt=gs(K);Xt(rt,1,()=>i(et),ot=>ot.id,(ot,Y)=>{var at=Sc();let _t;var je=S(at),lt=S(je);js(lt);var Bt=w(lt,2),Xe=S(Bt);js(Xe);var Yt=w(Xe,2),Mn=S(Yt,!0);v(Yt);var us=w(Yt,2),An=w(us,2);v(Bt),v(je);var qt=w(je,2);jo(qt);var Ln=w(qt,2);{var Os=Ee=>{var zt=xc(),Z=S(zt),se=w(Z,2);v(zt),A("click",Z,()=>{ro(i(Y).id),f(Pt,null)}),A("click",se,()=>{he.setSelected(i(Y).id),f(Pt,null)}),R(Ee,zt)};X(Ln,Ee=>{i(Pt),i(Y),B(()=>i(Pt)===i(Y).id)&&Ee(Os)})}v(at),ne(()=>{_t=ae(at,1,"list-card svelte-1gd50sk",null,_t,{selected:i(Y).id===i(Pi)}),Bn(lt,(i(Y),B(()=>i(Y).label))),Bn(Xe,(i(Y),B(()=>i(Y).color))),oe(Mn,(i(Y),B(()=>i(Y).hidden?"Show":"Hide"))),Bn(qt,(i(Y),B(()=>i(Y).details)))}),A("input",lt,Ee=>to(i(Y).id,Ee.target.value)),A("input",Xe,Ee=>no(i(Y).id,Ee.target.value)),A("click",Yt,()=>io(i(Y).id)),A("click",us,()=>oo(i(Y).id)),A("click",An,()=>f(Pt,i(Pt)===i(Y).id?null:i(Y).id)),A("input",qt,Ee=>so(i(Y).id,Ee.target.value)),R(ot,at)}),R(U,K)},V=U=>{var K=Cc();R(U,K)};X(W,U=>{i(et),B(()=>i(et).length)?U(J):U(V,!1)})}v(O),v(k),ne(()=>{$n(P,"aria-expanded",!i(Ce)),G.disabled=(i(et),B(()=>!i(et).length)),H.disabled=(i(et),B(()=>!i(et).length))}),A("click",P,()=>f(Ce,!i(Ce))),A("click",G,ao),A("click",H,yo),A("change",_e,vo),R(F,k)};X(b,F=>{i(Ce)||F(y)})}R(o,d)};X(Po,o=>{i(Qe)||o(Fo)})}v(Ls);var er=w(Ls,2);{var Eo=o=>{var d=Mc(),h=S(d),m=S(h),b=w(S(m),2);v(m);var y=w(m,2);{var F=C=>{var P=Ic(),L=S(P),j=S(L,!0);v(L);var G=w(L,2),H=S(G),ue=w(S(H),2),_e=S(ue,!0);v(ue),v(H);var O=w(H,2);{var ee=J=>{var V=Fc(),U=w(S(V),2),K=S(U,!0);v(U),v(V),ne(()=>oe(K,(i(de),B(()=>i(de).summary)))),R(J,V)};X(O,J=>{i(de),B(()=>i(de).summary)&&J(ee)})}var pe=w(O,2);{var W=J=>{var V=Ec(),U=w(S(V),2),K=S(U,!0);v(U),v(V),ne(()=>oe(K,(i(de),B(()=>i(de).description)))),R(J,V)};X(pe,J=>{i(de),B(()=>i(de).description)&&J(W)})}v(G),v(P),ne(()=>{oe(j,(i(de),B(()=>i(de).name))),oe(_e,(i(de),B(()=>i(de).type)))}),R(C,P)},k=C=>{var P=Tc();R(C,P)};X(y,C=>{i(de)?C(F):C(k,!1)})}v(h),v(d),Ve(d,C=>f(Nt,C),()=>i(Nt)),A("click",b,()=>f(ut,!1)),A("keydown",d,C=>{C.key==="Escape"&&(C.preventDefault(),f(ut,!1)),(C.key==="Enter"||C.key===" ")&&C.target===i(Nt)&&(C.preventDefault(),f(ut,!1))}),R(o,d)};X(er,o=>{i(ut)&&o(Eo)})}var Io=w(er,2);{var To=o=>{var d=Rc(),h=S(d),m=w(h,2),b=S(m),y=w(S(b),2);v(b);var F=w(b,2),k=S(F);js(k),Ve(k,O=>f(ls,O),()=>i(ls));var C=w(k,2),P=S(C),L=w(P,2);v(C),v(F);var j=w(F,2);{var G=O=>{var ee=Ac();R(O,ee)},H=O=>{var ee=jn(),pe=gs(ee);{var W=J=>{var V=Lc();let U;var K=S(V,!0);v(V),ne(()=>{U=ae(V,1,"svelte-1gd50sk",null,U,{errored:i(Fe)==="error",success:i(Fe)==="success"}),oe(K,i(Pe))}),R(J,V)};X(pe,J=>{i(Pe)&&J(W)},!0)}R(O,ee)};X(j,O=>{i(mt)?O(G):O(H,!1)})}var ue=w(j,2);{var _e=O=>{var ee=Oc();Xt(ee,5,()=>i(gt),pe=>pe.display_name,(pe,W)=>{var J=Gc(),V=S(J),U=S(V),K=S(U,!0);v(U);var rt=w(U,2);{var ot=_t=>{var je=Dc(),lt=S(je,!0);v(je),ne(()=>oe(lt,(i(W),B(()=>i(W).type)))),R(_t,je)};X(rt,_t=>{i(W),B(()=>i(W).type)&&_t(ot)})}v(V);var Y=w(V,2),at=S(Y);v(Y),v(J),ne(()=>oe(K,(i(W),B(()=>i(W).display_name)))),A("click",V,()=>{uo(i(W)),f(Le,!1)}),A("click",at,()=>fo(i(W))),R(pe,J)}),v(ee),R(O,ee)};X(ue,O=>{i(gt),B(()=>i(gt).length)&&O(_e)})}v(m),v(d),Ve(d,O=>f(dn,O),()=>i(dn)),ne(()=>{P.disabled=i(mt),L.disabled=(i(ft),i(gt),B(()=>!i(ft)&&!i(gt).length))}),A("click",h,()=>f(Le,!1)),A("click",y,()=>f(Le,!1)),or(k,()=>i(ft),O=>f(ft,O)),A("input",k,O=>ho(O.target.value)),A("click",P,mo),A("click",L,go),A("keydown",d,O=>{O.key==="Escape"&&(O.preventDefault(),f(Le,!1)),(O.key==="Enter"||O.key===" ")&&O.target===i(dn)&&(O.preventDefault(),f(Le,!1))}),R(o,d)};X(Io,o=>{i(Le)&&o(To)})}v(As),ne(()=>{Vi=ae(As,1,"viewer svelte-1gd50sk",null,Vi,{mobile:i(Qe),creator:!0}),Ga(Ls,i(ki)),Xi=ae(En,1,"svelte-1gd50sk",null,Xi,{selected:!i(ze)}),$n(Ds,"aria-expanded",i(qe)),Ji=ae(Ds,1,"svelte-1gd50sk",null,Ji,{selected:i(qe)||!!i(ze)}),Tn.disabled=!i(_),Ki.disabled=!i(I),$n(Gs,"aria-expanded",i(xt)),Qi=ae(Gs,1,"svelte-1gd50sk",null,Qi,{selected:i(xt)})}),A("pointerdown",Cn,o=>{i(re)==="side-x"&&(f(be,{sideX:!0,sideY:!1,lensR:!1}),o.currentTarget?.setPointerCapture(o.pointerId),o.preventDefault())}),A("pointerdown",kn,o=>{i(re)==="side-y"&&(f(be,{sideX:!1,sideY:!0,lensR:!1}),o.currentTarget?.setPointerCapture(o.pointerId),o.preventDefault())}),A("pointerdown",zi,o=>{i(re)==="spy"&&(f(be,{sideX:!1,sideY:!1,lensR:!0}),o.currentTarget?.setPointerCapture(o.pointerId),o.preventDefault())}),A("click",bo,()=>f(Le,!0)),A("click",En,vn),A("click",Ds,()=>f(qe,!i(qe))),A("click",Tn,Mi),A("click",Ki,gn),A("click",Gs,()=>f(xt,!i(xt))),R(a,As),Oo(),r()}function Vc(a,e){let t=Kn(e,"mode",8,"explore");Nc(a,{get initialMode(){return t()}})}var Uc=N('<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&amp;family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&amp;family=Be+Vietnam+Pro:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>');function Qc(a){No(e=>{var t=Uc();R(e,t)}),Vc(a,{})}export{Qc as component};
